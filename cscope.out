cscope 15 Z:\software\webs-2-5"               0000429560
	@CE/main.c

19 
	~<wödows.h
>

20 
	~<wösock.h
>

22 
	~"../wsI¡∫.h
"

24 #ifde‡
WEBS_SSL_SUPPORT


25 
	~"../websSSL.h
"

28 #ifde‡
USER_MANAGEMENT_SUPPORT


29 
	~"../um.h
"

30 
f‹mDeföeU£rMgmt
();

37 
HWND
 
	ghwnd
;

38 
	gsockSîvi˚Time
 = 1000;

39 
ch¨_t
 *
	gtôÀ
 = 
T
("GoAhead WebServer");

40 
ch¨_t
 *
	g«me
 = 
T
("gowebs");

41 
ch¨_t
 *
	groŸWeb
 = 
T
("/www");

42 
ch¨_t
 *
	gdemoWeb
 = 
T
("/wwwdemo");

43 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

44 
	gp‹t
 = 80;

45 
	gªåõs
 = 5;

46 
	gföished
;

50 
öôWebs
(
demo
);

51 
CALLBACK
 
websWödProc
(
HWND
 
hwnd
, 
msg
,

52 
wp
, 
Õ
);

53 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

54 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

55 
wödowsInô
(
HINSTANCE
 
hö°™˚
);

56 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

57 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

58 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

59 
memLóks
();

66 
WINAPI
 
	$WöMaö
(
HINSTANCE
 
hö°™˚
, HINSTANCE 
h¥evö°™˚
,

67 
LPTSTR
 
¨gs
, 
cmd_show
)

69 
i
, 
demo
 = 0;

71 
i
 = 1; i < 
¨gc
; i++) {

72 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

73 
demo
++;

83 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

88 i‡(
	`wödowsInô
(
hö°™˚
) < 0) {

89  
FALSE
;

95 i‡(
	`öôWebs
(
demo
) < 0) {

96  
FALSE
;

99 #ifde‡
WEBS_SSL_SUPPORT


100 
	`websSSLO≥n
();

108 !
föished
) {

109 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 
sockSîvi˚Time
)) {

110 
	`sockëPro˚ss
(-1);

112 
	`emfSchedPro˚ss
();

113 
	`websCgiCÀ™up
();

116 #ifde‡
WEBS_SSL_SUPPORT


117 
	`websSSLClo£
();

123 #ifde‡
USER_MANAGEMENT_SUPPORT


124 
	`umClo£
();

130 
	`websClo£Sîvî
();

131 
	`sockëClo£
();

132 #ifde‡
B_STATS


133 
	`memLóks
();

135 
	`b˛o£
();

137 
	}
}

144 
	$öôWebs
(
demo
)

146 
ho°ít
 *
hp
;

147 
ö_addr
 
öèddr
;

148 
ch¨_t
 
wbuf
[128];

149 
ho°
[64];

150 *
˝
;

155 
	`sockëO≥n
();

160 #ifde‡
USER_MANAGEMENT_SUPPORT


161 
	`umO≥n
();

162 
	`umRe°‹e
(
	`T
("umconfig.txt"));

169 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

170 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

173 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

174 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

177 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

178 (
size_t
Ë
hp
->
h_Àngth
);

183 i‡(
demo
) {

184 
	`websSëDeÁu…Dú
(
demoWeb
);

186 
	`websSëDeÁu…Dú
(
roŸWeb
);

192 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

193 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

194 
	`websSëI∑ddr
(
wbuf
);

195 
	`ascToUni
(
wbuf
, 
hp
->
h_«me
, 
	`mö
(
	`°æí
(hp->h_name) + 1, (wbuf)));

196 
	`websSëHo°
(
wbuf
);

201 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

202 
	`websSëPassw‹d
(
∑ssw‹d
);

208 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

215 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

216 
WEBS_HANDLER_FIRST
);

217 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

218 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

219 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

220 
WEBS_HANDLER_LAST
);

226 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

227 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

232 #ifde‡
USER_MANAGEMENT_SUPPORT


233 
	`f‹mDeföeU£rMgmt
();

239 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

241 
	}
}

248 
	$wödowsInô
(
HINSTANCE
 
hö°™˚
)

254 
WNDCLASS
 
wc
;

256 
	`emfIn°Së
((Ë
hö°™˚
);

258 
wc
.
°yÀ
 = 0;

259 
wc
.
hbrBackground
 = 
NULL
;

260 
wc
.
hCurs‹
 = 
NULL
;

261 
wc
.
cbClsExåa
 = 0;

262 
wc
.
cbWndExåa
 = 0;

263 
wc
.
hIn°™˚
 = 
hö°™˚
;

264 
wc
.
hIc⁄
 = 
NULL
;

265 
wc
.
Õ‚WndProc
 = (
WNDPROC
Ë
websWödProc
;

266 
wc
.
ÕszMíuName
 = 
NULL
;

267 
wc
.
ÕszCœssName
 = 
«me
;

268 i‡(! 
	`Regi°îCœss
(&
wc
)) {

275 
hwnd
 = 
	`Cª©eWödow
(
«me
, 
tôÀ
, 
WS_VISIBLE
,

276 
CW_USEDEFAULT
, 0, 0, 0, 
NULL
, NULL, 
hö°™˚
, NULL);

277 i‡(
hwnd
 =
NULL
) {

280 
	`ShowWödow
(
hwnd
, 
SW_MINIMIZE
);

281 
	`Upd©eWödow
(
hwnd
);

285 
	}
}

296 
CALLBACK
 
	$websWödProc
(
HWND
 
hwnd
, 
msg
,

297 
wp
, 
Õ
)

299 
msg
) {

300 
WM_DESTROY
:

301 
	`Po°QuôMesßge
(0);

302 
föished
++;

305  
	`DefWödowProc
(
hwnd
, 
msg
, 
wp
, 
Õ
);

306 
	}
}

316 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

318 
ch¨_t
 *
«me
, *
addªss
;

320 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

321 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

324  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

325 
	}
}

333 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

335 
ch¨_t
 *
«me
, *
addªss
;

337 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

338 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

340 
	`websHódî
(
wp
);

341 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

342 
	`websFoŸî
(
wp
);

343 
	`websD⁄e
(
wp
, 200);

344 
	}
}

351 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

352 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

357 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

358 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

362 
	}
}

365 #ifde‡
B_STATS


366 
	$memLóks
()

368 
fd
;

370 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

371 
	`b°©s
(
fd
, 
¥ötMemSèts
);

372 
	`˛o£
(
fd
);

374 
	}
}

381 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

383 
va_li°
 
¨gs
;

384 
ch¨_t
 
buf
[256];

386 
	`va_°¨t
(
¨gs
, 
fmt
);

387 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

388 
	`va_íd
(
¨gs
);

389 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

390 
	}
}

	@CE/wincompat.c

18 
	#IN_GETOPT


	)

20 
	~<wödows.h
>

22 #ifde‡
UEMF


23 
	~"../uemf.h
"

25 
	~"basic/basicI¡î«l.h
"

26 
	~<dúe˘.h
>

27 
	~<f˙é.h
>

28 
	~<gë›t.h
>

29 
	~<io.h
>

30 
	~<pwd.h
>

31 
	~<°©.h
>

32 
	~<°dio.h
>

33 
	~<°rög.h
>

34 
	~<time.h
>

35 
	~<timeb.h
>

36 
	~<ty≥s.h
>

37 
	~<uni°d.h
>

38 
	~<ulimô.h
>

44 
HANDLE
 
	mh™d
;

45 } 
	tfh_t
;

49 
	gî∫o
;

50 
	$__de˛•ec
(
dŒexp‹t
Ë
›ãº
 = 1;

51 
	$__de˛•ec
(
dŒexp‹t
Ë
›töd
 = 1;

52 
	$__de˛•ec
(
dŒexp‹t
Ë
›t›t
;

53 
	$__de˛•ec
(
dŒexp‹t
Ë
ch¨_t
* 
›èrg
;

57 
›tswi
 = '-';

59 
fh_t
 **
f
;

60 
fMax
;

65 
tm
 
loˇ…m
;

70 
ch¨_t
 
loˇl˘ime
[32];

72 
ch¨_t
 *
m⁄ths
[] = {

73 
	`T
("Jan"), T("Feb"), T("Mar"), T("Apr"), T("May"), T("Jun"), T("Jul"),

74 
	`T
("Aug"), T("Sep"), T("Oct"), T("Nov"), T("Dec")

75 
	}
};

77 
ch¨_t
 *
	gdays
[] = {

78 
T
("Sun"), T("Mon"), T("Tue"), T("Wed"), T("Thu"), T("Fri"), T("Sat")

81 
ch¨_t
 
	g˚Cwd
[
LF_PATHSIZE
];

83 
ch¨_t
 *
_wgëcwd
(ch¨_à*
dú
, 
Àn
);

84 
_wchdú
(*
∑th
);

88 
uid_t
 
	$gëeuid
()

91 
	}
}

95 
	$gë›t
(
¨gc
, 
ch¨_t
* c⁄° * 
¨gv
, c⁄° ch¨_t* 
›ts
)

97 
ch¨_t
 *
˝
;

98 
ch¨_t
 
noswôch
[3];

99 
•
 = 1;

100 
c
;

102 
	`g°∫£t
(
noswôch
, 
›tswi
, 2);

103 
noswôch
[2]=0;

104 i‡(
•
 == 1) {

105 i‡(
›töd
 >
¨gc
 ||

106 
¨gv
[
›töd
][0] !
›tswi
 ||árgv[optind][1] == '\0') {

107 (
EOF
);

109 i‡(
	`g°rcmp
(
¨gv
[
›töd
], 
noswôch
) == 0) {

110 
›töd
++;

111 (
EOF
);

114 
›t›t
 = 
c
 = 
¨gv
[
›töd
][
•
];

115 i‡(
c
 =':' || (
˝
 = 
	`g°rchr
(
›ts
, (
ch¨_t
Ëc)Ë=
NULL
) {

116 i‡(
¨gv
[
›töd
][++
•
] == '\0') {

117 
›töd
++;

118 
•
 = 1;

122 i‡(*++
˝
 == ':') {

123 i‡(
¨gv
[
›töd
][
•
+1] != '\0') {

124 
›èrg
 = &
¨gv
[
›töd
++][
•
+1];

125 } i‡(++
›töd
 >
¨gc
) {

126 
•
 = 1;

129 
›èrg
 = 
¨gv
[
›töd
++];

131 
•
 = 1;

133 i‡(
¨gv
[
›töd
][++
•
] == '\0') {

134 
•
 = 1;

135 
›töd
++;

137 
›èrg
 = 
NULL
;

139 (
c
);

140 
	}
}

147 
	$¶ìp
(
s
)

149 
	`SÀï
(
s
 * 1000);

151 
	}
}

158 
	$«p
(
ms
)

160 
	`SÀï
(
ms
);

162 
	}
}

169 
time_t
 
	$timeM£c
()

171 
timeb
 
tbnow
;

172 
time_t
 
£c
;

173 
m£c
;

174 
time_t
 
°¨t
 = 0;

175 
time_t
 
°¨t_m£c
;

177 
	`·ime
(&
tbnow
);

178 i‡(
°¨t
 == 0) {

179 
°¨t
 = 
tbnow
.
time
;

180 
°¨t_m£c
 = 
tbnow
.
mûlôm
;

182 
£c
 = 
tbnow
.
time
 - 
°¨t
;

183 
m£c
 = 
tbnow
.
mûlôm
 - 
°¨t_m£c
;

184 i‡(
m£c
 < 0) {

185 
m£c
 += 1000;

186 
£c
 -= 1;

188  
£c
 * 1000 + 
m£c
;

189 
	}
}

199 
	#SECS_BETWEEN_1601_AND_1970
 3054510208

	)

201 
time_t
 
	$fûeTimeToUnixEpochTime
(
FILETIME
 
f
)

203 
ULARGE_INTEGER
 
uli
;

205 
uli
.
LowP¨t
 = 
f
.
dwLowD©eTime
;

206 
uli
.
HighP¨t
 = 
f
.
dwHighD©eTime
;

207 
uli
.
QuadP¨t
 /= 10000000;

209 ((
time_t
Ë
uli
.
QuadP¨t
 - 
SECS_BETWEEN_1601_AND_1970
);

210 
	}
}

217 
time_t
 
	$time
(
time_t
 *
timî
)

219 
SYSTEMTIME
 
°ime
;

220 
FILETIME
 
·ime
;

221 
time_t
 
tmp
;

223 
	`GëLoˇlTime
(&
°ime
);

224 
	`Sy°emTimeToFûeTime
(&
°ime
, &
·ime
);

225 
tmp
 = 
	`fûeTimeToUnixEpochTime
(
·ime
);

226 i‡(
timî
 !
NULL
) {

227 *
timî
 = 
tmp
;

229  
tmp
;

230 
	}
}

237 
tm
* 
	$loˇ…ime
(c⁄° 
time_t
 *
timî
)

239 
SYSTEMTIME
 
°ime
;

240 
	`GëLoˇlTime
(&
°ime
);

242 
loˇ…m
.
tm_£c
 = 
°ime
.
wSec⁄d
;

243 
loˇ…m
.
tm_mö
 = 
°ime
.
wMöuã
;

244 
loˇ…m
.
tm_hour
 = 
°ime
.
wHour
;

245 
loˇ…m
.
tm_mday
 = 
°ime
.
wDay
;

246 
loˇ…m
.
tm_wday
 = 
°ime
.
wDayOfWìk
;

247 
loˇ…m
.
tm_m⁄
 = 
°ime
.
wM⁄th
 - 1;

248 
loˇ…m
.
tm_yór
 = 
°ime
.
wYór
 - 1900;

253 
loˇ…m
.
tm_yday
 = -1;

254 
loˇ…m
.
tm_isd°
 = -1;

255 
loˇ…m
.
tm_tzadj
 = -1;

256 
loˇ…m
.
tm_«me
[0] = 0;

257  &
loˇ…m
;

258 
	}
}

260 #i‚de‡
LITTLEFOOT


266 
ch¨_t
* 
	$_w˘ime
(c⁄° 
time_t
 *
timî
)

268 
SYSTEMTIME
 
°ime
;

269 
FILETIME
 
·ime
;

270 
ULARGE_INTEGER
 
uli
;

272 
uli
.
QuadP¨t
 = *
timî
 * 10000000;

273 
·ime
.
dwLowD©eTime
 = 
uli
.
LowP¨t
;

274 
·ime
.
dwHighD©eTime
 = 
uli
.
HighP¨t
;

276 i‡(
	`FûeTimeToSy°emTime
(&
·ime
, &
°ime
) == 0) {

277  
NULL
;

280 
	`w•rötf
(
loˇl˘ime
, 
	`T
("%s %s %02d %02d:%02d:%02d %04d\n"),

281 
days
[
°ime
.
wDayOfWìk
], 
m⁄ths
[°ime.
wM⁄th
 - 1], stime.
wDay
,

282 
°ime
.
wHour
, stime.
wMöuã
, stime.
wSec⁄d
, stime.
wYór
);

283  
loˇl˘ime
;

284 
	}
}

291 
ch¨_t
 *
	$_was˘ime
(c⁄° 
tm
 *
timïå
)

293 
ch¨_t
 
°rTime
[52];

295 
	`w•rötf
(
°rTime
, 
	`T
("%s %s %02d %02d:%02d:%02d %04d\n"),

296 
days
[
timïå
->
tm_wday
], 
m⁄ths
[timïå->
tm_m⁄
],Åimïå->
tm_mday
,

297 
timïå
->
tm_hour
,Åimïå->
tm_mö
,Åimïå->
tm_£c
,

298 (
timïå
->
tm_yór
 + 1900));

300  &
°rTime
[0];

301 
	}
}

309 
	$·ime
(
timeb
 *
ç
)

311 
ç
->
time
 = 
	`time
(
NULL
);

312 
ç
->
mûlôm
 = 0;

314 #ifde‡
UNSUPPORTED


315 
timez⁄e
;

316 
d°Êag
;

318 
	}
}

325 
	$_w›í
(c⁄° 
ch¨_t
 *
∑th
, 
oÊag
, ...)

327 
HANDLE
 
hFûe
;

328 
DWORD
 
dwDesúedAc˚ss
, 
dwSh¨eMode
, 
dwCª©i⁄Di•osôi⁄
;

329 
fh_t
 *
Â
;

330 
fid
;

331 
ch¨_t
 *
cwd
, *
fûï©h
;

333 
fûï©h
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
 * (
ch¨_t
));

334 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
 * (
ch¨_t
));

336 i‡((*
∑th
 != '/') && (*path != '\\')) {

337 
cwd
 = 
	`_wgëcwd
(cwd, 
LF_PATHSIZE
);

338 i‡(
cwd
 =
NULL
) {

341 
	`fmtAŒoc
(&
fûï©h
, 
LF_PATHSIZE
, 
	`T
("%s/%s"), 
cwd
, 
∑th
);

343 
	`wcs˝y
(
fûï©h
, 
∑th
);

346 
dwDesúedAc˚ss
 = 0;

347 i‡(((
oÊag
 & 0xFË=
O_RDONLY
Ë|| (oÊag & 
O_RDWR
)) {

348 
dwDesúedAc˚ss
 |
GENERIC_READ
;

350 i‡(
oÊag
 & 
O_WRONLY
 || oÊag & 
O_RDWR
) {

351 
dwDesúedAc˚ss
 |
GENERIC_WRITE
;

353 
dwSh¨eMode
 = 
FILE_SHARE_READ
 | 
FILE_SHARE_WRITE
;

354 i‡(
oÊag
 & 
O_CREAT
) {

355 
dwCª©i⁄Di•osôi⁄
 = 
OPEN_ALWAYS
;

357 
dwCª©i⁄Di•osôi⁄
 = 
OPEN_EXISTING
;

360 i‡((
hFûe
 = 
	`Cª©eFûe
(
fûï©h
, 
dwDesúedAc˚ss
, 
dwSh¨eMode
, 
NULL
,

361 
dwCª©i⁄Di•osôi⁄
, 
FILE_ATTRIBUTE_NORMAL
,

362 
NULL
)Ë=
INVALID_HANDLE_VALUE
) {

363 
	`b‰ì
(
B_L
, 
fûï©h
);

364 
	`b‰ì
(
B_L
, 
cwd
);

371 i‡((
fid
 = 
	`hAŒocE¡ry
((***Ë&
f
, &
fMax
, (
fh_t
))) < 0) {

372 
	`b‰ì
(
B_L
, 
fûï©h
);

373 
	`b‰ì
(
B_L
, 
cwd
);

376 
Â
 = 
f
[
fid
];

377 
Â
->
h™d
 = 
hFûe
;

378 
	`b‰ì
(
B_L
, 
fûï©h
);

379 
	`b‰ì
(
B_L
, 
cwd
);

381  
fid
;

382 
	}
}

389 
	$˛o£
(
fid
)

391 
fh_t
 *
Â
;

393 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

394 
Â
 = 
f
[
fid
];

395 i‡(
Â
 =
NULL
) {

398 
	`Clo£H™dÀ
(
Â
->
h™d
);

399 
fMax
 = 
	`hFªe
((***Ë&
f
, 
fid
);

400 
	`b‰ìSa„
(
B_L
, 
Â
);

403 
	}
}

410 
	$ªad
(
fid
, *
buf
, 
Àn
)

412 
fh_t
 *
Â
;

413 
byãsRód
;

415 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

416 
Â
 = 
f
[
fid
];

417 i‡(
Â
 =
NULL
) {

421 i‡(
	`RódFûe
(
Â
->
h™d
, 
buf
, 
Àn
, &
byãsRód
, 
NULL
) == 0) {

424  
byãsRód
;

425 
	}
}

432 
	$ªadAscToUni
(
fid
, **
buf
, 
Àn
)

434 
fh_t
 *
Â
;

435 
byãsRód
;

436 
ch¨_t
 *
uniBuf
;

438 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

439 
Â
 = 
f
[
fid
];

440 i‡(
Â
 =
NULL
) {

444 i‡(
	`RódFûe
(
Â
->
h™d
, *
buf
, 
Àn
, &
byãsRód
, 
NULL
) == 0) {

448 
uniBuf
 = 
	`bÆlocAscToUni
(*
buf
, 
Àn
);

449 
	`b‰ì
(
B_L
, *
buf
);

450 *
buf
 = 
uniBuf
;

452  
byãsRód
;

453 
	}
}

460 
	$wrôe
(
fid
, *
buf
, 
Àn
)

462 
fh_t
 *
Â
;

463 
byãsWrôãn
;

465 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

466 
Â
 = 
f
[
fid
];

467 i‡(
Â
 =
NULL
) {

471 i‡(
	`WrôeFûe
(
Â
->
h™d
, 
buf
, 
Àn
, &
byãsWrôãn
, 
NULL
) == 0) {

474  
byãsWrôãn
;

475 
	}
}

482 
	$wrôeUniToAsc
(
fid
, *
buf
, 
Àn
)

484 
fh_t
 *
Â
;

485 
byãsWrôãn
;

486 *
asciiBuf
;

488 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

489 
Â
 = 
f
[
fid
];

490 i‡(
Â
 =
NULL
) {

494 
asciiBuf
 = 
	`bÆlocUniToAsc
(
buf
, 
Àn
);

496 i‡(
	`WrôeFûe
(
Â
->
h™d
, 
asciiBuf
, 
Àn
, &
byãsWrôãn
, 
NULL
) == 0) {

497 
	`b‰ì
(
B_L
, 
asciiBuf
);

500 
	`b‰ì
(
B_L
, 
asciiBuf
);

501  
byãsWrôãn
;

502 
	}
}

509 
	$_wu∆ök
(
ch¨_t
 *
fûe
)

511 
ch¨_t
 *
cwd
, *
cwdFûe
;

513 
cwdFûe
 = 
NULL
;

514 i‡((*
fûe
 != '/') && (*file != '\\')) {

515 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

516 
	`ggëcwd
(
cwd
, 
LF_PATHSIZE
 / (
ch¨_t
));

517 
	`fmtAŒoc
(&
cwdFûe
, 
LF_PATHSIZE
 / (
ch¨_t
), 
	`T
("%s/%s"), 
cwd
, 
fûe
);

518 
	`b‰ì
(
B_L
, 
cwd
);

519 
fûe
 = 
cwdFûe
;

522 i‡(
	`DñëeFûe
(
fûe
Ë!
TRUE
) {

523 
	`b‰ìSa„
(
B_L
, 
cwdFûe
);

526 
	`b‰ìSa„
(
B_L
, 
cwdFûe
);

528 
	}
}

535 
	$_wmkdú
(c⁄° 
ch¨_t
 *
∑th
)

537 
ch¨_t
 *
cwd
, *
cwdP©h
;

539 
cwdP©h
 = 
NULL
;

540 i‡((*
∑th
 != '/') && (*path != '\\')) {

541 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

542 
	`ggëcwd
(
cwd
, 
LF_PATHSIZE
 / (
ch¨_t
));

543 
	`fmtAŒoc
(&
cwdP©h
, 
LF_PATHSIZE
, 
	`T
("%s/%s"), 
cwd
, 
∑th
);

544 
	`b‰ì
(
B_L
, 
cwd
);

545 
∑th
 = 
cwdP©h
;

548 i‡(
	`Cª©eDúe˘‹y
(
∑th
, 
NULL
) == 0) {

549 
	`b‰ìSa„
(
B_L
, 
cwdP©h
);

552 
	`b‰ìSa„
(
B_L
, 
cwdP©h
);

554 
	}
}

561 
	$_wrmdú
(c⁄° 
ch¨_t
 *
∑th
)

563 
ch¨_t
 *
cwd
, *
cwdP©h
;

565 
cwdP©h
 = 
NULL
;

566 i‡((*
∑th
 != '/') && (*path != '\\')) {

567 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

568 
	`ggëcwd
(
cwd
, 
LF_PATHSIZE
 / (
ch¨_t
));

569 
	`fmtAŒoc
(&
cwdP©h
, 
LF_PATHSIZE
, 
	`T
("%s/%s"), 
cwd
, 
∑th
);

570 
	`b‰ì
(
B_L
, 
cwd
);

571 
∑th
 = 
cwdP©h
;

574 i‡(
	`RemoveDúe˘‹y
(
∑th
) == 0) {

575 
	`b‰ìSa„
(
B_L
, 
cwdP©h
);

578 
	`b‰ìSa„
(
B_L
, 
cwdP©h
);

580 
	}
}

587 
	$f°©
(
fid
, 
_°©
 *
sbuf
)

589 
BY_HANDLE_FILE_INFORMATION
 
öfo
;

590 
size
;

591 
fh_t
 *
Â
;

593 
	`a_as£π
(0 <
fid
 && fid < 
fMax
);

594 
Â
 = 
f
[
fid
];

595 i‡(
Â
 =
NULL
 || fp->
h™d
 =
INVALID_HANDLE_VALUE
) {

599 
size
 = 
	`GëFûeSize
(
Â
->
h™d
, 
NULL
);

600 i‡(
size
 == 0xFFFFFFFF) {

603 
sbuf
->
°_size
 = (Ë
size
;

605 i‡(
	`GëFûeInf‹m©i⁄ByH™dÀ
(
Â
->
h™d
, &
öfo
)) {

606 i‡(
öfo
.
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_DIRECTORY
) {

607 
sbuf
->
°_mode
 = 
S_IFDIR
;

609 
sbuf
->
°_mode
 = 
S_IFREG
;

611 
sbuf
->
°_mtime
 = 
	`fûeTimeToUnixEpochTime
(
öfo
.
·La°WrôeTime
);

616 
	}
}

623 
	$_w°©
(
ch¨_t
 *
fûíame
, 
_°©
 *
sbuf
)

625 
DWORD
 
dwAâribuãs
;

626 
fid
, 
rc
;

628 
	`mem£t
(
sbuf
, 0, (
_°©
));

629 
dwAâribuãs
 = 
	`GëFûeAâribuãs
(
fûíame
);

630 i‡(
dwAâribuãs
 !0xFFFFFFFF && dwAâribuã†& 
FILE_ATTRIBUTE_DIRECTORY
) {

631 
sbuf
->
°_mode
 = 
S_IFDIR
;

634 
sbuf
->
°_mode
 = 
S_IFREG
;

636 i‡((
fid
 = 
	`_w›í
(
fûíame
, 0, 0)) < 0) {

640 
rc
 = 
	`f°©
(
fid
, 
sbuf
);

641 
	`˛o£
(
fid
);

643  
rc
;

644 
	}
}

651 
	$_wª«me
(c⁄° 
ch¨_t
 *
ﬁd«me
, c⁄° ch¨_à*
√w«me
)

653 
ch¨_t
 *
cwd
, *
cwdOld«me
, *
cwdNew«me
;

655 
cwdOld«me
 = 
cwd
 = 
NULL
;

656 i‡((*
ﬁd«me
 != '/') && (*oldname != '\\')) {

657 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

658 
	`ggëcwd
(
cwd
, 
LF_PATHSIZE
 / (
ch¨_t
));

659 
	`fmtAŒoc
(&
cwdOld«me
, 
LF_PATHSIZE
, 
	`T
("%s/%s"), 
cwd
, 
ﬁd«me
);

660 
ﬁd«me
 = 
cwdOld«me
;

663 
cwdNew«me
 = 
NULL
;

664 i‡((*
√w«me
 != '/') && (*newname != '\\')) {

665 i‡(
cwd
 !
NULL
) {

666 
cwd
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

667 
	`ggëcwd
(
cwd
, 
LF_PATHSIZE
 / (
ch¨_t
));

669 
	`fmtAŒoc
(&
cwdNew«me
, 
LF_PATHSIZE
, 
	`T
("%s/%s"), 
cwd
, 
√w«me
);

670 
√w«me
 = 
cwdNew«me
;

673 i‡(
	`MoveFûe
(
ﬁd«me
, 
√w«me
) == 0) {

674 
	`b‰ìSa„
(
B_L
, 
cwdOld«me
);

675 
	`b‰ìSa„
(
B_L
, 
cwdNew«me
);

676 
	`b‰ìSa„
(
B_L
, 
cwd
);

679 
	`b‰ìSa„
(
B_L
, 
cwdOld«me
);

680 
	`b‰ìSa„
(
B_L
, 
cwdNew«me
);

681 
	`b‰ìSa„
(
B_L
, 
cwd
);

684 
	}
}

691 
	$_wac˚ss
(c⁄° *
∑th
, 
mode
)

693 
fid
, 
omode
;

695 i‡(
mode
 =
R_OK
) {

696 
omode
 = 
O_RDONLY
;

697 } i‡(
mode
 =
W_OK
) {

698 
omode
 = 
O_RDWR
;

700 
	`a_as£π
(0);

702 i‡((
fid
 = 
	`_w›í
(
∑th
, 
omode
)) < 0) {

705 
	`˛o£
(
fid
);

707 
	}
}

715 
FILE
* 
	$fd›í
(
h™dÀ
, c⁄° *
mode
)

717  (
FILE
*Ë
h™dÀ
;

718 
	}
}

721 
	$f˛o£
(
FILE
 *
°ªam
)

723 
fh_t
 *
Â
;

724 
fid
;

726 
fid
 = 0; fid > 
fMax
; fid++) {

727 i‡((
Â
 = 
f
[
fid
]Ë!
NULL
) {

728 i‡(
Â
->
h™d
 =
°ªam
) {

729 
	`˛o£
(
fid
);

734  
EOF
;

735 
	}
}

737 
	$fÊush
(
FILE
* 
°ªam
)

740 
	}
}

747 
	$l£ek
(
h™dÀ
, 
off£t
, 
‹igö
)

749 
fh_t
 *
Â
;

751 
Â
 = 
f
[
h™dÀ
];

752  
	`SëFûePoöãr
(
Â
->
h™d
, 
off£t
, 
NULL
, 
‹igö
);

753 
	}
}

768 
	$isuµî
(
c
)

770 i‡(
c
 >= 'A' && c <= 'Z') {

774 
	}
}

781 
	$i¶owî
(
c
)

783 i‡(
c
 >= 'a' && c <= 'z') {

787 
	}
}

794 
	$isdigô
(
c
)

796 i‡(
c
 >= '0' && c <= '9') {

800 
	}
}

807 
	$is•a˚
(
c
)

809 i‡(
c
 >= 0x9 && c <= 0xd || c == 0x20) {

813 
	}
}

820 
	$i•röt
(
c
)

822 i‡(
c
 >= 0x20 && c <= 0x7e) {

826 
	}
}

833 
	$isxdigô
(
c
)

835 i‡((
c
 >= '0' && c <= '9') ||

836 (
c
 >= 'a' && c <= 'f') ||

837 (
c
 >= 'A' && c <= 'F')) {

841 
	}
}

846 #i‚de‡
LITTLEFOOT


847 
	$umask
(
mode
)

850 
	}
}

858 
	$w¥ötf
(c⁄° 
ch¨_t
 *
fmt
, ...)

861 
	}
}

865 
	$fw¥ötf
(
FILE
 *
°ªam
, c⁄° 
ch¨_t
 *
fmt
, ...)

868 
	}
}

870 
	$Âutws
(c⁄° 
ch¨_t
 *
fmt
, 
FILE
 *
°ªam
)

873 
	}
}

876 #i‚de‡
LITTLEFOOT


877 
	$_wexecvp
(
ch¨_t
 *
∑th
, ch¨_t** 
¨gv
)

880 
	}
}

888 
ch¨_t
 *
	$_wgëcwd
(
ch¨_t
 *
dú
, 
Àn
)

890 i‡(
Àn
 > 
LF_PATHSIZE
) {

891  
NULL
;

893  
	`wcs˝y
(
dú
, 
˚Cwd
);

895 
	}
}

902 
	$_wchdú
(*
∑th
)

904 
ch¨_t
 *
p
;

905 
ch¨_t
 
buf
[
LF_PATHSIZE
];

906 
Àn
;

907 
g°©_t
 
°©Dú
;

912 *
∑th
 == ' ') {

913 
∑th
++;

916 i‡(
∑th
 =
NULL
 || *path == '\0') {

918 } i‡((*
∑th
 == '/') || (*path == '\\')) {

919 
	`wcs˝y
(
˚Cwd
, 
∑th
);

927 
p
 = 
∑th
; *p;Ö++) {

928 i‡(*
p
 == '\\') {

929 *
p
 = '/';

933 
	`g°r˝y
(
buf
, 
˚Cwd
);

934 
p
 = 
buf
; *p;Ö++) {

935 i‡(*
p
 == '\\') {

936 *
p
 = '/';

940 i‡(*
∑th
 == '.' && *(path+1) == '/') {

941 
∑th
++;

942 *
∑th
 == '/') {

943 
∑th
++;

946 *
∑th
 == '.' && *(path+1) == '.') {

947 
∑th
 += 2;

948 i‡((
p
 = 
	`wc§chr
(
buf
, '/')Ë=
NULL
) {

951 *
p
 = '\0';

952 i‡(*
∑th
 == '\0') {

955 i‡(*
∑th
 != '/') {

958 *
∑th
 == '/') {

959 
∑th
++;

965 *
∑th
 == '.' || *path == ' ') {

966 
∑th
++;

972 
Àn
 = 
	`wc¶í
(
buf
);

973 i‡(*(
buf
 + 
Àn
 - 1) != '/') {

974 *(
buf
 + 
Àn
) = '/';

975 *(
buf
 + 
Àn
 + 1) = '\0';

976 
Àn
++;

978 i‡((
Àn
 + 
	`g°æí
(
∑th
Ë+ 1Ë> 
LF_PATHSIZE
 ) {

981 
	`g°r˝y
(
buf
+
Àn
, 
∑th
);

983 i‡(
	`_w°©
(
buf
, &
°©Dú
) == -1) {

986 
	`g°r˝y
(
˚Cwd
, 
buf
);

989 
	}
}

996 
	$_wchmod
(c⁄° 
ch¨_t
 *
fûíame
, 
pmode
)

999 
	}
}

	@CE/wincompat.h

8 #i‚de‡
_h_WINCOMPAT


9 
	#_h_WINCOMPAT
 1

	)

14 
	tFILE
;

16 
	#BUFSIZ
 1024

	)

17 
	#PATHSIZE
 1024

	)

22 
exô
(
°©us
);

23 
_wmkdú
(c⁄° *
∑th
);

24 * 
_wgëcwd
(*
dú
, 
Àn
);

26 
l£ek
(
h™dÀ
, 
off£t
, 
‹igö
);

27 
	#SEEK_CUR
 1

	)

28 
	#SEEK_END
 2

	)

29 
	#SEEK_SET
 0

	)

31 
	#EOF
 (-1)

	)

36 
	#O_RDONLY
 0x0

	)

37 
	#O_WRONLY
 0x1

	)

38 
	#O_RDWR
 0x2

	)

39 
	#O_ACCMODE
 0x3

	)

40 
	#O_NDELAY
 0x4

	)

41 
	#O_APPEND
 0x8

	)

42 
	#O_NONBLOCK
 0x10

	)

43 
	#O_BINARY
 0x20

	)

44 
	#O_CREAT
 0x40

	)

45 
	#O_TRUNC
 0x80

	)

46 
	#O_NOCTTY
 0x100

	)

48 
_w›í
(c⁄° * 
fûíame
, 
oÊag
, ...);

49 
ªad
(
h™dÀ
, * 
buf„r
, 
cou¡
);

50 
wrôe
(
h™dÀ
, c⁄° * 
buf„r
, 
cou¡
);

51 
˛o£
(
h™dÀ
);

52 
_wª«me
(c⁄° * 
ﬁd«me
, c⁄° * 
√w«me
);

53 
FILE
* 
fd›í
(
h™dÀ
, c⁄° * 
mode
);

58 
gë›t
(, * const *, const *);

63 #unde‡
u_l⁄g


64 #unde‡
u_sh‹t


66 
	tmode_t
;

67 
	tu_ch¨
;

68 
	tuöt
;

69 
	tuöt_t
;

70 
	tu_öt
;

71 
	tu_l⁄g
;

72 
	tul⁄g
;

73 
	tu_sh‹t
;

74 
	tush‹t
;

75 
	tunch¨
;

76 * 
	tˇddr_t
;

77 
	tpid_t
;

78 
	tuid_t
;

79 
	tgid_t
;

85 
_wu∆ök
(* 
fûíame
);

86 
_wª«me
(c⁄° * 
ﬁd«me
, c⁄° * 
√w«me
);

87 
_wac˚ss
(c⁄° * 
∑th
, 
mode
);

88 
_wchdú
(* 
∑th
);

89 
_wexecvp
(*
∑th
, ** 
¨gv
);

90 
umask
(
mode
);

95 
isuµî
(
c
);

96 
i¶owî
(
c
);

97 
isdigô
(
c
);

98 
is•a˚
(
c
);

99 
i•röt
(
c
);

100 
isxdigô
(
c
);

105 
	s_°©
 {

107 
	m°_size
;

108 
	m°_mode
;

111 
	m°_size
;

112 
	m°_mode
;

114 
time_t
 
	m°_©ime
;

115 
time_t
 
	m°_mtime
;

116 
time_t
 
	m°_˘ime
;

119 
	#S_IFREG
 0100000

	)

120 
	#S_IFDIR
 0040000

	)

122 
_w°©
(* 
∑th
, 
_°©
* 
buf„r
);

123 
f°©
(
fûíumbî
, 
_°©
* 
buf„r
);

129 
	#EINTR
 4

	)

130 
	#ENXIO
 6

	)

131 
	#EBADF
 9

	)

132 
	#EAGAIN
 11

	)

133 
	#EINVAL
 22

	)

135 
î∫o
;

140 
	stm


142 
	mtm_£c
;

143 
	mtm_mö
;

144 
	mtm_hour
;

145 
	mtm_mday
;

146 
	mtm_m⁄
;

147 
	mtm_yór
;

148 
	mtm_wday
;

149 
	mtm_yday
;

150 
	mtm_isd°
;

151 
	#LTZNMAX
 50

	)

152 
	mtm_tzadj
;

153 
	mtm_«me
[
LTZNMAX
];

157 * 
_w˘ime
(c⁄° 
time_t
* 
timî
);

158 
time_t
 
time
—ime_t* 
timî
);

159 
tm
 *
loˇ…ime
(c⁄° 
time_t
* 
timî
);

160 *
_was˘ime
(c⁄° 
tm
 *
timïå
);

165 
	stimeb
 {

167 
time_t
 
	mtime
;

168 
	mmûlôm
;

169 
	mtimez⁄e
;

170 
	md°Êag
;

173 
·ime
(
timeb
* 
ç
);

178 
«p
();

179 
¶ìp
(
£cs
);

180 
uid_t
 
gëeuid
();

182 
	#R_OK
 4

	)

183 
	#W_OK
 2

	)

184 
	#X_OK
 1

	)

185 
	#F_OK
 0

	)

187 * 
°rdup
(c⁄° *
s
);

	@ECOS/main.c

19 
	~"../uemf.h
"

20 
	~"../wsI¡∫.h
"

22 
	~<√tw‹k.h
>

29 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

30 
	gp‹t
 = 80;

31 
	gªåõs
 = 5;

32 
	gföished
;

36 
öôWebs
();

37 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

38 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

39 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

40 
¨g
, 
ch¨_t
* 
uæ
, ch¨_t* 
∑th
, ch¨_t* 
quîy
);

42 #ifde‡
B_STATS


43 #îr‹ 
WARNING
: 
B_STATS
 
dúe˘ive
 
is
 
nŸ
 
suµ‹ãd
 
ö
 
this
 
OS
!

51 
	$maö
(
¨gc
, ** 
¨gv
)

59 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

64 i‡(
	`öôWebs
() < 0) {

73 !
föished
) {

74 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 2000)) {

75 
	`sockëPro˚ss
(-1);

77 
	`emfSchedPro˚ss
();

83 
	`websClo£Sîvî
();

84 
	`sockëClo£
();

85 
	`b˛o£
();

87 
	}
}

94 
	$öôWebs
()

96 
ho°
[128];

97 *
˝
;

98 
ch¨_t
 
wbuf
[128];

104 
	`öô_Æl_√tw‹k_öãrÁ˚s
();

109 
	`sockëO≥n
();

114 
	`websSëDeÁu…Dú
("/www");

115 
˝
 = 
	`öë_¡ﬂ
(
ëh0_boŸp_d©a
.
bp_yüddr
);

116 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

117 
	`websSëI∑ddr
(
wbuf
);

118 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

119 
	`websSëHo°
(
wbuf
);

124 
	`websSëDeÁu…Page
(
	`T
("home.htm"));

125 
	`websSëPassw‹d
(
∑ssw‹d
);

131 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

138 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

139 
WEBS_HANDLER_FIRST
);

140 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

141 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

142 
WEBS_HANDLER_LAST
);

148 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

149 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

154 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

156 
	}
}

165 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

167 
ch¨_t
 *
«me
, *
addªss
;

169 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

170 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

174  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

175 
	}
}

183 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

185 
ch¨_t
 *
«me
, *
addªss
;

187 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

188 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

190 
	`websHódî
(
wp
);

191 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

192 
	`websFoŸî
(
wp
);

193 
	`websD⁄e
(
wp
, 200);

194 
	}
}

201 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

202 
¨g
, 
ch¨_t
* 
uæ
, ch¨_t* 
∑th
, ch¨_t* 
quîy
)

207 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

208 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

212 
	}
}

219 
	$£nd
(
s
, c⁄° *
buf
, 
size_t
 
Àn
, 
Êags
)

221  
	`wrôe
(
s
, 
buf
, 
Àn
);

222 
	}
}

224 
	$ªcv
(
s
, *
buf
, 
size_t
 
Àn
, 
Êags
)

226  
	`ªad
(
s
, 
buf
, 
Àn
);

227 
	}
}

	@LINUX/main.c

18 
	~"../uemf.h
"

19 
	~"../wsI¡∫.h
"

20 
	~<sig«l.h
>

21 
	~<uni°d.h
>

22 
	~<sys/ty≥s.h
>

24 #ifde‡
WEBS_SSL_SUPPORT


25 
	~"../websSSL.h
"

28 #ifde‡
USER_MANAGEMENT_SUPPORT


29 
	~"../um.h
"

30 
f‹mDeföeU£rMgmt
();

39 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

40 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

41 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

42 
	gp‹t
 = 
WEBS_DEFAULT_PORT
;

43 
	gªåõs
 = 5;

44 
	gföished
 = 0;

48 
öôWebs
(
demo
);

49 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

50 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

51 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

52 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

53 
sigötH™dÀr
();

54 #ifde‡
B_STATS


55 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

56 
memLóks
();

64 
	$maö
(
¨gc
, ** 
¨gv
)

66 
i
, 
demo
 = 0;

68 
i
 = 1; i < 
¨gc
; i++) {

69 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

70 
demo
++;

80 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

81 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

82 
	`sig«l
(
SIGINT
, 
sigötH™dÀr
);

83 
	`sig«l
(
SIGTERM
, 
sigötH™dÀr
);

88 i‡(
	`öôWebs
(
demo
) < 0) {

92 #ifde‡
WEBS_SSL_SUPPORT


93 
	`websSSLO≥n
();

102 
föished
 = 0;

103 !
föished
) {

104 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 1000)) {

105 
	`sockëPro˚ss
(-1);

107 
	`websCgiCÀ™up
();

108 
	`emfSchedPro˚ss
();

111 #ifde‡
WEBS_SSL_SUPPORT


112 
	`websSSLClo£
();

115 #ifde‡
USER_MANAGEMENT_SUPPORT


116 
	`umClo£
();

122 
	`websClo£Sîvî
();

123 
	`sockëClo£
();

124 #ifde‡
B_STATS


125 
	`memLóks
();

127 
	`b˛o£
();

129 
	}
}

134 
	$sigötH™dÀr
(
unu£d
)

136 
föished
 = 1;

137 
	}
}

144 
	$öôWebs
(
demo
)

146 
ho°ít
 *
hp
;

147 
ö_addr
 
öèddr
;

148 
ho°
[128], 
dú
[128], 
webdú
[128];

149 *
˝
;

150 
ch¨_t
 
wbuf
[128];

155 
	`sockëO≥n
();

157 #ifde‡
USER_MANAGEMENT_SUPPORT


161 
	`umO≥n
();

162 
	`umRe°‹e
(
	`T
("umconfig.txt"));

169 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

170 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

173 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

174 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

177 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

178 (
size_t
Ë
hp
->
h_Àngth
);

184 
	`gëcwd
(
dú
, (dir));

185 i‡((
˝
 = 
	`°ºchr
(
dú
, '/'))) {

186 *
˝
 = '\0';

188 i‡(
demo
) {

189 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
demoWeb
);

191 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
roŸWeb
);

197 
	`websSëDeÁu…Dú
(
webdú
);

198 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

199 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

200 
	`websSëI∑ddr
(
wbuf
);

201 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

202 
	`websSëHo°
(
wbuf
);

207 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

208 
	`websSëPassw‹d
(
∑ssw‹d
);

214 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

221 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

222 
WEBS_HANDLER_FIRST
);

223 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

224 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

225 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

226 
WEBS_HANDLER_LAST
);

232 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

233 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

238 #ifde‡
USER_MANAGEMENT_SUPPORT


239 
	`f‹mDeföeU£rMgmt
();

245 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

247 
	}
}

256 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

258 
ch¨_t
 *
«me
, *
addªss
;

260 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

261 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

264  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

265 
	}
}

273 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

275 
ch¨_t
 *
«me
, *
addªss
;

277 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

278 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

280 
	`websHódî
(
wp
);

281 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

282 
	`websFoŸî
(
wp
);

283 
	`websD⁄e
(
wp
, 200);

284 
	}
}

291 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

292 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

297 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

298 
	`websRedúe˘
(
wp
, 
WEBS_DEFAULT_HOME
);

302 
	}
}

306 #ifde‡
B_STATS


307 
	$memLóks
()

309 
fd
;

311 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 0666)) >= 0) {

312 
	`b°©s
(
fd
, 
¥ötMemSèts
);

313 
	`˛o£
(
fd
);

315 
	}
}

322 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

324 
va_li°
 
¨gs
;

325 
ch¨_t
 
buf
[256];

327 
	`va_°¨t
(
¨gs
, 
fmt
);

328 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

329 
	`va_íd
(
¨gs
);

330 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

331 
	}
}

	@LYNX/main.c

19 
	~"../uemf.h
"

20 
	~"../wsI¡∫.h
"

21 
	~<sig«l.h
>

22 
	~<uni°d.h
>

23 
	~<sys/ty≥s.h
>

25 #ifde‡
WEBS_SSL_SUPPORT


26 
	~"../websSSL.h
"

29 #ifde‡
USER_MANAGEMENT_SUPPORT


30 
	~"../um.h
"

31 
f‹mDeföeU£rMgmt
();

40 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

41 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

42 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

43 
	gp‹t
 = 80;

44 
	gªåõs
 = 5;

45 
	gföished
;

49 
öôWebs
(
demo
);

50 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

51 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

52 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

53 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

54 #ifde‡
B_STATS


55 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

56 
memLóks
();

64 
	$maö
(
¨gc
, **
¨gv
)

66 
i
, 
demo
 = 0;

68 
i
 = 1; i < 
¨gc
; i++) {

69 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

70 
demo
++;

80 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

81 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

86 i‡(
	`öôWebs
(
demo
) < 0) {

90 #ifde‡
WEBS_SSL_SUPPORT


91 
	`websSSLO≥n
();

99 !
föished
) {

100 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 1000)) {

101 
	`sockëPro˚ss
(-1);

103 
	`websCgiCÀ™up
();

104 
	`emfSchedPro˚ss
();

107 #ifde‡
WEBS_SSL_SUPPORT


108 
	`websSSLClo£
();

111 #ifde‡
USER_MANAGEMENT_SUPPORT


112 
	`umClo£
();

118 
	`websClo£Sîvî
();

119 
	`sockëClo£
();

120 #ifde‡
B_STATS


121 
	`memLóks
();

123 
	`b˛o£
();

125 
	}
}

132 
	$öôWebs
(
demo
)

134 
ho°ít
 *
hp
;

135 
ö_addr
 
öèddr
;

136 
ho°
[128], 
dú
[128], 
webdú
[128];

137 *
˝
;

138 
ch¨_t
 
wbuf
[128];

143 
	`sockëO≥n
();

145 #ifde‡
USER_MANAGEMENT_SUPPORT


149 
	`umO≥n
();

150 
	`umRe°‹e
(
	`T
("umconfig.txt"));

157 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

158 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

161 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

162 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

165 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

166 (
size_t
Ë
hp
->
h_Àngth
);

171 
	`gëcwd
(
dú
, (dir));

172 i‡((
˝
 = 
	`°ºchr
(
dú
, '/'))) {

173 *
˝
 = '\0';

175 i‡(
demo
) {

176 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
demoWeb
);

178 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
roŸWeb
);

184 
	`websSëDeÁu…Dú
(
webdú
);

185 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

186 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

187 
	`websSëI∑ddr
(
wbuf
);

188 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

189 
	`websSëHo°
(
wbuf
);

194 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

195 
	`websSëPassw‹d
(
∑ssw‹d
);

201 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

208 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

209 
WEBS_HANDLER_FIRST
);

210 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

211 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

212 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

213 
WEBS_HANDLER_LAST
);

219 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

220 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

225 #ifde‡
USER_MANAGEMENT_SUPPORT


226 
	`f‹mDeföeU£rMgmt
();

232 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

234 
	}
}

243 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

245 
ch¨_t
 *
«me
, *
addªss
;

247 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

248 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

251  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

252 
	}
}

259 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

261 
ch¨_t
 *
«me
, *
addªss
;

263 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

264 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

266 
	`websHódî
(
wp
);

267 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

268 
	`websFoŸî
(
wp
);

269 
	`websD⁄e
(
wp
, 200);

270 
	}
}

277 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

278 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

283 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

284 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

288 
	}
}

292 #ifde‡
B_STATS


293 
	$memLóks
()

295 
fd
;

297 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

298 
	`b°©s
(
fd
, 
¥ötMemSèts
);

299 
	`˛o£
(
fd
);

301 
	}
}

308 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

310 
va_li°
 
¨gs
;

311 
ch¨_t
 
buf
[256];

313 
	`va_°¨t
(
¨gs
, 
fmt
);

314 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

315 
	`va_íd
(
¨gs
);

316 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

317 
	}
}

	@MACOSX/main.c

19 
	~"../uemf.h
"

20 
	~"../wsI¡∫.h
"

21 
	~<sig«l.h
>

22 
	~<uni°d.h
>

23 
	~<sys/ty≥s.h
>

25 #ifde‡
WEBS_SSL_SUPPORT


26 
	~"../websSSL.h
"

29 #ifde‡
USER_MANAGEMENT_SUPPORT


30 
	~"../um.h
"

31 
f‹mDeföeU£rMgmt
();

36 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

37 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

38 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

39 
	gp‹t
 = 
WEBS_DEFAULT_PORT
;

41 
	gªåõs
 = 5;

42 
	gföished
 = 0;

46 
öôWebs
(
demo
);

47 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

48 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

49 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

50 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

51 
sigötH™dÀr
();

52 #ifde‡
B_STATS


53 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

54 
memLóks
();

62 
	$maö
(
¨gc
, ** 
¨gv
)

64 
i
, 
demo
 = 0;

66 
i
 = 1; i < 
¨gc
; i++) {

67 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

68 
demo
++;

78 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

79 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

80 
	`sig«l
(
SIGINT
, 
sigötH™dÀr
);

81 
	`sig«l
(
SIGTERM
, 
sigötH™dÀr
);

86 i‡(
	`öôWebs
(
demo
) < 0) {

90 #ifde‡
WEBS_SSL_SUPPORT


91 
	`websSSLO≥n
();

100 
föished
 = 0;

101 !
föished
) {

102 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 1000)) {

103 
	`sockëPro˚ss
(-1);

105 
	`websCgiCÀ™up
();

106 
	`emfSchedPro˚ss
();

109 #ifde‡
WEBS_SSL_SUPPORT


110 
	`websSSLClo£
();

113 #ifde‡
USER_MANAGEMENT_SUPPORT


114 
	`umClo£
();

120 
	`websClo£Sîvî
();

121 
	`sockëClo£
();

122 #ifde‡
B_STATS


123 
	`memLóks
();

125 
	`b˛o£
();

127 
	}
}

132 
	$sigötH™dÀr
(
unu£d
)

134 
föished
 = 1;

135 
	}
}

141 
	$öôWebs
(
demo
)

143 
ho°ít
 *
hp
;

144 
ö_addr
 
öèddr
;

145 
ho°
[128], 
dú
[128], 
webdú
[128];

146 *
˝
;

147 
ch¨_t
 
wbuf
[128];

152 
	`sockëO≥n
();

154 #ifde‡
USER_MANAGEMENT_SUPPORT


158 
	`umO≥n
();

159 
	`umRe°‹e
(
	`T
("umconfig.txt"));

166 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

167 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

170 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

171 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

174 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

175 (
size_t
Ë
hp
->
h_Àngth
);

181 
	`gëcwd
(
dú
, (dir));

182 i‡((
˝
 = 
	`°ºchr
(
dú
, '/'))) {

183 *
˝
 = '\0';

186 i‡(
demo
) {

187 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
demoWeb
);

189 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
roŸWeb
);

195 
	`websSëDeÁu…Dú
(
webdú
);

196 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

197 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

198 
	`websSëI∑ddr
(
wbuf
);

199 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

200 
	`websSëHo°
(
wbuf
);

205 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

206 
	`websSëPassw‹d
(
∑ssw‹d
);

212 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

219 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

220 
WEBS_HANDLER_FIRST
);

221 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

222 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

223 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

224 
WEBS_HANDLER_LAST
);

230 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

231 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

236 #ifde‡
USER_MANAGEMENT_SUPPORT


237 
	`f‹mDeföeU£rMgmt
();

243 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

245 
	}
}

254 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

256 
ch¨_t
 *
«me
, *
addªss
;

258 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

259 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

262  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

263 
	}
}

271 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

273 
ch¨_t
 *
«me
, *
addªss
;

275 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

276 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

278 
	`websHódî
(
wp
);

279 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

280 
	`websFoŸî
(
wp
);

281 
	`websD⁄e
(
wp
, 200);

282 
	}
}

289 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

290 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

295 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

296 
	`websRedúe˘
(
wp
, 
WEBS_DEFAULT_HOME
);

300 
	}
}

304 #ifde‡
B_STATS


305 
	$memLóks
()

307 
fd
;

309 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

310 
	`b°©s
(
fd
, 
¥ötMemSèts
);

311 
	`˛o£
(
fd
);

313 
	}
}

320 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

322 
va_li°
 
¨gs
;

323 
ch¨_t
 
buf
[256];

325 
	`va_°¨t
(
¨gs
, 
fmt
);

326 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

327 
	`va_íd
(
¨gs
);

328 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

329 
	}
}

	@NW/main.c

19 
	~"../uemf.h
"

20 
	~"../wsI¡∫.h
"

21 
	~<sig«l.h
>

22 
	~<sys/ty≥s.h
>

24 #ifde‡
WEBS_SSL_SUPPORT


25 
	~"../websSSL.h
"

28 #ifde‡
USER_MANAGEMENT_SUPPORT


29 
	~"../um.h
"

30 
f‹mDeföeU£rMgmt
();

39 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

40 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

41 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

42 
	gp‹t
 = 80;

43 
	gªåõs
 = 5;

44 
	gföished
;

51 #ifde‡
debug


52 
	#P
–
x
 ) 
	`¥ötf
–"\rWEBS: %d\n\r", x )

	)

53 
	#Ps
–
x
, 
s
 ) 
	`¥ötf
–"\rWEBS: %d [%s]\n\r", x, s )

	)

55 
	#P
–
x
 )

	)

56 
	#Ps
–
x
, 
s
 )

	)

59 
	gNETDB_DEFINE_CONTEXT
 ;

60 
	gNETINET_DEFINE_CONTEXT
 ;

64 
NLM˛ónup
( ) ;

65 
öôWebs
(
demo
);

66 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

67 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

68 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

69 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

71 #ifde‡
B_STATS


72 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

73 
memLóks
();

76 
SigTîmSig«lH™dÀr
–
sigty≥
 );

77 
NLM˛ónup
( );

84 
	$maö
(
¨gc
, ** 
¨gv
)

86 
i
, 
demo
 = 0;

88 
i
 = 1; i < 
¨gc
; i++) {

89 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

90 
demo
++;

97 
	`sig«l
–
SIGTERM
, 
SigTîmSig«lH™dÀr
 ) ;

105 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

107 
	`P
( 1 ) ;

113 
	`SëCuºítNameS∑˚
( 4 ) ;

118 i‡(
	`öôWebs
(
demo
) < 0) {

122 #ifde‡
WEBS_SSL_SUPPORT


123 
	`websSSLO≥n
();

126 
	`P
( 20 ) ;

133 !
föished
) {

134 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 1000)) {

135 
	`sockëPro˚ss
(-1);

136 
	`ThªadSwôch
() ;

138 
	`websCgiCÀ™up
();

139 
	`emfSchedPro˚ss
();

142 
	`NLM˛ónup
() ;

145 
	}
}

152 
	$öôWebs
(
demo
)

154 
ho°ít
 *
hp
;

155 
ö_addr
 
öèddr
;

156 
ho°
[128], 
dú
[128], 
webdú
[128];

157 *
˝
;

158 
ch¨_t
 
wbuf
[128];

159 
ch¨_t
 *
ùaddr
;

161 
	`P
( 2 ) ;

165 
	`sockëO≥n
();

167 
	`P
( 3 ) ;

169 #ifde‡
USER_MANAGEMENT_SUPPORT


173 
	`umO≥n
();

174 
	`umRe°‹e
(
	`T
("umconfig.txt"));

181 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

182 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

186 
	`P
( 4 ) ;

188 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

189 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

193 
	`P
( 5 ) ;

195 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

196 (
size_t
Ë
hp
->
h_Àngth
);

202 
	`gëcwd
(
dú
, (dir));

203 
	`Ps
–6, 
dú
 ) ;

204 i‡((
˝
 = 
	`°ºchr
(
dú
, '/')))

205 
˝
 ++ ;

207 
˝
 = 
dú
 ;

209 
	`Ps
–6, 
˝
 ) ;

211 i‡(
demo
) {

212 
	`•rötf
(
webdú
, "%s/%s", 
˝
, 
demoWeb
);

214 
	`•rötf
(
webdú
, "%s/%s", 
˝
, 
roŸWeb
);

217 
	`Ps
–6, 
webdú
 ) ;

222 
	`websSëDeÁu…Dú
(
webdú
);

223 
ùaddr
 = 
	`öë_¡ﬂ
(
öèddr
);

224 
	`ascToUni
(
wbuf
, 
ùaddr
, 
	`g°æí
(ipaddr) + 1);

225 
	`websSëI∑ddr
(
wbuf
);

226 
	`ascToUni
(
wbuf
, 
ho°
, 
	`g°æí
(host) + 1);

227 
	`websSëHo°
(
wbuf
);

229 
	`P
( 7 ) ;

234 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

235 
	`websSëPassw‹d
(
∑ssw‹d
);

237 
	`P
( 8 ) ;

243 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

245 
	`P
( 9 ) ;

252 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

253 
WEBS_HANDLER_FIRST
);

254 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

255 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

256 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

257 
WEBS_HANDLER_LAST
);

259 
	`P
( 10 ) ;

265 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

266 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

268 
	`P
( 11 ) ;

273 #ifde‡
USER_MANAGEMENT_SUPPORT


274 
	`f‹mDeföeU£rMgmt
();

280 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

282 
	`P
( 12 ) ;

285 
	}
}

292 
	$NLM˛ónup
( )

294 
	`P
( 23 ) ;

296 #ifde‡
WEBS_SSL_SUPPORT


297 
	`websSSLClo£
();

300 #ifde‡
USER_MANAGEMENT_SUPPORT


301 
	`umClo£
();

307 
	`websClo£Sîvî
();

309 
	`P
( 24 ) ;

311 
	`sockëClo£
();

312 #ifde‡
B_STATS


313 
	`memLóks
();

315 
	`P
( 25 ) ;

317 
	`b˛o£
();

319 
	`P
( 26 ) ;

320 
	}
}

328 #¥agm®
off
(
uƒe„ªn˚d
)

329 
	$SigTîmSig«lH™dÀr
–
sigty≥
 )

330 #¥agm®
	`⁄
(
uƒe„ªn˚d
)

332 
föished
 ++ ;

333 
	`NLM˛ónup
() ;

334 
	}
}

343 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

345 
ch¨_t
 *
«me
, *
addªss
;

347 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

348 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

351  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

352 
	}
}

360 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

362 
ch¨_t
 *
«me
, *
addªss
;

364 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

365 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

367 
	`websHódî
(
wp
);

368 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

369 
	`websFoŸî
(
wp
);

370 
	`websD⁄e
(
wp
, 200);

371 
	}
}

378 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

379 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

384 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

385 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

389 
	}
}

393 #ifde‡
B_STATS


394 
	$memLóks
()

396 
fd
;

398 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

399 
	`b°©s
(
fd
, 
¥ötMemSèts
);

400 
	`˛o£
(
fd
);

402 
	}
}

409 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

411 
va_li°
 
¨gs
;

412 
ch¨_t
 
buf
[256];

414 
	`va_°¨t
(
¨gs
, 
fmt
);

415 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

416 
	`va_íd
(
¨gs
);

417 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

418 
	}
}

	@QNX4/main.c

23 
	~"../uemf.h
"

24 
	~"../wsI¡∫.h
"

25 
	~<sig«l.h
>

27 #ifde‡
WEBS_SSL_SUPPORT


28 
	~"../websSSL.h
"

31 #ifde‡
USER_MANAGEMENT_SUPPORT


32 
	~"../um.h
"

33 
f‹mDeföeU£rMgmt
();

41 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

42 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

43 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

44 
	gp‹t
 = 80;

45 
	gªåõs
 = 5;

46 
	gföished
;

50 
öôWebs
(
demo
);

51 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

52 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

53 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

54 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

55 #ifde‡
B_STATS


56 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

57 
memLóks
();

65 
	$maö
(
¨gc
, **
¨gv
)

67 
i
, 
demo
 = 0;

69 
i
 = 1; i < 
¨gc
; i++) {

70 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

71 
demo
++;

81 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

82 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

87 i‡(
	`öôWebs
(
demo
) < 0) {

91 #ifde‡
WEBS_SSL_SUPPORT


92 
	`websSSLO≥n
();

100 !
föished
) {

101 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 1000)) {

102 
	`sockëPro˚ss
(-1);

104 
	`websCgiCÀ™up
();

105 
	`emfSchedPro˚ss
();

108 #ifde‡
WEBS_SSL_SUPPORT


109 
	`websSSLClo£
();

112 #ifde‡
USER_MANAGEMENT_SUPPORT


113 
	`umClo£
();

119 
	`websClo£Sîvî
();

120 
	`sockëClo£
();

121 #ifde‡
B_STATS


122 
	`memLóks
();

124 
	`b˛o£
();

126 
	}
}

133 
	$öôWebs
(
demo
)

135 
ho°ít
 *
hp
;

136 
ö_addr
 
öèddr
;

137 
ho°
[128], 
dú
[128], 
webdú
[128];

138 *
˝
;

139 
ch¨_t
 
wbuf
[128];

144 
	`sockëO≥n
();

146 #ifde‡
USER_MANAGEMENT_SUPPORT


150 
	`umO≥n
();

151 
	`umRe°‹e
(
	`T
("umconfig.txt"));

158 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

159 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

162 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

163 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

166 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

167 (
size_t
Ë
hp
->
h_Àngth
);

172 
	`gëcwd
(
dú
, (dir));

173 i‡((
˝
 = 
	`°ºchr
(
dú
, '/'))) {

174 *
˝
 = '\0';

176 i‡(
demo
) {

177 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
demoWeb
);

179 
	`•rötf
(
webdú
, "%s/%s", 
dú
, 
roŸWeb
);

185 
	`websSëDeÁu…Dú
(
webdú
);

186 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

187 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

188 
	`websSëI∑ddr
(
wbuf
);

189 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

190 
	`websSëHo°
(
wbuf
);

195 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

196 
	`websSëPassw‹d
(
∑ssw‹d
);

202 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

209 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

210 
WEBS_HANDLER_FIRST
);

211 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

212 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

213 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

214 
WEBS_HANDLER_LAST
);

220 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

221 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

226 #ifde‡
USER_MANAGEMENT_SUPPORT


227 
	`f‹mDeföeU£rMgmt
();

233 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

235 
	}
}

244 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

246 
ch¨_t
 *
«me
, *
addªss
;

248 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

249 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

252  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

253 
	}
}

260 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

262 
ch¨_t
 *
«me
, *
addªss
;

264 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

265 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

267 
	`websHódî
(
wp
);

268 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

269 
	`websFoŸî
(
wp
);

270 
	`websD⁄e
(
wp
, 200);

271 
	}
}

278 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

279 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

284 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

285 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

289 
	}
}

293 #ifde‡
B_STATS


294 
	$memLóks
()

296 
fd
;

298 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

299 
	`b°©s
(
fd
, 
¥ötMemSèts
);

300 
	`˛o£
(
fd
);

302 
	}
}

309 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

311 
va_li°
 
¨gs
;

312 
ch¨_t
 
buf
[256];

314 
	`va_°¨t
(
¨gs
, 
fmt
);

315 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

316 
	`va_íd
(
¨gs
);

317 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

318 
	}
}

	@VXWORKS/main.c

19 
	~<ívLib.h
>

20 
	~<ho°Lib.h
>

21 
	~<iosLib.h
>

22 
	~<lﬂdLib.h
>

23 
	~<sigLib.h
>

24 
	~<sysSymTbl.h
>

25 
	~<u∆dLib.h
>

27 
	~"../uemf.h
"

28 
	~"../wsI¡∫.h
"

30 #ifde‡
WEBS_SSL_SUPPORT


31 
	~"../websSSL.h
"

34 #ifde‡
USER_MANAGEMENT_SUPPORT


35 
	~"../um.h
"

36 
f‹mDeföeU£rMgmt
();

43 
	#ROOT_DIR
 
	`T
("/©a0/webs")

	)

45 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

46 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

47 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

48 
	gp‹t
 = 80;

49 
	gªåõs
 = 5;

50 
	gföished
;

54 
öôWebs
(
demo
);

55 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

56 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

57 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

58 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

59 
websTîmSigH™dÀr
(
signo
);

60 #ifde‡
B_STATS


61 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

62 
memLóks
();

70 
	$websvxmaö
(
¨gc
, **
¨gv
)

72 
i
, 
demo
 = 0;

74 
i
 = 1; i < 
¨gc
; i++) {

75 i‡(
	`°rcmp
(
¨gv
[
i
], "-demo") == 0) {

76 
demo
++;

86 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

91 
föished
 = 0;

92 i‡(
	`öôWebs
(
demo
) < 0) {

96 #ifde‡
WEBS_SSL_SUPPORT


97 
	`websSSLO≥n
();

105 !
föished
) {

106 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 2000)) {

107 
	`sockëPro˚ss
(-1);

109 
	`websCgiCÀ™up
();

110 
	`emfSchedPro˚ss
();

113 #ifde‡
WEBS_SSL_SUPPORT


114 
	`websSSLClo£
();

117 #ifde‡
USER_MANAGEMENT_SUPPORT


118 
	`umClo£
();

124 
	`websClo£Sîvî
();

125 
	`sockëClo£
();

126 
	`symSubClo£
();

127 #ifde‡
B_STATS


128 
	`memLóks
();

130 
	`b˛o£
();

132 
	}
}

139 
	$öôWebs
(
demo
)

141 
ö_addr
 
öèddr
;

142 *
pSåög
;

143 
ho°
[64], 
webdú
[128];

144 
ch¨_t
 
wbuf
[128];

149 
	`sockëO≥n
();

150 
	`symSubO≥n
();

152 #ifde‡
USER_MANAGEMENT_SUPPORT


156 
	`umO≥n
();

157 
	`umRe°‹e
(
	`T
("umconfig.txt"));

164 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

165 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

168 
öèddr
.
s_addr
 = (Ë
	`ho°GëByName
(
ho°
);

174 i‡(
demo
) {

175 
	`•rötf
(
webdú
, "%s/%s", 
ROOT_DIR
, 
demoWeb
);

177 
	`•rötf
(
webdú
, "%s/%s", 
ROOT_DIR
, 
roŸWeb
);

183 
	`websSëDeÁu…Dú
(
webdú
);

184 
pSåög
 = 
	`öë_¡ﬂ
(
öèddr
);

185 
	`ascToUni
(
wbuf
, 
pSåög
, 
	`mö
(
	`°æí
(pString) + 1, (wbuf)));

186 
	`‰ì
(
pSåög
);

187 
	`websSëI∑ddr
(
wbuf
);

188 
	`ascToUni
(
wbuf
, 
ho°
, 
	`mö
(
	`°æí
(host) + 1, (wbuf)));

189 
	`websSëHo°
(
wbuf
);

194 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

195 
	`websSëPassw‹d
(
∑ssw‹d
);

201 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

208 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

209 
WEBS_HANDLER_FIRST
);

210 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

211 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

212 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

213 
WEBS_HANDLER_LAST
);

219 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

220 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

225 #ifde‡
USER_MANAGEMENT_SUPPORT


226 
	`f‹mDeföeU£rMgmt
();

232 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

237 
	`sig«l
(
SIGTERM
, 
websTîmSigH™dÀr
);

238 
	`sig«l
(
SIGKILL
, 
websTîmSigH™dÀr
);

241 
	}
}

250 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

252 
ch¨_t
 *
«me
, *
addªss
;

254 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

255 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

258  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

259 
	}
}

266 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

268 
ch¨_t
 *
«me
, *
addªss
;

270 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

271 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

273 
	`websHódî
(
wp
);

274 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

275 
	`websFoŸî
(
wp
);

276 
	`websD⁄e
(
wp
, 200);

277 
	}
}

284 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

285 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

290 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

291 
	`websRedúe˘
(
wp
, 
	`T
("home.asp"));

295 
	}
}

305 
	$websTîmSigH™dÀr
(
signo
)

307 i‡(
signo
 =
SIGTERM
) {

308 
föished
 = 1;

309 } i‡(
signo
 =
SIGKILL
) {

310 #ifde‡
WEBS_SSL_SUPPORT


311 
	`websSSLClo£
();

314 #ifde‡
USER_MANAGEMENT_SUPPORT


315 
	`umClo£
();

317 
	`websClo£Sîvî
();

318 
	`sockëClo£
();

319 
	`symSubClo£
();

320 #ifde‡
B_STATS


321 
	`memLóks
();

323 
	`b˛o£
();

324 
	`exô
(1);

326 
	}
}

336 
ch¨_t
 *
	$gëAbsﬁuãP©h
(
ch¨_t
 *
∑th
)

338 
ch¨_t
 *
èû
;

339 
ch¨_t
 *
dev
;

347 i‡(
	`iosDevFöd
(
∑th
, &
èû
Ë!
NULL
 &&Öath !=Åail) {

348  
	`b°rdup
(
B_L
, 
∑th
);

350 
dev
 = 
	`bÆloc
(
B_L
, 
LF_PATHSIZE
);

351 
	`gëcwd
(
dev
, 
LF_PATHSIZE
);

352 
	`°rˇt
(
dev
, "/");

353 
	`°rˇt
(
dev
, 
∑th
);

354  
dev
;

355 
	}
}

362 
	$vxchdú
(
ch¨_t
 *
dú«me
)

364 
rc
;

365 
ch¨_t
 *
∑th
;

370 
∑th
 = 
	`gëAbsﬁuãP©h
(
dú«me
);

377 
rc
 = 
	`chdú
(
∑th
);

378 
	`b‰ì
(
B_L
, 
∑th
);

379  
rc
;

380 
	}
}

383 #ifde‡
B_STATS


384 
	$memLóks
()

386 
fd
;

388 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 0644)) >= 0) {

389 
	`b°©s
(
fd
, 
¥ötMemSèts
);

390 
	`˛o£
(
fd
);

392 
	}
}

399 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

401 
va_li°
 
¨gs
;

402 
ch¨_t
 
buf
[256];

404 
	`va_°¨t
(
¨gs
, 
fmt
);

405 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

406 
	`va_íd
(
¨gs
);

407 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

408 
	}
}

	@VXWORKS/vxcgitst.c

1 
	~<ívLib.h
>

2 
	~<°dio.h
>

4 
	$vxcgô°_cgõ¡ry
(
¨gc
, **
¨gv
)

6 
	`¥ötf
("\r\n");

7 
	`ívShow
(
NULL
);

8 
	}
}

	@WIN/main.c

19 
	~<dúe˘.h
>

20 
	~<wödows.h
>

21 
	~<wöu£r.h
>

22 
	~<¥o˚ss.h
>

24 
	~"../wsI¡∫.h
"

26 #ifde‡
WEBS_SSL_SUPPORT


27 
	~"../websSSL.h
"

30 #ifde‡
USER_MANAGEMENT_SUPPORT


31 
	~"../um.h
"

32 
f‹mDeföeU£rMgmt
();

41 
	#IDM_ABOUTBOX
 0xF200

	)

42 
	#IDS_ABOUTBOX
 "AboutBox"

	)

43 
	#IDC_VERSION
 101

	)

44 
	#IDC_BUILDDATE
 102

	)

45 
	#IDC_DISMISS
 103

	)

46 
	#SOCK_DFT_SVC_TIME
 20

	)

52 
ch¨_t
 *
	groŸWeb
 = 
T
("www");

53 
ch¨_t
 *
	gdemoWeb
 = 
T
("wwwdemo");

54 
ch¨_t
 *
	g∑ssw‹d
 = 
T
("");

57 
	gp‹t
 = 
WEBS_DEFAULT_PORT
;

58 
ch¨_t
 *
	gtôÀ
 = 
T
("GoAhead WebServer");

59 
ch¨_t
 *
	g«me
 = 
T
("gowebs");

60 
HWND
 
	ghwnd
;

61 
HWND
 
	ghwndAbout
;

62 
	gªåõs
 = 5;

63 
	gföished
;

64 
	gsockSîvi˚Time
;

68 
öôWebs
(
demo
);

69 
CALLBACK
 
websWödProc
(
HWND
 
hwnd
, 
msg
,

70 
wp
, 
Õ
);

71 
CALLBACK
 
websAboutProc
(
HWND
 
hwnd
, 
msg
,

72 
wp
, 
Õ
);

73 
ªgi°îAboutBox
(
HINSTANCE
 
hIn°™˚
);

74 
¸óãAboutBox
(
HINSTANCE
 
hIn°™˚
, 
HWND
 
hwnd
);

75 
a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

76 
WPARAM
 
checkWödowsMsgLo›
();

77 
f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

78 
wödowsInô
(
HINSTANCE
 
hö°™˚
);

79 
wödowsClo£
(
HINSTANCE
 
hö°™˚
);

80 
websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

81 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

82 
ch¨_t
 *
quîy
);

83 
¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

84 
memLóks
();

86 
LPWORD
 
ÕwAlign
(LPWORD);

87 
nC›yAnsiToWideCh¨
(
LPWORD
, 
LPSTR
);

88 
˚¡îWödowOnDi•œy
(
HWND
 
hwndCíãr
);

94 
APIENTRY
 
	$WöMaö
(
HINSTANCE
 
hö°™˚
, HINSTANCE 
h¥evö°™˚
,

95 *
¨gs
, 
cmd_show
)

97 
WPARAM
 
rc
;

98 #ifde‡
USE_DEMO_MODE


99 
demo
 = 1;

101 
demo
 = 0;

110 
	`b›í
(
NULL
, (60 * 1024), 
B_USE_MALLOC
);

116 i‡(
	`wödowsInô
(
hö°™˚
) < 0) {

117  
FALSE
;

123 i‡(
	`öôWebs
(
demo
) < 0) {

124  
FALSE
;

127 #ifde‡
WEBS_SSL_SUPPORT


128 
	`websSSLO≥n
();

137 !
föished
) {

138 i‡(
	`sockëRódy
(-1Ë|| 
	`sockëSñe˘
(-1, 
sockSîvi˚Time
)) {

139 
	`sockëPro˚ss
(-1);

141 
	`emfSchedPro˚ss
();

142 
	`websCgiCÀ™up
();

143 i‡((
rc
 = 
	`checkWödowsMsgLo›
()) != 0) {

148 #ifde‡
WEBS_SSL_SUPPORT


149 
	`websSSLClo£
();

155 #ifde‡
USER_MANAGEMENT_SUPPORT


156 
	`umClo£
();

162 
	`websClo£Sîvî
();

163 
	`sockëClo£
();

168 
	`wödowsClo£
(
hö°™˚
);

170 #ifde‡
B_STATS


171 
	`memLóks
();

173 
	`b˛o£
();

174  
rc
;

175 
	}
}

182 
	$öôWebs
(
demo
)

184 
ho°ít
 *
hp
;

185 
ö_addr
 
öèddr
;

186 *
˝
;

187 
ho°
[64], 
dú
[128];

188 
ch¨_t
 
dú_t
[128];

189 
ch¨_t
 
wbuf
[256];

194 
	`sockëO≥n
();

199 #ifde‡
USER_MANAGEMENT_SUPPORT


200 
	`umO≥n
();

201 
	`umRe°‹e
(
	`T
("umconfig.txt"));

208 i‡(
	`gëho°«me
(
ho°
, (host)) < 0) {

209 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostname"));

212 i‡((
hp
 = 
	`gëho°by«me
(
ho°
)Ë=
NULL
) {

213 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Can't get hostáddress"));

216 
	`mem˝y
((*Ë&
öèddr
, (*Ë
hp
->
h_addr_li°
[0],

217 (
size_t
Ë
hp
->
h_Àngth
);

222 
	`gëcwd
(
dú
, (dir));

223 
˝
 = 
dú
; *cp; cp++) {

224 i‡(*
˝
 == '\\')

225 *
˝
 = '/';

227 i‡(
˝
 = 
	`°ºchr
(
dú
, '/')) {

228 *
˝
 = '\0';

230 
	`ascToUni
(
dú_t
, 
dú
, (dir_t));

232 i‡(
demo
) {

233 
	`g•rötf
(
wbuf
, 
	`T
("%s/%s"), 
dú_t
, 
demoWeb
);

235 
	`g•rötf
(
wbuf
, 
	`T
("%s/%s"), 
dú_t
, 
roŸWeb
);

237 
	`websSëDeÁu…Dú
(
wbuf
);

238 
˝
 = 
	`öë_¡ﬂ
(
öèddr
);

239 
	`ascToUni
(
wbuf
, 
˝
, 
	`mö
(
	`°æí
(cp) + 1, (wbuf)));

240 
	`websSëI∑ddr
(
wbuf
);

241 
	`ascToUni
(
wbuf
, 
hp
->
h_«me
, 
	`mö
(
	`°æí
(hp->h_name) + 1, (wbuf)));

242 
	`websSëHo°
(
wbuf
);

247 
	`websSëDeÁu…Page
(
	`T
("default.asp"));

248 
	`websSëPassw‹d
(
∑ssw‹d
);

254 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

261 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websSecurôyH™dÀr
,

262 
WEBS_HANDLER_FIRST
);

263 
	`websUæH™dÀrDeföe
(
	`T
("/gof‹m"), 
NULL
, 0, 
websF‹mH™dÀr
, 0);

264 
	`websUæH™dÀrDeföe
(
	`T
("/cgi-bö"), 
NULL
, 0, 
websCgiH™dÀr
, 0);

265 
	`websUæH™dÀrDeföe
(
	`T
(""), 
NULL
, 0, 
websDeÁu…H™dÀr
,

266 
WEBS_HANDLER_LAST
);

272 
	`websA•Deföe
(
	`T
("a•Te°"), 
a•Te°
);

273 
	`websF‹mDeföe
(
	`T
("f‹mTe°"), 
f‹mTe°
);

277 #ifde‡
USER_MANAGEMENT_SUPPORT


278 
	`f‹mDeföeU£rMgmt
();

284 
	`websUæH™dÀrDeföe
(
	`T
("/"), 
NULL
, 0, 
websHomePageH™dÀr
, 0);

289 
sockSîvi˚Time
 = 
SOCK_DFT_SVC_TIME
;

292 
	}
}

300 
	$wödowsInô
(
HINSTANCE
 
hö°™˚
)

302 
WNDCLASS
 
wc
;

303 
HMENU
 
hSysMíu
;

305 
	`emfIn°Së
((Ë
hö°™˚
);

307 
wc
.
°yÀ
 = 
CS_HREDRAW
 | 
CS_VREDRAW
;

308 
wc
.
hbrBackground
 = (
HBRUSH
)(
COLOR_WINDOW
+1);

309 
wc
.
hCurs‹
 = 
	`LﬂdCurs‹
(
NULL
, 
IDC_ARROW
);

310 
wc
.
cbClsExåa
 = 0;

311 
wc
.
cbWndExåa
 = 0;

312 
wc
.
hIn°™˚
 = 
hö°™˚
;

313 
wc
.
hIc⁄
 = 
NULL
;

314 
wc
.
Õ‚WndProc
 = (
WNDPROC
Ë
websWödProc
;

315 
wc
.
ÕszMíuName
 = wc.
ÕszCœssName
 = 
«me
;

316 i‡(! 
	`Regi°îCœss
(&
wc
)) {

323 
hwnd
 = 
	`Cª©eWödow
(
«me
, 
tôÀ
, 
WS_MINIMIZE
 | 
WS_POPUPWINDOW
,

324 
CW_USEDEFAULT
, 0, 0, 0, 
NULL
, NULL, 
hö°™˚
, NULL);

325 i‡(
hwnd
 =
NULL
) {

333 
hSysMíu
 = 
	`GëSy°emMíu
(
hwnd
, 
FALSE
);

334 i‡(
hSysMíu
 !
NULL
)

336 
	`AµídMíu
(
hSysMíu
, 
MF_SEPARATOR
, 0, 
NULL
);

337 
	`AµídMíu
(
hSysMíu
, 
MF_STRING
, 
IDM_ABOUTBOX
, 
	`T
("About WebServer"));

340 
	`ShowWödow
(
hwnd
, 
SW_SHOWNORMAL
);

341 
	`Upd©eWödow
(
hwnd
);

343 
hwndAbout
 = 
NULL
;

345 
	}
}

352 
	$wödowsClo£
(
HINSTANCE
 
hIn°™˚
)

354 
nRëu∫
;

356 
nRëu∫
 = 
	`Uƒegi°îCœss
(
«me
, 
hIn°™˚
);

358 i‡(
hwndAbout
) {

359 
	`De°royWödow
(
hwndAbout
);

362  
nRëu∫
;

363 
	}
}

370 
CALLBACK
 
	$websWödProc
(
HWND
 
hwnd
, 
msg
,

371 
wp
, 
Õ
)

373 
msg
) {

374 
WM_DESTROY
:

375 
	`Po°QuôMesßge
(0);

376 
föished
++;

379 
WM_SYSCOMMAND
:

380 i‡(
wp
 =
IDM_ABOUTBOX
) {

381 i‡(!
hwndAbout
) {

382 
	`¸óãAboutBox
((
HINSTANCE
Ë
	`emfIn°Gë
(), 
hwnd
);

384 i‡(
hwndAbout
) {

385 
	`ShowWödow
(
hwndAbout
, 
SW_SHOWNORMAL
);

391  
	`DefWödowProc
(
hwnd
, 
msg
, 
wp
, 
Õ
);

392 
	}
}

399 
WPARAM
 
	$checkWödowsMsgLo›
()

401 
MSG
 
msg
;

403 i‡(
	`PìkMesßge
(&
msg
, 
NULL
, 0, 0, 
PM_NOREMOVE
)) {

404 i‡(!
	`GëMesßge
(&
msg
, 
NULL
, 0, 0Ë|| msg.
mesßge
 =
WM_QUIT
) {

405  
msg
.
wP¨am
;

408 
	`Tøn¶©eMesßge
(&
msg
);

409 
	`Di•©chMesßge
(&
msg
);

413 
	}
}

420 
CALLBACK
 
	$websAboutProc
(
HWND
 
hwndDlg
, 
msg
,

421 
wp
, 
Õ
)

423 
lResu…
;

424 
HWND
 
hwnd
;

426 
lResu…
 = 
	`DefWödowProc
(
hwndDlg
, 
msg
, 
wp
, 
Õ
);

428 
msg
) {

429 
WM_CREATE
:

430 
hwndAbout
 = 
hwndDlg
;

433 
WM_DESTROY
:

434 
hwndAbout
 = 
NULL
;

437 
WM_COMMAND
:

438 i‡(
wp
 =
IDOK
) {

439 
	`EndDülog
(
hwndDlg
, 0);

440 
	`Po°Mesßge
(
hwndDlg
, 
WM_CLOSE
, 0, 0);

444 
WM_INITDIALOG
:

448 
hwnd
 = 
	`GëDlgIãm
(
hwndDlg
, 
IDC_VERSION
);

449 i‡(
hwnd
) {

450 
	`SëWödowText
(
hwnd
, 
WEBS_VERSION
);

453 
hwnd
 = 
	`GëDlgIãm
(
hwndDlg
, 
IDC_BUILDDATE
);

454 i‡(
hwnd
) {

455 
	`SëWödowText
(
hwnd
, 
__DATE__
);

458 
	`SëWödowText
(
hwndDlg
, 
	`T
("GoAhead WebServer"));

459 
	`˚¡îWödowOnDi•œy
(
hwndDlg
);

461 
hwndAbout
 = 
hwndDlg
;

463 
lResu…
 = 
FALSE
;

467  
lResu…
;

468 
	}
}

475 
	$ªgi°îAboutBox
(
HINSTANCE
 
hIn°™˚
)

477 
WNDCLASS
 
wc
;

479 
wc
.
°yÀ
 = 0;

480 
wc
.
Õ‚WndProc
 = (
WNDPROC
)
websAboutProc
;

482 
wc
.
cbClsExåa
 = 0;

483 
wc
.
cbWndExåa
 = 0;

484 
wc
.
hIn°™˚
 = hInstance;

485 
wc
.
hIc⁄
 = 
NULL
;

486 
wc
.
hCurs‹
 = 
	`LﬂdCurs‹
(
NULL
, 
IDC_ARROW
);

487 
wc
.
hbrBackground
 = 
	`GëStockObje˘
(
LTGRAY_BRUSH
);

488 
wc
.
ÕszMíuName
 = 
NULL
;

489 
wc
.
ÕszCœssName
 = 
IDS_ABOUTBOX
;

491 i‡(!
	`Regi°îCœss
(&
wc
)) {

496 
	}
}

504 
LPWORD
 
	$ÕwAlign
(
LPWORD
 
ÕIn
)

506 
ULONG
 
ul
;

508 
ul
 = (
ULONG
Ë
ÕIn
;

509 
ul
 +=3;

510 
ul
 >>=2;

511 
ul
 <<=2;

512  (
LPWORD
Ë
ul
;

513 
	}
}

523 
	$nC›yAnsiToWideCh¨
(
LPWORD
 
ÕWCSå
, 
LPSTR
 
ÕAnsiIn
)

525 
cchAnsi
 = 
	`l°æí
(
ÕAnsiIn
);

527  
	`Mu…iByãToWideCh¨
(
	`GëACP
(),

528 
MB_PRECOMPOSED
, 
ÕAnsiIn
, 
cchAnsi
, 
ÕWCSå
, cchAnsi) + 1;

529 
	}
}

536 
	$¸óãAboutBox
(
HINSTANCE
 
hIn°™˚
, 
HWND
 
hwnd
)

538 
WORD
 *
p
, *
pdlgãm∂©e
;

539 
nch¨
;

540 
DWORD
 
lStyÀ
;

541 
HWND
 
hwndRëu∫
;

546 
pdlgãm∂©e
 = 
p
 = (
PWORD
Ë
	`LoˇlAŒoc
(
LPTR
, 1000);

552 
lStyÀ
 = 
WS_DLGFRAME
 | 
WS_POPUP
 | 
WS_VISIBLE
 | 
WS_CLIPCHILDREN
 | 
DS_SETFONT
;

553 *
p
++ = 
	`LOWORD
(
lStyÀ
);

554 *
p
++ = 
	`HIWORD
(
lStyÀ
);

555 *
p
++ = 0;

556 *
p
++ = 0;

557 *
p
++ = 7;

558 *
p
++ = 210;

559 *
p
++ = 10;

560 *
p
++ = 200;

561 *
p
++ = 100;

562 *
p
++ = 0;

563 *
p
++ = 0;

568 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
WEBS_NAME
);

569 
p
 +
nch¨
;

574 *
p
++ = 11;

575 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("Arial Bold"));

576 
p
 +
nch¨
;

581 
p
 = 
	`ÕwAlign
(p);

586 
lStyÀ
 = 
SS_CENTER
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

587 *
p
++ = 
	`LOWORD
(
lStyÀ
);

588 *
p
++ = 
	`HIWORD
(
lStyÀ
);

589 *
p
++ = 0;

590 *
p
++ = 0;

591 *
p
++ = 10;

592 *
p
++ = 10;

593 *
p
++ = 180;

594 *
p
++ = 15;

595 *
p
++ = 1;

600 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`TEXT
("STATIC"));

601 
p
 +
nch¨
;

606 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
,

607 
	`TEXT
("GoAhód WebSîvî "Ë
WEBS_VERSION
);

608 
p
 +
nch¨
;

609 #ifde‡
WEBS_SSL_SUPPORT


610 
p
 -(
ch¨_t
);

611 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
,

612 
	`TEXT
("\n"Ë
SSL_NAME
 TEXT(" "Ë
SSL_VERSION
);

613 
p
 +
nch¨
;

618 *
p
++ = 0;

623 
p
 = 
	`ÕwAlign
(p);

628 
lStyÀ
 = 
SS_CENTER
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

629 *
p
++ = 
	`LOWORD
(
lStyÀ
);

630 *
p
++ = 
	`HIWORD
(
lStyÀ
);

631 *
p
++ = 0;

632 *
p
++ = 0;

633 *
p
++ = 10;

634 *
p
++ = 30;

635 *
p
++ = 180;

636 *
p
++ = 15;

637 *
p
++ = 1;

642 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`TEXT
("STATIC"));

643 
p
 +
nch¨
;

648 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
GOAHEAD_COPYRIGHT
);

649 
p
 +
nch¨
;

654 *
p
++ = 0;

658 
p
 = 
	`ÕwAlign
(p);

663 
lStyÀ
 = 
SS_RIGHT
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

664 *
p
++ = 
	`LOWORD
(
lStyÀ
);

665 *
p
++ = 
	`HIWORD
(
lStyÀ
);

666 *
p
++ = 0;

667 *
p
++ = 0;

668 *
p
++ = 28;

669 *
p
++ = 50;

670 *
p
++ = 70;

671 *
p
++ = 10;

672 *
p
++ = 1;

673 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("STATIC"));

674 
p
 +
nch¨
;

675 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("Version:"));

676 
p
 +
nch¨
;

677 *
p
++ = 0;

682 
p
 = 
	`ÕwAlign
(p);

683 
lStyÀ
 = 
SS_LEFT
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

684 *
p
++ = 
	`LOWORD
(
lStyÀ
);

685 *
p
++ = 
	`HIWORD
(
lStyÀ
);

686 *
p
++ = 0;

687 *
p
++ = 0;

688 *
p
++ = 102;

689 *
p
++ = 50;

690 *
p
++ = 70;

691 *
p
++ = 10;

692 *
p
++ = 
IDC_VERSION
;

693 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("STATIC"));

694 
p
 +
nch¨
;

695 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("version"));

696 
p
 +
nch¨
;

697 *
p
++ = 0;

701 
p
 = 
	`ÕwAlign
(p);

702 
lStyÀ
 = 
SS_RIGHT
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

703 *
p
++ = 
	`LOWORD
(
lStyÀ
);

704 *
p
++ = 
	`HIWORD
(
lStyÀ
);

705 *
p
++ = 0;

706 *
p
++ = 0;

707 *
p
++ = 28;

708 *
p
++ = 65;

709 *
p
++ = 70;

710 *
p
++ = 10;

711 *
p
++ = 1;

712 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("STATIC"));

713 
p
 +
nch¨
;

714 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("Build Date:"));

715 
p
 +
nch¨
;

716 *
p
++ = 0;

720 
p
 = 
	`ÕwAlign
(p);

721 
lStyÀ
 = 
SS_LEFT
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

722 *
p
++ = 
	`LOWORD
(
lStyÀ
);

723 *
p
++ = 
	`HIWORD
(
lStyÀ
);

724 *
p
++ = 0;

725 *
p
++ = 0;

726 *
p
++ = 102;

727 *
p
++ = 65;

728 *
p
++ = 70;

729 *
p
++ = 10;

730 *
p
++ = 
IDC_BUILDDATE
;

731 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("STATIC"));

732 
p
 +
nch¨
;

733 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("Build Date"));

734 
p
 +
nch¨
;

735 *
p
++ = 0;

739 
p
 = 
	`ÕwAlign
(p);

740 
lStyÀ
 = 
BS_PUSHBUTTON
 | 
WS_VISIBLE
 | 
WS_CHILD
 | 
WS_TABSTOP
;

741 *
p
++ = 
	`LOWORD
(
lStyÀ
);

742 *
p
++ = 
	`HIWORD
(
lStyÀ
);

743 *
p
++ = 0;

744 *
p
++ = 0;

745 *
p
++ = 80;

746 *
p
++ = 80;

747 *
p
++ = 40;

748 *
p
++ = 10;

749 *
p
++ = 
IDOK
;

750 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("BUTTON"));

751 
p
 +
nch¨
;

752 
nch¨
 = 
	`nC›yAnsiToWideCh¨
(
p
, 
	`T
("OK"));

753 
p
 +
nch¨
;

754 *
p
++ = 0;

756 
hwndRëu∫
 = 
	`Cª©eDülogIndúe˘
(
hIn°™˚
,

757 (
LPDLGTEMPLATE
Ë
pdlgãm∂©e
, 
hwnd
, (
DLGPROC
Ë
websAboutProc
);

759 
	`LoˇlFªe
(
	`LoˇlH™dÀ
(
pdlgãm∂©e
));

762 
	}
}

771 
	$a•Te°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

773 
ch¨_t
 *
«me
, *
addªss
;

775 i‡(
	`ejArgs
(
¨gc
, 
¨gv
, 
	`T
("%†%s"), &
«me
, &
addªss
) < 2) {

776 
	`websEº‹
(
wp
, 400, 
	`T
("Insufficientárgs\n"));

779  
	`websWrôe
(
wp
, 
	`T
("Name: %s, Addªs†%s"), 
«me
, 
addªss
);

780 
	}
}

788 
	$f‹mTe°
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

790 
ch¨_t
 *
«me
, *
addªss
;

792 
«me
 = 
	`websGëV¨
(
wp
, 
	`T
("name"), T("Joe Smith"));

793 
addªss
 = 
	`websGëV¨
(
wp
, 
	`T
("address"), T("1212 Milky Way Ave."));

795 
	`websHódî
(
wp
);

796 
	`websWrôe
(
wp
, 
	`T
("<body><h2>Name: %s, Addªss: %s</h2>\n"), 
«me
, 
addªss
);

797 
	`websFoŸî
(
wp
);

798 
	`websD⁄e
(
wp
, 200);

799 
	}
}

806 
	$websHomePageH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

807 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

812 i‡(*
uæ
 ='\0' || 
	`g°rcmp
(uæ, 
	`T
("/")) == 0) {

813 
	`websRedúe˘
(
wp
, 
WEBS_DEFAULT_HOME
);

817 
	}
}

821 #ifde‡
B_STATS


822 
	$memLóks
()

824 
fd
;

826 i‡((
fd
 = 
	`g›í
(
	`T
("Àak.txt"), 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
)) >= 0) {

827 
	`b°©s
(
fd
, 
¥ötMemSèts
);

828 
	`˛o£
(
fd
);

830 
	}
}

837 
	$¥ötMemSèts
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

839 
va_li°
 
¨gs
;

840 
ch¨_t
 
buf
[256];

842 
	`va_°¨t
(
¨gs
, 
fmt
);

843 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

844 
	`va_íd
(
¨gs
);

845 
	`wrôe
(
h™dÀ
, 
buf
, 
	`°æí
(buf));

846 
	}
}

854 
	#RCWIDTH
(
rc
Ë(‘c).
right
 - (rc).
À·
)

	)

855 
	#RCHEIGHT
(
rc
Ë(‘c).
bŸtom
 - (rc).
t›
)

	)

857 
	$˚¡îWödowOnDi•œy
(
HWND
 
hwndCíãr
)

859 
xLe·
, 
yT›
, 
cxDi•
, 
cyDi•
;

860 
RECT
 
rcDlg
;

862 
	`a_as£π
(
	`IsWödow
(
hwndCíãr
));

867 
	`GëWödowRe˘
(
hwndCíãr
, &
rcDlg
);

872 
cxDi•
 = 
	`GëSy°emMërics
(
SM_CXFULLSCREEN
);

873 
cyDi•
 = 
	`GëSy°emMërics
(
SM_CYFULLSCREEN
);

878 
xLe·
 = 
cxDi•
 / 2 - 
	`RCWIDTH
(
rcDlg
) / 2;

879 
yT›
 = 
cyDi•
 / 2 - 
	`RCHEIGHT
(
rcDlg
) / 2;

884 i‡(
xLe·
 < 0) {

885 
xLe·
 = 0;

886 } i‡(
xLe·
 + 
	`RCWIDTH
(
rcDlg
Ë> 
cxDi•
) {

887 
xLe·
 = 
cxDi•
 - 
	`RCWIDTH
(
rcDlg
);

890 i‡(
yT›
 < 0) {

891 
yT›
 = 0;

892 } i‡(
yT›
 + 
	`RCHEIGHT
(
rcDlg
Ë> 
cyDi•
) {

893 
yT›
 = 
cyDi•
 - 
	`RCHEIGHT
(
rcDlg
);

899 
	`SëWödowPos
(
hwndCíãr
, 
HWND_TOP
, 
xLe·
, 
yT›
, -1, -1,

900 
SWP_NOSIZE
 | 
SWP_NOZORDER
 | 
SWP_NOACTIVATE
);

901 
	}
}

	@asp.c

20 
	~"wsI¡∫.h
"

24 
sym_fd_t
 
	gwebsA•Fun˘i⁄s
 = -1;

25 
	ga•O≥nCou¡
 = 0;

29 
ch¨_t
 *
°πokcmp
(ch¨_à*
s1
, ch¨_à*
s2
);

30 
ch¨_t
 *
skùWhôe
(ch¨_à*
s
);

37 
	$websA•O≥n
()

39 i‡(++
a•O≥nCou¡
 == 1) {

43 
websA•Fun˘i⁄s
 = 
	`symO≥n
(
WEBS_SYM_INIT
 * 2);

48 
	`websA•Deföe
(
	`T
("wrôe"), 
websA•Wrôe
);

51 
	}
}

58 
	$websA•Clo£
()

60 i‡(--
a•O≥nCou¡
 <= 0) {

61 i‡(
websA•Fun˘i⁄s
 != -1) {

62 
	`symClo£
(
websA•Fun˘i⁄s
);

63 
websA•Fun˘i⁄s
 = -1;

66 
	}
}

75 
	$websA•Reque°
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
)

77 
websSètTy≥
 
sbuf
;

78 *
rbuf
;

79 
ch¨_t
 *
tokí
, *
œng
, *
ªsu…
, *
∑th
, *
ï
, *
˝
, *
buf
, *
√xç
;

80 
ch¨_t
 *
œ°
;

81 
rc
, 
ígöe
, 
Àn
, 
ejid
;

83 
	`a_as£π
(
	`websVÆid
(
wp
));

84 
	`a_as£π
(
Õ©h
 && *lpath);

86 
rc
 = -1;

87 
buf
 = 
NULL
;

88 
rbuf
 = 
NULL
;

89 
ígöe
 = 
EMF_SCRIPT_EJSCRIPT
;

90 
wp
->
Êags
 |
WEBS_HEADER_DONE
;

91 
∑th
 = 
	`websGëReque°P©h
(
wp
);

96 
ejid
 = 
	`ejO≥nEngöe
(
wp
->
cgiV¨s
, 
websA•Fun˘i⁄s
);

97 i‡(
ejid
 < 0) {

98 
	`websEº‹
(
wp
, 200, 
	`T
("Can't create EjscriptÉngine"));

99 
d⁄e
;

101 
	`ejSëU£rH™dÀ
(
ejid
, 
wp
);

103 i‡(
	`websPageSèt
(
wp
, 
Õ©h
, 
∑th
, &
sbuf
) < 0) {

104 
	`websEº‹
(
wp
, 404, 
	`T
("C™'à°© %s"), 
Õ©h
);

105 
d⁄e
;

111 
Àn
 = 
sbuf
.
size
 * ();

112 i‡((
rbuf
 = 
	`bÆloc
(
B_L
, 
Àn
 + 1)Ë=
NULL
) {

113 
	`websEº‹
(
wp
, 200, 
	`T
("Can't get memory"));

114 
d⁄e
;

116 
rbuf
[
Àn
] = '\0';

118 i‡(
	`websPageRódD©a
(
wp
, 
rbuf
, 
Àn
) !=Üen) {

119 
	`websEº‹
(
wp
, 200, 
	`T
("C™àªad %s"), 
Õ©h
);

120 
d⁄e
;

122 
	`websPageClo£
(
wp
);

127 i‡((
buf
 = 
	`bÆlocAscToUni
(
rbuf
, 
Àn
)Ë=
NULL
) {

128 
	`websEº‹
(
wp
, 200, 
	`T
("Can't get memory"));

129 
d⁄e
;

135 
œ°
 = 
buf
;

136 
rc
 = 0;

137 
rc
 =0 && *
œ°
 && ((
√xç
 = 
	`g°r°r
÷a°, 
	`T
("<%"))Ë!
NULL
)) {

138 
	`websWrôeBlock
(
wp
, 
œ°
, (
√xç
 -Üast));

139 
√xç
 = 
	`skùWhôe
(nextp + 2);

144 
tokí
 = 
	`T
("language");

146 i‡((
œng
 = 
	`°πokcmp
(
√xç
, 
tokí
)Ë!
NULL
) {

147 i‡((
˝
 = 
	`°πokcmp
(
œng
, 
	`T
("=javas¸ùt"))Ë!
NULL
) {

148 
ígöe
 = 
EMF_SCRIPT_EJSCRIPT
;

150 
˝
 = 
√xç
;

152 
√xç
 = 
˝
;

158 i‡((
ï
 = 
	`g°r°r
(
√xç
, 
	`T
("%>"))Ë!
NULL
) {

160 *
ï
 = '\0';

161 
œ°
 = 
ï
 + 2;

162 
√xç
 = 
	`skùWhôe
(nextp);

166 
˝
 = 
√xç
; *cp; ) {

167 i‡(*
˝
 == '\\' && (cp[1] == '\r' || cp[1] == '\n')) {

168 *
˝
++ = ' ';

169 *
˝
 == '\r' || *cp == '\n') {

170 *
˝
++ = ' ';

173 
˝
++;

181 i‡(*
√xç
) {

182 
ªsu…
 = 
NULL
;

183 i‡(
ígöe
 =
EMF_SCRIPT_EJSCRIPT
) {

184 
rc
 = 
	`s¸ùtEvÆ
(
ígöe
, 
√xç
, &
ªsu…
, (*Ë
ejid
);

186 
rc
 = 
	`s¸ùtEvÆ
(
ígöe
, 
√xç
, &
ªsu…
, 
wp
);

188 i‡(
rc
 < 0) {

194 i‡(
	`websVÆid
(
wp
)) {

195 i‡(
ªsu…
) {

196 
	`websWrôe
(
wp
, 
	`T
("<h2><b>ASP Error: %s</b></h2>\n"),

197 
ªsu…
);

198 
	`websWrôe
(
wp
, 
	`T
("<¥e>%s</¥e>"), 
√xç
);

199 
	`b‰ì
(
B_L
, 
ªsu…
);

201 
	`websWrôe
(
wp
, 
	`T
("<h2><b>ASP Error</b></h2>\n%s\n"),

202 
√xç
);

204 
	`websWrôe
(
wp
, 
	`T
("</body></html>\n"));

205 
rc
 = 0;

207 
d⁄e
;

212 
	`websEº‹
(
wp
, 200, 
	`T
("U¡îmö©ed s¸ùàö %s: \n"), 
Õ©h
);

213 
rc
 = -1;

214 
d⁄e
;

220 i‡(
œ°
 && *œ° && 
rc
 == 0) {

221 
	`websWrôeBlock
(
wp
, 
œ°
, 
	`g°æí
(last));

223 
rc
 = 0;

228 
d⁄e
:

229 i‡(
	`websVÆid
(
wp
)) {

230 
	`websPageClo£
(
wp
);

231 i‡(
ejid
 >= 0) {

232 
	`ejClo£Engöe
(
ejid
);

235 
	`b‰ìSa„
(
B_L
, 
buf
);

236 
	`b‰ìSa„
(
B_L
, 
rbuf
);

237  
rc
;

238 
	}
}

245 
websA•Deföe
(
ch¨_t
 *
«me
,

246 (*
‚
)(
ejid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
))

248  
	`ejSëGlobÆFun˘i⁄Dúe˘
(
websA•Fun˘i⁄s
, 
«me
,

249 ((*)(, *, , 
ch¨_t
**)Ë
‚
);

250 
	}
}

257 
	$websA•Wrôe
(
ejid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

259 
i
;

261 
	`a_as£π
(
	`websVÆid
(
wp
));

263 
i
 = 0; i < 
¨gc
; ) {

264 
	`a_as£π
(
¨gv
);

265 i‡(
	`websWrôeBlock
(
wp
, 
¨gv
[
i
], 
	`g°æí
(argv[i])) < 0) {

268 i‡(++
i
 < 
¨gc
) {

269 i‡(
	`websWrôeBlock
(
wp
, 
	`T
(" "), 2) < 0) {

275 
	}
}

283 
ch¨_t
 *
	$°πokcmp
(
ch¨_t
 *
s1
, ch¨_à*
s2
)

285 
Àn
;

287 
s1
 = 
	`skùWhôe
(s1);

288 
Àn
 = 
	`g°æí
(
s2
);

289 
Àn
 = 
	`g°æí
(
s2
);Üí > 0 && (
	`tﬁowî
(*
s1
) ==Åolower(*s2));Üen--) {

290 i‡(*
s2
 == '\0') {

291  
s1
;

293 
s1
++;

294 
s2
++;

296 i‡(
Àn
 == 0) {

297  
s1
;

299  
NULL
;

300 
	}
}

307 
ch¨_t
 *
	$skùWhôe
(
ch¨_t
 *
s
)

309 
	`a_as£π
(
s
);

311 i‡(
s
 =
NULL
) {

312  
s
;

314 *
s
 && 
	`gis•a˚
(*s)) {

315 
s
++;

317  
s
;

318 
	}
}

	@balloc.c

28 
	#IN_BALLOC


	)

30 
	~"uemf.h
"

32 
	~<°d¨g.h
>

33 
	~<°dlib.h
>

35 #i‚de‡
NO_BALLOC


41 #ifde‡
B_STATS


47 
	mÆloc
;

48 
	möu£
;

49 } 
	tbSètsTy≥
;

52 
ch¨_t
 
	mfûe
[
FNAMESIZE
];

53 
	mÆloˇãd
;

54 
	mcou¡
;

55 
	mtimes
;

56 
	mœrge°
;

57 
	mq
;

58 } 
	tbSètsFûeTy≥
;

64 *
	m±r
;

65 
bSètsFûeTy≥
 *
	mwho
;

66 } 
	tbSètsBlkTy≥
;

68 
bSètsTy≥
 
	gbSèts
[
B_MAX_CLASS
];

69 
bSètsFûeTy≥
 
	gbSètsFûes
[
B_MAX_FILES
];

70 
bSètsBlkTy≥
 
	gbSètsBlks
[
B_MAX_BLOCKS
];

71 
	gbSètsBlksMax
 = 0;

72 
	gbSètsFûesMax
 = 0;

73 
	gbSètsMemInU£
 = 0;

74 
	gbSètsBÆlocInU£
 = 0;

75 
	gbSètsMemMax
 = 0;

76 
	gbSètsBÆlocMax
 = 0;

77 *
	gbSèckMö
 = (*) -1;

78 *
	gbSèckSèπ
;

79 
	gbSètsMemMÆloc
 = 0;

90 
	#ROUNDUP4
(
size
Ë((sizeË% 4Ë? (sizeË+ (4 - ((sizeË% 4)Ë: (size)

	)

97 
bTy≥
 *
	gbQhód
[
B_MAX_CLASS
];

98 *
	gbFªeBuf
;

99 *
	gbFªeNext
;

100 
	gbFªeSize
;

101 
	gbFªeLe·
;

102 
	gbFœgs
 = 
B_USE_MALLOC
;

103 
	gb›íCou¡
 = 0;

107 #ifde‡
B_STATS


108 
bSètsAŒoc
(
B_ARGS_DEC
, *
±r
, 
q
, 
size
);

109 
bSètsFªe
(
B_ARGS_DEC
, *
±r
, 
q
, 
size
);

110 
b°©sWrôe
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...);

111 
bSètsFûeS‹t
(c⁄° *
˝1
, c⁄° *
˝2
);

114 #i‡(
deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

115 
bFûlBlock
(*
buf
, 
bufsize
);

118 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


119 
vîifyU£dBlock
(
bTy≥
 *
bp
, 
q
);

120 
vîifyFªeBlock
(
bTy≥
 *
bp
, 
q
);

121 
vîifyBÆlocS∑˚
();

124 
bÆlocGëSize
(
size
, *
q
);

137 
	$b›í
(*
buf
, 
bufsize
, 
Êags
)

139 
bFœgs
 = 
Êags
;

141 #ifde‡
BASTARD_TESTING


142 
	`§™d
(
	`time
(0L));

149 i‡(++
b›íCou¡
 > 1) {

153 i‡(
buf
 =
NULL
) {

154 i‡(
bufsize
 == 0) {

155 
bufsize
 = 
B_DEFAULT_MEM
;

157 #ifde‡
IRIX


158 
bufsize
 = 
	`ROUNDUP4
(bufsize);

160 i‡((
buf
 = 
	`mÆloc
(
bufsize
)Ë=
NULL
) {

165 --
b›íCou¡
;

168 #ifde‡
B_STATS


169 
bSètsMemMÆloc
 +
bufsize
;

172 
bFœgs
 |
B_USER_BUF
;

175 
bFªeSize
 = 
bFªeLe·
 = 
bufsize
;

176 
bFªeBuf
 = 
bFªeNext
 = 
buf
;

177 
	`mem£t
(
bQhód
, 0, (bQhead));

178 #i‡(
	`deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

179 
	`bFûlBlock
(
buf
, 
bufsize
);

181 #ifde‡
B_STATS


182 
bSèckSèπ
 = &
buf
;

184 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


185 
	`vîifyFªeBlock
(
buf
, 
bufsize
);

188 
	}
}

195 
	$b˛o£
()

197 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


198 
	`vîifyBÆlocS∑˚
();

200 i‡(--
b›íCou¡
 <0 && !(
bFœgs
 & 
B_USER_BUF
)) {

201 
	`‰ì
(
bFªeBuf
);

202 
b›íCou¡
 = 0;

204 
	}
}

212 *
	$bÆloc
(
B_ARGS_DEC
, 
size
)

214 
bTy≥
 *
bp
;

215 
q
, 
memSize
;

220 i‡(
bFªeBuf
 =
NULL
) {

221 i‡(
	`b›í
(
NULL
, 
B_DEFAULT_MEM
, 0) < 0) {

222  
NULL
;

225 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


226 
	`vîifyBÆlocS∑˚
();

228 i‡(
size
 < 0) {

229  
NULL
;

232 #ifde‡
BASTARD_TESTING


233 i‡(
	`ønd
() == 0x7fff) {

234  
NULL
;

239 
memSize
 = 
	`bÆlocGëSize
(
size
, &
q
);

241 i‡(
q
 >
B_MAX_CLASS
) {

245 i‡(
bFœgs
 & 
B_USE_MALLOC
) {

246 #ifde‡
B_STATS


247 
	`b°©s
(0, 
NULL
);

249 #ifde‡
IRIX


250 
memSize
 = 
	`ROUNDUP4
(memSize);

252 
bp
 = (
bTy≥
*Ë
	`mÆloc
(
memSize
);

253 i‡(
bp
 =
NULL
) {

254 
	`åa˚Raw
(
	`T
("B: malloc failed\n"));

255  
NULL
;

257 #ifde‡
B_STATS


258 
bSètsMemMÆloc
 +
memSize
;

260 #i‡(
	`deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

261 
	`bFûlBlock
(
bp
, 
memSize
);

265 
	`åa˚Raw
(
	`T
("B: malloc failed\n"));

266  
NULL
;

272 
bp
->
u
.
size
 = 
memSize
 - (
bTy≥
);

273 
bp
->
Êags
 = 
B_MALLOCED
;

275 } i‡((
bp
 = 
bQhód
[
q
]Ë!
NULL
) {

279 
bQhód
[
q
] = 
bp
->
u
.
√xt
;

280 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


281 
	`vîifyFªeBlock
(
bp
, 
q
);

283 #i‡(
	`deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

284 
	`bFûlBlock
(
bp
, 
memSize
);

286 
bp
->
u
.
size
 = 
memSize
 - (
bTy≥
);

287 
bp
->
Êags
 = 0;

290 i‡(
bFªeLe·
 > 
memSize
) {

295 
bp
 = (
bTy≥
*Ë
bFªeNext
;

296 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


297 
	`vîifyFªeBlock
(
bp
, 
q
);

299 
bFªeNext
 +
memSize
;

300 
bFªeLe·
 -
memSize
;

301 #i‡(
	`deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

302 
	`bFûlBlock
(
bp
, 
memSize
);

304 
bp
->
u
.
size
 = 
memSize
 - (
bTy≥
);

305 
bp
->
Êags
 = 0;

307 } i‡(
bFœgs
 & 
B_USE_MALLOC
) {

308 #ifde‡
B_STATS


309 
⁄˚
 = 0;

310 i‡(
⁄˚
++ == 0) {

311 
	`b°©s
(0, 
NULL
);

317 #ifde‡
IRIX


318 
memSize
 = 
	`ROUNDUP4
(memSize);

320 i‡((
bp
 = (
bTy≥
*Ë
	`mÆloc
(
memSize
)Ë=
NULL
) {

321 
	`åa˚Raw
(
	`T
("B: malloc failed\n"));

322  
NULL
;

324 #ifde‡
B_STATS


325 
bSètsMemMÆloc
 +
memSize
;

327 #i‡(
	`deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

328 
	`bFûlBlock
(
bp
, 
memSize
);

330 
bp
->
u
.
size
 = 
memSize
 - (
bTy≥
);

331 
bp
->
Êags
 = 
B_MALLOCED
;

334 
	`åa˚Raw
(
	`T
("B: malloc failed\n"));

335  
NULL
;

339 #ifde‡
B_STATS


340 
	`bSètsAŒoc
(
B_ARGS
, 
bp
, 
q
, 
memSize
);

342 
bp
->
Êags
 |
B_INTEGRITY
;

349 #ifde‡
B_STATS


350 i‡(
bSètsBÆlocInU£
 =
bSètsBÆlocMax
) {

351 
	`b°©s
(0, 
NULL
);

355  (*Ë((*Ë
bp
 + (
bTy≥
));

356 
	}
}

365 
	$b‰ì
(
B_ARGS_DEC
, *
mp
)

367 
bTy≥
 *
bp
;

368 
q
, 
memSize
;

370 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


371 
	`vîifyBÆlocS∑˚
();

373 
bp
 = (
bTy≥
*Ë((*Ë
mp
 - (bType));

375 
	`a_as£π
((
bp
->
Êags
 & 
B_INTEGRITY_MASK
Ë=
B_INTEGRITY
);

377 i‡((
bp
->
Êags
 & 
B_INTEGRITY_MASK
Ë!
B_INTEGRITY
) {

381 
memSize
 = 
	`bÆlocGëSize
(
bp
->
u
.
size
, &
q
);

383 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


384 
	`vîifyU£dBlock
(
bp
,
q
);

386 #ifde‡
B_STATS


387 
	`bSètsFªe
(
B_ARGS
, 
bp
, 
q
, bp->
u
.
size
+(
bTy≥
));

389 i‡(
bp
->
Êags
 & 
B_MALLOCED
) {

390 
	`‰ì
(
bp
);

394 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


395 
	`bFûlBlock
(
bp
, 
memSize
);

401 
bp
->
u
.
√xt
 = 
bQhód
[
q
];

402 
bQhód
[
q
] = 
bp
;

404 
bp
->
Êags
 = 
B_FILL_WORD
;

405 
	}
}

412 
	$b‰ìSa„
(
B_ARGS_DEC
, *
mp
)

414 i‡(
mp
) {

415 
	`b‰ì
(
B_ARGS
, 
mp
);

417 
	}
}

420 #ifde‡
UNICODE


425 *
	$b°rdupA
(
B_ARGS_DEC
, *
s
)

427 *
˝
;

428 
Àn
;

430 i‡(
s
 =
NULL
) {

431 
s
 = "";

433 
Àn
 = 
	`°æí
(
s
) + 1;

434 i‡(
˝
 = 
	`bÆloc
(
B_ARGS
, 
Àn
)) {

435 
	`°r˝y
(
˝
, 
s
);

437  
˝
;

438 
	}
}

448 
ch¨_t
 *
	$b°rdup
(
B_ARGS_DEC
, 
ch¨_t
 *
s
)

450 
ch¨_t
 *
˝
;

451 
Àn
;

453 i‡(
s
 =
NULL
) {

454 
s
 = 
	`T
("");

456 
Àn
 = 
	`g°æí
(
s
) + 1;

457 i‡((
˝
 = 
	`bÆloc
(
B_ARGS
, 
Àn
 * (
ch¨_t
))Ë!
NULL
) {

458 
	`g°∫˝y
(
˝
, 
s
, 
Àn
 * (
ch¨_t
));

460  
˝
;

461 
	}
}

470 *
	$bªÆloc
(
B_ARGS_DEC
, *
mp
, 
√wsize
)

472 
bTy≥
 *
bp
;

473 *
√wbuf
;

475 i‡(
mp
 =
NULL
) {

476  
	`bÆloc
(
B_ARGS
, 
√wsize
);

478 
bp
 = (
bTy≥
*Ë((*Ë
mp
 - (bType));

479 
	`a_as£π
((
bp
->
Êags
 & 
B_INTEGRITY_MASK
Ë=
B_INTEGRITY
);

485 i‡(
bp
->
u
.
size
 >
√wsize
) {

486  
mp
;

488 i‡((
√wbuf
 = 
	`bÆloc
(
B_ARGS
, 
√wsize
)Ë!
NULL
) {

489 
	`mem˝y
(
√wbuf
, 
mp
, 
bp
->
u
.
size
);

490 
	`b‰ì
(
B_ARGS
, 
mp
);

492  
√wbuf
;

493 
	}
}

503 
	$bÆlocGëSize
(
size
, *
q
)

505 
mask
;

507 
mask
 = (
size
 =0Ë? 0 : (size-1Ë>> 
B_SHIFT
;

508 *
q
 = 0; 
mask
; mask >>= 1) {

509 *
q
 = *q + 1;

511  ((1 << (
B_SHIFT
 + *
q
)Ë+ (
bTy≥
));

512 
	}
}

515 #i‡(
deföed
 (
B_FILL
Ë|| deföed (
B_VERIFY_CAUSES_SEVERE_OVERHEAD
))

520 
	$bFûlBlock
(*
buf
, 
bufsize
)

522 
	`mem£t
(
buf
, 
B_FILL_CHAR
, 
bufsize
);

523 
	}
}

527 #ifde‡
B_STATS


533 
b°©s
(
h™dÀ
, (*
wrôe‚
)(h™dÀ, 
ch¨_t
 *
fmt
, ...))

535 
bSètsFûeTy≥
 *
Â
, *
fûes
;

536 
bSètsBlkTy≥
 *
blkp
;

537 
bTy≥
 *
bp
;

538 
ch¨_t
 *
˝
;

539 
q
, 
cou¡
, 
mem
, 
tŸÆ
, 
Àn
;

540 
ªcur£PrŸe˘
 = 0;

542 i‡(
ªcur£PrŸe˘
++ > 0) {

543 
ªcur£PrŸe˘
--;

547 i‡(
wrôe‚
 =
NULL
) {

548 
wrôe‚
 = 
b°©sWrôe
;

554 (*
wrôe‚
)(
h™dÀ
, 
	`T
("\nMemory Stats\n"));

561 (*
wrôe‚
)(
h™dÀ
, " Q Size Free Bytes Inuse Bytes Allocs\n");

563 
tŸÆ
 = 0;

564 
q
 = 0; q < 
B_MAX_CLASS
; q++) {

565 
cou¡
 = 0;

566 
bp
 = 
bQhód
[
q
]; bp; b∞bp->
u
.
√xt
) {

567 
cou¡
++;

569 
mem
 = 
cou¡
 * (1 << (
q
 + 
B_SHIFT
));

570 
tŸÆ
 +
mem
;

571 (*
wrôe‚
)(
h™dÀ
,

572 
	`T
("%2d %5d %4d %6d %4d %5d %4d\n"),

573 
q
, 1 << (q + 
B_SHIFT
), 
cou¡
, 
mem
, 
bSèts
[q].
öu£
,

574 
bSèts
[
q
].
öu£
 * (1 << (q + 
B_SHIFT
)), bSèts[q].
Æloc
);

577 (*
wrôe‚
)(
h™dÀ
, 
	`T
("\n"));

595 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Inôü»‰ìÜi° sizê %7d\n"), 
bFªeSize
);

596 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Max mem‹y mÆlo˚d %7d\n"), 
bSètsMemMÆloc
);

597 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Max mem‹yÉvî u£d %7d\n"), 
bSètsMemMax
);

598 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Max mem‹yÉvî bÆlo˚d %7d\n"), 
bSètsBÆlocMax
);

599 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Mem‹y cuºíéy i¿u£ %7d\n"), 
bSètsMemInU£
);

600 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Mem‹y cuºíéy bÆlo˚d %7d\n"), 
bSètsBÆlocInU£
);

601 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Max block†Æloˇãd %7d\n"), 
bSètsBlksMax
);

602 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Maximum stack used %7d\n"),

603 (Ë
bSèckSèπ
 - (Ë
bSèckMö
);

605 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Fªêmem‹y o¿Æ»queue†%7d\n"), 
tŸÆ
);

606 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Fªêli° buf„∏À· %7d\n"), 
bFªeLe·
);

607 (*
wrôe‚
)(
h™dÀ
, 
	`T
("TŸÆ fªêmem‹y %7d\n"), 
bFªeLe·
 + 
tŸÆ
);

612 
Àn
 = (
bSètsFûeTy≥
Ë* 
B_MAX_FILES
;

613 
fûes
 = 
	`mÆloc
(
Àn
);

614 i‡(
fûes
 =
NULL
) {

615 (*
wrôe‚
)(
h™dÀ
, 
	`T
("Can'tállocate stats memory\n"));

616 
ªcur£PrŸe˘
--;

619 
	`mem˝y
(
fûes
, 
bSètsFûes
, 
Àn
);

620 
	`qs‹t
(
fûes
, 
bSètsFûesMax
, (
bSètsFûeTy≥
), 
bSètsFûeS‹t
);

622 (*
wrôe‚
)(
h™dÀ
, 
	`T
("\nMemory Currently Allocated\n"));

623 
tŸÆ
 = 0;

624 (*
wrôe‚
)(
h™dÀ
,

625 
	`T
(" bytes, blocks in use,ÅotalÅimes,")

626 
	`T
("largest, q\n"));

628 
Â
 = 
fûes
; f∞< &fûes[
bSètsFûesMax
]; fp++) {

629 i‡(
Â
->
fûe
[0]) {

630 (*
wrôe‚
)(
h™dÀ
, 
	`T
("%18s, %7d, %5d, %6d, %7d,%4d\n"),

631 
Â
->
fûe
, fp->
Æloˇãd
, fp->
cou¡
, fp->
times
, fp->
œrge°
,

632 
Â
->
q
);

633 
tŸÆ
 +
Â
->
Æloˇãd
;

636 (*
wrôe‚
)(
h™dÀ
, 
	`T
("\nTŸÆáŒoˇãd %7d\n\n"), 
tŸÆ
);

641 (*
wrôe‚
)(
h™dÀ
, 
	`T
("\nStrings\n"));

642 
blkp
 = &
bSètsBlks
[
bSètsBlksMax
 - 1]; blkp >= bStatsBlks; blkp--) {

643 i‡(
blkp
->
±r
) {

644 
˝
 = (
ch¨_t
*Ë((*Ë
blkp
->
±r
 + (
bTy≥
));

645 
Â
 = 
blkp
->
who
;

646 i‡(
	`giß um
(*
˝
)) {

647 (*
wrôe‚
)(
h™dÀ
, 
	`T
("%-50†Æloˇãd by %s\n"), 
˝
,

648 
Â
->
fûe
);

652 
	`‰ì
(
fûes
);

653 
ªcur£PrŸe˘
--;

654 
	}
}

661 
	$bSètsFûeS‹t
(c⁄° *
˝1
, c⁄° *
˝2
)

663 
bSètsFûeTy≥
 *
s1
, *
s2
;

665 
s1
 = (
bSètsFûeTy≥
*Ë
˝1
;

666 
s2
 = (
bSètsFûeTy≥
*Ë
˝2
;

668 i‡(
s1
->
Æloˇãd
 < 
s2
->allocated)

670 i‡(
s1
->
Æloˇãd
 =
s2
->allocated)

673 
	}
}

680 
	$bSètsAŒoc
(
B_ARGS_DEC
, *
±r
, 
q
, 
size
)

682 
memSize
;

683 
bSètsFûeTy≥
 *
Â
;

684 
bSètsBlkTy≥
 *
bp
;

685 
ch¨_t
 
«me
[
FNAMESIZE
 + 10];

687 
	`g•rötf
(
«me
, 
	`T
("%s:%d"), 
B_ARGS
);

689 
bSèts
[
q
].
Æloc
++;

690 
bSèts
[
q
].
öu£
++;

691 
bSètsMemInU£
 +
size
;

692 i‡(
bSètsMemInU£
 > 
bSètsMemMax
) {

693 
bSètsMemMax
 = 
bSètsMemInU£
;

695 
memSize
 = (1 << (
B_SHIFT
 + 
q
)Ë+ (
bTy≥
);

696 
bSètsBÆlocInU£
 +
memSize
;

697 i‡(
bSètsBÆlocInU£
 > 
bSètsBÆlocMax
) {

698 
bSètsBÆlocMax
 = 
bSètsBÆlocInU£
;

705 i‡((*Ë&
fûe
 < 
bSèckMö
) {

706 
bSèckMö
 = (*Ë&
fûe
;

712 
Â
 = 
bSètsFûes
; f∞< &bSètsFûes[
bSètsFûesMax
]; fp++) {

713 i‡(
Â
->
fûe
[0] =fûe[0] && 
	`g°rcmp
(Â->fûe, 
«me
) == 0) {

714 
Â
->
Æloˇãd
 +
size
;

715 
Â
->
cou¡
++;

716 
Â
->
times
++;

717 i‡(
Â
->
œrge°
 < 
size
) {

718 
Â
->
œrge°
 = 
size
;

719 
Â
->
q
 = q;

728 i‡(
Â
 >&
bSètsFûes
[
bSètsFûesMax
]) {

729 
Â
 = 
bSètsFûes
; f∞< &bSètsFûes[
B_MAX_FILES
]; fp++) {

730 i‡(
Â
->
fûe
[0] == '\0') {

731 
	`g°∫˝y
(
Â
->
fûe
, 
«me
, 
	`TSZ
(fp->file));

732 
Â
->
Æloˇãd
 +
size
;

733 
Â
->
cou¡
++;

734 
Â
->
times
++;

735 
Â
->
œrge°
 = 
size
;

736 
Â
->
q
 = q;

737 i‡((
Â
 - 
bSètsFûes
Ë>
bSètsFûesMax
) {

738 
bSètsFûesMax
 = (
Â
 - 
bSètsFûes
) + 1;

748 
bp
 = 
bSètsBlks
; b∞< &bSètsBlks[
B_MAX_BLOCKS
]; bp++) {

749 i‡(
bp
->
±r
 =
NULL
) {

750 
bp
->
±r
 =Ötr;

751 
bp
->
who
 = 
Â
;

752 i‡((
bp
 - 
bSètsBlks
Ë>
bSètsBlksMax
) {

753 
bSètsBlksMax
 = (
bp
 - 
bSètsBlks
) + 1;

758 
	}
}

765 
	$bSètsFªe
(
B_ARGS_DEC
, *
±r
, 
q
, 
size
)

767 
memSize
;

768 
bSètsFûeTy≥
 *
Â
;

769 
bSètsBlkTy≥
 *
bp
;

771 
memSize
 = (1 << (
B_SHIFT
 + 
q
)Ë+ (
bTy≥
);

772 
bSètsMemInU£
 -
size
;

773 
bSètsBÆlocInU£
 -
memSize
;

774 
bSèts
[
q
].
öu£
--;

779 
bp
 = &
bSètsBlks
[
bSètsBlksMax
 - 1]; bp >= bStatsBlks; bp--) {

780 i‡(
bp
->
±r
 ==Ötr) {

781 
bp
->
±r
 = 
NULL
;

782 
Â
 = 
bp
->
who
;

783 
bp
->
who
 = 
NULL
;

784 
Â
->
Æloˇãd
 -
size
;

785 
Â
->
cou¡
--;

789 
	}
}

796 #unde‡
•rötf


797 
	$b°©sWrôe
(
h™dÀ
, 
ch¨_t
 *
fmt
, ...)

799 
va_li°
 
¨gs
;

800 
ch¨_t
 
buf
[
BUF_MAX
];

802 
	`va_°¨t
(
¨gs
, 
fmt
);

803 
	`v•rötf
(
buf
, 
fmt
, 
¨gs
);

804 
	`va_íd
(
¨gs
);

805 
	`åa˚Raw
(
buf
);

806 
	}
}

815 
b°©s
(
h™dÀ
, (*
wrôe‚
)(h™dÀ, 
ch¨_t
 *
fmt
, ...))

817 
	}
}

821 #ifde‡
B_VERIFY_CAUSES_SEVERE_OVERHEAD


838 
	$vîifyU£dBlock
(
bTy≥
 *
bp
, 
q
)

840 
memSize
, 
size
;

841 *
p
;

843 
memSize
 = (1 << (
B_SHIFT
 + 
q
)Ë+ (
bTy≥
);

844 
	`a_as£π
((
bp
->
Êags
 & ~
B_MALLOCED
Ë=
B_INTEGRITY
);

845 
size
 = 
bp
->
u
.size;

846 
p
 = ((*)
bp
)+(
bTy≥
)+
size
;Ö < ((*)bp)+
memSize
;Ö++) {

847 
	`a_as£π
(*
p
 =
B_FILL_CHAR
);

849 
	}
}

857 
	$vîifyFªeBlock
(
bTy≥
 *
bp
, 
q
)

859 
memSize
;

860 *
p
;

862 
memSize
 = (1 << (
B_SHIFT
 + 
q
)Ë+ (
bTy≥
);

863 
p
 = ((*)
bp
)+(*);Ö < ((*)bp)+
memSize
;Ö++) {

864 
	`a_as£π
(*
p
 =
B_FILL_CHAR
);

866 
bp
 = (
bTy≥
 *)
p
;

867 
	`a_as£π
((
bp
->
Êags
 & ~
B_MALLOCED
Ë=
B_INTEGRITY
 ||

868 
bp
->
Êags
 =
B_FILL_WORD
);

869 
	}
}

879 
	$vîifyBÆlocS∑˚
()

881 
q
;

882 *
p
;

883 
bTy≥
 *
bp
;

888 
q
 = 0; q < 
B_MAX_CLASS
; q++) {

889 
bp
 = 
bQhód
[
q
]; b∞!
NULL
; b∞bp->
u
.
√xt
) {

890 
	`vîifyFªeBlock
(
bp
, 
q
);

897 
p
 = 
bFªeBuf
;

898 
p
 < (
bFªeBuf
 + 
bFªeSize
)) {

899 
bp
 = (
bTy≥
 *)
p
;

900 i‡(
bp
->
u
.
size
 > 0xFFFFF) {

901 
p
 +(
bp
->
u
);

902 
p
 < (
bFªeBuf
 + 
bFªeSize
Ë&& *∞=
B_FILL_CHAR
) {

903 
p
++;

906 
	`a_as£π
(((
bp
->
Êags
 & ~
B_MALLOCED
Ë=
B_INTEGRITY
) ||

907 
bp
->
Êags
 =
B_FILL_WORD
);

908 
p
 +((
bTy≥
Ë+ 
bp
->
u
.
size
);

909 
p
 < (
bFªeBuf
 + 
bFªeSize
Ë&& *∞=
B_FILL_CHAR
) {

910 
p
++;

914 
	}
}

920 
	$b›í
(*
buf
, 
bufsize
, 
Êags
)

923 
	}
}

927 
	$b˛o£
()

929 
	}
}

933 
b°©s
(
h™dÀ
, (*
wrôe‚
)(h™dÀ, 
ch¨_t
 *
fmt
, ...))

935 
	}
}

939 
ch¨_t
 *
	$b°rdupNoBÆloc
(
ch¨_t
 *
s
)

941 #ifde‡
UNICODE


942 i‡(
s
) {

943  
	`wcsdup
(
s
);

945  
	`wcsdup
(
	`T
(""));

948  
	`b°rdupANoBÆloc
(
s
);

950 
	}
}

954 *
	$b°rdupANoBÆloc
(*
s
)

956 * 
buf
;

958 i‡(
s
 =
NULL
) {

959 
s
 = "";

961 
buf
 = 
	`mÆloc
(
	`°æí
(
s
)+1);

962 
	`°r˝y
(
buf
, 
s
);

963  
buf
;

964 
	}
}

	@cgi.c

21 
	~"wsI¡∫.h
"

22 
	~"uemf.h
"

27 
webs_t
 
	mwp
;

28 
ch¨_t
 *
	m°dIn
;

29 
ch¨_t
 *
	m°dOut
;

30 
ch¨_t
 *
	mcgiP©h
;

31 
ch¨_t
 **
	m¨gp
;

32 
ch¨_t
 **
	mívp
;

33 
	mh™dÀ
;

34 
	mÂœ˚m¨k
;

35 } 
	tcgiRec
;

36 
cgiRec
 **
	gcgiLi°
;

37 
	gcgiMax
;

44 
	$websCgiH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
,

45 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_t* 
quîy
)

47 
cgiRec
 *
cgù
;

48 
sym_t
 *
s
;

49 
ch¨_t
 
cgiBuf
[
FNAMESIZE
], *
°dIn
, *
°dOut
, 
cwd
[FNAMESIZE];

50 
ch¨_t
 *
˝
, *
cgiName
, *
cgiP©h
, **
¨gp
, **
ívp
, **
ï
;

51 
n
, 
ívpsize
, 
¨gpsize
, 
pH™dÀ
, 
cid
, 
rc
;

52 
	`a_as£π
(
	`websVÆid
(
wp
));

53 
	`a_as£π
(
uæ
 && *url);

54 
	`a_as£π
(
∑th
 && *path == '/');

60 #ifde‡
WEBS_WHITELIST_SUPPORT


61 i‡((
rc
 = 
	`websWhôñi°Check
(
wp
->
uæ
)Ë< 0 || !‘¯& 
WHITELIST_CGI
)) {

62 
	`websBuûdWhôñi°
();

63 i‡((
rc
 = 
	`websWhôñi°Check
(
wp
->
uæ
)Ë< 0 || !‘¯& 
WHITELIST_CGI
)) {

64 
	`websEº‹
(
wp
, 500, 
	`T
("Invalid CGI URL"));

68 i‡(!(
wp
->
Êags
 & 
WEBS_SECURE
Ë&& (
rc
 & 
WHITELIST_SSL
)) {

69 
	`websEº‹
(
wp
, 500, 
	`T
("HTTPS Access Required"));

74 
websSèts
.
cgiHôs
++;

80 
	`g°∫˝y
(
cgiBuf
, 
∑th
, 
	`TSZ
(cgiBuf));

81 i‡((
cgiName
 = 
	`g°rchr
(&
cgiBuf
[1], '/')Ë=
NULL
) {

82 
	`websEº‹
(
wp
, 200, 
	`T
("Missing CGIÇame"));

85 
cgiName
++;

86 i‡((
˝
 = 
	`g°rchr
(
cgiName
, '/')Ë!
NULL
) {

87 *
˝
 = '\0';

89 
	`fmtAŒoc
(&
cgiP©h
, 
FNAMESIZE
, 
	`T
("%s/%s/%s"), 
	`websGëDeÁu…Dú
(),

90 
CGI_BIN
, 
cgiName
);

91 #i‚de‡
VXWORKS


98 
g°©_t
 
sbuf
;

99 i‡(
	`g°©
(
cgiP©h
, &
sbuf
Ë!0 || (sbuf.
°_mode
 & 
S_IFREG
) == 0) {

100 
	`websEº‹
(
wp
, 404, 
	`T
("CGIÖrocess file doesÇotÉxist"));

101 
	`b‰ì
(
B_L
, 
cgiP©h
);

104 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

105 i‡(
	`g°r°r
(
cgiP©h
, 
	`T
(".exe")Ë=
NULL
 &&

106 
	`g°r°r
(
cgiP©h
, 
	`T
(".b©")Ë=
NULL
) {

107 #ñi‡(
	`deföed
 (
NW
))

108 i‡(
	`g°r°r
(
cgiP©h
, 
	`T
(".∆m")Ë=
NULL
) {

110 i‡(
	`gac˚ss
(
cgiP©h
, 
X_OK
) != 0) {

112 
	`websEº‹
(
wp
, 200, 
	`T
("CGIÖrocess file isÇotÉxecutable"));

113 
	`b‰ì
(
B_L
, 
cgiP©h
);

123 
	`ggëcwd
(
cwd
, 
FNAMESIZE
);

127 i‡((
˝
 = 
	`g°ºchr
(
cgiP©h
, '/')Ë!
NULL
) {

128 *
˝
 = '\0';

129 
	`gchdú
(
cgiP©h
);

130 *
˝
 = '/';

143 
¨gpsize
 = 10;

144 
¨gp
 = 
	`bÆloc
(
B_L
, 
¨gpsize
 * (
ch¨_t
 *));

145 *
¨gp
 = 
cgiP©h
;

146 
n
 = 1;

147 i‡(
	`g°rchr
(
quîy
, '='Ë=
NULL
) {

148 
	`websDecodeUæ
(
quîy
, quîy, 
	`g°æí
(query));

149 
˝
 = 
	`g°πok
(
quîy
, 
	`T
(" ")); c∞!
NULL
; ) {

150 *(
¨gp
+
n
Ë
˝
;

151 
n
++;

152 i‡(
n
 >
¨gpsize
) {

153 
¨gpsize
 *= 2;

154 
¨gp
 = 
	`bªÆloc
(
B_L
,árgp, 
¨gpsize
 * (
ch¨_t
 *));

156 
˝
 = 
	`g°πok
(
NULL
, 
	`T
(" "));

159 *(
¨gp
+
n
Ë
NULL
;

170 
ívpsize
 = 
WEBS_SYM_INIT
;

171 
ívp
 = 
	`bÆloc
(
B_L
, 
ívpsize
 * (
ch¨_t
 *));

172 
n
 = 0;

173 
	`fmtAŒoc
(
ívp
+
n
, 
FNAMESIZE
, 
	`T
("%s=%s"),T("PATH_TRANSLATED"), 
cgiP©h
);

174 
n
++;

175 
	`fmtAŒoc
(
ívp
+
n
, 
FNAMESIZE
, 
	`T
("%s=%s/%s"),T("SCRIPT_NAME"),

176 
CGI_BIN
, 
cgiName
);

177 
n
++;

178 
	`fmtAŒoc
(
ívp
+
n
, 
FNAMESIZE
, 
	`T
("%s=%s"),T("REMOTE_USER"), 
wp
->
u£rName
);

179 
n
++;

180 
	`fmtAŒoc
(
ívp
+
n
, 
FNAMESIZE
, 
	`T
("%s=%s"),T("AUTH_TYPE"), 
wp
->
authTy≥
);

181 
n
++;

182 
s
 = 
	`symFú°
(
wp
->
cgiV¨s
); s !
NULL
; s = 
	`symNext
(wp->cgiVars)) {

183 i‡(
s
->
c⁄ã¡
.
vÆid
 && s->c⁄ã¡.
ty≥
 =
°rög
 &&

184 
	`g°rcmp
(
s
->
«me
.
vÆue
.
°rög
, 
	`T
("REMOTE_HOST")) != 0 &&

185 
	`g°rcmp
(
s
->
«me
.
vÆue
.
°rög
, 
	`T
("HTTP_AUTHORIZATION")) != 0) {

186 
	`fmtAŒoc
(
ívp
+
n
, 
FNAMESIZE
, 
	`T
("%s=%s"), 
s
->
«me
.
vÆue
.
°rög
,

187 
s
->
c⁄ã¡
.
vÆue
.
°rög
);

188 
n
++;

189 i‡(
n
 >
ívpsize
) {

190 
ívpsize
 *= 2;

191 
ívp
 = 
	`bªÆloc
(
B_L
,Énvp, 
ívpsize
 * (
ch¨_t
 *));

195 *(
ívp
+
n
Ë
NULL
;

200 i‡(
wp
->
cgiStdö
 =
NULL
) {

201 
wp
->
cgiStdö
 = 
	`websGëCgiCommName
();

203 
°dIn
 = 
wp
->
cgiStdö
;

204 
°dOut
 = 
	`websGëCgiCommName
();

209 i‡((
pH™dÀ
 = 
	`websLaunchCgiProc
(
cgiP©h
, 
¨gp
, 
ívp
, 
°dIn
, 
°dOut
))

211 
	`websEº‹
(
wp
, 200, 
	`T
("failedÅo spawn CGIÅask"));

212 
ï
 = 
ívp
; *ï !
NULL
;Ép++) {

213 
	`b‰ìSa„
(
B_L
, *
ï
);

215 
	`b‰ìSa„
(
B_L
, 
cgiP©h
);

216 
	`b‰ìSa„
(
B_L
, 
¨gp
);

217 
	`b‰ìSa„
(
B_L
, 
ívp
);

218 
	`b‰ìSa„
(
B_L
, 
°dOut
);

224 
cid
 = 
	`hAŒocE¡ry
((***Ë&
cgiLi°
, &
cgiMax
, (
cgiRec
));

225 
cgù
 = 
cgiLi°
[
cid
];

226 
cgù
->
h™dÀ
 = 
pH™dÀ
;

227 
cgù
->
°dIn
 = stdIn;

228 
cgù
->
°dOut
 = stdOut;

229 
cgù
->
cgiP©h
 = cgiPath;

230 
cgù
->
¨gp
 =árgp;

231 
cgù
->
ívp
 =Énvp;

232 
cgù
->
wp
 = wp;

233 
cgù
->
Âœ˚m¨k
 = 0;

234 
	`websTimeoutC™˚l
(
wp
);

239 
	`gchdú
(
cwd
);

241 
	}
}

247 
	$websCgiG©hîOuçut
 (
cgiRec
 *
cgù
)

249 
g°©_t
 
sbuf
;

250 
ch¨_t
 
cgiBuf
[
FNAMESIZE
];

251 #i‡
	`deföed
(
WIN32
)

252 
î∫o_t
 
îr‹
;

255 i‡((
	`g°©
(
cgù
->
°dOut
, &
sbuf
) == 0) &&

256 (
sbuf
.
°_size
 > 
cgù
->
Âœ˚m¨k
)) {

257 
fdout
;

258 #i‡!
	`deföed
(
WIN32
)

259 
fdout
 = 
	`g›í
(
cgù
->
°dOut
, 
O_RDONLY
 | 
O_BINARY
, 0444 );

261 
îr‹
 = 
	`_s›í_s
(&
fdout
, 
cgù
->
°dOut
, 
O_RDONLY
 | 
O_BINARY
, 
_SH_DENYNO
, 0444);

268 i‡(
fdout
 >= 0) {

269 
webs_t
 
wp
 = 
cgù
->wp;

270 
nRód
;

274 i‡(
cgù
->
Âœ˚m¨k
 == 0) {

275 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.0 200 OK\r\n"));

277 
	`gl£ek
(
fdout
, 
cgù
->
Âœ˚m¨k
, 
SEEK_SET
);

278 (
nRód
 = 
	`gªad
(
fdout
, 
cgiBuf
, 
FNAMESIZE
)) > 0) {

279 
	`websWrôeBlock
(
wp
, 
cgiBuf
, 
nRód
);

280 
cgù
->
Âœ˚m¨k
 +
nRód
;

282 
	`g˛o£
(
fdout
);

285 
	}
}

294 
	$websCgiCÀ™up
()

296 
cgiRec
 *
cgù
;

297 
webs_t
 
wp
;

298 
ch¨_t
 **
ï
;

299 
cid
, 
nTrõs
;

300 
cid
 = 0; cid < 
cgiMax
; cid++) {

301 i‡((
cgù
 = 
cgiLi°
[
cid
]Ë!
NULL
) {

302 
wp
 = 
cgù
->wp;

303 
	`websCgiG©hîOuçut
 (
cgù
);

304 i‡(
	`websCheckCgiProc
(
cgù
->
h™dÀ
) == 0) {

308 
nTrõs
 = 0;

313 (
cgù
->
Âœ˚m¨k
 =0Ë&& (
nTrõs
 < 100)) {

314 
	`websCgiG©hîOuçut
(
cgù
);

319 i‡(
cgù
->
Âœ˚m¨k
 == 0) {

320 #ifde‡
WIN


321 
	`SÀï
(10);

324 
nTrõs
++;

326 i‡(
cgù
->
Âœ˚m¨k
 == 0) {

327 
	`websEº‹
(
wp
, 200, 
	`T
("CGI generatedÇo output"));

329 
	`websD⁄e
(
wp
, 200);

334 
	`gu∆ök
(
cgù
->
°dIn
);

335 
	`gu∆ök
(
cgù
->
°dOut
);

341 
cgiMax
 = 
	`hFªe
((***Ë&
cgiLi°
, 
cid
);

342 
ï
 = 
cgù
->
ívp
;É∞!
NULL
 && *ep != NULL;Ép++) {

343 
	`b‰ìSa„
(
B_L
, *
ï
);

345 
	`b‰ìSa„
(
B_L
, 
cgù
->
cgiP©h
);

346 
	`b‰ìSa„
(
B_L
, 
cgù
->
¨gp
);

347 
	`b‰ìSa„
(
B_L
, 
cgù
->
ívp
);

348 
	`b‰ìSa„
(
B_L
, 
cgù
->
°dOut
);

349 
	`b‰ìSa„
(
B_L
, 
cgù
);

353 
	}
}

364 #ifde‡
CE


371 
ch¨_t
 *
	$websGëCgiCommName
()

378 
ch¨_t
 *
≤ame1
, *
≤ame2
;

380 
≤ame1
 = 
	`gtm≤am
(
NULL
, 
	`T
("cgi"));

381 
≤ame2
 = 
	`b°rdup
(
B_L
, 
≤ame1
);

382 
	`‰ì
(
≤ame1
);

383  
≤ame2
;

385  
NULL
;

386 
	}
}

395 
	$websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
, ch¨_à**
ívp
,

396 
ch¨_t
 *
°dIn
, ch¨_à*
°dOut
)

398 
PROCESS_INFORMATION
 
¥ocöfo
;

399 
DWORD
 
dwCª©eFœgs
;

400 *
fuŒdú
;

401 
BOOL
 
bRëu∫
;

402 
i
, 
nLí
;

407 
nLí
 = 
	`g°æí
(
cgiP©h
);

408 
i
 = 0; i < 
nLí
; i++) {

409 i‡(
cgiP©h
[
i
] == '/') {

410 
cgiP©h
[
i
] = '\\';

414 
fuŒdú
 = 
NULL
;

415 
dwCª©eFœgs
 = 
CREATE_NEW_CONSOLE
;

422 
¥ocöfo
.
hThªad
 = 
NULL
;

423 
bRëu∫
 = 
	`Cª©ePro˚ss
(

424 
cgiP©h
,

425 
NULL
,

426 
NULL
,

427 
NULL
,

429 
dwCª©eFœgs
,

430 
NULL
,

431 
NULL
,

432 
NULL
,

433 &
¥ocöfo
);

435 i‡(
bRëu∫
 == 0) {

436 
DWORD
 
dw
;

437 
dw
 = 
	`GëLa°Eº‹
();

440 
	`Clo£H™dÀ
(
¥ocöfo
.
hThªad
);

442  (Ë
¥ocöfo
.
dwPro˚ssId
;

443 
	}
}

449 
	$websCheckCgiProc
(
h™dÀ
)

451 
nRëu∫
;

452 
DWORD
 
exôCode
;

454 
nRëu∫
 = 
	`GëExôCodePro˚ss
((
HANDLE
)
h™dÀ
, &
exôCode
);

459 i‡((
nRëu∫
 =0Ë|| (
exôCode
 !
STILL_ACTIVE
)) {

460 
	`Clo£H™dÀ
((
HANDLE
)
h™dÀ
);

465 
	}
}

471 #i‡
deföed
(
LINUX
Ë|| deföed(
LYNX
Ë|| deföed(
MACOSX
Ë|| deföed(
QNX4
)

473 
	~<sys/waô.h
>

480 
ch¨_t
 *
	$websGëCgiCommName
()

482 
ch¨_t
 *
≤ame1
, *
≤ame2
;

484 
≤ame1
 = 
	`ãm≤am
(
NULL
, 
	`T
("cgi"));

485 
≤ame2
 = 
	`b°rdup
(
B_L
, 
≤ame1
);

486 
	`‰ì
(
≤ame1
);

487  
≤ame2
;

488 
	}
}

495 
	$websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
, ch¨_à**
ívp
,

496 
ch¨_t
 *
°dIn
, ch¨_à*
°dOut
)

498 
pid
, 
fdö
, 
fdout
, 
h°dö
, 
h°dout
, 
rc
;

500 
fdö
 = 
fdout
 = 
h°dö
 = 
h°dout
 = 
rc
 = -1;

501 i‡((
fdö
 = 
	`›í
(
°dIn
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0 ||

502 (
fdout
 = 
	`›í
(
°dOut
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0 ||

503 (
h°dö
 = 
	`dup
(0)) == -1 ||

504 (
h°dout
 = 
	`dup
(1)) == -1 ||

505 
	`dup2
(
fdö
, 0) == -1 ||

506 
	`dup2
(
fdout
, 1) == -1) {

507 
DONE
;

510 
rc
 = 
pid
 = 
	`f‹k
();

511 i‡(
pid
 == 0) {

515 i‡(
	`execve
(
cgiP©h
, 
¨gp
, 
ívp
) == -1) {

516 
	`¥ötf
("content-type:Åext/html\n\n"

519 
	`exô
 (0);

522 
DONE
:

523 i‡(
h°dout
 >= 0) {

524 
	`dup2
(
h°dout
, 1);

525 
	`˛o£
(
h°dout
);

527 i‡(
h°dö
 >= 0) {

528 
	`dup2
(
h°dö
, 0);

529 
	`˛o£
(
h°dö
);

531 i‡(
fdout
 >= 0) {

532 
	`˛o£
(
fdout
);

534 i‡(
fdö
 >= 0) {

535 
	`˛o£
(
fdö
);

537  
rc
;

538 
	}
}

544 
	$websCheckCgiProc
(
h™dÀ
)

549 i‡(
	`waôpid
(
h™dÀ
, 
NULL
, 
WNOHANG
) == handle) {

554 
	}
}

561 #ifde‡
NW


569 
ch¨_t
 *
	$websGëCgiCommName
()

571 
ch¨_t
 *
≤ame
;

573 
≤ame
 = 
	`b°rdup
(
B_L
, 
	`tm≤am
–
NULL
 ) );

574  
≤ame
;

575 
	}
}

581 
	$websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
, ch¨_à**
ívp
,

582 
ch¨_t
 *
°dIn
, ch¨_à*
°dOut
)

584 
pid
, 
fdö
, 
fdout
, 
h°dö
, 
h°dout
, 
rc
;

586 
fdö
 = 
fdout
 = -1;

587 i‡((
fdö
 = 
	`›í
(
°dIn
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0 ||

588 (
fdout
 = 
	`›í
(
°dOut
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0 )

589 
DONE
;

602 
rc
 = 
	`•awnvp
–
P_NOWAIT
, 
cgiP©h
, 
¨gp
 ) ;

604 if–
rc
 != 0) {

605 
	`exô
 (0);

608 
DONE
:

609 i‡(
fdout
 >= 0) {

610 
	`˛o£
(
fdout
);

612 i‡(
fdö
 >= 0) {

613 
	`˛o£
(
fdö
);

615  
rc
;

616 
	}
}

622 
	$websCheckCgiProc
(
h™dÀ
)

627 if–
h™dÀ
 ) {

632 
	}
}

639 #ifde‡
VXWORKS


641 
vxWebsCgiE¡ry
(*
íåyAddr
(
¨gc
, 
ch¨_t
 **
¨gv
),

642 
ch¨_t
 **
¨gv
, ch¨_à**
ívp
, ch¨_à*
°dIn
, ch¨_à*
°dOut
);

649 
ch¨_t
 *
	$websGëCgiCommName
()

651 
ch¨_t
 *
äame
, 
buf
[
FNAMESIZE
];

653 
	`fmtAŒoc
(&
äame
,
FNAMESIZE
, 
	`T
("%s/%s"), 
	`ggëcwd
(
buf
, FNAMESIZE),

654 
	`tm≤am
(
NULL
));

655  
äame
;

656 
	}
}

688 
	$websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
, ch¨_à**
ívp
,

689 
ch¨_t
 *
°dIn
, ch¨_à*
°dOut
)

691 
SYM_TYPE
 
±y≥
;

692 
ch¨_t
 *
p
, *
ba£«me
, *
pE¡ry
, *
≤ame
, *
íåyAddr
, **
µ
;

693 
¥i‹ôy
, 
rc
, 
fd
;

698 i‡(()(
p
 = 
	`g°ºchr
(
cgiP©h
, '/') + 1) == 1) {

699 
p
 = 
cgiP©h
;

701 
ba£«me
 = 
	`b°rdup
(
B_L
, 
p
);

702 i‡((
p
 = 
	`g°ºchr
(
ba£«me
, '.')Ë!
NULL
) {

703 *
p
 = '\0';

710 
	`u∆d
(
cgiP©h
, 0);

711 
	`èskPri‹ôyGë
(
	`èskIdSñf
(), &
¥i‹ôy
);

712 
rc
 = 
fd
 = -1;

718 
µ
 = 
ívp
, 
pE¡ry
 = 
NULL
;Öp != NULL && *pp != NULL;Öp++) {

719 i‡(
	`g°∫cmp
(*
µ
, 
	`T
("cgientry="), 9) == 0) {

720 
pE¡ry
 = 
	`b°rdup
(
B_L
, *
µ
 + 9);

724 i‡(
pE¡ry
 =
NULL
) {

725 
	`fmtAŒoc
(&
pE¡ry
, 
LF_PATHSIZE
, 
	`T
("%s_%s"), 
ba£«me
, T("cgientry"));

727 
íåyAddr
 = 0;

728 i‡(
	`symFödByName
(
sysSymTbl
, 
pE¡ry
, &
íåyAddr
, &
±y≥
) == -1) {

729 
	`fmtAŒoc
(&
≤ame
, 
VALUE_MAX_STRING
, 
	`T
("_%s"), 
pE¡ry
);

730 
	`symFödByName
(
sysSymTbl
, 
≤ame
, &
íåyAddr
, &
±y≥
);

731 
	`b‰ìSa„
(
B_L
, 
≤ame
);

733 i‡(
íåyAddr
 != 0) {

734 
rc
 = 
	`èskS∑wn
(
pE¡ry
, 
¥i‹ôy
, 0, 20000, (*)
vxWebsCgiE¡ry
,

735 ()
íåyAddr
, ()
¨gp
, ()
ívp
, ()
°dIn
, ()
°dOut
,

737 
DONE
;

743 i‡((
fd
 = 
	`g›í
(
cgiP©h
, 
O_RDONLY
 | 
O_BINARY
, 0666)) < 0 ||

744 
	`lﬂdModuÀ
(
fd
, 
LOAD_GLOBAL_SYMBOLS
Ë=
NULL
) {

745 
DONE
;

747 i‡((
	`symFödByName
(
sysSymTbl
, 
pE¡ry
, &
íåyAddr
, &
±y≥
)) == -1) {

748 
	`fmtAŒoc
(&
≤ame
, 
VALUE_MAX_STRING
, 
	`T
("_%s"), 
pE¡ry
);

749 
	`symFödByName
(
sysSymTbl
, 
≤ame
, &
íåyAddr
, &
±y≥
);

750 
	`b‰ìSa„
(
B_L
, 
≤ame
);

752 i‡(
íåyAddr
 != 0) {

753 
rc
 = 
	`èskS∑wn
(
pE¡ry
, 
¥i‹ôy
, 0, 20000, (*)
vxWebsCgiE¡ry
,

754 ()
íåyAddr
, ()
¨gp
, ()
ívp
, ()
°dIn
, ()
°dOut
,

758 
DONE
:

759 i‡(
fd
 != -1) {

760 
	`g˛o£
(
fd
);

762 
	`b‰ì
(
B_L
, 
ba£«me
);

763 
	`b‰ì
(
B_L
, 
pE¡ry
);

764  
rc
;

765 
	}
}

774 
vxWebsCgiE¡ry
(*
íåyAddr
(
¨gc
, 
ch¨_t
 **
¨gv
),

775 
ch¨_t
 **
¨gp
, ch¨_à**
ívp
, ch¨_à*
°dIn
, ch¨_à*
°dOut
)

777 
ch¨_t
 **
	gp
;

778 
	g¨gc
, 
	gèskId
, 
	gfdö
, 
	gfdout
;

784 
	gèskId
 = 
èskIdSñf
();

785 i‡((
	gfdout
 = 
g›í
(
°dOut
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0 &&

786 (
	gfdout
 = 
¸ót
(
°dOut
, 
O_RDWR
)) < 0) {

787 
exô
(0);

789 
ioTaskStdSë
(
èskId
, 1, 
fdout
);

791 i‡((
	gfdö
 = 
g›í
(
°dIn
, 
O_RDONLY
 | 
O_CREAT
, 0666)) < 0 &&

792 (
	gfdö
 = 
¸ót
(
°dIn
, 
O_RDWR
)) < 0) {

793 
¥ötf
("content-type:Åext/html\n\n"

794 "C™ÇŸ cª©êCGI stdöÅÿ%s\n", 
°dIn
);

795 
g˛o£
(
fdout
);

796 
exô
 (0);

798 
ioTaskStdSë
(
èskId
, 0, 
fdö
);

803 
	g¨gc
 = 0, 
	gp
 = 
¨gp
;Ö !
NULL
 && *
p
 != NULL;Ö++,árgc++) {

809 i‡(
ívPriv©eCª©e
(
èskId
, -1Ë!
OK
) {

810 
¥ötf
("content-type:Åext/html\n\n"

812 
g˛o£
(
fdö
);

813 
g˛o£
(
fdout
);

814 
exô
 (0);

816 
	gp
 = 
ívp
;Ö !
NULL
 && *
p
 != NULL;Ö++) {

817 
puãnv
(*
p
);

823 (*
	gíåyAddr
)(
	g¨gc
, 
	g¨gp
);

829 
ívPriv©eDe°roy
(
èskId
);

830 
g˛o£
(
fdö
);

831 
g˛o£
(
fdout
);

832 
exô
(0);

840 
	$websCheckCgiProc
(
h™dÀ
)

842 
STATUS
 
°©
;

846 
°©
 = 
	`èskIdVîify
(
h™dÀ
);

848 i‡(
°©
 =
OK
) {

853 
	}
}

859 #ifde‡
WIN


871 *
	$èbÀToBlock
(**
èbÀ
)

873 *
pBlock
;

874 *
pE¡ry
;

875 
size_t
 
sizeBlock
;

876 
ödex
;

878 
	`a_as£π
(
èbÀ
);

883 
sizeBlock
 = 1;

884 
ödex
 = 0; 
èbÀ
[index]; index++) {

885 
sizeBlock
 +
	`°æí
(
èbÀ
[
ödex
]) + 1;

891 
pBlock
 = 
	`bÆloc
(
B_L
, 
sizeBlock
);

893 i‡(
pBlock
 !
NULL
) {

894 
pE¡ry
 = (*Ë
pBlock
;

896 
ödex
 = 0; 
èbÀ
[index]; index++) {

897 
	`°r˝y
(
pE¡ry
, 
èbÀ
[
ödex
]);

898 
pE¡ry
 +
	`°æí
(pEntry) + 1;

904 *
pE¡ry
 = '\0';

907  
pBlock
;

908 
	}
}

915 
ch¨_t
 *
	$websGëCgiCommName
()

917 
ch¨_t
 *
≤ame1
, *
≤ame2
;

919 
≤ame1
 = 
	`ãm≤am
(
NULL
, 
	`T
("cgi"));

920 
≤ame2
 = 
	`b°rdup
(
B_L
, 
≤ame1
);

921 
	`‰ì
(
≤ame1
);

922  
≤ame2
;

923 
	}
}

930 
	$websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
, ch¨_à**
ívp
,

931 
ch¨_t
 *
°dIn
, ch¨_à*
°dOut
)

933 
STARTUPINFO
 
√wöfo
;

934 
SECURITY_ATTRIBUTES
 
£curôy
;

935 
PROCESS_INFORMATION
 
¥ocöfo
;

936 
DWORD
 
dwCª©eFœgs
;

937 
ch¨_t
 *
cmdLöe
;

938 
ch¨_t
 **
pArgs
;

939 
BOOL
 
bRëu∫
;

940 
i
, 
nLí
;

941 *
pEnvD©a
;

946 
nLí
 = 
	`g°æí
(
cgiP©h
);

947 
i
 = 0; i < 
nLí
; i++) {

948 i‡(
cgiP©h
[
i
] == '/') {

949 
cgiP©h
[
i
] = '\\';

955 
nLí
 = 0;

956 
pArgs
 = 
¨gp
;

957 
pArgs
 && *pArgs && **pArgs) {

958 
nLí
 +
	`g°æí
(*
pArgs
) + 1;

959 
pArgs
++;

964 
cmdLöe
 = 
	`bÆloc
(
B_L
, (
ch¨_t
Ë* 
nLí
);

965 
	`a_as£π
 (
cmdLöe
);

966 
	`g°r˝y
(
cmdLöe
, "");

968 
pArgs
 = 
¨gp
;

969 
pArgs
 && *pArgs && **pArgs) {

970 
	`g°rˇt
(
cmdLöe
, *
pArgs
);

971 
	`g°rˇt
(
cmdLöe
, 
	`T
(" "));

972 
pArgs
++;

978 
	`mem£t
 (&
√wöfo
, 0, (newinfo));

979 
√wöfo
.
cb
 = (newinfo);

980 
√wöfo
.
dwFœgs
 = 
STARTF_USESHOWWINDOW
 | 
STARTF_USESTDHANDLES
;

981 
√wöfo
.
wShowWödow
 = 
SW_HIDE
;

982 
√wöfo
.
ÕTôÀ
 = 
NULL
;

987 
£curôy
.
nLígth
 = (
SECURITY_ATTRIBUTES
);

988 
£curôy
.
ÕSecurôyDes¸ùt‹
 = 
NULL
;

989 
£curôy
.
bInhîôH™dÀ
 = 
TRUE
;

994 
√wöfo
.
hStdI≈ut
 = 
	`Cª©eFûe
(
°dIn
, 
GENERIC_READ
,

995 
FILE_SHARE_READ
, &
£curôy
, 
OPEN_ALWAYS
, 
FILE_ATTRIBUTE_NORMAL
, 
NULL
);

999 
√wöfo
.
hStdOuçut
 = 
	`Cª©eFûe
(
°dOut
, 
GENERIC_READ
 | 
GENERIC_WRITE
,

1000 
FILE_SHARE_READ
 + 
FILE_SHARE_WRITE
, &
£curôy
, 
OPEN_ALWAYS
,

1001 
FILE_ATTRIBUTE_NORMAL
, 
NULL
);

1002 
	`SëFûePoöãr
 (
√wöfo
.
hStdOuçut
, 0, 
NULL
, 
FILE_END
);

1007 
√wöfo
.
hStdEº‹
 =Çewöfo.
hStdOuçut
;

1009 
dwCª©eFœgs
 = 
CREATE_NEW_CONSOLE
;

1010 
pEnvD©a
 = 
	`èbÀToBlock
(
ívp
);

1017 
¥ocöfo
.
hPro˚ss
 = 
NULL
;

1018 
bRëu∫
 = 
	`Cª©ePro˚ss
(

1019 
NULL
,

1020 
cmdLöe
,

1021 
NULL
,

1022 
NULL
,

1023 
TRUE
,

1024 
dwCª©eFœgs
,

1025 
pEnvD©a
,

1026 
NULL
,

1027 &
√wöfo
,

1028 &
¥ocöfo
);

1030 i‡(
¥ocöfo
.
hThªad
 !
NULL
) {

1031 
	`Clo£H™dÀ
(
¥ocöfo
.
hThªad
);

1034 i‡(
√wöfo
.
hStdI≈ut
) {

1035 
	`Clo£H™dÀ
(
√wöfo
.
hStdI≈ut
);

1038 i‡(
√wöfo
.
hStdOuçut
) {

1039 
	`Clo£H™dÀ
(
√wöfo
.
hStdOuçut
);

1042 
	`b‰ì
(
B_L
, 
pEnvD©a
);

1043 
	`b‰ì
(
B_L
, 
cmdLöe
);

1045 i‡(
bRëu∫
 == 0) {

1048  (Ë
¥ocöfo
.
hPro˚ss
;

1050 
	}
}

1057 
	$websCheckCgiProc
(
h™dÀ
)

1059 
nRëu∫
;

1060 
DWORD
 
exôCode
;

1062 
nRëu∫
 = 
	`GëExôCodePro˚ss
((
HANDLE
)
h™dÀ
, &
exôCode
);

1067 i‡((
nRëu∫
 =0Ë|| (
exôCode
 !
STILL_ACTIVE
)) {

1068 
	`Clo£H™dÀ
((
HANDLE
)
h™dÀ
);

1073 
	}
}

	@default.c

26 
	~"wsI¡∫.h
"

30 
ch¨_t
 *
	gwebsDeÁu…Page
;

31 
ch¨_t
 *
	gwebsDeÁu…Dú
;

34 
	#MAX_URL_DEPTH
 8

	)

36 #ifde‡
WEBS_WHITELIST_SUPPORT


38 #i‚de‡
WIN


39 
	~<dúít.h
>

43 
	#WHITELIST_BLOCKED
 0x100

	)

44 
	#WHITELIST_DIR
 0x200

	)

46 #ifde‡
WEBS_SSL_SUPPORT


47 
	s_s¶Li°
 {

48 
_s¶Li°
 *
	m√xt
;

49 *
	muæ
;

50 } 
	ts¶Li°_t
;

52 
s¶Li°_t
 *
	gs¶Li°
;

55 
	s_fûeNode
 {

56 
_fûeNode
 *
	m√xt
;

57 
_fûeNode
 *
	mchûd
;

58 *
	m«me
;

59 
	mÊags
;

60 } 
	tfûeNode_t
;

62 
fûeNode_t
 *
	gwhôñi°
 = 
NULL
;

64 
websBuûdWhôñi°Recursive
(*
_∑th
, 
fûeNode_t
 *
dú
, 
Àvñ
);

65 
fûeNode_t
* 
websWhôñi°CheckRecursive
(fûeNode_à*
n
, *
∑th
);

66 
websDñëeWhôñi°Recursive
(
fûeNode_t
 *
dú
);

67 
websMakeP©h
(*
d
, *
§c
, *
subdú
, 
wûdˇrd
);

69 
	#websBuûdWhôñi°
()

	)

72 
websDeÁu…WrôeEvít
(
webs_t
 
wp
);

82 
	$websDeÁu…H™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
,

83 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

85 
websSètTy≥
 
sbuf
;

86 
ch¨_t
 *
Õ©h
, *
tmp
, *
d©e
;

87 
byãs
, 
Êags
, 
nch¨s
, 
rc
;

89 
	`a_as£π
(
	`websVÆid
(
wp
));

90 
	`a_as£π
(
uæ
 && *url);

91 
	`a_as£π
(
∑th
);

92 
	`a_as£π
(
quîy
);

94 
Êags
 = 
	`websGëReque°Fœgs
(
wp
);

102 #ifde‡
WEBS_WHITELIST_SUPPORT


103 i‡((
rc
 = 
	`websWhôñi°Check
(
wp
->
uæ
)) < 0) {

104 
	`websBuûdWhôñi°
();

105 i‡((
rc
 = 
	`websWhôñi°Check
(
wp
->
uæ
)) < 0) {

106 
	`websEº‹
(
wp
, 404, 
	`T
("Cannot open URL"));

110 i‡(!(
Êags
 & 
WEBS_SECURE
Ë&& (
rc
 & 
WHITELIST_SSL
)) {

111 
	`websEº‹
(
wp
, 500, 
	`T
("HTTPSáccessÑequired"));

118 i‡(
	`websVÆid©eUæ
(
wp
, 
∑th
) < 0) {

124 
	`websEº‹
(
wp
, 500, 
	`T
("Invalid URL"));

125 
	`websBuûdWhôñi°
();

128 
Õ©h
 = 
	`websGëReque°L∑th
(
wp
);

129 
nch¨s
 = 
	`g°æí
(
Õ©h
) - 1;

130 i‡(
Õ©h
[
nch¨s
] == '/' ||Üpath[nchars] == '\\') {

131 
Õ©h
[
nch¨s
] = '\0';

137 i‡(
	`websPageIsDúe˘‹y
(
Õ©h
)) {

138 
nch¨s
 = 
	`g°æí
(
∑th
);

139 i‡(
∑th
[
nch¨s
-1] == '/' ||Öath[nchars-1] == '\\') {

140 
∑th
[--
nch¨s
] = '\0';

142 
nch¨s
 +
	`g°æí
(
websDeÁu…Page
) + 2;

143 
	`fmtAŒoc
(&
tmp
, 
nch¨s
, 
	`T
("%s/%s"), 
∑th
, 
websDeÁu…Page
);

144 
	`websRedúe˘
(
wp
, 
tmp
);

145 
	`b‰ìSa„
(
B_L
, 
tmp
);

152 i‡(
	`websPageO≥n
(
wp
, 
Õ©h
, 
∑th
, 
O_RDONLY
 | 
O_BINARY
,

166 
	`websEº‹
(
wp
, 404, 
	`T
("Cannot open URL"));

167 
	`websBuûdWhôñi°
();

171 i‡(
	`websPageSèt
(
wp
, 
Õ©h
, 
∑th
, &
sbuf
) < 0) {

177 
	`websEº‹
(
wp
, 400, 
	`T
("Cannot statÖage for URL"));

178 
	`websBuûdWhôñi°
();

187 
websSèts
.
loˇlHôs
++;

188 #ifde‡
WEBS_IF_MODIFIED_SUPPORT


189 i‡(
Êags
 & 
WEBS_IF_MODIFIED
 && !(Êag†& 
WEBS_ASP
)) {

190 i‡(
sbuf
.
mtime
 <
wp
->
sö˚
) {

191 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.0 304 UseÜocal copy\r\n"));

197 
	`websWrôe
(
wp
, 
	`T
("Sîvî: %s\r\n"), 
WEBS_NAME
);

199 i‡(
Êags
 & 
WEBS_KEEP_ALIVE
) {

200 
	`websWrôe
(
wp
, 
	`T
("Connection: keep-alive\r\n"));

202 
	`websWrôe
(
wp
, 
	`T
("\r\n"));

203 
	`websSëReque°Fœgs
(
wp
, 
Êags
 |
WEBS_HEADER_DONE
);

204 
	`websD⁄e
(
wp
, 304);

213 i‡((
d©e
 = 
	`websGëD©eSåög
(
NULL
)) != NULL) {

214 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.0 200 OK\r\nD©e: %s\r\n"), 
d©e
);

219 #ifde‡
WEBS_SSL_SUPPORT


220 
	`websWrôe
(
wp
, 
	`T
("Server: %s/%s %s/%s\r\n"),

221 
WEBS_NAME
, 
WEBS_VERSION
, 
SSL_NAME
, 
SSL_VERSION
);

223 
	`websWrôe
(
wp
, 
	`T
("Sîvî: %s/%s\r\n"), 
WEBS_NAME
, 
WEBS_VERSION
);

225 
	`b‰ì
(
B_L
, 
d©e
);

227 
Êags
 |
WEBS_HEADER_DONE
;

233 i‡(
Êags
 & 
WEBS_ASP
) {

234 
byãs
 = 0;

235 
	`websWrôe
(
wp
, 
	`T
("Pragma:Ço-cache\r\nCache-Control:Ço-cache\r\n"));

238 i‡((
d©e
 = 
	`websGëD©eSåög
(&
sbuf
)Ë!
NULL
) {

239 
	`websWrôe
(
wp
, 
	`T
("La°-modifõd: %s\r\n"), 
d©e
);

240 
	`b‰ì
(
B_L
, 
d©e
);

242 
byãs
 = 
sbuf
.
size
;

245 i‡(
byãs
) {

246 
	`websWrôe
(
wp
, 
	`T
("C⁄ã¡-Àngth: %d\r\n"), 
byãs
);

247 
	`websSëReque°Byãs
(
wp
, 
byãs
);

249 
	`websWrôe
(
wp
, 
	`T
("C⁄ã¡-ty≥: %s\r\n"), 
	`websGëReque°Ty≥
(wp));

251 i‡((
Êags
 & 
WEBS_KEEP_ALIVE
Ë&& !(Êag†& 
WEBS_ASP
)) {

252 
	`websWrôe
(
wp
, 
	`T
("Connection: keep-alive\r\n"));

254 
	`websWrôe
(
wp
, 
	`T
("\r\n"));

259 i‡(
Êags
 & 
WEBS_HEAD_REQUEST
) {

260 
	`websD⁄e
(
wp
, 200);

267 i‡(
Êags
 & 
WEBS_ASP
) {

268 i‡(
	`websA•Reque°
(
wp
, 
Õ©h
) < 0) {

271 
	`websD⁄e
(
wp
, 200);

277 
	`websSëReque°SockëH™dÀr
(
wp
, 
SOCKET_WRITABLE
, 
websDeÁu…WrôeEvít
);

279 
	}
}

281 #ifde‡
WIN32


283 
	$badP©h
(
ch¨_t
* 
∑th
, ch¨_t* 
badP©h
, 
badLí
)

285 
ªtvÆ
 = 0;

286 
Àn
 = 
	`g°æí
(
∑th
);

287 
i
 = 0;

289 i‡(
Àn
 <
badLí
 +1)

291 
i
 = 0; i < 
badLí
; ++i)

293 i‡(
badP©h
[
i
] !
	`gtﬁowî
(
∑th
[i]))

302 
ªtvÆ
 = 1;

303 i‡(
badLí
 + 1 =
Àn
)

306 i‡(
	`giß um
(
∑th
[
Àn
-1]))

311 
ªtvÆ
 = 0;

315  
ªtvÆ
;

316 
	}
}

318 
	$isBadWödowsP©h
(
ch¨_t
** 
∑πs
, 
∑πCou¡
)

352 
OSVERSIONINFO
 
vîsi⁄
;

353 
i
;

354 
vîsi⁄
.
dwOSVîsi⁄InfoSize
 = (
OSVERSIONINFO
);

355 i‡(
	`GëVîsi⁄Ex
(&
vîsi⁄
))

357 i‡(
VER_PLATFORM_WIN32_NT
 !
vîsi⁄
.
dwPœtf‹mId
)

362 
i
 = 0; i < 
∑πCou¡
; ++i)

369 (
	`badP©h
(
∑πs
[
i
], 
	`T
("con"), 3)) ||

370 (
	`badP©h
(
∑πs
[
i
], 
	`T
("com"), 3)) ||

371 (
	`badP©h
(
∑πs
[
i
], 
	`T
("nul"), 3)) ||

372 (
	`badP©h
(
∑πs
[
i
], 
	`T
("aux"), 3)) ||

373 (
	`badP©h
(
∑πs
[
i
], 
	`T
("clock$"), 6)) ||

374 (
	`badP©h
(
∑πs
[
i
], 
	`T
("config$"), 7)) ) {

385 
	}
}

394 
	$websVÆid©eUæ
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
)

403 
ch¨_t
 *
∑πs
[
MAX_URL_DEPTH
];

404 
ch¨_t
 *
tokí
, *
dú
, *
Õ©h
;

405 
i
, 
Àn
, 
≈¨t
;

407 
	`a_as£π
(
	`websVÆid
(
wp
));

408 
	`a_as£π
(
∑th
);

410 
dú
 = 
	`websGëReque°Dú
(
wp
);

411 i‡(
dú
 =
NULL
 || *dir == '\0') {

418 
∑th
 = 
	`b°rdup
(
B_L
,Öath);

419 
	`websDecodeUæ
(
∑th
,Ö©h, 
	`g°æí
(path));

421 
Àn
 = 
≈¨t
 = 0;

422 
∑πs
[0] = 
NULL
;

450 
tokí
 = 
	`g°rchr
(
∑th
, '\\');

451 
tokí
 !
NULL
) {

452 *
tokí
 = '/';

453 
tokí
 = 
	`g°rchr
(token, '\\');

455 
tokí
 = 
	`g°πok
(
∑th
, 
	`T
("/"));

461 
tokí
 !
NULL
)

463 i‡(
≈¨t
 >
MAX_URL_DEPTH
)

468 
	`b‰ì
(
B_L
, 
∑th
);

471 i‡(
	`g°rcmp
(
tokí
, 
	`T
("..")) == 0)

473 i‡(
≈¨t
 > 0)

475 
≈¨t
--;

477 } i‡(
	`g°rcmp
(
tokí
, 
	`T
(".")) != 0) {

478 
∑πs
[
≈¨t
] = 
tokí
;

479 
Àn
 +
	`g°æí
(
tokí
) + 1;

480 
≈¨t
++;

482 
tokí
 = 
	`g°πok
(
NULL
, 
	`T
("/"));

485 #ifde‡
WIN32


486 i‡(
	`isBadWödowsP©h
(
∑πs
, 
≈¨t
))

488 
	`b‰ì
(
B_L
, 
∑th
);

497 i‡(
≈¨t
 || (
	`g°rcmp
(
∑th
, 
	`T
("/")) == 0) || (path[0] == '\0')) {

498 
Õ©h
 = 
	`bÆloc
(
B_L
, (
	`g°æí
(
dú
Ë+ 1 + 
Àn
 + 1Ë* (
ch¨_t
));

499 
	`g°r˝y
(
Õ©h
, 
dú
);

501 
i
 = 0; i < 
≈¨t
; i++) {

502 
	`g°rˇt
(
Õ©h
, 
	`T
("/"));

503 
	`g°rˇt
(
Õ©h
, 
∑πs
[
i
]);

505 
	`websSëReque°L∑th
(
wp
, 
Õ©h
);

506 
	`b‰ì
(
B_L
, 
∑th
);

507 
	`b‰ì
(
B_L
, 
Õ©h
);

509 
	`b‰ì
(
B_L
, 
∑th
);

513 
	}
}

521 
	$websDeÁu…WrôeEvít
(
webs_t
 
wp
)

523 
Àn
, 
wrŸe
, 
Êags
, 
byãs
, 
wrôãn
;

524 *
buf
;

526 
	`a_as£π
(
	`websVÆid
(
wp
));

528 
Êags
 = 
	`websGëReque°Fœgs
(
wp
);

530 
	`websSëTimeM¨k
(
wp
);

532 
wrŸe
 = 
byãs
 = 0;

533 
wrôãn
 = 
	`websGëReque°Wrôãn
(
wp
);

538 i‡–!(
Êags
 & 
WEBS_ASP
)) {

539 
byãs
 = 
	`websGëReque°Byãs
(
wp
);

544 i‡((
buf
 = 
	`bÆloc
(
B_L
, 
PAGE_READ_BUFSIZE
)Ë=
NULL
) {

545 
	`websEº‹
(
wp
, 200, 
	`T
("Can't get memory"));

547 (
Àn
 = 
	`websPageRódD©a
(
wp
, 
buf
, 
PAGE_READ_BUFSIZE
)) > 0) {

548 i‡((
wrŸe
 = 
	`websWrôeD©aN⁄Block
(
wp
, 
buf
, 
Àn
)) < 0) {

551 
wrôãn
 +
wrŸe
;

552 i‡(
wrŸe
 !
Àn
) {

553 
	`websPageSìk
(
wp
, - (
Àn
 - 
wrŸe
));

560 i‡(
Àn
 == 0) {

561 
	`a_as£π
(
wrôãn
 >
byãs
);

562 
wrôãn
 = 
byãs
;

564 
	`b‰ì
(
B_L
, 
buf
);

571 
	`websSëReque°Wrôãn
(
wp
, 
wrôãn
);

572 i‡(
wrŸe
 < 0 || 
wrôãn
 >
byãs
) {

573 
	`websD⁄e
(
wp
, 200);

575 
	}
}

582 
	$websDeÁu…O≥n
()

584 #ifde‡
WEBS_WHITELIST_SUPPORT


585 #ifde‡
WEBS_SSL_SUPPORT


586 
s¶Li°
 = 
NULL
;

588 
whôñi°
 = 
NULL
;

589 
	`websBuûdWhôñi°
();

591 
	}
}

598 
	$websDeÁu…Clo£
()

600 #ifde‡
WEBS_WHITELIST_SUPPORT


601 #ifde‡
WEBS_SSL_SUPPORT


602 
s¶Li°_t
 *
l
;

603 
s¶Li°
 !
NULL
) {

604 
l
 = 
s¶Li°
;

605 
s¶Li°
 = s¶Li°->
√xt
;

606 
	`b‰ìSa„
(
B_L
, 
l
->
uæ
);

607 
	`b‰ì
(
B_L
, 
l
);

610 
	`websDñëeWhôñi°
();

612 i‡(
websDeÁu…Page
) {

613 
	`b‰ì
(
B_L
, 
websDeÁu…Page
);

614 
websDeÁu…Page
 = 
NULL
;

616 i‡(
websDeÁu…Dú
) {

617 
	`b‰ì
(
B_L
, 
websDeÁu…Dú
);

618 
websDeÁu…Dú
 = 
NULL
;

620 
	}
}

627 
ch¨_t
 *
	$websGëDeÁu…Page
()

629  
websDeÁu…Page
;

630 
	}
}

637 
ch¨_t
 *
	$websGëDeÁu…Dú
()

639  
websDeÁu…Dú
;

640 
	}
}

647 
	$websSëDeÁu…Page
(
ch¨_t
 *
∑ge
)

649 
	`a_as£π
(
∑ge
 && *page);

651 i‡(
websDeÁu…Page
) {

652 
	`b‰ì
(
B_L
, 
websDeÁu…Page
);

654 
websDeÁu…Page
 = 
	`b°rdup
(
B_L
, 
∑ge
);

655 
	}
}

662 
	$websSëDeÁu…Dú
(
ch¨_t
 *
dú
)

664 
	`a_as£π
(
dú
 && *dir);

665 i‡(
websDeÁu…Dú
) {

666 
	`b‰ì
(
B_L
, 
websDeÁu…Dú
);

668 
websDeÁu…Dú
 = 
	`b°rdup
(
B_L
, 
dú
);

669 
	}
}

671 #ifde‡
WEBS_WHITELIST_SUPPORT


678 
	$websWhôñi°Check
(*
uæ
)

680 
fûeNode_t
 *
n
;

681 i‡((
n
 = 
	`websWhôñi°CheckRecursive
(
whôñi°
, 
uæ
)Ë=
NULL
) {

684  
n
->
Êags
;

685 
	}
}

687 
fûeNode_t
* 
	$websWhôñi°CheckRecursive
(
fûeNode_t
 *
n
, *
∑th
)

689 *
c
, *
p
;

691 i‡(
n
 =
NULL
)  NULL;

692 i‡((
n
->
Êags
 & 
WHITELIST_BLOCKED
) != 0) {

693  
	`websWhôñi°CheckRecursive
(
n
->
√xt
, 
∑th
);

695 i‡(
n
->
«me
) {

696 
c
 = 
n
->
«me
, 
p
 = 
∑th
; *c != '\0' && *p != '\0'; c++,Ö++) {

697 i‡(
	`tﬁowî
(*
c
Ë!tﬁowî(*
p
)) {

702 i‡(*
p
 ='\0' && (*
c
 == '\0' || (*c == '/' && *(c+1) == '\0'))) {

703  
n
;

705 i‡(*
c
 ='\0' && (
n
->
Êags
 & 
WHITELIST_DIR
)) {

706  
	`websWhôñi°CheckRecursive
(
n
->
chûd
, 
p
);

708  
	`websWhôñi°CheckRecursive
(
n
->
√xt
, 
∑th
);

709 
	}
}

717 #ifde‡
WEBS_SSL_SUPPORT


718 
	$websRequúeSSL
(*
uæ
)

720 
s¶Li°_t
 *
l
;

721 
sz
;

723 
l
 = 
	`bÆloc
(
B_L
, (
s¶Li°_t
));

724 
	`mem£t
(
l
, 0x0, (
s¶Li°_t
));

725 
sz
 = 
	`°æí
(
uæ
) + 1;

726 i‡(
uæ
[
sz
 - 2] == '/') {

727 
l
->
uæ
 = 
	`b°rdup
(
B_L
, url);

729 
sz
++;

730 
l
->
uæ
 = 
	`bÆloc
(
B_L
, 
sz
);

731 
	`mem˝y
(
l
->
uæ
, uæ, 
sz
 - 1);

732 
l
->
uæ
[
sz
 - 2] = '/';

733 
l
->
uæ
[
sz
 - 1] = '\0';

735 
l
->
√xt
 = 
s¶Li°
;

736 
s¶Li°
 = 
l
;

737 
	`websBuûdWhôñi°
();

739 
	}
}

746 
	$websDñëeWhôñi°
()

748 
	`websDñëeWhôñi°Recursive
(
whôñi°
);

749 
whôñi°
 = 
NULL
;

750 
	}
}

752 
	$websDñëeWhôñi°Recursive
(
fûeNode_t
 *
dú
)

754 i‡(
dú
 =
NULL
) ;

755 i‡(
dú
->
chûd
) {

756 
	`websDñëeWhôñi°Recursive
(
dú
->
chûd
);

758 i‡(
dú
->
√xt
) {

759 
	`websDñëeWhôñi°Recursive
(
dú
->
√xt
);

761 i‡(
dú
->
«me
) {

762 
	`b‰ì
(
B_L
, 
dú
->
«me
);

764 
	`mem£t
(
dú
, 0x0, (
fûeNode_t
));

765 
	`b‰ì
(
B_L
, 
dú
);

766 
	}
}

772 
	$websBuûdWhôñi°
()

774 i‡(
websDeÁu…Dú
 =
NULL
 || *websDefaultDir == '\0') {

777 
	`websDñëeWhôñi°Recursive
(
whôñi°
);

778 
whôñi°
 = 
	`bÆloc
(
B_L
, (
fûeNode_t
));

779 
	`mem£t
(
whôñi°
, 0x0, (
fûeNode_t
));

780 
whôñi°
->
«me
 = 
	`b°rdup
(
B_L
, "/");

781 
whôñi°
->
Êags
 |
WHITELIST_DIR
;

782  
	`websBuûdWhôñi°Recursive
(
websDeÁu…Dú
, 
whôñi°
, 0);

783 
	}
}

789 #ifde‡
WIN32


790 
	$websBuûdWhôñi°Recursive
(*
_∑th
, 
fûeNode_t
 *
dú
, 
Àvñ
)

792 
WIN32_FIND_DATA
 
födD©a
;

793 
HANDLE
 
fh
;

794 
fûeNode_t
 *
˙ode
, *
¬ode
;

795 #ifde‡
WEBS_SSL_SUPPORT


796 
s¶Li°_t
 *
l
;

798 
rc
 = 0;

799 
fú°Time
;

800 
∑th
[
MAX_PATH
];

801 
tmµ©h
[
MAX_PATH
];

803 
fú°Time
 = 1;

804 
˙ode
 = 
dú
;

805 
	`websMakeP©h
(
∑th
, 
_∑th
, 
NULL
, 1);

806 
fh
 = 
	`FödFú°Fûe
((
LPCSTR
)
∑th
, &
födD©a
);

807 
fh
 !
INVALID_HANDLE_VALUE
) {

808 i‡((
	`°rcmp
(
födD©a
.
cFûeName
, ".") == 0) ||

809 (
	`°rcmp
(
födD©a
.
cFûeName
, "..") == 0) ||

810 (
födD©a
.
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_HIDDEN
) ||

811 (
födD©a
.
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_SYSTEM
)) {

812 
√xtFûe
;

814 
¬ode
 = 
	`bÆloc
(
B_L
, (
fûeNode_t
));

815 
	`mem£t
(
¬ode
, 0x0, (
fûeNode_t
));

816 i‡(
födD©a
.
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_DIRECTORY
) {

817 
	`fmtAŒoc
(&(
¬ode
->
«me
), 
MAX_PATH
, "%s/", 
födD©a
.
cFûeName
);

818 
¬ode
->
Êags
 |
WHITELIST_DIR
;

820 
¬ode
->
«me
 = 
	`b°rdup
(
B_L
, 
födD©a
.
cFûeName
);

822 i‡(
fú°Time
) {

823 
˙ode
->
chûd
 = 
¬ode
;

824 
fú°Time
 = 0;

826 
˙ode
->
√xt
 = 
¬ode
;

828 
˙ode
 = 
¬ode
;

829 i‡(
	`°∫cmp
(
∑th
 + 
	`°æí
(
websDeÁu…Dú
), "/" 
CGI_BIN
,

830 
	`°æí
(
CGI_BIN
) + 1) == 0) {

831 
˙ode
->
Êags
 |
WHITELIST_CGI
;

833 #ifde‡
WEBS_SSL_SUPPORT


834 
l
 = 
s¶Li°
;Ü !
NULL
;Ü =Ü->
√xt
) {

835 i‡(
	`°∫cmp
(
∑th
 + 
	`°æí
(
websDeÁu…Dú
), 
l
->
uæ
,

836 
	`°æí
(
l
->
uæ
)) == 0) {

837 
˙ode
->
Êags
 |
WHITELIST_SSL
;

841 i‡(
födD©a
.
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_DIRECTORY
) {

842 
	`websMakeP©h
(
tmµ©h
, 
∑th
, 
födD©a
.
cFûeName
, 1);

843 i‡(
Àvñ
 < 
MAX_URL_DEPTH
) {

844 i‡(
	`websBuûdWhôñi°Recursive
(
tmµ©h
, 
˙ode
, 
Àvñ
 + 1) < 0){

845 
˙ode
->
Êags
 |
WHITELIST_BLOCKED
;

849 
√xtFûe
:

850 i‡(
	`FödNextFûe
(
fh
, &
födD©a
) == 0) {

851 i‡(
	`GëLa°Eº‹
(Ë!
ERROR_NO_MORE_FILES
) {

852 
rc
 = -1;

857 
	`FödClo£
(
fh
);

858  
rc
;

859 
	}
}

866 
	$websBuûdWhôñi°Recursive
(*
_∑th
, 
fûeNode_t
 *
dú
, 
Àvñ
)

868 
dúít
 *
födD©a
, *
ªsu…
;

869 
DIR
 *
fh
;

870 
fûeNode_t
 *
˙ode
, *
¬ode
;

871 
fú°Time
;

872 
∑th
[
PATH_MAX
];

873 
tmµ©h
[
PATH_MAX
];

875 
fú°Time
 = 1;

876 
˙ode
 = 
dú
;

886 i‡((
dúít
Ë> 
PATH_MAX
) {

887 
födD©a
 = 
	`bÆloc
(
B_L
, (
dúít
));

889 
födD©a
 = 
	`bÆloc
(
B_L
, (
dúít
Ë+ 
PATH_MAX
);

891 
	`websMakeP©h
(
∑th
, 
_∑th
, 
NULL
, 0);

892 i‡((
fh
 = 
	`›ídú
(
∑th
)Ë=
NULL
) {

893 
	`b‰ì
(
B_L
, 
födD©a
);

896 (
	`ªaddú_r
(
fh
, 
födD©a
, &
ªsu…
) == 0) &&Ñesult) {

897 i‡((
	`°rcmp
(
födD©a
->
d_«me
, ".") == 0) ||

898 (
	`°rcmp
(
födD©a
->
d_«me
, "..") == 0) ||

899 (
födD©a
->
d_ty≥
 !
DT_REG
 && födD©a->d_ty≥ !
DT_DIR
)) {

902 
¬ode
 = 
	`bÆloc
(
B_L
, (
fûeNode_t
));

903 
	`mem£t
(
¬ode
, 0x0, (
fûeNode_t
));

904 i‡(
födD©a
->
d_ty≥
 =
DT_DIR
) {

905 
	`fmtAŒoc
(&(
¬ode
->
«me
), 
PATH_MAX
, "%s/", 
födD©a
->
d_«me
);

906 
¬ode
->
Êags
 |
WHITELIST_DIR
;

908 
¬ode
->
«me
 = 
	`b°rdup
(
B_L
, 
födD©a
->
d_«me
);

910 i‡(
fú°Time
) {

911 
˙ode
->
chûd
 = 
¬ode
;

912 
fú°Time
 = 0;

914 
˙ode
->
√xt
 = 
¬ode
;

916 
˙ode
 = 
¬ode
;

917 i‡(
	`°∫cmp
(
∑th
 + 
	`°æí
(
websDeÁu…Dú
), "/" 
CGI_BIN
,

918 
	`°æí
(
CGI_BIN
) + 1) == 0) {

919 
˙ode
->
Êags
 |
WHITELIST_CGI
;

921 #ifde‡
WEBS_SSL_SUPPORT


922 
s¶Li°_t
 *
l
;

923 
l
 = 
s¶Li°
;Ü !
NULL
;Ü =Ü->
√xt
) {

924 i‡(
	`°∫cmp
(
∑th
 + 
	`°æí
(
websDeÁu…Dú
), 
l
->
uæ
,

925 
	`°æí
(
l
->
uæ
)) == 0) {

926 
˙ode
->
Êags
 |
WHITELIST_SSL
;

931 i‡(
födD©a
->
d_ty≥
 =
DT_DIR
) {

932 
	`websMakeP©h
(
tmµ©h
, 
∑th
, 
födD©a
->
d_«me
, 0);

933 i‡(
Àvñ
 < 
MAX_URL_DEPTH
) {

934 i‡(
	`websBuûdWhôñi°Recursive
(
tmµ©h
, 
˙ode
, 
Àvñ
 + 1) < 0){

935 
˙ode
->
Êags
 |
WHITELIST_BLOCKED
;

940 
	`b‰ì
(
B_L
, 
födD©a
);

941 
	`˛o£dú
(
fh
);

943 
	}
}

951 
	$websMakeP©h
(*
d
, *
§c
, *
subdú
, 
wûdˇrd
)

953 
max
;

954 *
a
;

956 #i‡
WIN


957 
max
 = 
MAX_PATH
 - 4 - (
subdú
 ? 
	`°æí
(subdir) : 0);

959 
max
 = 
PATH_MAX
 - 4 - (
subdú
 ? 
	`°æí
(subdir) : 0);

961 
a
 = 
§c
; *®!'\0' && ()◊ - srcË< 
max
;á++, 
d
++) {

962 *
d
 = *
a
;

964 i‡(*(
d
 - 1) == '*') d -= 1;

965 i‡(
subdú
) {

966 i‡(*(
d
 - 1) != '/') {

967 *
d
 = '/'; d++;

969 
a
 = 
subdú
; *a != '\0';á++) {

970 *
d
 = *
a
; d++;

973 i‡(*(
d
 - 1) != '/') {

974 *
d
 = '/'; d++;

976 i‡(
wûdˇrd
) {

977 *
d
 = '*'; d++;

979 *
d
 = '\0';

980 
	}
}

	@ej.h

10 #i‚de‡
_h_EJ


11 
	#_h_EJ
 1

	)

22 
	~"uemf.h
"

28 
ejArgs
(
¨gc
, 
ch¨_t
 **
¨gv
, ch¨_à*
fmt
, ...);

29 
ejSëResu…
(
eid
, 
ch¨_t
 *
s
);

30 
ejO≥nEngöe
(
sym_fd_t
 
v¨übÀs
, sym_fd_à
fun˘i⁄s
);

31 
ejClo£Engöe
(
eid
);

32 
ejSëGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
,

33 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
));

34 
	`ejSëV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

35 
	`ejGëV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à**
vÆue
);

36 
ch¨_t
 *
	`ejEvÆ
(
eid
, ch¨_à*
s¸ùt
, ch¨_à**
emsg
);

	@ejIntrn.h

10 #i‚de‡
_h_EJINTERNAL


11 
	#_h_EJINTERNAL
 1

	)

22 
	~<˘y≥.h
>

23 
	~<°d¨g.h
>

24 
	~<°dlib.h
>

26 #ifde‡
WIN32


27 
	~<sh¨e.h
>

30 #ifde‡
LYNX


31 
	~<uni°d.h
>

34 #ifde‡
QNX4


35 
	~<dúít.h
>

38 
	~"uemf.h
"

39 
	~"ej.h
"

45 
	#EJ_INC
 110

	)

46 
	#EJ_SCRIPT_INC
 1023

	)

47 
	#EJ_OFFSET
 1

	)

48 
	#EJ_MAX_RECURSE
 100

	)

53 
	#TOK_ERR
 -1

	)

54 
	#TOK_LPAREN
 1

	)

55 
	#TOK_RPAREN
 2

	)

56 
	#TOK_IF
 3

	)

57 
	#TOK_ELSE
 4

	)

58 
	#TOK_LBRACE
 5

	)

59 
	#TOK_RBRACE
 6

	)

60 
	#TOK_LOGICAL
 7

	)

61 
	#TOK_EXPR
 8

	)

62 
	#TOK_SEMI
 9

	)

63 
	#TOK_LITERAL
 10

	)

64 
	#TOK_FUNCTION
 11

	)

65 
	#TOK_NEWLINE
 12

	)

66 
	#TOK_ID
 13

	)

67 
	#TOK_EOF
 14

	)

68 
	#TOK_COMMA
 15

	)

69 
	#TOK_VAR
 16

	)

70 
	#TOK_ASSIGNMENT
 17

	)

71 
	#TOK_FOR
 18

	)

72 
	#TOK_INC_DEC
 19

	)

73 
	#TOK_RETURN
 20

	)

78 
	#EXPR_LESS
 1

	)

79 
	#EXPR_LESSEQ
 2

	)

80 
	#EXPR_GREATER
 3

	)

81 
	#EXPR_GREATEREQ
 4

	)

82 
	#EXPR_EQ
 5

	)

83 
	#EXPR_NOTEQ
 6

	)

84 
	#EXPR_PLUS
 7

	)

85 
	#EXPR_MINUS
 8

	)

86 
	#EXPR_DIV
 9

	)

87 
	#EXPR_MOD
 10

	)

88 
	#EXPR_LSHIFT
 11

	)

89 
	#EXPR_RSHIFT
 12

	)

90 
	#EXPR_MUL
 13

	)

91 
	#EXPR_ASSIGNMENT
 14

	)

92 
	#EXPR_INC
 15

	)

93 
	#EXPR_DEC
 16

	)

94 
	#EXPR_BOOL_COMP
 17

	)

98 
	#COND_AND
 1

	)

99 
	#COND_OR
 2

	)

100 
	#COND_NOT
 3

	)

105 
	#STATE_ERR
 -1

	)

106 
	#STATE_EOF
 1

	)

107 
	#STATE_COND
 2

	)

108 
	#STATE_COND_DONE
 3

	)

109 
	#STATE_RELEXP
 4

	)

110 
	#STATE_RELEXP_DONE
 5

	)

111 
	#STATE_EXPR
 6

	)

112 
	#STATE_EXPR_DONE
 7

	)

113 
	#STATE_STMT
 8

	)

114 
	#STATE_STMT_DONE
 9

	)

115 
	#STATE_STMT_BLOCK_DONE
 10

	)

116 
	#STATE_ARG_LIST
 11

	)

117 
	#STATE_ARG_LIST_DONE
 12

	)

118 
	#STATE_DEC_LIST
 16

	)

119 
	#STATE_DEC_LIST_DONE
 17

	)

120 
	#STATE_DEC
 18

	)

121 
	#STATE_DEC_DONE
 19

	)

123 
	#STATE_RET
 20

	)

125 
	#STATE_BEGIN
 
STATE_STMT


	)

130 
	#FLAGS_EXE
 0x1

	)

131 
	#FLAGS_VARIABLES
 0x2

	)

132 
	#FLAGS_FUNCTIONS
 0x4

	)

138 
ch¨_t
 *
	m‚ame
;

139 
ch¨_t
 **
	m¨gs
;

140 
	mnArgs
;

141 } 
	tejfunc_t
;

146 
	sejEvÆ
 {

147 
rögq_t
 
	mtokbuf
;

148 
rögq_t
 
	ms¸ùt
;

149 
ch¨_t
 *
	mputBackTokí
;

150 
	mputBackTokíId
;

151 
ch¨_t
 *
	mlöe
;

152 
	mlöeLígth
;

153 
	mlöeNumbî
;

154 
	mlöeCﬁumn
;

155 } 
	tejöput_t
;

160 
	sej
 {

161 
ejöput_t
 *
	möput
;

162 
sym_fd_t
 
	mfun˘i⁄s
;

163 
sym_fd_t
 *
	mv¨übÀs
;

164 
	mv¨übÀMax
;

165 
ejfunc_t
 *
	mfunc
;

166 
ch¨_t
 *
	mªsu…
;

167 
ch¨_t
 *
	mîr‹
;

168 
ch¨_t
 *
	mtokí
;

169 
	mtid
;

170 
	meid
;

171 
	mÊags
;

172 *
	mu£rH™dÀ
;

173 } 
	tej_t
;

177 
ejO≥nBlock
(
eid
);

178 
ejClo£Block
(
eid
, 
vid
);

179 
ch¨_t
 *
ejEvÆBlock
(
eid
, ch¨_à*
s¸ùt
, ch¨_à**
emsg
);

180 #i‚de‡
__NO_EJ_FILE


181 
ch¨_t
 *
ejEvÆFûe
(
eid
, ch¨_à*
∑th
, ch¨_à**
emsg
);

183 
ejRemoveGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
);

184 *
ejGëGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
);

185 
ejSëGlobÆFun˘i⁄Dúe˘
(
sym_fd_t
 
fun˘i⁄s
, 
ch¨_t
 *
«me
,

186 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
));

187 
	`ejEº‹
(
ej_t
* 
ï
, 
ch¨_t
* 
fmt
, ...);

188 
	`ejSëU£rH™dÀ
(
eid
, * 
h™dÀ
);

189 *
	`ejGëU£rH™dÀ
(
eid
);

190 
	`ejGëLöeNumbî
(
eid
);

191 
ch¨_t
 *
	`ejGëResu…
(
eid
);

192 
	`ejSëLoˇlV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

193 
	`ejSëGlobÆV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

195 
	`ejLexO≥n
(
ej_t
* 
ï
);

196 
	`ejLexClo£
(
ej_t
* 
ï
);

197 
	`ejLexO≥nS¸ùt
(
ej_t
* 
ï
, 
ch¨_t
 *
s¸ùt
);

198 
	`ejLexClo£S¸ùt
(
ej_t
* 
ï
);

199 
	`ejLexSaveI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
);

200 
	`ejLexFªeI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
);

201 
	`ejLexRe°‹eI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
);

202 
	`ejLexGëTokí
(
ej_t
* 
ï
, 
°©e
);

203 
	`ejLexPutbackTokí
(
ej_t
* 
ï
, 
tid
, 
ch¨_t
 *
°rög
);

205 
sym_fd_t
 
	`ejGëV¨übÀTabÀ
(
eid
);

206 
sym_fd_t
 
	`ejGëFun˘i⁄TabÀ
(
eid
);

208 
	`ejEmfO≥n
(
eid
);

209 
	`ejEmfClo£
(
eid
);

211 
	`ejEmfDbRód
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

212 
	`ejEmfDbRódKeyed
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

213 
	`ejEmfDbTabÀGëNrow
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

214 
	`ejEmfDbDñëeRow
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

215 
	`ejEmfTø˚
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

216 
	`ejEmfDbWrôe
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

217 
	`ejEmfDbCﬁÀ˘TabÀ
(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

	@ejlex.c

19 
	~"ejI¡∫.h
"

21 
	~"uemf.h
"

24 
	#OCTAL
 8

	)

25 
	#HEX
 16

	)

28 
gëLexiˇlTokí
(
ej_t
* 
ï
, 
°©e
);

29 
tokíAddCh¨
(
ej_t
 *
ï
, 
c
);

30 
öputGëc
(
ej_t
* 
ï
);

31 
öputPutback
(
ej_t
* 
ï
, 
c
);

32 
ch¨C⁄vît
(
ej_t
* 
ï
, 
ba£
, 
maxDig
);

39 
	$ejLexO≥n
(
ej_t
* 
ï
)

42 
	}
}

49 
	$ejLexClo£
(
ej_t
* 
ï
)

51 
	}
}

58 
	$ejLexO≥nS¸ùt
(
ej_t
* 
ï
, 
ch¨_t
 *
s¸ùt
)

60 
ejöput_t
 *
ù
;

62 
	`a_as£π
(
ï
);

63 
	`a_as£π
(
s¸ùt
);

65 i‡((
ï
->
öput
 = 
	`bÆloc
(
B_L
, (
ejöput_t
))Ë=
NULL
) {

68 
ù
 = 
ï
->
öput
;

69 
	`mem£t
(
ù
, 0, (*ip));

71 
	`a_as£π
(
ù
);

72 
	`a_as£π
(
ù
->
putBackTokí
 =
NULL
);

73 
	`a_as£π
(
ù
->
putBackTokíId
 == 0);

78 i‡(
	`rögqO≥n
(&
ù
->
tokbuf
, 
EJ_INC
, -1) < 0) {

81 i‡(
	`rögqO≥n
(&
ù
->
s¸ùt
, 
EJ_SCRIPT_INC
, -1) < 0) {

87 
	`rögqPutSå
(&
ù
->
s¸ùt
, script);

89 
ù
->
löeNumbî
 = 1;

90 
ù
->
löeLígth
 = 0;

91 
ù
->
löeCﬁumn
 = 0;

92 
ù
->
löe
 = 
NULL
;

95 
	}
}

102 
	$ejLexClo£S¸ùt
(
ej_t
* 
ï
)

104 
ejöput_t
 *
ù
;

106 
	`a_as£π
(
ï
);

108 
ù
 = 
ï
->
öput
;

109 
	`a_as£π
(
ù
);

111 i‡(
ù
->
putBackTokí
) {

112 
	`b‰ì
(
B_L
, 
ù
->
putBackTokí
);

113 
ù
->
putBackTokí
 = 
NULL
;

115 
ù
->
putBackTokíId
 = 0;

117 i‡(
ù
->
löe
) {

118 
	`b‰ì
(
B_L
, 
ù
->
löe
);

119 
ù
->
löe
 = 
NULL
;

122 
	`rögqClo£
(&
ù
->
tokbuf
);

123 
	`rögqClo£
(&
ù
->
s¸ùt
);

125 
	`b‰ì
(
B_L
, 
ù
);

126 
	}
}

133 
	$ejLexSaveI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
)

135 
ejöput_t
 *
ù
;

137 
	`a_as£π
(
ï
);

139 
ù
 = 
ï
->
öput
;

140 
	`a_as£π
(
ù
);

142 *
°©e
 = *
ù
;

143 i‡(
ù
->
putBackTokí
) {

144 
°©e
->
putBackTokí
 = 
	`b°rdup
(
B_L
, 
ù
->putBackToken);

146 
	}
}

153 
	$ejLexRe°‹eI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
)

155 
ejöput_t
 *
ù
;

157 
	`a_as£π
(
ï
);

159 
ù
 = 
ï
->
öput
;

160 
	`a_as£π
(
ù
);

162 
ù
->
tokbuf
 = 
°©e
->tokbuf;

163 
ù
->
s¸ùt
 = 
°©e
->script;

164 
ù
->
putBackTokíId
 = 
°©e
->putBackTokenId;

165 i‡(
ù
->
putBackTokí
) {

166 
	`b‰ì
(
B_L
, 
ù
->
putBackTokí
);

168 i‡(
°©e
->
putBackTokí
) {

169 
ù
->
putBackTokí
 = 
	`b°rdup
(
B_L
, 
°©e
->putBackToken);

171 
	}
}

178 
	$ejLexFªeI≈utSèã
(
ej_t
* 
ï
, 
ejöput_t
* 
°©e
)

180 i‡(
°©e
->
putBackTokí
) {

181 
	`b‰ì
(
B_L
, 
°©e
->
putBackTokí
);

182 
°©e
->
putBackTokí
 = 
NULL
;

184 
	}
}

191 
	$ejLexGëTokí
(
ej_t
* 
ï
, 
°©e
)

193 
ï
->
tid
 = 
	`gëLexiˇlTokí
”p, 
°©e
);

201  
ï
->
tid
;

202 
	}
}

209 
	$gëLexiˇlTokí
(
ej_t
* 
ï
, 
°©e
)

211 
rögq_t
 *
öq
, *
tokq
;

212 
ejöput_t
* 
ù
;

213 
d⁄e
, 
tid
, 
c
, 
quŸe
, 
°yÀ
;

215 
	`a_as£π
(
ï
);

216 
ù
 = 
ï
->
öput
;

217 
	`a_as£π
(
ù
);

219 
öq
 = &
ù
->
s¸ùt
;

220 
tokq
 = &
ù
->
tokbuf
;

222 
ï
->
tid
 = -1;

223 
tid
 = -1;

224 
ï
->
tokí
 = 
	`T
("");

226 
	`rögqFlush
(
tokq
);

228 i‡(
ù
->
putBackTokíId
 > 0) {

229 
	`rögqPutSå
(
tokq
, 
ù
->
putBackTokí
);

230 
tid
 = 
ù
->
putBackTokíId
;

231 
ù
->
putBackTokíId
 = 0;

232 
ï
->
tokí
 = (
ch¨_t
*Ë
tokq
->
£rvp
;

233  
tid
;

236 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

237  
TOK_EOF
;

240 
d⁄e
 = 0; !done; ) {

241 
c
) {

243  
TOK_EOF
;

249 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0)

251 } 
c
 == ' ' || c == '\t' || c == '\r');

255  
TOK_NEWLINE
;

258 
	`tokíAddCh¨
(
ï
, 
c
);

259  
TOK_LPAREN
;

262 
	`tokíAddCh¨
(
ï
, 
c
);

263  
TOK_RPAREN
;

266 
	`tokíAddCh¨
(
ï
, 
c
);

267  
TOK_LBRACE
;

270 
	`tokíAddCh¨
(
ï
, 
c
);

271  
TOK_RBRACE
;

274 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

275 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

276  
TOK_ERR
;

278 i‡(
c
 != '+' ) {

279 
	`öputPutback
(
ï
, 
c
);

280 
	`tokíAddCh¨
(
ï
, 
EXPR_PLUS
);

281  
TOK_EXPR
;

283 
	`tokíAddCh¨
(
ï
, 
EXPR_INC
);

284  
TOK_INC_DEC
;

287 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

288 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

289  
TOK_ERR
;

291 i‡(
c
 != '-' ) {

292 
	`öputPutback
(
ï
, 
c
);

293 
	`tokíAddCh¨
(
ï
, 
EXPR_MINUS
);

294  
TOK_EXPR
;

296 
	`tokíAddCh¨
(
ï
, 
EXPR_DEC
);

297  
TOK_INC_DEC
;

300 
	`tokíAddCh¨
(
ï
, 
EXPR_MUL
);

301  
TOK_EXPR
;

304 
	`tokíAddCh¨
(
ï
, 
EXPR_MOD
);

305  
TOK_EXPR
;

311 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

312 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

313  
TOK_ERR
;

315 i‡(
c
 != '*' && c != '/') {

316 
	`öputPutback
(
ï
, 
c
);

317 
	`tokíAddCh¨
(
ï
, 
EXPR_DIV
);

318  
TOK_EXPR
;

320 
°yÀ
 = 
c
;

325 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

326 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

327  
TOK_ERR
;

329 i‡(
c
 ='\n' && 
°yÀ
 == '/') {

331 } i‡(
c
 == '*') {

332 
c
 = 
	`öputGëc
(
ï
);

333 i‡(
°yÀ
 == '/') {

334 i‡(
c
 == '\n') {

338 i‡(
c
 == '/') {

347 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

348  
TOK_EOF
;

353 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

354 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

355  
TOK_ERR
;

357 i‡(
c
 == '<') {

358 
	`tokíAddCh¨
(
ï
, 
EXPR_LSHIFT
);

359  
TOK_EXPR
;

360 } i‡(
c
 == '=') {

361 
	`tokíAddCh¨
(
ï
, 
EXPR_LESSEQ
);

362  
TOK_EXPR
;

364 
	`tokíAddCh¨
(
ï
, 
EXPR_LESS
);

365 
	`öputPutback
(
ï
, 
c
);

366  
TOK_EXPR
;

369 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

370 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

371  
TOK_ERR
;

373 i‡(
c
 == '>') {

374 
	`tokíAddCh¨
(
ï
, 
EXPR_RSHIFT
);

375  
TOK_EXPR
;

376 } i‡(
c
 == '=') {

377 
	`tokíAddCh¨
(
ï
, 
EXPR_GREATEREQ
);

378  
TOK_EXPR
;

380 
	`tokíAddCh¨
(
ï
, 
EXPR_GREATER
);

381 
	`öputPutback
(
ï
, 
c
);

382  
TOK_EXPR
;

385 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

386 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

387  
TOK_ERR
;

389 i‡(
c
 == '=') {

390 
	`tokíAddCh¨
(
ï
, 
EXPR_EQ
);

391  
TOK_EXPR
;

393 
	`öputPutback
(
ï
, 
c
);

394  
TOK_ASSIGNMENT
;

397 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

398 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

399  
TOK_ERR
;

401 i‡(
c
 == '=') {

402 
	`tokíAddCh¨
(
ï
, 
EXPR_NOTEQ
);

403  
TOK_EXPR
;

405 
	`öputPutback
(
ï
, 
c
);

406 
	`tokíAddCh¨
(
ï
, 
EXPR_BOOL_COMP
);

407  
TOK_EXPR
;

410 
	`tokíAddCh¨
(
ï
, 
c
);

411  
TOK_SEMI
;

414 
	`tokíAddCh¨
(
ï
, 
c
);

415  
TOK_COMMA
;

418 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0 || c != '|') {

419 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

420  
TOK_ERR
;

422 
	`tokíAddCh¨
(
ï
, 
COND_OR
);

423  
TOK_LOGICAL
;

426 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0 || c != '&') {

427 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

428  
TOK_ERR
;

430 
	`tokíAddCh¨
(
ï
, 
COND_AND
);

431  
TOK_LOGICAL
;

435 
quŸe
 = 
c
;

436 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

437 
	`ejEº‹
(
ï
, 
	`T
("Syntax Error"));

438  
TOK_ERR
;

441 
c
 !
quŸe
) {

445 i‡(
c
 == '\\') {

446 
c
 = 
	`öputGëc
(
ï
);

448 i‡(
	`gisdigô
(
c
)) {

453 
	`öputPutback
(
ï
, 
c
);

454 
c
 = 
	`ch¨C⁄vît
(
ï
, 
OCTAL
, 3);

457 
c
) {

459 
c
 = '\n'; ;

461 
c
 = '\b'; ;

463 
c
 = '\f'; ;

465 
c
 = '\r'; ;

467 
c
 = '\t'; ;

472 
c
 = 
	`ch¨C⁄vît
(
ï
, 
HEX
, 2);

478 
c
 = 
	`ch¨C⁄vît
(
ï
, 
HEX
, 2);

479 
c
 = c*16 + 
	`ch¨C⁄vît
(
ï
, 
HEX
, 2);

487 
	`ejEº‹
(
ï
, 
	`T
("Invalid Escape Sequence"));

488  
TOK_ERR
;

491 i‡(
	`tokíAddCh¨
(
ï
, 
c
) < 0) {

492  
TOK_ERR
;

495 i‡(
	`tokíAddCh¨
(
ï
, 
c
) < 0) {

496  
TOK_ERR
;

499 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

500 
	`ejEº‹
(
ï
, 
	`T
("Unmatched Quote"));

501  
TOK_ERR
;

504  
TOK_LITERAL
;

509 i‡(
	`tokíAddCh¨
(
ï
, 
c
) < 0) {

510  
TOK_ERR
;

512 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0)

514 } 
	`gisdigô
(
c
));

515 
	`öputPutback
(
ï
, 
c
);

516  
TOK_LITERAL
;

523 i‡(
c
 == '\\') {

527 } i‡(
	`tokíAddCh¨
(
ï
, 
c
) < 0) {

530 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

533 i‡(!
	`giß um
(
c
) && c != '$' && c != '_' &&

534 
c
 != '\\') {

538 i‡(! 
	`gißÕha
(*
tokq
->
£rvp
) && *tokq->servp != '$' &&

539 *
tokq
->
£rvp
 != '_') {

540 
	`ejEº‹
(
ï
, 
	`T
("InvÆid idítifõ∏%s"), 
tokq
->
£rvp
);

541  
TOK_ERR
;

547 i‡(
°©e
 =
STATE_STMT
) {

548 i‡(
	`g°rcmp
(
ï
->
tokí
, 
	`T
("if")) == 0) {

549  
TOK_IF
;

550 } i‡(
	`g°rcmp
(
ï
->
tokí
, 
	`T
("else")) == 0) {

551  
TOK_ELSE
;

552 } i‡(
	`g°rcmp
(
ï
->
tokí
, 
	`T
("var")) == 0) {

553  
TOK_VAR
;

554 } i‡(
	`g°rcmp
(
ï
->
tokí
, 
	`T
("for")) == 0) {

555  
TOK_FOR
;

556 } i‡(
	`g°rcmp
(
ï
->
tokí
, 
	`T
("return")) == 0) {

557 i‡((
c
 == ';') || (c == '(')) {

558 
	`öputPutback
(
ï
, 
c
);

560  
TOK_RETURN
;

568 
c
 == ' ' || c == '\t' || c == '\r' || c == '\n') {

569 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0)

573 
tid
 = (
c
 ='('Ë? 
TOK_FUNCTION
 : 
TOK_ID
;

574 
d⁄e
++;

581 
	`öputPutback
(
ï
, 
c
);

582  
tid
;

583 
	}
}

590 
	$ejLexPutbackTokí
(
ej_t
* 
ï
, 
tid
, 
ch¨_t
 *
°rög
)

592 
ejöput_t
* 
ù
;

594 
	`a_as£π
(
ï
);

595 
ù
 = 
ï
->
öput
;

596 
	`a_as£π
(
ù
);

598 i‡(
ù
->
putBackTokí
) {

599 
	`b‰ì
(
B_L
, 
ù
->
putBackTokí
);

601 
ù
->
putBackTokíId
 = 
tid
;

602 
ù
->
putBackTokí
 = 
	`b°rdup
(
B_L
, 
°rög
);

603 
	}
}

610 
	$tokíAddCh¨
(
ej_t
 *
ï
, 
c
)

612 
ejöput_t
* 
ù
;

614 
	`a_as£π
(
ï
);

615 
ù
 = 
ï
->
öput
;

616 
	`a_as£π
(
ù
);

618 i‡(
	`rögqPutc
(&
ù
->
tokbuf
, (
ch¨_t
Ë
c
) < 0) {

619 
	`ejEº‹
(
ï
, 
	`T
("TokenÅoo big"));

622 * ((
ch¨_t
*Ë
ù
->
tokbuf
.
ídp
) = '\0';

623 
ï
->
tokí
 = (
ch¨_t
*Ë
ù
->
tokbuf
.
£rvp
;

626 
	}
}

633 
	$öputGëc
(
ej_t
* 
ï
)

635 
ejöput_t
 *
ù
;

636 
c
, 
Àn
;

638 
	`a_as£π
(
ï
);

639 
ù
 = 
ï
->
öput
;

641 i‡((
Àn
 = 
	`rögqLí
(&
ù
->
s¸ùt
)) == 0) {

645 
c
 = 
	`rögqGëc
(&
ù
->
s¸ùt
);

647 i‡(
c
 == '\n') {

648 
ù
->
löeNumbî
++;

649 
ù
->
löeCﬁumn
 = 0;

651 i‡((
ù
->
löeCﬁumn
 + 2Ë>ù->
löeLígth
) {

652 
ù
->
löeLígth
 +
EJ_INC
;

653 
ù
->
löe
 = 
	`bªÆloc
(
B_L
, ip->löe, ip->
löeLígth
 * (
ch¨_t
));

655 
ù
->
löe
[ù->
löeCﬁumn
++] = 
c
;

656 
ù
->
löe
[ù->
löeCﬁumn
] = '\0';

658  
c
;

659 
	}
}

666 
	$öputPutback
(
ej_t
* 
ï
, 
c
)

668 
ejöput_t
 *
ù
;

670 
	`a_as£π
(
ï
);

672 
ù
 = 
ï
->
öput
;

673 
	`rögqIn£πc
(&
ù
->
s¸ùt
, (
ch¨_t
Ë
c
);

675 i‡(
ù
->
löeCﬁumn
 > 0) {

676 
ù
->
löeCﬁumn
-- ;

678 
ù
->
löe
[ù->
löeCﬁumn
] = '\0';

679 
	}
}

687 
	$ch¨C⁄vît
(
ej_t
* 
ï
, 
ba£
, 
maxDig
)

689 
i
, 
c
, 
lvÆ
, 
c⁄vCh¨
;

691 
lvÆ
 = 0;

692 
i
 = 0; i < 
maxDig
; i++) {

693 i‡((
c
 = 
	`öputGëc
(
ï
)) < 0) {

699 
c⁄vCh¨
 = 
ba£
;

700 i‡(
	`gisdigô
(
c
)) {

701 
c⁄vCh¨
 = 
c
 - '0';

702 } i‡(
c
 >= 'a' && c <= 'f') {

703 
c⁄vCh¨
 = 
c
 - 'a' + 10;

704 } i‡(
c
 >= 'A' && c <= 'F') {

705 
c⁄vCh¨
 = 
c
 - 'A' + 10;

710 i‡(
c⁄vCh¨
 >
ba£
) {

711 
	`öputPutback
(
ï
, 
c
);

714 
lvÆ
 = (lvÆ * 
ba£
Ë+ 
c⁄vCh¨
;

716  
lvÆ
;

717 
	}
}

	@ejparse.c

19 
	~"ejI¡∫.h
"

21 #ifde‡
CE


22 
	~"CE/wöcom∑t.h
"

27 
ej_t
 **
	gejH™dÀs
;

28 
	gejMax
 = -1;

32 #i‚de‡
B_STATS


33 
	#£tSåög
(
a
,
b
,
c
Ë
	`£t°rög
(b,c)

	)

36 
ej_t
 *
ejPå
(
eid
);

37 
˛órSåög
(
ch¨_t
 **
±r
);

38 
£tSåög
(
B_ARGS_DEC
, 
ch¨_t
 **
±r
, ch¨_à*
s
);

39 
≠≥ndSåög
(
ch¨_t
 **
±r
, ch¨_à*
s
);

40 
∑r£
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

41 
∑r£Stmt
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

42 
∑r£De˛¨©i⁄
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

43 
∑r£Args
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

44 
∑r£C⁄d
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

45 
∑r£Ex¥
(
ej_t
 *
ï
, 
°©e
, 
Êags
);

46 
evÆEx¥
(
ej_t
 *
ï
, 
ch¨_t
 *
lhs
, 
ªl
, ch¨_à*
rhs
);

47 
evÆC⁄d
(
ej_t
 *
ï
, 
ch¨_t
 *
lhs
, 
ªl
, ch¨_à*
rhs
);

48 
evÆFun˘i⁄
(
ej_t
 *
ï
);

49 
‰ìFunc
(
ejfunc_t
 *
func
);

50 
ejRemoveNewlöes
(
ej_t
 *
ï
, 
°©e
);

57 
	$ejO≥nEngöe
(
sym_fd_t
 
v¨übÀs
, sym_fd_à
fun˘i⁄s
)

59 
ej_t
 *
ï
;

60 
eid
, 
vid
;

62 i‡((
eid
 = 
	`hAŒocE¡ry
((***Ë&
ejH™dÀs
, &
ejMax
, (
ej_t
))) < 0) {

65 
ï
 = 
ejH™dÀs
[
eid
];

66 
ï
->
eid
 =Éid;

73 i‡((
vid
 = 
	`hAŒoc
((***Ë&
ï
->
v¨übÀs
)) < 0) {

74 
ejMax
 = 
	`hFªe
((***Ë&
ejH™dÀs
, 
ï
->
eid
);

77 i‡(
vid
 >
ï
->
v¨übÀMax
) {

78 
ï
->
v¨übÀMax
 = 
vid
 + 1;

81 i‡(
v¨übÀs
 == -1) {

82 
ï
->
v¨übÀs
[
vid
] = 
	`symO≥n
(64Ë+ 
EJ_OFFSET
;

83 
ï
->
Êags
 |
FLAGS_VARIABLES
;

85 
ï
->
v¨übÀs
[
vid
] = v¨übÀ†+ 
EJ_OFFSET
;

88 i‡(
fun˘i⁄s
 == -1) {

89 
ï
->
fun˘i⁄s
 = 
	`symO≥n
(64);

90 
ï
->
Êags
 |
FLAGS_FUNCTIONS
;

92 
ï
->
fun˘i⁄s
 = functions;

95 
	`ejLexO≥n
(
ï
);

100 
	`ejSëGlobÆV¨
(
ï
->
eid
, 
	`T
("nuŒ"), 
NULL
);

102  
ï
->
eid
;

103 
	}
}

110 
	$ejClo£Engöe
(
eid
)

112 
ej_t
 *
ï
;

113 
i
;

115 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

119 
	`b‰ìSa„
(
B_L
, 
ï
->
îr‹
);

120 
ï
->
îr‹
 = 
NULL
;

121 
	`b‰ìSa„
(
B_L
, 
ï
->
ªsu…
);

122 
ï
->
ªsu…
 = 
NULL
;

124 
	`ejLexClo£
(
ï
);

126 
i
 = 
ï
->
v¨übÀMax
 - 1; i >= 0; i--) {

127 i‡(
ï
->
Êags
 & 
FLAGS_VARIABLES
) {

128 
	`symClo£
(
ï
->
v¨übÀs
[
i
] - 
EJ_OFFSET
);

130 
ï
->
v¨übÀMax
 = 
	`hFªe
((***Ë&ï->
v¨übÀs
, 
i
);

133 i‡(
ï
->
Êags
 & 
FLAGS_FUNCTIONS
) {

134 
	`symClo£
(
ï
->
fun˘i⁄s
);

137 
ejMax
 = 
	`hFªe
((***Ë&
ejH™dÀs
, 
ï
->
eid
);

138 
	`b‰ì
(
B_L
, 
ï
);

139 
	}
}

141 #i‚de‡
__NO_EJ_FILE


147 
ch¨_t
 *
	$ejEvÆFûe
(
eid
, 
ch¨_t
 *
∑th
, ch¨_à**
emsg
)

149 
g°©_t
 
sbuf
;

150 
ej_t
 *
ï
;

151 
ch¨_t
 *
s¸ùt
, *
rs
;

152 *
fûeBuf
;

153 
fd
;

155 
	`a_as£π
(
∑th
 && *path);

157 i‡(
emsg
) {

158 *
emsg
 = 
NULL
;

161 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

162  
NULL
;

165 #i‡!
	`deföed
(
WIN32
)

166 
fd
 = 
	`g›í
(
∑th
, 
O_RDONLY
 | 
O_BINARY
, 0666);

168 
	`_s›í_s
(&
fd
, 
∑th
, 
O_RDONLY
 | 
O_BINARY
, 
_SH_DENYNO
, 0666);

171 i‡(
fd
 < 0) {

172 
	`ejEº‹
(
ï
, 
	`T
("Bad h™dÀ %d"), 
eid
);

173  
NULL
;

176 i‡(
	`g°©
(
∑th
, &
sbuf
) < 0) {

177 
	`g˛o£
(
fd
);

178 
	`ejEº‹
(
ï
, 
	`T
("C™à°© %s"), 
∑th
);

179  
NULL
;

182 i‡((
fûeBuf
 = 
	`bÆloc
(
B_L
, 
sbuf
.
°_size
 + 1)Ë=
NULL
) {

183 
	`g˛o£
(
fd
);

184 
	`ejEº‹
(
ï
, 
	`T
("C™àmÆlo¯%d"), 
sbuf
.
°_size
);

185  
NULL
;

188 i‡(
	`gªad
(
fd
, 
fûeBuf
, 
sbuf
.
°_size
) != ()sbuf.st_size) {

189 
	`g˛o£
(
fd
);

190 
	`b‰ì
(
B_L
, 
fûeBuf
);

191 
	`ejEº‹
(
ï
, 
	`T
("Eº‹Ñódög %s"), 
∑th
);

192  
NULL
;

195 
fûeBuf
[
sbuf
.
°_size
] = '\0';

196 
	`g˛o£
(
fd
);

198 i‡((
s¸ùt
 = 
	`bÆlocAscToUni
(
fûeBuf
, 
sbuf
.
°_size
)Ë=
NULL
) {

199 
	`b‰ì
(
B_L
, 
fûeBuf
);

200 
	`ejEº‹
(
ï
, 
	`T
("C™àmÆlo¯%d"), 
sbuf
.
°_size
 + 1);

201  
NULL
;

203 
	`b‰ì
(
B_L
, 
fûeBuf
);

205 
rs
 = 
	`ejEvÆBlock
(
eid
, 
s¸ùt
, 
emsg
);

207 
	`b‰ì
(
B_L
, 
s¸ùt
);

208  
rs
;

209 
	}
}

219 
	$ejO≥nBlock
(
eid
)

221 
ej_t
 *
ï
;

222 
vid
;

224 if((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

228 i‡((
vid
 = 
	`hAŒoc
((***Ë&
ï
->
v¨übÀs
)) < 0) {

232 i‡(
vid
 >
ï
->
v¨übÀMax
) {

233 
ï
->
v¨übÀMax
 = 
vid
 + 1;

235 
ï
->
v¨übÀs
[
vid
] = 
	`symO≥n
(64Ë+ 
EJ_OFFSET
;

236  
vid
;

238 
	}
}

246 
	$ejClo£Block
(
eid
, 
vid
)

248 
ej_t
 *
ï
;

250 if((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

253 
	`symClo£
(
ï
->
v¨übÀs
[
vid
] - 
EJ_OFFSET
);

254 
ï
->
v¨übÀMax
 = 
	`hFªe
((***Ë&ï->
v¨übÀs
, 
vid
);

257 
	}
}

265 
ch¨_t
 *
	$ejEvÆBlock
(
eid
, 
ch¨_t
 *
s¸ùt
, ch¨_à**
emsg
)

267 
ch¨_t
* 
ªtu∫VÆ
;

268 
vid
;

270 
	`a_as£π
(
s¸ùt
);

272 
vid
 = 
	`ejO≥nBlock
(
eid
);

273 
ªtu∫VÆ
 = 
	`ejEvÆ
(
eid
, 
s¸ùt
, 
emsg
);

274 
	`ejClo£Block
(
eid
, 
vid
);

276  
ªtu∫VÆ
;

277 
	}
}

286 
ch¨_t
 *
	$ejEvÆ
(
eid
, 
ch¨_t
 *
s¸ùt
, ch¨_à**
emsg
)

288 
ej_t
 *
ï
;

289 
ejöput_t
 *
ﬁdBlock
;

290 
°©e
;

291 *
ídÀssLo›Te°
;

292 
lo›Cou¡î
;

295 
	`a_as£π
(
s¸ùt
);

297 i‡(
emsg
) {

298 *
emsg
 = 
NULL
;

301 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

302  
NULL
;

305 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
	`T
(""));

310 
ﬁdBlock
 = 
ï
->
öput
;

311 
	`ejLexO≥nS¸ùt
(
ï
, 
s¸ùt
);

316 
lo›Cou¡î
 = 0;

317 
ídÀssLo›Te°
 = 
NULL
;

320 
°©e
 = 
	`∑r£
(
ï
, 
STATE_BEGIN
, 
FLAGS_EXE
);

322 i‡(
°©e
 =
STATE_RET
) {

323 
°©e
 = 
STATE_EOF
;

330 i‡(
ídÀssLo›Te°
 =
ï
->
öput
->
s¸ùt
.
£rvp
) {

331 i‡(
lo›Cou¡î
++ > 10) {

332 
°©e
 = 
STATE_ERR
;

333 
	`ejEº‹
(
ï
, 
	`T
("SyntaxÉrror"));

336 
ídÀssLo›Te°
 = 
ï
->
öput
->
s¸ùt
.
£rvp
;

337 
lo›Cou¡î
 = 0;

339 } 
°©e
 !
STATE_EOF
 && sèã !
STATE_ERR
);

341 
	`ejLexClo£S¸ùt
(
ï
);

346 i‡(
°©e
 =
STATE_ERR
 && 
emsg
) {

347 *
emsg
 = 
	`b°rdup
(
B_L
, 
ï
->
îr‹
);

353 
ï
->
öput
 = 
ﬁdBlock
;

355 i‡(
°©e
 =
STATE_EOF
) {

356  
ï
->
ªsu…
;

359 i‡(
°©e
 =
STATE_ERR
) {

360  
NULL
;

363  
ï
->
ªsu…
;

364 
	}
}

371 
	$∑r£
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

373 
	`a_as£π
(
ï
);

375 
°©e
) {

379 
STATE_STMT
:

380 i‡((
°©e
 = 
	`∑r£Stmt
(
ï
, sèã, 
Êags
)Ë!
STATE_STMT_DONE
 &&

381 
°©e
 !
STATE_EOF
 && sèã !
STATE_STMT_BLOCK_DONE
 &&

382 
°©e
 !
STATE_RET
) {

383 
°©e
 = 
STATE_ERR
;

387 
STATE_DEC
:

388 i‡((
°©e
 = 
	`∑r£Stmt
(
ï
, sèã, 
Êags
)Ë!
STATE_DEC_DONE
 &&

389 
°©e
 !
STATE_EOF
) {

390 
°©e
 = 
STATE_ERR
;

394 
STATE_EXPR
:

395 i‡((
°©e
 = 
	`∑r£Stmt
(
ï
, sèã, 
Êags
)Ë!
STATE_EXPR_DONE
 &&

396 
°©e
 !
STATE_EOF
) {

397 
°©e
 = 
STATE_ERR
;

404 
STATE_DEC_LIST
:

405 
°©e
 = 
	`∑r£De˛¨©i⁄
(
ï
, sèã, 
Êags
);

411 
STATE_ARG_LIST
:

412 
°©e
 = 
	`∑r£Args
(
ï
, sèã, 
Êags
);

418 
STATE_COND
:

419 
°©e
 = 
	`∑r£C⁄d
(
ï
, sèã, 
Êags
);

425 
STATE_RELEXP
:

426 
°©e
 = 
	`∑r£Ex¥
(
ï
, sèã, 
Êags
);

430 i‡(
°©e
 =
STATE_ERR
 && 
ï
->
îr‹
 =
NULL
) {

431 
	`ejEº‹
(
ï
, 
	`T
("SyntaxÉrror"));

433  
°©e
;

434 
	}
}

441 
	$∑r£Stmt
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

443 
ejfunc_t
 
func
;

444 
ejfunc_t
 *
ßveFunc
;

445 
ejöput_t
 
c⁄dS¸ùt
, 
ídS¸ùt
, 
bodyS¸ùt
, 
ö¸S¸ùt
;

446 
ch¨_t
 *
vÆue
, *
idítifõr
;

447 
d⁄e
, 
ex≥˘Semi
, 
thíFœgs
, 
ñ£Fœgs
, 
tid
, 
c⁄d
, 
f‹Fœgs
;

448 
ejV¨Ty≥
;

450 
	`a_as£π
(
ï
);

455 
ídS¸ùt
.
putBackTokí
 = 
NULL
;

456 
bodyS¸ùt
.
putBackTokí
 = 
NULL
;

457 
ö¸S¸ùt
.
putBackTokí
 = 
NULL
;

458 
c⁄dS¸ùt
.
putBackTokí
 = 
NULL
;

460 
ex≥˘Semi
 = 0;

461 
ßveFunc
 = 
NULL
;

463 
d⁄e
 = 0; !done; ) {

464 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

466 
tid
) {

468 
	`ejLexPutbackTokí
(
ï
, 
TOK_EXPR
,Ép->
tokí
);

469 
d⁄e
++;

472 
TOK_ERR
:

473 
°©e
 = 
STATE_ERR
;

474 
d⁄e
++;

477 
TOK_EOF
:

478 
°©e
 = 
STATE_EOF
;

479 
d⁄e
++;

482 
TOK_NEWLINE
:

485 
TOK_SEMI
:

489 i‡(
°©e
 !
STATE_STMT
) {

490 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

492 
d⁄e
++;

495 
TOK_ID
:

499 
idítifõr
 = 
NULL
;

500 
	`£tSåög
(
B_L
, &
idítifõr
, 
ï
->
tokí
);

504 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

505 i‡(
tid
 =
TOK_ASSIGNMENT
) {

506 i‡(
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
Ë!
STATE_RELEXP_DONE
) {

507 
	`˛órSåög
(&
idítifõr
);

508 
îr‹
;

510 i‡(
Êags
 & 
FLAGS_EXE
) {

511 i‡–
°©e
 =
STATE_DEC
 ) {

512 
	`ejSëLoˇlV¨
(
ï
->
eid
, 
idítifõr
,Ép->
ªsu…
);

514 
ejV¨Ty≥
 = 
	`ejGëV¨
(
ï
->
eid
, 
idítifõr
, &
vÆue
);

515 i‡(
ejV¨Ty≥
 > 0) {

516 
	`ejSëLoˇlV¨
(
ï
->
eid
, 
idítifõr
,Ép->
ªsu…
);

518 
	`ejSëGlobÆV¨
(
ï
->
eid
, 
idítifõr
,Ép->
ªsu…
);

523 } i‡(
tid
 =
TOK_INC_DEC
 ) {

524 
vÆue
 = 
NULL
;

525 i‡(
Êags
 & 
FLAGS_EXE
) {

526 
ejV¨Ty≥
 = 
	`ejGëV¨
(
ï
->
eid
, 
idítifõr
, &
vÆue
);

527 i‡(
ejV¨Ty≥
 < 0) {

528 
	`ejEº‹
(
ï
, 
	`T
("Undeföed v¨übÀ %s\n"), 
idítifõr
);

529 
îr‹
;

531 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
vÆue
);

532 i‡(
	`evÆEx¥
(
ï
, 
vÆue
, (Ë*ï->
tokí
, 
	`T
("1")) < 0) {

533 
°©e
 = 
STATE_ERR
;

537 i‡(
ejV¨Ty≥
 > 0) {

538 
	`ejSëLoˇlV¨
(
ï
->
eid
, 
idítifõr
,Ép->
ªsu…
);

540 
	`ejSëGlobÆV¨
(
ï
->
eid
, 
idítifõr
,Ép->
ªsu…
);

548 
vÆue
 = 
NULL
;

549 i‡(
°©e
 =
STATE_DEC
) {

550 i‡(
	`ejGëV¨
(
ï
->
eid
, 
idítifõr
, &
vÆue
) > 0) {

551 
	`ejEº‹
(
ï
, 
	`T
("Variableálready declared"),

552 
idítifõr
);

553 
	`˛órSåög
(&
idítifõr
);

554 
îr‹
;

556 
	`ejSëLoˇlV¨
(
ï
->
eid
, 
idítifõr
, 
NULL
);

558 i‡–
Êags
 & 
FLAGS_EXE
 ) {

559 i‡(
	`ejGëV¨
(
ï
->
eid
, 
idítifõr
, &
vÆue
) < 0) {

560 
	`ejEº‹
(
ï
, 
	`T
("Undefined variable %s\n"),

561 
idítifõr
);

562 
	`˛órSåög
(&
idítifõr
);

563 
îr‹
;

567 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
vÆue
);

568 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

570 
	`˛órSåög
(&
idítifõr
);

572 i‡(
°©e
 =
STATE_STMT
) {

573 
ex≥˘Semi
++;

575 
d⁄e
++;

578 
TOK_LITERAL
:

582 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
,Ép->
tokí
);

583 i‡(
°©e
 =
STATE_STMT
) {

584 
ex≥˘Semi
++;

586 
d⁄e
++;

589 
TOK_FUNCTION
:

593 i‡(
ï
->
func
) {

594 
ßveFunc
 = 
ï
->
func
;

596 
	`mem£t
(&
func
, 0, (
ejfunc_t
));

597 
	`£tSåög
(
B_L
, &
func
.
‚ame
, 
ï
->
tokí
);

598 
ï
->
func
 = &func;

600 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
	`T
(""));

601 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_LPAREN
) {

602 
	`‰ìFunc
(&
func
);

603 
îr‹
;

606 i‡(
	`∑r£
(
ï
, 
STATE_ARG_LIST
, 
Êags
Ë!
STATE_ARG_LIST_DONE
) {

607 
	`‰ìFunc
(&
func
);

608 
ï
->
func
 = 
ßveFunc
;

609 
îr‹
;

614 i‡(
Êags
 & 
FLAGS_EXE
 && 
	`evÆFun˘i⁄
(
ï
) < 0) {

615 
	`‰ìFunc
(&
func
);

616 
ï
->
func
 = 
ßveFunc
;

617 
îr‹
;

620 
	`‰ìFunc
(&
func
);

621 
ï
->
func
 = 
ßveFunc
;

623 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_RPAREN
) {

624 
îr‹
;

626 i‡(
°©e
 =
STATE_STMT
) {

627 
ex≥˘Semi
++;

629 
d⁄e
++;

632 
TOK_IF
:

633 i‡(
°©e
 !
STATE_STMT
) {

634 
îr‹
;

636 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_LPAREN
) {

637 
îr‹
;

642 i‡(
	`∑r£
(
ï
, 
STATE_COND
, 
Êags
Ë!
STATE_COND_DONE
) {

643 
îr‹
;

645 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_RPAREN
) {

646 
îr‹
;

652 i‡(*
ï
->
ªsu…
 == '1') {

653 
thíFœgs
 = 
Êags
;

654 
ñ£Fœgs
 = 
Êags
 & ~
FLAGS_EXE
;

656 
thíFœgs
 = 
Êags
 & ~
FLAGS_EXE
;

657 
ñ£Fœgs
 = 
Êags
;

662 
	`∑r£
(
ï
, 
STATE_STMT
, 
thíFœgs
)) {

663 
STATE_RET
:

664  
STATE_RET
;

665 
STATE_STMT_DONE
:

668 
îr‹
;

673 
	`ejRemoveNewlöes
(
ï
, 
°©e
);

674 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

675 i‡(
tid
 !
TOK_ELSE
) {

676 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

677 
d⁄e
++;

683 
	`∑r£
(
ï
, 
STATE_STMT
, 
ñ£Fœgs
)) {

684 
STATE_RET
:

685  
STATE_RET
;

686 
STATE_STMT_DONE
:

689 
îr‹
;

691 
d⁄e
++;

694 
TOK_FOR
:

702 i‡(
°©e
 !
STATE_STMT
) {

703 
îr‹
;

705 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_LPAREN
) {

706 
îr‹
;

712 i‡(
	`∑r£
(
ï
, 
STATE_EXPR
, 
Êags
Ë!
STATE_EXPR_DONE
) {

713 
îr‹
;

715 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_SEMI
) {

716 
îr‹
;

724 
	`ejLexSaveI≈utSèã
(
ï
, &
c⁄dS¸ùt
);

725 i‡(
	`∑r£
(
ï
, 
STATE_COND
, 
Êags
Ë!
STATE_COND_DONE
) {

726 
îr‹
;

728 
c⁄d
 = (*
ï
->
ªsu…
 != '0');

730 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_SEMI
) {

731 
îr‹
;

737 
f‹Fœgs
 = 
Êags
 & ~
FLAGS_EXE
;

738 
	`ejLexSaveI≈utSèã
(
ï
, &
ö¸S¸ùt
);

739 i‡(
	`∑r£
(
ï
, 
STATE_EXPR
, 
f‹Fœgs
Ë!
STATE_EXPR_DONE
) {

740 
îr‹
;

742 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_RPAREN
) {

743 
îr‹
;

749 
	`ejLexSaveI≈utSèã
(
ï
, &
bodyS¸ùt
);

750 i‡(
	`∑r£
(
ï
, 
STATE_STMT
, 
f‹Fœgs
Ë!
STATE_STMT_DONE
) {

751 
îr‹
;

753 
	`ejLexSaveI≈utSèã
(
ï
, &
ídS¸ùt
);

758 
c⁄d
 && (
Êags
 & 
FLAGS_EXE
) ) {

762 
	`ejLexRe°‹eI≈utSèã
(
ï
, &
bodyS¸ùt
);

764 
	`∑r£
(
ï
, 
STATE_STMT
, 
Êags
)) {

765 
STATE_RET
:

766  
STATE_RET
;

767 
STATE_STMT_DONE
:

770 
îr‹
;

775 
	`ejLexRe°‹eI≈utSèã
(
ï
, &
ö¸S¸ùt
);

776 i‡(
	`∑r£
(
ï
, 
STATE_EXPR
, 
Êags
Ë!
STATE_EXPR_DONE
) {

777 
îr‹
;

782 
	`ejLexRe°‹eI≈utSèã
(
ï
, &
c⁄dS¸ùt
);

783 i‡(
	`∑r£
(
ï
, 
STATE_COND
, 
Êags
Ë!
STATE_COND_DONE
) {

784 
îr‹
;

786 
c⁄d
 = (*
ï
->
ªsu…
 != '0');

788 
	`ejLexRe°‹eI≈utSèã
(
ï
, &
ídS¸ùt
);

789 
d⁄e
++;

792 
TOK_VAR
:

793 i‡(
	`∑r£
(
ï
, 
STATE_DEC_LIST
, 
Êags
Ë!
STATE_DEC_LIST_DONE
) {

794 
îr‹
;

796 
d⁄e
++;

799 
TOK_COMMA
:

800 
	`ejLexPutbackTokí
(
ï
, 
TOK_EXPR
,Ép->
tokí
);

801 
d⁄e
++;

804 
TOK_LPAREN
:

805 i‡(
°©e
 =
STATE_EXPR
) {

806 i‡(
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
Ë!
STATE_RELEXP_DONE
) {

807 
îr‹
;

809 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_RPAREN
) {

810 
îr‹
;

812  
STATE_EXPR_DONE
;

814 
d⁄e
++;

817 
TOK_RPAREN
:

818 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

819  
STATE_EXPR_DONE
;

821 
TOK_LBRACE
:

825 i‡(
°©e
 !
STATE_STMT
) {

826 
îr‹
;

833 
°©e
 = 
	`∑r£
(
ï
, 
STATE_STMT
, 
Êags
);

834 } 
°©e
 =
STATE_STMT_DONE
);

839 i‡(
°©e
 =
STATE_RET
) {

840  
°©e
;

843 i‡(
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_RBRACE
) {

844 
îr‹
;

846  
STATE_STMT_DONE
;

848 
TOK_RBRACE
:

849 i‡(
°©e
 =
STATE_STMT
) {

850 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

851  
STATE_STMT_BLOCK_DONE
;

853 
îr‹
;

855 
TOK_RETURN
:

856 i‡(
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
Ë!
STATE_RELEXP_DONE
) {

857 
îr‹
;

859 i‡(
Êags
 & 
FLAGS_EXE
) {

860  
	`ejLexGëTokí
(
ï
, 
°©e
Ë!
TOK_EOF
 );

861 
d⁄e
++;

862  
STATE_RET
;

868 i‡(
ex≥˘Semi
) {

869 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

870 i‡(
tid
 !
TOK_SEMI
 &&Åid !
TOK_NEWLINE
) {

871 
îr‹
;

877 
	`ejRemoveNewlöes
(
ï
, 
°©e
);

883 
d⁄eP¨£
:

884 i‡(
tid
 =
TOK_FOR
) {

885 
	`ejLexFªeI≈utSèã
(
ï
, &
c⁄dS¸ùt
);

886 
	`ejLexFªeI≈utSèã
(
ï
, &
ö¸S¸ùt
);

887 
	`ejLexFªeI≈utSèã
(
ï
, &
ídS¸ùt
);

888 
	`ejLexFªeI≈utSèã
(
ï
, &
bodyS¸ùt
);

891 i‡(
°©e
 =
STATE_STMT
) {

892  
STATE_STMT_DONE
;

893 } i‡(
°©e
 =
STATE_DEC
) {

894  
STATE_DEC_DONE
;

895 } i‡(
°©e
 =
STATE_EXPR
) {

896  
STATE_EXPR_DONE
;

897 } i‡(
°©e
 =
STATE_EOF
) {

898  
°©e
;

900  
STATE_ERR
;

906 
îr‹
:

907 
°©e
 = 
STATE_ERR
;

908 
d⁄eP¨£
;

909 
	}
}

916 
	$∑r£De˛¨©i⁄
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

918 
tid
;

920 
	`a_as£π
(
ï
);

932 i‡((
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
)Ë!
TOK_ID
) {

933  
STATE_ERR
;

935 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

940 i‡(
	`∑r£
(
ï
, 
STATE_DEC
, 
Êags
Ë!
STATE_DEC_DONE
) {

941  
STATE_ERR
;

947 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

948 i‡(
tid
 =
TOK_SEMI
) {

949  
STATE_DEC_LIST_DONE
;

950 } i‡(
tid
 !
TOK_COMMA
) {

951  
STATE_ERR
;

953 } 
tid
 =
TOK_COMMA
);

955 i‡(
tid
 !
TOK_SEMI
) {

956  
STATE_ERR
;

958  
STATE_DEC_LIST_DONE
;

959 
	}
}

966 
	$∑r£Args
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

968 
tid
, 
aid
;

970 
	`a_as£π
(
ï
);

973 
°©e
 = 
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
);

974 i‡(
°©e
 =
STATE_EOF
 || sèã =
STATE_ERR
) {

975  
°©e
;

977 i‡(
°©e
 =
STATE_RELEXP_DONE
) {

978 
aid
 = 
	`hAŒoc
((***Ë&
ï
->
func
->
¨gs
);

979 
ï
->
func
->
¨gs
[
aid
] = 
	`b°rdup
(
B_L
,Ép->
ªsu…
);

980 
ï
->
func
->
nArgs
++;

985 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

986 i‡(
tid
 !
TOK_COMMA
) {

987 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

989 } 
tid
 =
TOK_COMMA
);

991 i‡(
tid
 !
TOK_RPAREN
 && 
°©e
 !
STATE_RELEXP_DONE
) {

992  
STATE_ERR
;

994  
STATE_ARG_LIST_DONE
;

995 
	}
}

1002 
	$∑r£C⁄d
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

1004 
ch¨_t
 *
lhs
, *
rhs
;

1005 
tid
, 
›î©‹
;

1007 
	`a_as£π
(
ï
);

1009 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
	`T
(""));

1010 
rhs
 = 
lhs
 = 
NULL
;

1011 
›î©‹
 = 0;

1018 
°©e
 = 
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
);

1019 i‡(
°©e
 !
STATE_RELEXP_DONE
) {

1020 
°©e
 = 
STATE_ERR
;

1024 i‡(
›î©‹
 > 0) {

1025 
	`£tSåög
(
B_L
, &
rhs
, 
ï
->
ªsu…
);

1026 i‡(
	`evÆC⁄d
(
ï
, 
lhs
, 
›î©‹
, 
rhs
) < 0) {

1027 
°©e
 = 
STATE_ERR
;

1031 
	`£tSåög
(
B_L
, &
lhs
, 
ï
->
ªsu…
);

1033 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

1034 i‡(
tid
 =
TOK_LOGICAL
) {

1035 
›î©‹
 = (Ë*
ï
->
tokí
;

1037 } i‡(
tid
 =
TOK_RPAREN
 ||Åid =
TOK_SEMI
) {

1038 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

1039 
°©e
 = 
STATE_COND_DONE
;

1043 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

1046 } 
°©e
 =
STATE_RELEXP_DONE
);

1048 i‡(
lhs
) {

1049 
	`b‰ì
(
B_L
, 
lhs
);

1052 i‡(
rhs
) {

1053 
	`b‰ì
(
B_L
, 
rhs
);

1055  
°©e
;

1056 
	}
}

1063 
	$∑r£Ex¥
(
ej_t
 *
ï
, 
°©e
, 
Êags
)

1065 
ch¨_t
 *
lhs
, *
rhs
;

1066 
ªl
, 
tid
;

1068 
	`a_as£π
(
ï
);

1070 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
	`T
(""));

1071 
rhs
 = 
lhs
 = 
NULL
;

1072 
ªl
 = 0;

1073 
tid
 = 0;

1080 i‡(
tid
 =
TOK_LOGICAL
) {

1081 i‡((
°©e
 = 
	`∑r£
(
ï
, 
STATE_RELEXP
, 
Êags
)Ë!
STATE_RELEXP_DONE
) {

1082 
°©e
 = 
STATE_ERR
;

1086 i‡((
°©e
 = 
	`∑r£
(
ï
, 
STATE_EXPR
, 
Êags
)Ë!
STATE_EXPR_DONE
) {

1087 
°©e
 = 
STATE_ERR
;

1092 i‡(
ªl
 > 0) {

1093 
	`£tSåög
(
B_L
, &
rhs
, 
ï
->
ªsu…
);

1094 i‡(
tid
 =
TOK_LOGICAL
) {

1095 i‡(
	`evÆC⁄d
(
ï
, 
lhs
, 
ªl
, 
rhs
) < 0) {

1096 
°©e
 = 
STATE_ERR
;

1100 i‡(
	`evÆEx¥
(
ï
, 
lhs
, 
ªl
, 
rhs
) < 0) {

1101 
°©e
 = 
STATE_ERR
;

1106 
	`£tSåög
(
B_L
, &
lhs
, 
ï
->
ªsu…
);

1108 i‡((
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
)Ë=
TOK_EXPR
 ||

1109 
tid
 =
TOK_INC_DEC
 ||Åid =
TOK_LOGICAL
) {

1110 
ªl
 = (Ë*
ï
->
tokí
;

1113 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

1114 
°©e
 = 
STATE_RELEXP_DONE
;

1117 } 
°©e
 =
STATE_EXPR_DONE
);

1119 i‡(
rhs
) {

1120 
	`b‰ì
(
B_L
, 
rhs
);

1123 i‡(
lhs
) {

1124 
	`b‰ì
(
B_L
, 
lhs
);

1127  
°©e
;

1128 
	}
}

1135 
	$evÆC⁄d
(
ej_t
 *
ï
, 
ch¨_t
 *
lhs
, 
ªl
, ch¨_à*
rhs
)

1137 
ch¨_t
 
buf
[16];

1138 
l
, 
r
, 
lvÆ
;

1140 
	`a_as£π
(
lhs
);

1141 
	`a_as£π
(
rhs
);

1142 
	`a_as£π
(
ªl
 > 0);

1144 
lvÆ
 = 0;

1145 i‡(
	`gisdigô
(()*
lhs
Ë&& gisdigô(()*
rhs
)) {

1146 
l
 = 
	`g©oi
(
lhs
);

1147 
r
 = 
	`g©oi
(
rhs
);

1148 
ªl
) {

1149 
COND_AND
:

1150 
lvÆ
 = 
l
 && 
r
;

1152 
COND_OR
:

1153 
lvÆ
 = 
l
 || 
r
;

1156 
	`ejEº‹
(
ï
, 
	`T
("Bad o≥øt‹ %d"), 
ªl
);

1160 i‡(!
	`gisdigô
(()*
lhs
)) {

1161 
	`ejEº‹
(
ï
, 
	`T
("C⁄dôi⁄Æ mu° bênumîic"), 
lhs
);

1163 
	`ejEº‹
(
ï
, 
	`T
("C⁄dôi⁄Æ mu° bênumîic"), 
rhs
);

1167 
	`°rôﬂ
(
lvÆ
, 
buf
, (buf));

1168 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
buf
);

1170 
	}
}

1177 
	$evÆEx¥
(
ej_t
 *
ï
, 
ch¨_t
 *
lhs
, 
ªl
, ch¨_à*
rhs
)

1179 
ch¨_t
 *
˝
, 
buf
[16];

1180 
numîic
, 
l
, 
r
, 
lvÆ
;

1182 
	`a_as£π
(
lhs
);

1183 
	`a_as£π
(
rhs
);

1184 
	`a_as£π
(
ªl
 > 0);

1189 
numîic
 = 1;

1190 
˝
 = 
lhs
; *cp; cp++) {

1191 i‡(!
	`gisdigô
(()*
˝
)) {

1192 
numîic
 = 0;

1197 i‡(
numîic
) {

1198 
˝
 = 
rhs
; *cp; cp++) {

1199 i‡(!
	`gisdigô
(()*
˝
)) {

1200 
numîic
 = 0;

1206 i‡(
numîic
) {

1207 
l
 = 
	`g©oi
(
lhs
);

1208 
r
 = 
	`g©oi
(
rhs
);

1209 
ªl
) {

1210 
EXPR_PLUS
:

1211 
lvÆ
 = 
l
 + 
r
;

1213 
EXPR_INC
:

1214 
lvÆ
 = 
l
 + 1;

1216 
EXPR_MINUS
:

1217 
lvÆ
 = 
l
 - 
r
;

1219 
EXPR_DEC
:

1220 
lvÆ
 = 
l
 - 1;

1222 
EXPR_MUL
:

1223 
lvÆ
 = 
l
 * 
r
;

1225 
EXPR_DIV
:

1226 i‡(
r
 != 0) {

1227 
lvÆ
 = 
l
 / 
r
;

1229 
lvÆ
 = 0;

1232 
EXPR_MOD
:

1233 i‡(
r
 != 0) {

1234 
lvÆ
 = 
l
 % 
r
;

1236 
lvÆ
 = 0;

1239 
EXPR_LSHIFT
:

1240 
lvÆ
 = 
l
 << 
r
;

1242 
EXPR_RSHIFT
:

1243 
lvÆ
 = 
l
 >> 
r
;

1245 
EXPR_EQ
:

1246 
lvÆ
 = 
l
 =
r
;

1248 
EXPR_NOTEQ
:

1249 
lvÆ
 = 
l
 !
r
;

1251 
EXPR_LESS
:

1252 
lvÆ
 = (
l
 < 
r
) ? 1 : 0;

1254 
EXPR_LESSEQ
:

1255 
lvÆ
 = (
l
 <
r
) ? 1 : 0;

1257 
EXPR_GREATER
:

1258 
lvÆ
 = (
l
 > 
r
) ? 1 : 0;

1260 
EXPR_GREATEREQ
:

1261 
lvÆ
 = (
l
 >
r
) ? 1 : 0;

1263 
EXPR_BOOL_COMP
:

1264 
lvÆ
 = (
r
 == 0) ? 1 : 0;

1267 
	`ejEº‹
(
ï
, 
	`T
("Bad o≥øt‹ %d"), 
ªl
);

1272 
ªl
) {

1273 
EXPR_PLUS
:

1274 
	`˛órSåög
(&
ï
->
ªsu…
);

1275 
	`≠≥ndSåög
(&
ï
->
ªsu…
, 
lhs
);

1276 
	`≠≥ndSåög
(&
ï
->
ªsu…
, 
rhs
);

1278 
EXPR_LESS
:

1279 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) < 0;

1281 
EXPR_LESSEQ
:

1282 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) <= 0;

1284 
EXPR_GREATER
:

1285 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) > 0;

1287 
EXPR_GREATEREQ
:

1288 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) >= 0;

1290 
EXPR_EQ
:

1291 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) == 0;

1293 
EXPR_NOTEQ
:

1294 
lvÆ
 = 
	`g°rcmp
(
lhs
, 
rhs
) != 0;

1296 
EXPR_INC
:

1297 
EXPR_DEC
:

1298 
EXPR_MINUS
:

1299 
EXPR_DIV
:

1300 
EXPR_MOD
:

1301 
EXPR_LSHIFT
:

1302 
EXPR_RSHIFT
:

1304 
	`ejEº‹
(
ï
, 
	`T
("Bad operator"));

1309 
	`°rôﬂ
(
lvÆ
, 
buf
, (buf));

1310 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
buf
);

1312 
	}
}

1319 
	$evÆFun˘i⁄
(
ej_t
 *
ï
)

1321 
sym_t
 *
•
;

1322 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

1324 i‡((
•
 = 
	`symLookup
(
ï
->
fun˘i⁄s
,Ép->
func
->
‚ame
)Ë=
NULL
) {

1325 
	`ejEº‹
(
ï
, 
	`T
("UndeföedÖro˚duª %s"),Ép->
func
->
‚ame
);

1329 
‚
 = ((*)(, *, , 
ch¨_t
**)Ë
•
->
c⁄ã¡
.
vÆue
.
öãgî
;

1330 i‡(
‚
 =
NULL
) {

1331 
	`ejEº‹
(
ï
, 
	`T
("UndeföedÖro˚duª %s"),Ép->
func
->
‚ame
);

1335  (*
‚
)(
ï
->
eid
,Ép->
u£rH™dÀ
,Ép->
func
->
nArgs
,

1336 
ï
->
func
->
¨gs
);

1337 
	}
}

1344 
	$ejEº‹
(
ej_t
* 
ï
, 
ch¨_t
* 
fmt
, ...)

1346 
va_li°
 
¨gs
;

1347 
ejöput_t
 *
ù
;

1348 
ch¨_t
 *
îrbuf
, *
msgbuf
;

1350 
	`a_as£π
(
ï
);

1351 
	`a_as£π
(
fmt
);

1352 
ù
 = 
ï
->
öput
;

1354 
	`va_°¨t
(
¨gs
, 
fmt
);

1355 
msgbuf
 = 
NULL
;

1356 
	`fmtVÆloc
(&
msgbuf
, 
E_MAX_ERROR
, 
fmt
, 
¨gs
);

1357 
	`va_íd
(
¨gs
);

1359 i‡(
ï
 && 
ù
) {

1360 
	`fmtAŒoc
(&
îrbuf
, 
E_MAX_ERROR
, 
	`T
("%s\n AtÜine %d,Üine => \n\n%s\n"),

1361 
msgbuf
, 
ù
->
löeNumbî
, ip->
löe
);

1362 
	`b‰ìSa„
(
B_L
, 
ï
->
îr‹
);

1363 
ï
->
îr‹
 = 
îrbuf
;

1365 
	`b‰ìSa„
(
B_L
, 
msgbuf
);

1366 
	}
}

1373 
	$˛órSåög
(
ch¨_t
 **
±r
)

1375 
	`a_as£π
(
±r
);

1377 i‡(*
±r
) {

1378 
	`b‰ì
(
B_L
, *
±r
);

1380 *
±r
 = 
NULL
;

1381 
	}
}

1388 
	$£tSåög
(
B_ARGS_DEC
, 
ch¨_t
 **
±r
, ch¨_à*
s
)

1390 
	`a_as£π
(
±r
);

1392 i‡(*
±r
) {

1393 
	`b‰ì
(
B_ARGS
, *
±r
);

1395 *
±r
 = 
	`b°rdup
(
B_ARGS
, 
s
);

1396 
	}
}

1403 
	$≠≥ndSåög
(
ch¨_t
 **
±r
, ch¨_à*
s
)

1405 
Àn
, 
ﬁdÀn
, 
size
;

1407 
	`a_as£π
(
±r
);

1409 i‡(*
±r
) {

1410 
Àn
 = 
	`g°æí
(
s
);

1411 
ﬁdÀn
 = 
	`g°æí
(*
±r
);

1412 
size
 = (
Àn
 + 
ﬁdÀn
 + 1Ë* (
ch¨_t
);

1413 *
±r
 = 
	`bªÆloc
(
B_L
, *±r, 
size
);

1414 #i‡!
	`deföed
(
WIN32
)

1415 
	`g°r˝y
(&(*
±r
)[
ﬁdÀn
], 
s
);

1417 
	`°r˝y_s
(&(*
±r
)[
ﬁdÀn
], 
size
 - oldÀn, 
s
);

1420 *
±r
 = 
	`b°rdup
(
B_L
, 
s
);

1422 
	}
}

1429 
ejSëGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
,

1430 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
))

1432 
ej_t
 *
ï
;

1434 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1437  
	`ejSëGlobÆFun˘i⁄Dúe˘
(
ï
->
fun˘i⁄s
, 
«me
, 
‚
);

1438 
	}
}

1445 
ejSëGlobÆFun˘i⁄Dúe˘
(
sym_fd_t
 
fun˘i⁄s
, 
ch¨_t
 *
«me
,

1446 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
))

1448 i‡(
	`symE¡î
(
fun˘i⁄s
, 
«me
, 
	`vÆueI¡egî
((Ë
‚
), 0Ë=
NULL
) {

1452 
	}
}

1459 
	$ejRemoveGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
)

1461 
ej_t
 *
ï
;

1463 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1466  
	`symDñëe
(
ï
->
fun˘i⁄s
, 
«me
);

1467 
	}
}

1474 *
	$ejGëGlobÆFun˘i⁄
(
eid
, 
ch¨_t
 *
«me
)

1476 
ej_t
 *
ï
;

1477 
sym_t
 *
•
;

1478 (*
‚
)(
eid
, *
h™dÀ
, 
¨gc
, 
ch¨_t
 **
¨gv
);

1480 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1481  
NULL
;

1484 i‡((
•
 = 
	`symLookup
(
ï
->
fun˘i⁄s
, 
«me
)Ë!
NULL
) {

1485 
‚
 = ((*)(, *, , 
ch¨_t
**)Ë
•
->
c⁄ã¡
.
vÆue
.
öãgî
;

1486  (*Ë
‚
;

1488  
NULL
;

1489 
	}
}

1504 
	$ejArgs
(
¨gc
, 
ch¨_t
 **
¨gv
, ch¨_à*
fmt
, ...)

1506 
va_li°
 
v¨gs
;

1507 
ch¨_t
 *
˝
, **
•
;

1508 *
ù
;

1509 
¨gn
;

1511 
	`va_°¨t
(
v¨gs
, 
fmt
);

1513 i‡(
¨gv
 =
NULL
) {

1517 
¨gn
 = 0, 
˝
 = 
fmt
; c∞&& *˝ && 
¨gv
[argn]; ) {

1518 i‡(*
˝
++ != '%') {

1522 *
˝
) {

1524 
ù
 = 
	`va_¨g
(
v¨gs
, *);

1525 *
ù
 = 
	`g©oi
(
¨gv
[
¨gn
]);

1529 
•
 = 
	`va_¨g
(
v¨gs
, 
ch¨_t
**);

1530 *
•
 = 
¨gv
[
¨gn
];

1537 
	`a_as£π
(0);

1539 
¨gn
++;

1542 
	`va_íd
(
v¨gs
);

1543  
¨gn
;

1544 
	}
}

1551 
	$ejSëU£rH™dÀ
(
eid
, * 
h™dÀ
)

1553 
ej_t
 *
ï
;

1555 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1558 
ï
->
u£rH™dÀ
 = 
h™dÀ
;

1559 
	}
}

1566 * 
	$ejGëU£rH™dÀ
(
eid
)

1568 
ej_t
 *
ï
;

1570 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1571  
NULL
;

1573  
ï
->
u£rH™dÀ
;

1574 
	}
}

1581 
	$ejGëLöeNumbî
(
eid
)

1583 
ej_t
 *
ï
;

1585 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1588  
ï
->
öput
->
löeNumbî
;

1589 
	}
}

1596 
	$ejSëResu…
(
eid
, 
ch¨_t
 *
s
)

1598 
ej_t
 *
ï
;

1600 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1603 
	`£tSåög
(
B_L
, &
ï
->
ªsu…
, 
s
);

1604 
	}
}

1611 
ch¨_t
 *
	$ejGëResu…
(
eid
)

1613 
ej_t
 *
ï
;

1615 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1616  
NULL
;

1618  
ï
->
ªsu…
;

1619 
	}
}

1627 
	$ejSëV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
)

1629 
ej_t
 *
ï
;

1630 
vÆue_t
 
v
;

1632 
	`a_as£π
(
v¨
 && *var);

1634 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1638 i‡(
vÆue
 =
NULL
) {

1639 
v
 = 
	`vÆueSåög
(
vÆue
, 0);

1641 
v
 = 
	`vÆueSåög
(
vÆue
, 
VALUE_ALLOCATE
);

1643 
	`symE¡î
(
ï
->
v¨übÀs
[ï->
v¨übÀMax
 - 1] - 
EJ_OFFSET
, 
v¨
, 
v
, 0);

1644 
	}
}

1652 
	$ejSëLoˇlV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
)

1654 
ej_t
 *
ï
;

1655 
vÆue_t
 
v
;

1657 
	`a_as£π
(
v¨
 && *var);

1659 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1663 i‡(
vÆue
 =
NULL
) {

1664 
v
 = 
	`vÆueSåög
(
vÆue
, 0);

1666 
v
 = 
	`vÆueSåög
(
vÆue
, 
VALUE_ALLOCATE
);

1668 
	`symE¡î
(
ï
->
v¨übÀs
[ï->
v¨übÀMax
 - 1] - 
EJ_OFFSET
, 
v¨
, 
v
, 0);

1669 
	}
}

1677 
	$ejSëGlobÆV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
)

1679 
ej_t
 *
ï
;

1680 
vÆue_t
 
v
;

1682 
	`a_as£π
(
v¨
 && *var);

1684 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1688 i‡(
vÆue
 =
NULL
) {

1689 
v
 = 
	`vÆueSåög
(
vÆue
, 0);

1691 
v
 = 
	`vÆueSåög
(
vÆue
, 
VALUE_ALLOCATE
);

1693 
	`symE¡î
(
ï
->
v¨übÀs
[0] - 
EJ_OFFSET
, 
v¨
, 
v
, 0);

1694 
	}
}

1701 
	$ejGëV¨
(
eid
, 
ch¨_t
 *
v¨
, ch¨_à**
vÆue
)

1703 
ej_t
 *
ï
;

1704 
sym_t
 *
•
;

1705 
i
;

1707 
	`a_as£π
(
v¨
 && *var);

1708 
	`a_as£π
(
vÆue
);

1710 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1714 
i
 = 
ï
->
v¨übÀMax
 - 1;

1715 i‡((
•
 = 
	`symLookup
(
ï
->
v¨übÀs
[
i
] - 
EJ_OFFSET
, 
v¨
)Ë=
NULL
) {

1716 
i
 = 0;

1717 i‡((
•
 = 
	`symLookup
(
ï
->
v¨übÀs
[0] - 
EJ_OFFSET
, 
v¨
)Ë=
NULL
) {

1721 
	`a_as£π
(
•
->
c⁄ã¡
.
ty≥
 =
°rög
);

1722 *
vÆue
 = 
•
->
c⁄ã¡
.vÆue.
°rög
;

1723  
i
;

1724 
	}
}

1731 
sym_fd_t
 
	$ejGëV¨übÀTabÀ
(
eid
)

1733 
ej_t
 *
ï
;

1735 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1738  *
ï
->
v¨übÀs
;

1739 
	}
}

1746 
sym_fd_t
 
	$ejGëFun˘i⁄TabÀ
(
eid
)

1748 
ej_t
 *
ï
;

1750 i‡((
ï
 = 
	`ejPå
(
eid
)Ë=
NULL
) {

1753  
ï
->
fun˘i⁄s
;

1754 
	}
}

1761 
	$‰ìFunc
(
ejfunc_t
 *
func
)

1763 
i
;

1765 
i
 = 
func
->
nArgs
 - 1; i >= 0; i--) {

1766 
	`b‰ì
(
B_L
, 
func
->
¨gs
[
i
]);

1767 
func
->
nArgs
 = 
	`hFªe
((***Ë&func->
¨gs
, 
i
);

1770 i‡(
func
->
‚ame
) {

1771 
	`b‰ì
(
B_L
, 
func
->
‚ame
);

1772 
func
->
‚ame
 = 
NULL
;

1774 
	}
}

1781 
ej_t
 *
	$ejPå
(
eid
)

1783 
	`a_as£π
(0 <
eid
 &&Éid < 
ejMax
);

1785 i‡(
eid
 < 0 ||Éid >
ejMax
 || 
ejH™dÀs
[eid] =
NULL
) {

1786 
	`ejEº‹
(
NULL
, 
	`T
("Bad h™dÀ %d"), 
eid
);

1787  
NULL
;

1789  
ejH™dÀs
[
eid
];

1790 
	}
}

1796 
	$ejRemoveNewlöes
(
ej_t
 *
ï
, 
°©e
)

1798 
tid
;

1801 
tid
 = 
	`ejLexGëTokí
(
ï
, 
°©e
);

1802 } 
tid
 =
TOK_NEWLINE
);

1804 
	`ejLexPutbackTokí
(
ï
, 
tid
,Ép->
tokí
);

1805 
	}
}

	@emfdb.c

17 
	~"emfdb.h
"

18 
	~"wsI¡∫.h
"

22 
	#KEYWORD_TABLE
 
	`T
("TABLE")

	)

23 
	#KEYWORD_ROW
 
	`T
("ROW")

	)

31 
ch¨_t
 *
	gbasicProdDú
 = 
NULL
;

32 
ch¨_t
 *
	gbasicDeÁu…Dú
 = 
T
(".");

38 
	gdbMaxTabÀs
 = 0;

39 
dbTabÀ_t
 **
	gdbLi°TabÀs
 = 
NULL
;

43 
¸ack
(
ch¨_t
 *
buf
, ch¨_à**
key
, ch¨_à**
vÆ
);

44 
ch¨_t
 *
åim
(ch¨_à*
°r
);

45 
GëCﬁumnIndex
(
tid
, 
ch¨_t
 *
cﬁName
);

52 
	$dbRegi°îDBSchema
(
dbTabÀ_t
 *
pTabÀRegi°î
)

54 
dbTabÀ_t
 *
pTabÀ
;

55 
tid
;

57 
	`a_as£π
(
pTabÀRegi°î
);

59 
	`åa˚
(4, 
	`T
("DB: Registering databaseÅable <%s>\n"),

60 
pTabÀRegi°î
->
«me
);

65 
tid
 = 
	`hAŒocE¡ry
((***Ë&
dbLi°TabÀs
,

66 &
dbMaxTabÀs
, (
dbTabÀ_t
));

71 
	`a_as£π
(
dbLi°TabÀs
);

72 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

73 
	`a_as£π
(
pTabÀ
);

78 
pTabÀ
->
«me
 = 
	`b°rdup
(
B_L
, 
pTabÀRegi°î
->name);

83 
pTabÀ
->
nCﬁumns
 = 
pTabÀRegi°î
->nColumns;

88 i‡(
pTabÀ
->
nCﬁumns
 > 0) {

89 
i
;

90 
pTabÀ
->
cﬁumnNames
 = 
	`bÆloc
(
B_L
, (
ch¨_t
 *Ë*ÖTabÀ->
nCﬁumns
);

91 
pTabÀ
->
cﬁumnTy≥s
 = 
	`bÆloc
(
B_L
, (*Ë*ÖTabÀ->
nCﬁumns
);

93 
i
 = 0; (ò< 
pTabÀRegi°î
->
nCﬁumns
); i++) {

94 
pTabÀ
->
cﬁumnNames
[
i
] =

95 
	`b°rdup
(
B_L
, 
pTabÀRegi°î
->
cﬁumnNames
[
i
]);

96 
pTabÀ
->
cﬁumnTy≥s
[
i
] = 
pTabÀRegi°î
->columnTypes[i];

100 
pTabÀ
->
cﬁumnNames
 = 
NULL
;

101 
pTabÀ
->
cﬁumnTy≥s
 = 
NULL
;

107 
pTabÀ
->
nRows
 = 0;

108 
pTabÀ
->
rows
 = 
NULL
;

111 
	}
}

119 
dbO≥n
(
ch¨_t
 *
èbÀ«me
, ch¨_à*
fûíame
,

120 (*
gëtime
)(
did
), 
Êags
)

122 
basicProdDú
 = 
NULL
;

123 
basicDeÁu…Dú
 = 
	`T
(".");

124 
dbMaxTabÀs
 = 0;

125 
dbLi°TabÀs
 = 
NULL
;

127 
	}
}

134 
	$dbClo£
(
did
)

136 
èbÀ
, 
cﬁumn
;

137 
dbTabÀ_t
 *
pTabÀ
;

142 
	`dbZîo
(
did
);

147 
èbÀ
 = 0;ÅabÀ < 
dbMaxTabÀs
;Åable++) {

148 
pTabÀ
 = 
dbLi°TabÀs
[
èbÀ
];

150 i‡(
pTabÀ
 !
NULL
) {

154 i‡(
pTabÀ
->
nCﬁumns
) {

155 
cﬁumn
 = 0; cﬁum¿< 
pTabÀ
->
nCﬁumns
; column++) {

156 
	`b‰ìSa„
(
B_L
, 
pTabÀ
->
cﬁumnNames
[
cﬁumn
]);

158 
	`b‰ìSa„
(
B_L
, 
pTabÀ
->
cﬁumnNames
);

159 
	`b‰ìSa„
(
B_L
, 
pTabÀ
->
cﬁumnTy≥s
);

164 
	`b‰ìSa„
(
B_L
, 
pTabÀ
->
«me
);

168 
	`b‰ìSa„
(
B_L
, 
pTabÀ
);

169 
	`hFªe
((***Ë&
dbLi°TabÀs
, 
èbÀ
);

173 i‡(
dbLi°TabÀs
) {

174 
	`b‰ì
(
B_L
, 
dbLi°TabÀs
);

180 
dbLi°TabÀs
 = 
NULL
;

181 
dbMaxTabÀs
 = 0;

182 
	}
}

190 
	$dbZîo
(
did
)

192 
èbÀ
, 
row
, 
cﬁumn
, 
nRows
, 
nCﬁumns
;

193 *
pRow
;

194 
dbTabÀ_t
 *
pTabÀ
;

199 
èbÀ
 = 0;ÅabÀ < 
dbMaxTabÀs
;Åable++) {

200 
pTabÀ
 = 
dbLi°TabÀs
[
èbÀ
];

204 i‡(
pTabÀ
) {

205 
nCﬁumns
 = 
pTabÀ
->nColumns;

206 
nRows
 = 
pTabÀ
->nRows;

207 
row
 = 0;Ñow < 
nRows
;Ñow++) {

208 
pRow
 = 
pTabÀ
->
rows
[
row
];

209 i‡(
pRow
) {

213 
cﬁumn
 = 0; cﬁum¿< 
nCﬁumns
; column++) {

214 i‡(
pTabÀ
->
cﬁumnTy≥s
[
cﬁumn
] =
T_STRING
) {

215 
	`b‰ìSa„
(
B_L
, (
ch¨_t
 *)(
pRow
[
cﬁumn
]));

216 
pRow
[
cﬁumn
] = ()
NULL
;

220 
	`b‰ìSa„
(
B_L
, 
pRow
);

221 
	`hFªe
((***Ë&
pTabÀ
->
rows
, 
row
);

225 
pTabÀ
->
rows
 = 
NULL
;

226 
pTabÀ
->
nRows
 = 0;

229 
	}
}

236 
	$dbSórchSå
(
did
, 
ch¨_t
 *
èbÀ«me
,

237 
ch¨_t
 *
cﬁName
, ch¨_à*
vÆue
, 
Êags
)

239 
tid
, 
nRows
, 
nCﬁumns
, 
cﬁumn
;

240 
m©ch
 = 0;

241 
dbTabÀ_t
 *
pTabÀ
;

243 
	`a_as£π
(
èbÀ«me
);

244 
	`a_as£π
(
cﬁName
);

245 
	`a_as£π
(
vÆue
);

247 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ«me
);

248 
	`a_as£π
(
tid
 >= 0);

250 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

251 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

253  
DB_ERR_TABLE_NOT_FOUND
;

256 
nCﬁumns
 = 
pTabÀ
->nColumns;

257 
nRows
 = 
pTabÀ
->nRows;

258 
cﬁumn
 = 
	`GëCﬁumnIndex
(
tid
, 
cﬁName
);

259 
	`a_as£π
 (
cﬁumn
 >= 0);

261 i‡(
cﬁumn
 >= 0) {

262 
ch¨_t
 *
com∑ªVÆ
;

263 
row
, *
pRow
;

268 
row
 = 0;

269 
row
 < 
nRows
) {

270 
pRow
 = 
pTabÀ
->
rows
[
row
];

271 i‡(
pRow
) {

272 
com∑ªVÆ
 = (
ch¨_t
 *)(
pRow
[
cﬁumn
]);

273 i‡(
NULL
 !
com∑ªVÆ
)

275 i‡(
DB_CASE_INSENSITIVE
 =
Êags
)

277 
m©ch
 = 
	`g°ricmp
(
com∑ªVÆ
, 
vÆue
);

281 
m©ch
 = 
	`g°rcmp
(
com∑ªVÆ
, 
vÆue
);

283 i‡(0 =
m©ch
)

285  
row
;

289 
row
++;

295 
	`åa˚
(3, 
	`T
("DB: UnableÅo find column <%s> inÅable <%s>\n"),

296 
cﬁName
, 
èbÀ«me
);

297  
DB_ERR_COL_NOT_FOUND
;

301 
	}
}

308 
	$dbAddRow
(
did
, 
ch¨_t
 *
èbÀ«me
)

310 
tid
, 
size
;

311 
dbTabÀ_t
 *
pTabÀ
;

313 
	`a_as£π
(
èbÀ«me
);

315 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ«me
);

316 
	`a_as£π
(
tid
 >= 0);

318 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

319 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

321  
DB_ERR_TABLE_NOT_FOUND
;

324 
	`a_as£π
(
pTabÀ
);

326 i‡(
pTabÀ
) {

327 
	`åa˚
(5, 
	`T
("DB: AddögáÑowÅÿèbÀ <%s>\n"), 
èbÀ«me
);

329 
size
 = 
pTabÀ
->
nCﬁumns
 * 
	`max
((), (
ch¨_t
 *));

330  
	`hAŒocE¡ry
((***Ë&(
pTabÀ
->
rows
), &’TabÀ->
nRows
), 
size
);

334 
	}
}

341 
	$dbDñëeRow
(
did
, 
ch¨_t
 *
èbÀ«me
, 
row
)

343 
tid
, 
nCﬁumns
, 
nRows
;

344 
dbTabÀ_t
 *
pTabÀ
;

346 
	`a_as£π
(
èbÀ«me
);

347 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ«me
);

348 
	`a_as£π
(
tid
 >= 0);

350 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

351 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

353  
DB_ERR_TABLE_NOT_FOUND
;

356 
nCﬁumns
 = 
pTabÀ
->nColumns;

357 
nRows
 = 
pTabÀ
->nRows;

359 i‡((
row
 >0Ë&& (row < 
nRows
)) {

360 *
pRow
 = 
pTabÀ
->
rows
[
row
];

362 i‡(
pRow
) {

363 
cﬁumn
 = 0;

367 
cﬁumn
 < 
nCﬁumns
) {

368 i‡(
pRow
[
cﬁumn
] &&

369 (
pTabÀ
->
cﬁumnTy≥s
[
cﬁumn
] =
T_STRING
)) {

370 
	`b‰ì
(
B_L
, (
ch¨_t
 *)
pRow
[
cﬁumn
]);

373 
cﬁumn
++;

378 
	`mem£t
(
pRow
, 0, 
nCﬁumns
 * 
	`max
((), (
ch¨_t
 *)));

380 
	`b‰ìSa„
(
B_L
, 
pRow
);

381 
pTabÀ
->
nRows
 = 
	`hFªe
((***)&pTabÀ->
rows
, 
row
);

382 
	`åa˚
(5, 
	`T
("DB: DeletedÑow <%d> fromÅable <%s>\n"),

383 
row
, 
èbÀ«me
);

387 
	`åa˚
(3, 
	`T
("DB: UnableÅo deleteÑow <%d> fromÅable <%s>\n"),

388 
row
, 
èbÀ«me
);

392 
	}
}

399 
	$dbSëTabÀNrow
(
did
, 
ch¨_t
 *
èbÀ«me
, 
nNewRows
)

401 
nRë
, 
tid
, 
nRows
, 
nCﬁumns
;

402 
dbTabÀ_t
 *
pTabÀ
;

404 
	`a_as£π
(
èbÀ«me
);

405 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ«me
);

406 
	`a_as£π
(
tid
 >= 0) ;

408 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

409 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

411  
DB_ERR_TABLE_NOT_FOUND
;

414 
nRë
 = -1;

416 
	`a_as£π
(
pTabÀ
);

417 i‡(
pTabÀ
) {

418 
nCﬁumns
 = 
pTabÀ
->nColumns;

419 
nRows
 = 
pTabÀ
->nRows;

420 
nRë
 = 0;

422 i‡(
nRows
 >
nNewRows
) {

426 
	`åa˚
(4, 
	`T
("DB: IgnoringÑow setÅo <%d> inÅable <%s>\n"),

427 
nNewRows
, 
èbÀ«me
);

429 
	`åa˚
(4, 
	`T
("DB: SettingÑowsÅo <%d> inÅable <%s>\n"),

430 
nNewRows
, 
èbÀ«me
);

431 
pTabÀ
->
nRows
 < 
nNewRows
) {

432 i‡(
	`dbAddRow
(
did
, 
èbÀ«me
) < 0) {

439  
nRë
;

440 
	}
}

447 
	$dbGëTabÀNrow
(
did
, 
ch¨_t
 *
èbÀ«me
)

449 
tid
;

451 
	`a_as£π
(
èbÀ«me
);

452 
tid
 = 
	`dbGëTabÀId
(
did
, 
èbÀ«me
);

454 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

455  (
dbLi°TabÀs
[
tid
])->
nRows
;

459 
	}
}

466 
	$dbRódI¡
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
, *
ªtu∫VÆue
)

468 
cﬁIndex
, *
pRow
, 
tid
;

469 
dbTabÀ_t
 *
pTabÀ
;

471 
	`a_as£π
(
èbÀ
);

472 
	`a_as£π
(
cﬁumn
);

473 
	`a_as£π
(
ªtu∫VÆue
);

475 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ
);

476 
	`a_as£π
(
tid
 >= 0);

481 i‡(
tid
 < 0) {

482  
DB_ERR_TABLE_NOT_FOUND
;

488 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

489 i‡(
pTabÀ
 =
NULL
) {

490  
DB_ERR_TABLE_DELETED
;

493 
	`a_as£π
(
row
 >= 0);

495 i‡((
row
 >0Ë&& (row < 
pTabÀ
->
nRows
)) {

496 
cﬁIndex
 = 
	`GëCﬁumnIndex
(
tid
, 
cﬁumn
);

497 
	`a_as£π
(
cﬁIndex
 >= 0);

499 i‡(
cﬁIndex
 >= 0) {

500 
pRow
 = 
pTabÀ
->
rows
[
row
];

501 i‡(
pRow
) {

502 *
ªtu∫VÆue
 = 
pRow
[
cﬁIndex
];

505  
DB_ERR_ROW_DELETED
;

507  
DB_ERR_COL_NOT_FOUND
;

510  
DB_ERR_ROW_NOT_FOUND
;

511 
	}
}

518 
	$dbRódSå
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
,

519 
ch¨_t
 **
ªtu∫VÆue
)

521  
	`dbRódI¡
(
did
, 
èbÀ
, 
cﬁumn
, 
row
, (*)
ªtu∫VÆue
);

522 
	}
}

531 
	$dbWrôeI¡
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
, 
iD©a
)

533 
tid
, 
cﬁIndex
, *
pRow
;

534 
dbTabÀ_t
 *
pTabÀ
;

536 
	`a_as£π
(
èbÀ
);

537 
	`a_as£π
(
cﬁumn
);

542 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ
);

543 
	`a_as£π
(
tid
 >= 0);

545 i‡(
tid
 < 0) {

546  
DB_ERR_TABLE_NOT_FOUND
;

549 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

551 i‡(
pTabÀ
) {

555 
cﬁIndex
 = 
	`GëCﬁumnIndex
(
tid
, 
cﬁumn
);

556 
	`a_as£π
(
cﬁIndex
 >= 0);

557 i‡(
cﬁIndex
 >= 0) {

561 
	`a_as£π
((
row
 >0Ë&& (row < 
pTabÀ
->
nRows
));

562 i‡((
row
 >0Ë&& (row < 
pTabÀ
->
nRows
)) {

563 
pRow
 = 
pTabÀ
->
rows
[
row
];

564 i‡(
pRow
) {

565 
pRow
[
cﬁIndex
] = 
iD©a
;

568  
DB_ERR_ROW_DELETED
;

570  
DB_ERR_ROW_NOT_FOUND
;

572  
DB_ERR_COL_NOT_FOUND
;

575  
DB_ERR_TABLE_DELETED
;

576 
	}
}

586 
	$dbWrôeSå
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
, ch¨_à*
s
)

588 
tid
, 
cﬁIndex
;

589 *
pRow
;

590 
ch¨_t
 *
±r
;

591 
dbTabÀ_t
 *
pTabÀ
;

593 
	`a_as£π
(
èbÀ
);

594 
	`a_as£π
(
cﬁumn
);

596 
tid
 = 
	`dbGëTabÀId
(0, 
èbÀ
);

597 
	`a_as£π
(
tid
 >= 0);

599 i‡(
tid
 < 0) {

600  
DB_ERR_TABLE_NOT_FOUND
;

606 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

607 
	`a_as£π
(
pTabÀ
);

608 i‡(!
pTabÀ
) {

609  
DB_ERR_TABLE_DELETED
;

615 
cﬁIndex
 = 
	`GëCﬁumnIndex
(
tid
, 
cﬁumn
);

616 i‡(
cﬁIndex
 < 0) {

617  
DB_ERR_COL_NOT_FOUND
;

623 i‡(
pTabÀ
->
cﬁumnTy≥s
[
cﬁIndex
] !
T_STRING
) {

624  
DB_ERR_BAD_FORMAT
;

630 
	`a_as£π
((
row
 >0Ë&& (row < 
pTabÀ
->
nRows
));

631 i‡((
row
 >0Ë&& (row < 
pTabÀ
->
nRows
)) {

632 
pRow
 = 
pTabÀ
->
rows
[
row
];

634  
DB_ERR_ROW_NOT_FOUND
;

637 i‡(!
pRow
) {

638  
DB_ERR_ROW_DELETED
;

645 i‡(
pRow
[
cﬁIndex
]) {

646 
	`b‰ì
(
B_L
, (
ch¨_t
 *Ë
pRow
[
cﬁIndex
]);

653 
±r
 = 
	`b°rdup
(
B_L
, 
s
);

654 
pRow
[
cﬁIndex
] = ()
±r
;

657 
	}
}

664 
	$dbWrôeKeyVÆue
(
fd
, 
ch¨_t
 *
key
, ch¨_à*
vÆue
)

666 
rc
;

667 
Àn
;

668 
ch¨_t
 *
pLöeOut
;

670 
	`a_as£π
(
key
 && *key);

671 
	`a_as£π
(
vÆue
);

673 
	`fmtAŒoc
(&
pLöeOut
, 
BUF_MAX
, 
	`T
("%s=%s\n"), 
key
, 
vÆue
);

675 i‡(
pLöeOut
) {

676 
Àn
 = 
	`g°æí
(
pLöeOut
);

677 #ifde‡
CE


678 
rc
 = 
	`wrôeUniToAsc
(
fd
, 
pLöeOut
, 
Àn
);

680 
rc
 = 
	`gwrôe
(
fd
, 
pLöeOut
, 
Àn
);

682 
	`b‰ì
(
B_L
, 
pLöeOut
);

684 
rc
 = -1;

687  
rc
;

688 
	}
}

695 
	$dbSave
(
did
, 
ch¨_t
 *
fûíame
, 
Êags
)

697 
row
, 
cﬁumn
, 
nCﬁumns
, 
nRows
, 
fd
, 
rc
;

698 *
cﬁTy≥s
, *
pRow
, 
nRë
, 
tid
;

699 
ch¨_t
 *
∑th
, *
tmpFûe
, *
tmpNum
;

700 
ch¨_t
 **
cﬁNames
;

701 
dbTabÀ_t
 *
pTabÀ
;

703 
	`åa˚
(5, 
	`T
("DB: AboutÅo save databaseÅo file\n"));

705 
	`a_as£π
(
dbMaxTabÀs
 > 0);

710 
	`fmtAŒoc
(&
tmpFûe
, 
FNAMESIZE
, 
	`T
("%s/d©a.tmp"), 
	`basicGëProdu˘Dú
());

711 #i‡!
	`deföed
(
WIN32
)

712 
fd
 = 
	`g›í
(
tmpFûe
,

713 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
 | 
O_BINARY
, 0666);

715 
	`_s›í_s
(&
fd
, 
tmpFûe
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
 | 
O_BINARY
, 
_SH_DENYNO
, 0666);

718 i‡(
fd
 < 0) {

719 
	`åa˚
(1, 
	`T
("WARNING: FaûedÅÿ›í fûê%s\n"), 
tmpFûe
);

720 
	`b‰ì
(
B_L
, 
tmpFûe
);

724 
nRë
 = 0;

726 
tid
 = 0; (tid < 
dbMaxTabÀs
Ë&& (
nRë
 != -1);Åid++) {

727 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

729 i‡(
pTabÀ
) {

733 
rc
 = 
	`dbWrôeKeyVÆue
(
fd
, 
KEYWORD_TABLE
, 
pTabÀ
->
«me
);

735 
nCﬁumns
 = 
pTabÀ
->nColumns;

736 
nRows
 = 
pTabÀ
->nRows;

738 
row
 = 0; (row < 
nRows
Ë&& (
nRë
 == 0);Ñow++) {

739 
pRow
 = 
pTabÀ
->
rows
[
row
];

744 i‡((
pRow
 =
NULL
) || (pRow[0] == '\0') ||

745 (*(
ch¨_t
 *)(
pRow
[0]) == '\0')) {

751 
	`fmtAŒoc
(&
tmpNum
, 20, 
	`T
("%d"), 
row
);

752 
rc
 = 
	`dbWrôeKeyVÆue
(
fd
, 
KEYWORD_ROW
, 
tmpNum
);

753 
	`b‰ìSa„
(
B_L
, 
tmpNum
);

755 
cﬁNames
 = 
pTabÀ
->
cﬁumnNames
;

756 
cﬁTy≥s
 = 
pTabÀ
->
cﬁumnTy≥s
;

760 
cﬁumn
 = 0; (cﬁum¿< 
nCﬁumns
Ë&& (
rc
 >= 0);

761 
cﬁumn
++, 
cﬁNames
++, 
cﬁTy≥s
++) {

762 i‡(*
cﬁTy≥s
 =
T_STRING
) {

763 
rc
 = 
	`dbWrôeKeyVÆue
(
fd
, *
cﬁNames
,

764 (
ch¨_t
 *)(
pRow
[
cﬁumn
]));

766 
	`fmtAŒoc
(&
tmpNum
, 20, 
	`T
("%d"), 
pRow
[
cﬁumn
]);

767 
rc
 = 
	`dbWrôeKeyVÆue
(
fd
, *
cﬁNames
, 
tmpNum
);

768 
	`b‰ìSa„
(
B_L
, 
tmpNum
);

772 i‡(
rc
 < 0) {

773 
	`åa˚
(1, 
	`T
("WARNING: FailedÅo writeÅo file %s\n"),

774 
tmpFûe
);

775 
nRë
 = -1;

781 
	`g˛o£
(
fd
);

786 i‡(
nRë
 == 0) {

787 
	`fmtAŒoc
(&
∑th
, 
FNAMESIZE
, 
	`T
("%s/%s"), 
	`basicGëProdu˘Dú
(), 
fûíame
);

789 
	`gu∆ök
(
∑th
);

790 i‡(
	`gª«me
(
tmpFûe
, 
∑th
) != 0) {

791 
	`åa˚
(1, 
	`T
("WARNING: FaûedÅÿª«mê%†tÿ%s\n"), 
tmpFûe
, 
∑th
);

792 
nRë
 = -1;

795 
	`b‰ì
(
B_L
, 
∑th
);

798 
	`b‰ì
(
B_L
, 
tmpFûe
);

800  
nRë
;

801 
	}
}

808 
	$¸ack
(
ch¨_t
 *
buf
, ch¨_à**
key
, ch¨_à**
vÆ
)

810 
ch¨_t
 *
±r
;

812 i‡((
±r
 = 
	`g°ºchr
(
buf
, '\n')Ë!
NULL
 ||

813 (
±r
 = 
	`g°ºchr
(
buf
, '\r')Ë!
NULL
) {

814 *
±r
 = '\0';

820 i‡((
±r
 = 
	`g°r°r
(
buf
, 
	`T
("="))Ë=
NULL
) {

824 *
±r
++ = '\0';

825 *
key
 = 
	`åim
(
buf
);

826 *
vÆ
 = 
	`åim
(
±r
);

829 
	}
}

838 
	$dbLﬂd
(
did
, 
ch¨_t
 *
fûíame
, 
Êags
)

840 
g°©_t
 
sbuf
;

841 
ch¨_t
 *
buf
, *
keyw‹d
, *
vÆue
, *
∑th
, *
±r
;

842 
ch¨_t
 *
èbÀ«me
;

843 
fd
, 
tid
, 
row
;

844 
dbTabÀ_t
 *
pTabÀ
;

846 
	`a_as£π
(
did
 >= 0);

848 
	`fmtAŒoc
(&
∑th
, 
FNAMESIZE
, 
	`T
("%s/%s"), 
	`basicGëProdu˘Dú
(), 
fûíame
);

849 
	`åa˚
(4, 
	`T
("DB: Abouàtÿªad d©®fûê<%s>\n"), 
∑th
);

851 i‡(
	`g°©
(
∑th
, &
sbuf
) < 0) {

852 
	`åa˚
(3, 
	`T
("DB: FailedÅo statÖersistent data file.\n"));

853 
	`b‰ì
(
B_L
, 
∑th
);

857 #i‡!
	`deföed
(
WIN32
)

858 
fd
 = 
	`g›í
(
∑th
, 
O_RDONLY
 | 
O_BINARY
, 0666);

860 
	`_s›í_s
(&
fd
, 
∑th
, 
O_RDONLY
 | 
O_BINARY
, 
_SH_DENYNO
, 0666);

862 
	`b‰ì
(
B_L
, 
∑th
);

864 i‡(
fd
 < 0) {

865 
	`åa˚
(3, 
	`T
("DB: NoÖersistent data fileÖresent.\n"));

869 i‡(
sbuf
.
°_size
 <= 0) {

870 
	`åa˚
(3, 
	`T
("DB: Persistent data file isÉmpty.\n"));

871 
	`g˛o£
(
fd
);

877 
buf
 = 
	`bÆloc
(
B_L
, 
sbuf
.
°_size
 + 1);

878 #ifde‡
CE


879 i‡(
	`ªadAscToUni
(
fd
, &
buf
, 
sbuf
.
°_size
) != ()sbuf.st_size) {

881 i‡(
	`gªad
(
fd
, 
buf
, 
sbuf
.
°_size
) != ()sbuf.st_size) {

883 
	`åa˚
(3, 
	`T
("DB: Persistent dataÑead failed.\n"));

884 
	`b‰ì
(
B_L
, 
buf
);

885 
	`g˛o£
(
fd
);

889 
	`g˛o£
(
fd
);

890 *(
buf
 + 
sbuf
.
°_size
) = '\0';

892 
row
 = -1;

893 
tid
 = -1;

894 
pTabÀ
 = 
NULL
;

895 
±r
 = 
	`g°πok
(
buf
, 
	`T
("\n"));

896 
èbÀ«me
 = 
NULL
;

899 i‡(
	`¸ack
(
±r
, &
keyw‹d
, &
vÆue
) < 0) {

900 
	`åa˚
(5, 
	`T
("DB: FaûedÅÿ¸ackÜöê%s\n"), 
±r
);

904 
	`a_as£π
(
keyw‹d
 && *keyword);

906 i‡(
	`g°rcmp
(
keyw‹d
, 
KEYWORD_TABLE
) == 0) {

910 i‡(
èbÀ«me
) {

911 
	`b‰ì
(
B_L
, 
èbÀ«me
);

914 
èbÀ«me
 = 
	`b°rdup
(
B_L
, 
vÆue
);

915 
tid
 = 
	`dbGëTabÀId
(
did
, 
èbÀ«me
);

917 i‡(
tid
 >= 0) {

918 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

920 
pTabÀ
 = 
NULL
;

923 } i‡(
	`g°rcmp
(
keyw‹d
, 
KEYWORD_ROW
) == 0) {

927 i‡(
tid
 >= 0) {

928 
nRows
 = 
	`dbGëTabÀNrow
(
did
, 
èbÀ«me
);

930 i‡(
	`dbSëTabÀNrow
(
did
, 
èbÀ«me
, 
nRows
 + 1) == 0) {

931 
row
 = 
nRows
;

935 } i‡(
row
 != -1) {

939 
nCﬁumn
 = 
	`GëCﬁumnIndex
(
tid
, 
keyw‹d
);

941 i‡((
nCﬁumn
 >0Ë&& (
pTabÀ
 !
NULL
)) {

942 
nCﬁumnTy≥
 = 
pTabÀ
->
cﬁumnTy≥s
[
nCﬁumn
];

943 i‡(
nCﬁumnTy≥
 =
T_STRING
) {

944 
	`dbWrôeSå
(
did
, 
èbÀ«me
, 
keyw‹d
, 
row
, 
vÆue
);

946 
	`dbWrôeI¡
(
did
, 
èbÀ«me
, 
keyw‹d
, 
row
, 
	`g°πoi
(
vÆue
));

950 } (
±r
 = 
	`g°πok
(
NULL
, 
	`T
("\n"))) != NULL);

952 i‡(
èbÀ«me
) {

953 
	`b‰ì
(
B_L
, 
èbÀ«me
);

956 
	`b‰ì
(
B_L
, 
buf
);

959 
	}
}

966 
	$dbGëTabÀId
(
did
, 
ch¨_t
 *
èbÀ«me
)

968 
tid
;

969 
dbTabÀ_t
 *
pTabÀ
;

971 
	`a_as£π
(
èbÀ«me
);

973 
tid
 = 0; (tid < 
dbMaxTabÀs
);Åid++) {

974 i‡((
pTabÀ
 = 
dbLi°TabÀs
[
tid
]Ë!
NULL
) {

975 i‡(
	`g°rcmp
(
èbÀ«me
, 
pTabÀ
->
«me
) == 0) {

976  
tid
;

982 
	}
}

989 
ch¨_t
 *
	$dbGëTabÀName
(
did
, 
tid
)

991 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

992  (
dbLi°TabÀs
[
tid
])->
«me
;

995  
NULL
;

996 
	}
}

1003 
ch¨_t
 *
	$åim
(
ch¨_t
 *
°r
)

1005 
	`is•a˚
(()*
°r
)) {

1006 
°r
++;

1008  
°r
;

1009 
	}
}

1016 
	$GëCﬁumnIndex
(
tid
, 
ch¨_t
 *
cﬁName
)

1018 
cﬁumn
;

1019 
dbTabÀ_t
 *
pTabÀ
;

1021 
	`a_as£π
(
cﬁName
);

1023 i‡((
tid
 >0Ë&& (tid < 
dbMaxTabÀs
Ë&& (
dbLi°TabÀs
[tid] !
NULL
)) {

1024 
pTabÀ
 = 
dbLi°TabÀs
[
tid
];

1026 
cﬁumn
 = 0; (cﬁum¿< 
pTabÀ
->
nCﬁumns
); column++) {

1027 i‡(
	`g°rcmp
(
cﬁName
, 
pTabÀ
->
cﬁumnNames
[
cﬁumn
]) == 0)

1028  
cﬁumn
;

1033 
	}
}

1040 
	$basicSëProdu˘Dú
(
ch¨_t
 *
¥oddú
)

1042 
Àn
;

1044 i‡(
basicProdDú
 !
NULL
) {

1045 
	`b‰ì
(
B_L
, 
basicProdDú
);

1048 
basicProdDú
 = 
	`b°rdup
(
B_L
, 
¥oddú
);

1052 
Àn
 = 
	`g°æí
(
basicProdDú
);

1053 i‡((
Àn
 > 0Ë&& *(
basicProdDú
 +Üen - 1) == '/') {

1054 *(
basicProdDú
+
Àn
-1) = '\0';

1056 
	}
}

1063 
ch¨_t
 *
	$basicGëProdu˘Dú
()

1065 i‡(
basicProdDú
) {

1066  
basicProdDú
;

1068  
basicDeÁu…Dú
;

1070 
	}
}

	@emfdb.h

17 #i‚de‡
_h_EMFDB


18 
	#_h_EMFDB
 1

	)

20 
	~"uemf.h
"

25 
	#T_INT
 0

	)

26 
	#T_STRING
 1

	)

28 
	#DB_OK
 0

	)

29 
	#DB_ERR_GENERAL
 -1

	)

30 
	#DB_ERR_COL_NOT_FOUND
 -2

	)

31 
	#DB_ERR_COL_DELETED
 -3

	)

32 
	#DB_ERR_ROW_NOT_FOUND
 -4

	)

33 
	#DB_ERR_ROW_DELETED
 -5

	)

34 
	#DB_ERR_TABLE_NOT_FOUND
 -6

	)

35 
	#DB_ERR_TABLE_DELETED
 -7

	)

36 
	#DB_ERR_BAD_FORMAT
 -8

	)

42 
	#DB_CASE_INSENSITIVE
 1

	)

44 
	sdbTabÀ_s
 {

45 
ch¨_t
 *
	m«me
;

46 
	mnCﬁumns
;

47 
ch¨_t
 **
	mcﬁumnNames
;

48 *
	mcﬁumnTy≥s
;

49 
	mnRows
;

50 **
	mrows
;

51 } 
	tdbTabÀ_t
;

58 
dbRegi°îDBSchema
(
dbTabÀ_t
 *
sTabÀ
);

60 
dbO≥n
(
ch¨_t
 *
d©aba£«me
, ch¨_à*
fûíame
,

61 (*
gëtime
)(
did
), 
Êags
);

62 
	`dbClo£
(
did
);

63 
	`dbGëTabÀId
(
did
, 
ch¨_t
 *
äame
);

64 
ch¨_t
 *
	`dbGëTabÀName
(
did
, 
tid
);

65 
	`dbRódI¡
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
,

66 *
ªtu∫VÆue
);

67 
	`dbRódSå
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
,

68 
ch¨_t
 **
ªtu∫VÆue
);

69 
	`dbWrôeI¡
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
,

70 
id©a
);

71 
	`dbWrôeSå
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
, 
row
,

72 
ch¨_t
 *
s
);

73 
	`dbAddRow
(
did
, 
ch¨_t
 *
èbÀ
);

74 
	`dbDñëeRow
(
did
, 
ch¨_t
 *
èbÀ
, 
rid
);

75 
	`dbSëTabÀNrow
(
did
, 
ch¨_t
 *
èbÀ
, 
nNewRows
);

76 
	`dbGëTabÀNrow
(
did
, 
ch¨_t
 *
èbÀ
);

81 
	`dbSave
(
did
, 
ch¨_t
 *
fûíame
, 
Êags
);

86 
	`dbLﬂd
(
did
, 
ch¨_t
 *
fûíame
, 
Êags
);

93 
	`dbSórchSå
(
did
, 
ch¨_t
 *
èbÀ
, ch¨_à*
cﬁumn
,

94 
ch¨_t
 *
vÆue
, 
Êags
);

96 
	`dbZîo
(
did
);

98 
ch¨_t
 *
	`basicGëProdu˘Dú
();

99 
	`basicSëProdu˘Dú
(
ch¨_t
 *
¥oddú
);

	@form.c

22 
	~"wsI¡∫.h
"

26 
sym_fd_t
 
	gf‹mSymèb
 = -1;

33 
	$websF‹mH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
,

34 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

36 
sym_t
 *
•
;

37 
ch¨_t
 
f‹mBuf
[
FNAMESIZE
];

38 
ch¨_t
 *
˝
, *
f‹mName
;

39 (*
‚
)(*
sock
, 
ch¨_t
 *
∑th
, ch¨_à*
¨gs
);

41 
	`a_as£π
(
	`websVÆid
(
wp
));

42 
	`a_as£π
(
uæ
 && *url);

43 
	`a_as£π
(
∑th
 && *path == '/');

45 
websSèts
.
f‹mHôs
++;

50 
	`g°∫˝y
(
f‹mBuf
, 
∑th
, 
	`TSZ
(formBuf));

51 i‡((
f‹mName
 = 
	`g°rchr
(&
f‹mBuf
[1], '/')Ë=
NULL
) {

52 
	`websEº‹
(
wp
, 200, 
	`T
("Missing formÇame"));

55 
f‹mName
++;

56 i‡((
˝
 = 
	`g°rchr
(
f‹mName
, '/')Ë!
NULL
) {

57 *
˝
 = '\0';

64 
•
 = 
	`symLookup
(
f‹mSymèb
, 
f‹mName
);

65 i‡(
•
 =
NULL
) {

66 
	`websEº‹
(
wp
, 404, 
	`T
("F‹m %†i†nŸ deföed"), 
f‹mName
);

68 
‚
 = ((*)(*, 
ch¨_t
 *, ch¨_à*)Ë
•
->
c⁄ã¡
.
vÆue
.
öãgî
;

69 
	`a_as£π
(
‚
);

70 i‡(
‚
) {

74 (*
‚
)((*Ë
wp
, 
f‹mName
, 
quîy
);

81 i‡(
	`websVÆid
(
wp
)) {

82 
	`websEº‹
(
wp
, 200, 
	`T
("Form didn't call websDone"));

88 
	}
}

95 
websF‹mDeföe
(
ch¨_t
 *
«me
, (*
‚
)(
webs_t
 
wp
, ch¨_à*
∑th
,

96 
ch¨_t
 *
quîy
))

98 
	`a_as£π
(
«me
 && *name);

99 
	`a_as£π
(
‚
);

101 i‡(
‚
 =
NULL
) {

105 
	`symE¡î
(
f‹mSymèb
, 
«me
, 
	`vÆueI¡egî
((Ë
‚
), (Ë
NULL
);

107 
	}
}

114 
	$websF‹mO≥n
()

116 
f‹mSymèb
 = 
	`symO≥n
(
WEBS_SYM_INIT
);

117 
	}
}

124 
	$websF‹mClo£
()

126 i‡(
f‹mSymèb
 != -1) {

127 
	`symClo£
(
f‹mSymèb
);

128 
f‹mSymèb
 = -1;

130 
	}
}

138 
	$websHódî
(
webs_t
 
wp
)

140 
	`a_as£π
(
	`websVÆid
(
wp
));

142 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.0 200 OK\n"));

148 #ifde‡
WEBS_SSL_SUPPORT


149 
	`websWrôe
(
wp
, 
	`T
("Server: %s/%s %s/%s\r\n"),

150 
WEBS_NAME
, 
WEBS_VERSION
, 
SSL_NAME
, 
SSL_VERSION
);

152 
	`websWrôe
(
wp
, 
	`T
("Sîvî: %s/%s\r\n"), 
WEBS_NAME
, 
WEBS_VERSION
);

155 
	`websWrôe
(
wp
, 
	`T
("Pragma:Ço-cache\n"));

156 
	`websWrôe
(
wp
, 
	`T
("Cache-control:Ço-cache\n"));

157 
	`websWrôe
(
wp
, 
	`T
("Content-Type:Åext/html\n"));

158 
	`websWrôe
(
wp
, 
	`T
("\n"));

159 
	`websWrôe
(
wp
, 
	`T
("<html>\n"));

160 
	}
}

167 
	$websFoŸî
(
webs_t
 
wp
)

169 
	`a_as£π
(
	`websVÆid
(
wp
));

171 
	`websWrôe
(
wp
, 
	`T
("</html>\n"));

172 
	}
}

	@h.c

20 
	~"uemf.h
"

29 
	#H_LEN
 0

	)

30 
	#H_USED
 1

	)

31 
	#H_OFFSET
 2

	)

33 
	#H_INCR
 16

	)

42 #ifde‡
B_STATS


43 
	$HALLOC
(
B_ARGS_DEC
, ***
m≠
)

45 
	$hAŒoc
(***
m≠
)

48 *
mp
;

49 
h™dÀ
, 
Àn
, 
memsize
, 
ö¸
;

51 
	`a_as£π
(
m≠
);

53 i‡(*
m≠
 =
NULL
) {

54 
ö¸
 = 
H_INCR
;

55 
memsize
 = (
ö¸
 + 
H_OFFSET
) * (**);

56 #ifde‡
B_STATS


57 i‡((
mp
 = (*Ë
	`bÆloc
(
B_ARGS
, 
memsize
)Ë=
NULL
) {

59 i‡((
mp
 = (*Ë
	`bÆloc
(
B_L
, 
memsize
)Ë=
NULL
) {

63 
	`mem£t
(
mp
, 0, 
memsize
);

64 
mp
[
H_LEN
] = 
ö¸
;

65 
mp
[
H_USED
] = 0;

66 *
m≠
 = (**Ë&
mp
[
H_OFFSET
];

68 
mp
 = &((*(**)
m≠
)[-
H_OFFSET
]);

71 
Àn
 = 
mp
[
H_LEN
];

76 i‡(
mp
[
H_USED
] < mp[
H_LEN
]) {

77 
h™dÀ
 = 0; h™dÀ < 
Àn
; handle++) {

78 i‡(
mp
[
h™dÀ
+
H_OFFSET
] == 0) {

79 
mp
[
H_USED
]++;

80  
h™dÀ
;

84 
h™dÀ
 = 
Àn
;

90 
Àn
 +
H_INCR
;

91 
memsize
 = (
Àn
 + 
H_OFFSET
) * (**);

92 i‡((
mp
 = (*Ë
	`bªÆloc
(
B_L
, (*Ëmp, 
memsize
)Ë=
NULL
) {

95 *
m≠
 = (**Ë&
mp
[
H_OFFSET
];

96 
mp
[
H_LEN
] = 
Àn
;

97 
	`mem£t
(&
mp
[
H_OFFSET
 + 
Àn
 - 
H_INCR
], 0, (*) * H_INCR);

98 
mp
[
H_USED
]++;

99  
h™dÀ
;

100 
	}
}

108 
	$hFªe
(***
m≠
, 
h™dÀ
)

110 *
mp
;

111 
Àn
;

113 
	`a_as£π
(
m≠
);

114 
mp
 = &((*(**)
m≠
)[-
H_OFFSET
]);

115 
	`a_as£π
(
mp
[
H_LEN
] >
H_INCR
);

117 
	`a_as£π
(
mp
[
h™dÀ
 + 
H_OFFSET
]);

118 
	`a_as£π
(
mp
[
H_USED
]);

119 
mp
[
h™dÀ
 + 
H_OFFSET
] = 0;

120 i‡(--(
mp
[
H_USED
]) == 0) {

121 
	`b‰ì
(
B_L
, (*Ë
mp
);

122 *
m≠
 = 
NULL
;

128 i‡(*
m≠
 =
NULL
) {

129 
h™dÀ
 = -1;

131 
Àn
 = 
mp
[
H_LEN
];

132 i‡(
mp
[
H_USED
] < mp[
H_LEN
]) {

133 
h™dÀ
 = 
Àn
 - 1; handle >= 0; handle--) {

134 i‡(
mp
[
h™dÀ
 + 
H_OFFSET
])

138 
h™dÀ
 = 
Àn
;

141  
h™dÀ
 + 1;

142 
	}
}

149 #ifde‡
B_STATS


150 
	$HALLOCENTRY
(
B_ARGS_DEC
, ***
li°
, *
max
, 
size
)

152 
	$hAŒocE¡ry
(***
li°
, *
max
, 
size
)

155 
ch¨_t
 *
˝
;

156 
id
;

158 
	`a_as£π
(
li°
);

159 
	`a_as£π
(
max
);

161 #ifde‡
B_STATS


162 i‡((
id
 = 
	`HALLOC
(
B_ARGS
, (***Ë
li°
)) < 0) {

164 i‡((
id
 = 
	`hAŒoc
((***Ë
li°
)) < 0) {

169 i‡(
size
 > 0) {

170 #ifde‡
B_STATS


171 i‡((
˝
 = 
	`bÆloc
(
B_ARGS
, 
size
)Ë=
NULL
) {

173 i‡((
˝
 = 
	`bÆloc
(
B_L
, 
size
)Ë=
NULL
) {

175 
	`hFªe
(
li°
, 
id
);

178 
	`a_as£π
(
˝
);

179 
	`mem£t
(
˝
, 0, 
size
);

181 (*
li°
)[
id
] = (*Ë
˝
;

184 i‡(
id
 >*
max
) {

185 *
max
 = 
id
 + 1;

187  
id
;

188 
	}
}

	@handler.c

19 
	~"wsI¡∫.h
"

23 
websUæH™dÀrTy≥
 *
	gwebsUæH™dÀr
;

24 
	gwebsUæH™dÀrMax
;

25 
	guæH™dÀrO≥nCou¡
 = 0;

29 
websUæH™dÀrS‹t
(c⁄° *
p1
, c⁄° *
p2
);

30 
websPublishH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

31 
sid
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

32 
ch¨_t
 *
websC⁄dí£Mu…ùÀCh¨s
(ch¨_à*
°rToC⁄dí£
, ch¨_à
cC⁄dí£
);

39 
	$websUæH™dÀrO≥n
()

41 i‡(++
uæH™dÀrO≥nCou¡
 == 1) {

42 
	`websA•O≥n
();

43 
websUæH™dÀr
 = 
NULL
;

44 
websUæH™dÀrMax
 = 0;

47 
	}
}

54 
	$websUæH™dÀrClo£
()

56 
websUæH™dÀrTy≥
 *
•
;

58 i‡(--
uæH™dÀrO≥nCou¡
 <= 0) {

59 
	`websA•Clo£
();

60 
•
 = 
websUæH™dÀr
; s∞< &websUæH™dÀr[
websUæH™dÀrMax
];

61 
•
++) {

62 
	`b‰ì
(
B_L
, 
•
->
uæPªfix
);

63 i‡(
•
->
webDú
) {

64 
	`b‰ì
(
B_L
, 
•
->
webDú
);

67 
	`b‰ì
(
B_L
, 
websUæH™dÀr
);

68 
websUæH™dÀrMax
 = 0;

70 
	}
}

82 
websUæH™dÀrDeföe
(
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
,

83 (*
h™dÀr
)(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webdú
, 
¨g
,

84 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
), 
Êags
)

86 
websUæH™dÀrTy≥
 *
•
;

87 
Àn
;

89 
	`a_as£π
(
uæPªfix
);

90 
	`a_as£π
(
h™dÀr
);

95 
Àn
 = (
websUæH™dÀrMax
 + 1Ë* (
websUæH™dÀrTy≥
);

96 i‡((
websUæH™dÀr
 = 
	`bªÆloc
(
B_L
, websUæH™dÀr, 
Àn
)Ë=
NULL
) {

99 
•
 = &
websUæH™dÀr
[
websUæH™dÀrMax
++];

100 
	`mem£t
(
•
, 0, (
websUæH™dÀrTy≥
));

102 
•
->
uæPªfix
 = 
	`b°rdup
(
B_L
, urlPrefix);

103 
•
->
Àn
 = 
	`g°æí
(•->
uæPªfix
);

104 i‡(
webDú
) {

105 
•
->
webDú
 = 
	`b°rdup
(
B_L
, webDir);

107 
•
->
webDú
 = 
	`b°rdup
(
B_L
, 
	`T
(""));

109 
•
->
h™dÀr
 = handler;

110 
•
->
¨g
 =árg;

111 
•
->
Êags
 = flags;

116 
	`qs‹t
(
websUæH™dÀr
, 
websUæH™dÀrMax
, (
websUæH™dÀrTy≥
),

117 
websUæH™dÀrS‹t
);

119 
	}
}

127 
websUæH™dÀrDñëe
((*
h™dÀr
)(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

128 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
))

130 
websUæH™dÀrTy≥
 *
•
;

131 
i
;

133 
i
 = 0; i < 
websUæH™dÀrMax
; i++) {

134 
•
 = &
websUæH™dÀr
[
i
];

135 i‡(
•
->
h™dÀr
 == handler) {

136 
•
->
h™dÀr
 = 
NULL
;

141 
	}
}

148 
	$websUæH™dÀrS‹t
(c⁄° *
p1
, c⁄° *
p2
)

150 
websUæH™dÀrTy≥
 *
s1
, *
s2
;

151 
rc
;

153 
	`a_as£π
(
p1
);

154 
	`a_as£π
(
p2
);

156 
s1
 = (
websUæH™dÀrTy≥
*Ë
p1
;

157 
s2
 = (
websUæH™dÀrTy≥
*Ë
p2
;

159 i‡((
s1
->
Êags
 & 
WEBS_HANDLER_FIRST
Ë|| (
s2
->Êag†& 
WEBS_HANDLER_LAST
)) {

163 i‡((
s2
->
Êags
 & 
WEBS_HANDLER_FIRST
Ë|| (
s1
->Êag†& 
WEBS_HANDLER_LAST
)) {

167 i‡((
rc
 = 
	`g°rcmp
(
s1
->
uæPªfix
, 
s2
->urlPrefix)) == 0) {

168 i‡(
s1
->
Àn
 < 
s2
->len) {

170 } i‡(
s1
->
Àn
 > 
s2
->len) {

174  -
rc
;

175 
	}
}

182 
	$websPublish
(
ch¨_t
 *
uæPªfix
, ch¨_à*
∑th
)

184  
	`websUæH™dÀrDeföe
(
uæPªfix
, 
∑th
, 0, 
websPublishH™dÀr
, 0);

185 
	}
}

192 
ch¨_t
 *
	$websGëPublishDú
(
ch¨_t
 *
∑th
, ch¨_à**
uæPªfix
)

194 
websUæH™dÀrTy≥
 *
•
;

195 
i
;

197 
i
 = 0; i < 
websUæH™dÀrMax
; i++) {

198 
•
 = &
websUæH™dÀr
[
i
];

199 i‡(
•
->
uæPªfix
[0] == '\0') {

202 i‡(
•
->
h™dÀr
 && 
	`g°∫cmp
(•->
uæPªfix
, 
∑th
, sp->
Àn
) == 0) {

203 i‡(
uæPªfix
) {

204 *
uæPªfix
 = 
•
->urlPrefix;

206  
•
->
webDú
;

209  
NULL
;

210 
	}
}

218 
	$websPublishH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

219 
sid
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

221 
Àn
;

223 
	`a_as£π
(
	`websVÆid
(
wp
));

224 
	`a_as£π
(
∑th
);

230 
Àn
 = 
	`g°æí
(
uæPªfix
) + 1;

231 
	`websSëReque°P©h
(
wp
, 
webDú
, &
∑th
[
Àn
]);

233 
	}
}

242 
	$websUæH™dÀrReque°
(
webs_t
 
wp
)

244 
websUæH™dÀrTy≥
 *
•
;

245 
i
, 
fú°
;

247 
	`a_as£π
(
	`websVÆid
(
wp
));

254 
	`sockëDñëeH™dÀr
(
wp
->
sid
);

255 
wp
->
°©e
 = 
WEBS_PROCESSING
;

256 
websSèts
.
h™dÀrHôs
++;

258 
	`websSëReque°P©h
(
wp
, 
	`websGëDeÁu…Dú
(), 
NULL
);

263 
	`websC⁄dí£Mu…ùÀCh¨s
(
wp
->
∑th
, '/');

264 
	`websC⁄dí£Mu…ùÀCh¨s
(
wp
->
uæ
, '/');

268 i‡((
wp
->
∑th
[0] !'/'Ë|| 
	`°rchr
(wp->path, '\\')) {

269 
	`websEº‹
(
wp
, 400, 
	`T
("BadÑequest"));

277 
fú°
 = 1;

278 
i
 = 0; i < 
websUæH™dÀrMax
; i++) {

279 
•
 = &
websUæH™dÀr
[
i
];

280 i‡(
•
->
h™dÀr
 && 
	`g°∫cmp
(•->
uæPªfix
, 
wp
->
∑th
, sp->
Àn
) == 0) {

281 i‡(
fú°
) {

282 
	`websSëEnv
(
wp
);

283 
fú°
 = 0;

285 i‡((*
•
->
h™dÀr
)(
wp
, sp->
uæPªfix
, sp->
webDú
, sp->
¨g
,

286 
wp
->
uæ
, wp->
∑th
, wp->
quîy
)) {

289 i‡(!
	`websVÆid
(
wp
)) {

290 
	`åa˚
(0,

291 
	`T
("webs: handler %s called websDone, but didn'tÑeturn 1\n"),

292 
•
->
uæPªfix
);

301 i‡(
i
 >
websUæH™dÀrMax
) {

307 
	`websEº‹
(
wp
, 200, 
	`T
("No handler forÅhis URL"));

310 
	}
}

319 
ch¨_t
 *
	$websC⁄dí£Mu…ùÀCh¨s
(
ch¨_t
 *
°rToC⁄dí£
, ch¨_à
cC⁄dí£
)

321 i‡(
°rToC⁄dí£
 !
NULL
) {

322 
ch¨_t
 *
pSå
, *
pSˇn
;

324 
pSå
 = 
pSˇn
 = 
°rToC⁄dí£
;

326 *
pSˇn
 && *
pSå
) {

330 (*
pSˇn
 =
cC⁄dí£
) && (*(pScan + 1) == cCondense)) {

331 
pSˇn
++;

336 i‡(
pSå
 !
pSˇn
) {

337 *
pSå
 = *
pSˇn
;

340 
pSˇn
++;

341 
pSå
++;

346 i‡(
pSå
 !
pSˇn
) {

347 *
pSå
 = 0;

351  
°rToC⁄dí£
;

352 
	}
}

	@matrixSSLSocket.c

10 #ifde‡
WEBS_SSL_SUPPORT


12 
	~<°dlib.h
>

13 
	~<°dio.h
>

14 
	~"m©rixSSLSockë.h
"

15 
	~"uemf.h
"

17 #ifde‡
MACOSX


18 
	#OSX
 1

	)

19 
	#LINUX
 1

	)

22 
	#MAX_WRITE_MSEC
 500

	)

28 
waôF‹WrôeEvít
(
fd
, 
m£c
);

29 
£tSockëN⁄block
(
SOCKET
 
sock
);

38 
s¶Ac˚±
(
s¶C⁄n_t
 **
c⁄n
, 
SOCKET
 
fd
, 
s¶Keys_t
 *
keys
, 
öt32
 
ªsume
,

39 
	$öt32
 (*
˚πVÆid©‹
)(
s¶_t
 *, 
psX509Cît_t
 *, 
öt32
))

41 
s¶C⁄n_t
 *
˝
;

42 
rc
;

44 i‡(
ªsume
 == 0) {

50 
˝
 = 
	`bÆloc
(
B_L
, (
s¶C⁄n_t
));

51 
	`mem£t
(
˝
, 0x0, (
s¶C⁄n_t
));

52 
˝
->
fd
 = fd;

53 i‡(
	`m©rixS¶NewSîvîSessi⁄
(&
˝
->
s¶
, 
keys
, 
˚πVÆid©‹
) < 0) {

54 
	`s¶FªeC⁄√˘i⁄
(&
˝
);

57 #ifde‡
USE_NONBLOCKING_SSL_SOCKETS


59 
	`£tSockëN⁄block
(
fd
);

62 
˝
 = *
c⁄n
;

67 
rc
 = 
	`s¶Ród
(
˝
, 
NULL
, 0);

68 i‡(
rc
 < 0) {

71 *
c⁄n
 = 
˝
;

73 
	}
}

114 
	$s¶Ród
(
s¶C⁄n_t
 *
˝
, *
öbuf
, 
öÀn
)

116 *
buf
;

117 
rc
, 
Àn
, 
å™s„ºed
;

125 i‡(
öbuf
 !
NULL
 && 
öÀn
 > 0 && 
˝
->
±Byãs
 > 0 && cp->
±
) {

126 i‡(
˝
->
±Byãs
 < 
öÀn
) {

127 
öÀn
 = 
˝
->
±Byãs
;

129 
	`mem˝y
(
öbuf
, 
˝
->
cuºPt
, 
öÀn
);

130 
˝
->
cuºPt
 +
öÀn
;

131 
˝
->
±Byãs
 -
öÀn
;

133 i‡(
˝
->
±Byãs
 == 0) {

134 
	`b‰ì
(
B_L
, 
˝
->
±
);

135 
˝
->
±
 = cp->
cuºPt
 = 
NULL
;

137  
öÀn
;

146 
WRITE_MORE
:

147 i‡((
Àn
 = 
	`m©rixS¶GëOutd©a
(
˝
->
s¶
, &
buf
)) > 0) {

148 
å™s„ºed
 = 
	`£nd
(
˝
->
fd
, 
buf
, 
Àn
, 
MSG_NOSIGNAL
);

149 i‡(
å™s„ºed
 <= 0) {

150 i‡(
	`sockëGëEº‹
(Ë!
EWOULDBLOCK
) {

153 i‡(
	`waôF‹WrôeEvít
(
˝
->
fd
, 
MAX_WRITE_MSEC
) == 0) {

154 
WRITE_MORE
;

159 i‡((
rc
 = 
	`m©rixS¶SítD©a
(
˝
->
s¶
, 
å™s„ºed
)) < 0) {

162 i‡(
rc
 =
MATRIXSSL_REQUEST_CLOSE
) {

164 } i‡(
rc
 =
MATRIXSSL_HANDSHAKE_COMPLETE
) {

169 i‡(
rc
 =
MATRIXSSL_REQUEST_SEND
 || 
å™s„ºed
 < 
Àn
) {

170 
WRITE_MORE
;

173 } i‡(
Àn
 < 0) {

177 
READ_MORE
:

180 i‡((
Àn
 = 
	`m©rixS¶GëRódbuf
(
˝
->
s¶
, &
buf
)) <= 0) {

183 i‡((
å™s„ºed
 = 
	`ªcv
(
˝
->
fd
, 
buf
, 
Àn
, 
MSG_NOSIGNAL
)) < 0) {

185 i‡(
	`sockëGëEº‹
(Ë=
EWOULDBLOCK
) {

188 
	`åa˚
(1, 
	`T
("RECVÉº‹: %d\n"), 
	`sockëGëEº‹
());

191 i‡(
å™s„ºed
 == 0) {

193 
	`åa˚
(4, 
	`T
("Closög c⁄√˘i⁄ %d o¿EOF\n"), 
˝
->
fd
);

200 i‡((
rc
 = 
	`m©rixS¶Re˚ivedD©a
(
˝
->
s¶
, 
å™s„ºed
, &
buf
,

201 (
uöt32
*)&
Àn
)) < 0) {

205 
PROCESS_MORE
:

206 
rc
) {

207 
MATRIXSSL_REQUEST_SEND
:

209 
WRITE_MORE
;

210 
MATRIXSSL_REQUEST_RECV
:

211 
READ_MORE
;

212 
MATRIXSSL_HANDSHAKE_COMPLETE
:

214 
READ_MORE
;

215 
MATRIXSSL_RECEIVED_ALERT
:

217 i‡(*
buf
 =
SSL_ALERT_LEVEL_FATAL
) {

218 
	`åa˚
(1, 
	`T
("Fatalálert: %d, closing connection.\n"),

219 *(
buf
 + 1));

223 i‡(*(
buf
 + 1Ë=
SSL_ALERT_CLOSE_NOTIFY
) {

227 
	`åa˚
(4, 
	`T
("W¨nögáÀπ: %d\n"), *(
buf
 + 1));

228 i‡((
rc
 = 
	`m©rixS¶Pro˚s£dD©a
(
˝
->
s¶
, &
buf
, (
uöt32
*)&
Àn
))

231 i‡(
öbuf
 !
NULL
 && 
öÀn
 > 0 && 
˝
->
±Byãs
 > 0 && cp->
±
) {

232 i‡(
˝
->
±Byãs
 < 
öÀn
) {

233 
öÀn
 = 
˝
->
±Byãs
;

235 
	`mem˝y
(
öbuf
, 
˝
->
cuºPt
, 
öÀn
);

236 
˝
->
cuºPt
 +
öÀn
;

237 
˝
->
±Byãs
 -
öÀn
;

239 i‡(
˝
->
±Byãs
 == 0) {

240 
	`b‰ì
(
B_L
, 
˝
->
±
);

241 
˝
->
±
 = cp->
cuºPt
 = 
NULL
;

243  
öÀn
;

248 
PROCESS_MORE
;

250 
MATRIXSSL_APP_DATA
:

251 i‡(
˝
->
±Byãs
 == 0) {

256 
˝
->
±Byãs
 = 
Àn
;

257 
˝
->
±
 = 
	`bÆloc
(
B_L
, 
Àn
);

258 
	`mem˝y
(
˝
->
±
, 
buf
, 
Àn
);

259 
˝
->
cuºPt
 = cp->
±
;

266 
	`psAs£π
(
˝
->
±
 =˝->
cuºPt
);

267 
˝
->
±
 = 
	`bªÆloc
(
B_L
, cp->±, cp->
±Byãs
 + 
Àn
);

268 
	`mem˝y
(
˝
->
±
 + cp->
±Byãs
, 
buf
, 
Àn
);

269 
˝
->
cuºPt
 = cp->
±
;

270 
˝
->
±Byãs
 +
Àn
;

272 i‡((
rc
 = 
	`m©rixS¶Pro˚s£dD©a
(
˝
->
s¶
, &
buf
, (
uöt32
*)&
Àn
))

277 i‡(
rc
 > 0) {

278 
PROCESS_MORE
;

283 i‡(
öbuf
 !0 && 
öÀn
 > 0) {

284 i‡(
˝
->
±Byãs
 < 
öÀn
) {

285 
öÀn
 = 
˝
->
±Byãs
;

287 
	`mem˝y
(
öbuf
, 
˝
->
cuºPt
, 
öÀn
);

288 
˝
->
cuºPt
 +
öÀn
;

289 
˝
->
±Byãs
 -
öÀn
;

290  
öÀn
;

298 
	}
}

333 
	$s¶Wrôe
(
s¶C⁄n_t
 *
˝
, *
d©a
, 
Àn
)

335 *
buf
;

336 
rc
, 
å™s„ºed
, 
˘Lí
;

345 i‡(!
˝
->
£ndBlocked
) {

346 i‡(
	`m©rixS¶GëWrôebuf
(
˝
->
s¶
, &
buf
, 
Àn
) <Üen) {

350 
	`mem˝y
((*)
buf
, 
d©a
, 
Àn
);

351 i‡(
	`m©rixS¶EncodeWrôebuf
(
˝
->
s¶
, 
Àn
) < 0) {

360 i‡(
Àn
 !
˝
->
±ReqByãs
) {

361 
	`a_as£π
(
Àn
 !
˝
->
±ReqByãs
);

365 
WRITE_MORE
:

372 
˘Lí
 = 
	`m©rixS¶GëOutd©a
(
˝
->
s¶
, &
buf
);

373 i‡(
˘Lí
 > 0) {

374 
å™s„ºed
 = 
	`£nd
(
˝
->
fd
, 
buf
, 
˘Lí
, 
MSG_NOSIGNAL
);

375 i‡(
å™s„ºed
 <= 0) {

376 #ifde‡
USE_NONBLOCKING_SSL_SOCKETS


377 i‡(
	`sockëGëEº‹
(Ë!
EWOULDBLOCK
) {

380 i‡(!
˝
->
£ndBlocked
) {

381 
˝
->
£ndBlocked
 = 1;

382 
˝
->
±ReqByãs
 = 
Àn
;

391 i‡((
rc
 = 
	`m©rixS¶SítD©a
(
˝
->
s¶
, 
å™s„ºed
)) < 0) {

395 i‡(
rc
 =
MATRIXSSL_REQUEST_SEND
) {

396 
WRITE_MORE
;

399 
˝
->
£ndBlocked
 = 0;

400 
˝
->
±ReqByãs
 = 0;

401  
Àn
;

402 
	}
}

408 
	$s¶WrôeClosuªAÀπ
(
s¶C⁄n_t
 *
˝
)

410 *
buf
;

411 
Àn
;

413 i‡(
˝
 !
NULL
) {

414 i‡(
	`m©rixS¶EncodeClosuªAÀπ
(
˝
->
s¶
) >= 0) {

415 i‡((
Àn
 = 
	`m©rixS¶GëOutd©a
(
˝
->
s¶
, &
buf
)) > 0) {

417 
	`£tSockëN⁄block
(
˝
->
fd
);

418 i‡((
Àn
 = 
	`£nd
(
˝
->
fd
, 
buf
,Üí, 
MSG_DONTWAIT
)) > 0) {

419 
	`m©rixS¶SítD©a
(
˝
->
s¶
, 
Àn
);

424 
	}
}

431 
	$s¶FªeC⁄√˘i⁄
(
s¶C⁄n_t
 **
˝p
)

433 
s¶C⁄n_t
 *
c⁄n
;

435 
c⁄n
 = *
˝p
;

436 
	`m©rixS¶DñëeSessi⁄
(
c⁄n
->
s¶
);

437 
c⁄n
->
s¶
 = 
NULL
;

438 i‡(
c⁄n
->
±
 !
NULL
) {

439 
	`b‰ì
(
B_L
, 
c⁄n
->
±
);

441 
	`b‰ì
(
B_L
, 
c⁄n
);

442 *
˝p
 = 
NULL
;

443 
	}
}

450 
	$waôF‹WrôeEvít
(
fd
, 
m£c
)

452 
timevÆ
 
tv
;

453 
fd_£t
 
wrôeFds
;

455 
	`FD_ZERO
(&
wrôeFds
);

456 
	`FD_SET
(
fd
, &
wrôeFds
);

457 
tv
.
tv_£c
 = 
m£c
 / 1000;

458 
tv
.
tv_u£c
 = (
m£c
 % 1000) * 1000;

459 i‡(
	`£À˘
(
fd
 + 1, 
NULL
, &
wrôeFds
, NULL, &
tv
) > 0 &&

460 
	`FD_ISSET
(
fd
, &
wrôeFds
)) {

464 
	}
}

470 
	$£tSockëN⁄block
(
SOCKET
 
sock
)

472 #i‡
_WIN32


473 
block
 = 1;

474 
	`io˘lsockë
(
sock
, 
FIONBIO
, &
block
);

475 #ñi‡
LINUX


476 
	`f˙é
(
sock
, 
F_SETFL
, f˙é(sock, 
F_GETFL
Ë| 
O_NONBLOCK
);

478 #ifde‡
MACOSX


480 
⁄off
 = 1;

481 
	`£tsock›t
(
sock
, 
SOL_SOCKET
, 
SO_NOSIGPIPE
, (*)&
⁄off
, (onoff));

483 
	}
}

	@matrixSSLSocket.h

11 #ifde‡
WEBS_SSL_SUPPORT


13 #i‚de‡
_h_SSLSOCKET


14 
	#_h_SSLSOCKET


	)

16 #ifde‡
__˝lu•lus


20 
	~"m©rixs¶/m©rixs¶Api.h
"

25 
	#USE_NONBLOCKING_SSL_SOCKETS


	)

27 #ifde‡
MACOSX


28 
	#LINUX
 1

	)

29 
	#OSX
 1

	)

34 #i‡
WIN32
 || 
WINCE


35 
	~<wödows.h
>

36 
	~<wösock.h
>

37 
	#f˙é
(
A
, 
B
, 
C
)

	)

38 
	#MSG_NOSIGNAL
 0

	)

39 
	#MSG_DONTWAIT
 0

	)

40 
	#WOULD_BLOCK
 
WSAEWOULDBLOCK


	)

41 
	#gëSockëEº‹
(Ë
	`WSAGëLa°Eº‹
()

	)

42 #ñi‡
LINUX


43 
	~<sys/sockë.h
>

44 
	~<√töë/ö.h
>

45 
	~<√töë/t˝.h
>

46 
	~<¨∑/öë.h
>

47 #ifde‡
OSX


48 
	~<sys/sockë.h
>

49 
	#MSG_NOSIGNAL
 0

	)

51 
	~<f˙é.h
>

52 
	~<uni°d.h
>

53 
	~<°rög.h
>

54 
	~<î∫o.h
>

55 
	#SOCKET_ERROR
 -1

	)

56 
	#gëSockëEº‹
(Ë
î∫o


	)

57 
	#WOULD_BLOCK
 
EAGAIN


	)

58 
	#˛o£sockë
 
˛o£


	)

59 
	#MAKEWORD
(
A
, 
B
)

	)

60 
	#WSASèπup
(
A
, 
B
)

	)

61 
	#WSACÀ™up
()

	)

62 
	#INVALID_SOCKET
 -1

	)

63 
	tWSADATA
;

64 
	tSOCKET
;

65 #ñi‡
VXWORKS


66 
	~<ty≥s.h
>

67 
	~<sockë.h
>

68 
	~<√töë/ö.h
>

69 
	~<√töë/t˝.h
>

70 
	~<f˙é.h
>

71 
	~<î∫o.h
>

72 
	#f˙é
(
A
, 
B
, 
C
Ë
	`io˘l
(A, B, C)

	)

73 
	#SOCKET_ERROR
 -1

	)

74 
	#gëSockëEº‹
(Ë
î∫o


	)

75 
	#WOULD_BLOCK
 
EAGAIN


	)

76 
	#˛o£sockë
 
˛o£


	)

77 
	#MAKEWORD
(
A
, 
B
)

	)

78 
	#WSASèπup
(
A
, 
B
)

	)

79 
	#WSACÀ™up
()

	)

80 
	#INVALID_SOCKET
 -1

	)

81 
	#MSG_NOSIGNAL
 0

	)

82 
	tWSADATA
;

83 
	tSOCKET
;

86 #ifde‡
MACOSX


87 #unde‡
LINUX


88 #unde‡
OSX


91 
	#s¶As£π
(
C
Ëi‡(CË; {
	`Ârötf
(
°dîr
, "%s:%d sslAssert(%s)\n",\

92 
__FILE__
, 
__LINE__
, #C); }

	)

93 #i‚de‡
mö


94 
	#mö
(
a
,
b
Ë((◊Ë< (b)Ë? (aË: (b))

	)

100 
	#SSLSOCKET_EOF
 0x1

	)

101 
	#SSLSOCKET_CLOSE_NOTIFY
 0x2

	)

107 
s¶_t
 *
s¶
;

108 *
±
;

109 *
cuºPt
;

110 
±Byãs
;

111 
SOCKET
 
fd
;

112 
±ReqByãs
;

113 
£ndBlocked
;

114 } 
	ts¶C⁄n_t
;

119 
s¶Ac˚±
(
s¶C⁄n_t
 **
˝
, 
SOCKET
 
fd
, 
s¶Keys_t
 *
keys
, 
öt32
 
ªsume
,

120 (*
˚πVÆid©‹
)(
s¶_t
 *, 
psX509Cît_t
 *, 
öt32
));

121 
s¶FªeC⁄√˘i⁄
(
s¶C⁄n_t
 **
˝
);

123 
s¶Ród
(
s¶C⁄n_t
 *
˝
, *
buf
, 
Àn
);

124 
s¶Wrôe
(
s¶C⁄n_t
 *
˝
, *
buf
, 
Àn
);

125 
s¶WrôeClosuªAÀπ
(
s¶C⁄n_t
 *
˝
);

127 #ifde‡
__˝lu•lus


	@md5.h

11 #i‚de‡
_h_MD5


12 
	#_h_MD5
 1

	)

14 #i‚de‡
WEBS_SSL_SUPPORT


16 #i‚de‡
ul⁄g32


17 
	tul⁄g32
;

21 
ul⁄g32
 
	mÀngthHi
;

22 
ul⁄g32
 
	mÀngthLo
;

23 
ul⁄g32
 
	m°©e
[4], 
	mcuæí
;

24 
	mbuf
[64];

25 } 
	tpsDige°C⁄ãxt_t
;

27 
psDige°C⁄ãxt_t
 
	tpsMd5C⁄ãxt_t
;

29 
psMd5Inô
(
psMd5C⁄ãxt_t
 *
md
);

30 
psMd5Upd©e
(
psMd5C⁄ãxt_t
 *
md
, *
buf
,

31 
Àn
);

32 
psMd5FöÆ
(
psMd5C⁄ãxt_t
 *
md
, *
hash
);

	@md5c.c

10 #ifde‡
DIGEST_ACCESS_SUPPORT


11 #i‚de‡
WEBS_SSL_SUPPORT


12 
	~<°rög.h
>

13 
	~"md5.h
"

14 
	töt32
;

16 
	#F
(
x
,
y
,
z
Ë(z ^ (x & (y ^ z)))

	)

17 
	#G
(
x
,
y
,
z
Ë(y ^ (z & (y ^ x)))

	)

18 
	#H
(
x
,
y
,
z
Ë(x^y^z)

	)

19 
	#I
(
x
,
y
,
z
Ë(y^(x|(~z)))

	)

21 #i‚de‡
MIN


22 
	#MIN
(
x
, 
y
Ë–((x)<(y))?(x):(yË)

	)

25 
	#STORE32L
(
x
, 
y
) \

26 { (
y
)[3] = ()(((
x
)>>24)&255); \

27 (
y
)[2] = ()(((
x
)>>16)&255); \

28 (
y
)[1] = ()(((
x
)>>8)&255); \

29 (
y
)[0] = ()((
x
)&255); }

	)

31 
	#LOAD32L
(
x
, 
y
) \

32 { 
x
 = (()((
y
)[3] & 255)<<24) | \

33 (()((
y
)[2] & 255)<<16) | \

34 (()((
y
)[1] & 255)<<8) | \

35 (()((
y
)[0] & 255)); }

	)

37 #ifde‡
SMALL_CODE


39 
	#ROL
(
x
, 
y
) ( ((()(x)<<()((y)&31)) | \

40 ((()(
x
)&0xFFFFFFFFUL)>>()(32-((
y
)&31)))) & \

41 0xFFFFFFFFUL)

	)

43 
	#FF
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

44 
a
 = (®+ 
	`F
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROL
◊, 
s
Ë+ b;

	)

46 
	#GG
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

47 
a
 = (®+ 
	`G
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROL
◊, 
s
Ë+ b;

	)

49 
	#HH
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

50 
a
 = (®+ 
	`H
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROL
◊, 
s
Ë+ b;

	)

52 
	#II
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

53 
a
 = (®+ 
	`I
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROL
◊, 
s
Ë+ b;

	)

55 c⁄° 
	gW‹dî
[64] = {

62 c⁄° 
	gR‹dî
[64] = {

69 c⁄° 
ul⁄g32
 
	gK‹dî
[] = {

90 
	#ROLc
(
x
, 
y
) ( ((()(x)<<()((y)&31)) | \

91 ((()(
x
)&0xFFFFFFFFUL)>>()(32-((
y
)&31)))) & \

92 0xFFFFFFFFUL)

	)

94 
	#FF
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

95 
a
 = (®+ 
	`F
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROLc
◊, 
s
Ë+ b;

	)

97 
	#GG
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

98 
a
 = (®+ 
	`G
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROLc
◊, 
s
Ë+ b;

	)

100 
	#HH
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

101 
a
 = (®+ 
	`H
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROLc
◊, 
s
Ë+ b;

	)

103 
	#II
(
a
,
b
,
c
,
d
,
M
,
s
,
t
) \

104 
a
 = (®+ 
	`I
(
b
,
c
,
d
Ë+ 
M
 + 
t
);á = 
	`ROLc
◊, 
s
Ë+ b;

	)

108 
	$_md5_com¥ess
(
psMd5C⁄ãxt_t
 *
md
)

110 
i
, 
W
[16], 
a
, 
b
, 
c
, 
d
;

111 #ifde‡
SMALL_CODE


112 
ul⁄g32
 
t
;

118 
i
 = 0; i < 16; i++) {

119 
	`LOAD32L
(
W
[
i
], 
md
->
buf
 + (4*i));

125 
a
 = 
md
->
°©e
[0];

126 
b
 = 
md
->
°©e
[1];

127 
c
 = 
md
->
°©e
[2];

128 
d
 = 
md
->
°©e
[3];

130 #ifde‡
SMALL_CODE


131 
i
 = 0; i < 16; ++i) {

132 
	`FF
(
a
,
b
,
c
,
d
,
W
[
W‹dî
[
i
]],
R‹dî
[i],
K‹dî
[i]);

133 
t
 = 
d
; d = 
c
; c = 
b
; b = 
a
;á =Å;

136 ; 
i
 < 32; ++i) {

137 
	`GG
(
a
,
b
,
c
,
d
,
W
[
W‹dî
[
i
]],
R‹dî
[i],
K‹dî
[i]);

138 
t
 = 
d
; d = 
c
; c = 
b
; b = 
a
;á =Å;

141 ; 
i
 < 48; ++i) {

142 
	`HH
(
a
,
b
,
c
,
d
,
W
[
W‹dî
[
i
]],
R‹dî
[i],
K‹dî
[i]);

143 
t
 = 
d
; d = 
c
; c = 
b
; b = 
a
;á =Å;

146 ; 
i
 < 64; ++i) {

147 
	`II
(
a
,
b
,
c
,
d
,
W
[
W‹dî
[
i
]],
R‹dî
[i],
K‹dî
[i]);

148 
t
 = 
d
; d = 
c
; c = 
b
; b = 
a
;á =Å;

153 
	`FF
(
a
,
b
,
c
,
d
,
W
[0],7,0xd76aa478UL)

154 
	`FF
(
d
,
a
,
b
,
c
,
W
[1],12,0xe8c7b756UL)

155 
	`FF
(
c
,
d
,
a
,
b
,
W
[2],17,0x242070dbUL)

156 
	`FF
(
b
,
c
,
d
,
a
,
W
[3],22,0xc1bdceeeUL)

157 
	`FF
(
a
,
b
,
c
,
d
,
W
[4],7,0xf57c0fafUL)

158 
	`FF
(
d
,
a
,
b
,
c
,
W
[5],12,0x4787c62aUL)

159 
	`FF
(
c
,
d
,
a
,
b
,
W
[6],17,0xa8304613UL)

160 
	`FF
(
b
,
c
,
d
,
a
,
W
[7],22,0xfd469501UL)

161 
	`FF
(
a
,
b
,
c
,
d
,
W
[8],7,0x698098d8UL)

162 
	`FF
(
d
,
a
,
b
,
c
,
W
[9],12,0x8b44f7afUL)

163 
	`FF
(
c
,
d
,
a
,
b
,
W
[10],17,0xffff5bb1UL)

164 
	`FF
(
b
,
c
,
d
,
a
,
W
[11],22,0x895cd7beUL)

165 
	`FF
(
a
,
b
,
c
,
d
,
W
[12],7,0x6b901122UL)

166 
	`FF
(
d
,
a
,
b
,
c
,
W
[13],12,0xfd987193UL)

167 
	`FF
(
c
,
d
,
a
,
b
,
W
[14],17,0xa679438eUL)

168 
	`FF
(
b
,
c
,
d
,
a
,
W
[15],22,0x49b40821UL)

169 
	`GG
(
a
,
b
,
c
,
d
,
W
[1],5,0xf61e2562UL)

170 
	`GG
(
d
,
a
,
b
,
c
,
W
[6],9,0xc040b340UL)

171 
	`GG
(
c
,
d
,
a
,
b
,
W
[11],14,0x265e5a51UL)

172 
	`GG
(
b
,
c
,
d
,
a
,
W
[0],20,0xe9b6c7aaUL)

173 
	`GG
(
a
,
b
,
c
,
d
,
W
[5],5,0xd62f105dUL)

174 
	`GG
(
d
,
a
,
b
,
c
,
W
[10],9,0x02441453UL)

175 
	`GG
(
c
,
d
,
a
,
b
,
W
[15],14,0xd8a1e681UL)

176 
	`GG
(
b
,
c
,
d
,
a
,
W
[4],20,0xe7d3fbc8UL)

177 
	`GG
(
a
,
b
,
c
,
d
,
W
[9],5,0x21e1cde6UL)

178 
	`GG
(
d
,
a
,
b
,
c
,
W
[14],9,0xc33707d6UL)

179 
	`GG
(
c
,
d
,
a
,
b
,
W
[3],14,0xf4d50d87UL)

180 
	`GG
(
b
,
c
,
d
,
a
,
W
[8],20,0x455a14edUL)

181 
	`GG
(
a
,
b
,
c
,
d
,
W
[13],5,0xa9e3e905UL)

182 
	`GG
(
d
,
a
,
b
,
c
,
W
[2],9,0xfcefa3f8UL)

183 
	`GG
(
c
,
d
,
a
,
b
,
W
[7],14,0x676f02d9UL)

184 
	`GG
(
b
,
c
,
d
,
a
,
W
[12],20,0x8d2a4c8aUL)

185 
	`HH
(
a
,
b
,
c
,
d
,
W
[5],4,0xfffa3942UL)

186 
	`HH
(
d
,
a
,
b
,
c
,
W
[8],11,0x8771f681UL)

187 
	`HH
(
c
,
d
,
a
,
b
,
W
[11],16,0x6d9d6122UL)

188 
	`HH
(
b
,
c
,
d
,
a
,
W
[14],23,0xfde5380cUL)

189 
	`HH
(
a
,
b
,
c
,
d
,
W
[1],4,0xa4beea44UL)

190 
	`HH
(
d
,
a
,
b
,
c
,
W
[4],11,0x4bdecfa9UL)

191 
	`HH
(
c
,
d
,
a
,
b
,
W
[7],16,0xf6bb4b60UL)

192 
	`HH
(
b
,
c
,
d
,
a
,
W
[10],23,0xbebfbc70UL)

193 
	`HH
(
a
,
b
,
c
,
d
,
W
[13],4,0x289b7ec6UL)

194 
	`HH
(
d
,
a
,
b
,
c
,
W
[0],11,0xeaa127faUL)

195 
	`HH
(
c
,
d
,
a
,
b
,
W
[3],16,0xd4ef3085UL)

196 
	`HH
(
b
,
c
,
d
,
a
,
W
[6],23,0x04881d05UL)

197 
	`HH
(
a
,
b
,
c
,
d
,
W
[9],4,0xd9d4d039UL)

198 
	`HH
(
d
,
a
,
b
,
c
,
W
[12],11,0xe6db99e5UL)

199 
	`HH
(
c
,
d
,
a
,
b
,
W
[15],16,0x1fa27cf8UL)

200 
	`HH
(
b
,
c
,
d
,
a
,
W
[2],23,0xc4ac5665UL)

201 
	`II
(
a
,
b
,
c
,
d
,
W
[0],6,0xf4292244UL)

202 
	`II
(
d
,
a
,
b
,
c
,
W
[7],10,0x432aff97UL)

203 
	`II
(
c
,
d
,
a
,
b
,
W
[14],15,0xab9423a7UL)

204 
	`II
(
b
,
c
,
d
,
a
,
W
[5],21,0xfc93a039UL)

205 
	`II
(
a
,
b
,
c
,
d
,
W
[12],6,0x655b59c3UL)

206 
	`II
(
d
,
a
,
b
,
c
,
W
[3],10,0x8f0ccc92UL)

207 
	`II
(
c
,
d
,
a
,
b
,
W
[10],15,0xffeff47dUL)

208 
	`II
(
b
,
c
,
d
,
a
,
W
[1],21,0x85845dd1UL)

209 
	`II
(
a
,
b
,
c
,
d
,
W
[8],6,0x6fa87e4fUL)

210 
	`II
(
d
,
a
,
b
,
c
,
W
[15],10,0xfe2ce6e0UL)

211 
	`II
(
c
,
d
,
a
,
b
,
W
[6],15,0xa3014314UL)

212 
	`II
(
b
,
c
,
d
,
a
,
W
[13],21,0x4e0811a1UL)

213 
	`II
(
a
,
b
,
c
,
d
,
W
[4],6,0xf7537e82UL)

214 
	`II
(
d
,
a
,
b
,
c
,
W
[11],10,0xbd3af235UL)

215 
	`II
(
c
,
d
,
a
,
b
,
W
[2],15,0x2ad7d2bbUL)

216 
	`II
(
b
,
c
,
d
,
a
,
W
[9],21,0xeb86d391UL)

219 
md
->
°©e
[0] = md->°©e[0] + 
a
;

220 
md
->
°©e
[1] = md->°©e[1] + 
b
;

221 
md
->
°©e
[2] = md->°©e[2] + 
c
;

222 
md
->
°©e
[3] = md->°©e[3] + 
d
;

223 
	}
}

225 
	$psZîomem
(*
d°
, 
Àn
)

227 *
mem
 = (*)
d°
;

229 i‡(
d°
 == (*)0) { ; }

230 
Àn
-- > 0Ë{ *
mem
++ = 0; }

231 
	}
}

233 
	$psBu∫Sèck
(
Àn
)

235 
buf
[32];

237 
	`psZîomem
(
buf
, (buf));

238 i‡(
Àn
 > ()(
buf
)Ë{ 
	`psBu∫Sèck
(len - (buf)); }

239 
	}
}

241 
	$md5_com¥ess
(
psMd5C⁄ãxt_t
 *
md
)

243 
	`_md5_com¥ess
(
md
);

244 
	`psBu∫Sèck
(() * 21);

245 
	}
}

247 
	$psMd5Inô
(
psMd5C⁄ãxt_t
* 
md
)

249 
md
->
°©e
[0] = 0x67452301UL;

250 
md
->
°©e
[1] = 0xefcdab89UL;

251 
md
->
°©e
[2] = 0x98badcfeUL;

252 
md
->
°©e
[3] = 0x10325476UL;

253 
md
->
cuæí
 = 0;

254 #ifde‡
USE_INT64


255 
md
->
Àngth
 = 0;

257 
md
->
ÀngthHi
 = 0;

258 
md
->
ÀngthLo
 = 0;

260 
	}
}

262 
	$psMd5Upd©e
(
psMd5C⁄ãxt_t
* 
md
, *
buf
, 
Àn
)

264 
n
;

266 
Àn
 > 0) {

267 
n
 = 
	`MIN
(
Àn
, (64 - 
md
->
cuæí
));

268 
	`mem˝y
(
md
->
buf
 + md->
cuæí
, buf, ()
n
);

269 
md
->
cuæí
 +
n
;

270 
buf
 +
n
;

271 
Àn
 -
n
;

275 i‡(
md
->
cuæí
 == 64) {

276 
	`md5_com¥ess
(
md
);

277 #ifde‡
USE_INT64


278 
md
->
Àngth
 += 512;

280 
n
 = (
md
->
ÀngthLo
 + 512) & 0xFFFFFFFFL;

281 i‡(
n
 < 
md
->
ÀngthLo
) {

282 
md
->
ÀngthHi
++;

284 
md
->
ÀngthLo
 = 
n
;

286 
md
->
cuæí
 = 0;

289 
	}
}

291 
öt32
 
	$psMd5FöÆ
(
psMd5C⁄ãxt_t
* 
md
, *
hash
)

293 
öt32
 
i
;

294 #i‚de‡
USE_INT64


295 
n
;

298 i‡(
hash
 =
NULL
) {

304 #ifde‡
USE_INT64


305 
md
->
Àngth
 +md->
cuæí
 << 3;

307 
n
 = (
md
->
ÀngthLo
 + (md->
cuæí
 << 3)) & 0xFFFFFFFFL;

308 i‡(
n
 < 
md
->
ÀngthLo
) {

309 
md
->
ÀngthHi
++;

311 
md
->
ÀngthHi
 +(md->
cuæí
 >> 29);

312 
md
->
ÀngthLo
 = 
n
;

317 
md
->
buf
[md->
cuæí
++] = ()0x80;

322 i‡(
md
->
cuæí
 > 56) {

323 
md
->
cuæí
 < 64) {

324 
md
->
buf
[md->
cuæí
++] = ()0;

326 
	`md5_com¥ess
(
md
);

327 
md
->
cuæí
 = 0;

332 
md
->
cuæí
 < 56) {

333 
md
->
buf
[md->
cuæí
++] = ()0;

338 #ifde‡
USE_INT64


339 
	`STORE64L
(
md
->
Àngth
, md->
buf
+56);

341 
	`STORE32L
(
md
->
ÀngthLo
, md->
buf
+56);

342 
	`STORE32L
(
md
->
ÀngthHi
, md->
buf
+60);

344 
	`md5_com¥ess
(
md
);

348 
i
 = 0; i < 4; i++) {

349 
	`STORE32L
(
md
->
°©e
[
i
], 
hash
+(4*i));

351 
	`psZîomem
(
md
, (
psMd5C⁄ãxt_t
));

353 
	}
}

	@mime.c

19 
	~"wsI¡∫.h
"

25 
	#MORE_MIME_TYPES
 1

	)

26 
websMimeTy≥
 
	gwebsMimeLi°
[] = {

27 { 
T
("application/java"), T(".class") },

28 { 
T
("application/java"), T(".jar") },

29 { 
T
("text/html"), T(".asp") },

30 { 
T
("text/html"), T(".htm") },

31 { 
T
("text/html"), T(".html") },

32 { 
T
("text/xml"), T(".xml") },

33 { 
T
("image/gif"), T(".gif") },

34 { 
T
("image/jpeg"), T(".jpg") },

35 { 
T
("image/png"), T(".png") },

36 { 
T
("image/vnd.microsoft.icon"), T(".ico") },

37 { 
T
("text/css"), T(".css") },

38 { 
T
("text/plain"), T(".txt") },

39 { 
T
("application/x-javascript"), T(".js") },

40 { 
T
("application/x-shockwave-flash"), T(".swf") },

42 #ifde‡
MORE_MIME_TYPES


43 { 
T
("application/binary"), T(".exe") },

44 { 
T
("application/compress"), T(".z") },

45 { 
T
("application/gzip"), T(".gz") },

46 { 
T
("application/octet-stream"), T(".bin") },

47 { 
T
("application/oda"), T(".oda") },

48 { 
T
("application/pdf"), T(".pdf") },

49 { 
T
("application/postscript"), T(".ai") },

50 { 
T
("application/postscript"), T(".eps") },

51 { 
T
("application/postscript"), T(".ps") },

52 { 
T
("application/rtf"), T(".rtf") },

53 { 
T
("application/x-bcpio"), T(".bcpio") },

54 { 
T
("application/x-cpio"), T(".cpio") },

55 { 
T
("application/x-csh"), T(".csh") },

56 { 
T
("application/x-dvi"), T(".dvi") },

57 { 
T
("application/x-gtar"), T(".gtar") },

58 { 
T
("application/x-hdf"), T(".hdf") },

59 { 
T
("application/x-latex"), T(".latex") },

60 { 
T
("application/x-mif"), T(".mif") },

61 { 
T
("application/x-netcdf"), T(".nc") },

62 { 
T
("application/x-netcdf"), T(".cdf") },

63 { 
T
("application/x-ns-proxy-autoconfig"), T(".pac") },

64 { 
T
("application/x-patch"), T(".patch") },

65 { 
T
("application/x-sh"), T(".sh") },

66 { 
T
("application/x-shar"), T(".shar") },

67 { 
T
("application/x-sv4cpio"), T(".sv4cpio") },

68 { 
T
("application/x-sv4crc"), T(".sv4crc") },

69 { 
T
("application/x-tar"), T(".tar") },

70 { 
T
("application/x-tgz"), T(".tgz") },

71 { 
T
("application/x-tcl"), T(".tcl") },

72 { 
T
("application/x-tex"), T(".tex") },

73 { 
T
("application/x-texinfo"), T(".texinfo") },

74 { 
T
("application/x-texinfo"), T(".texi") },

75 { 
T
("application/x-troff"), T(".t") },

76 { 
T
("application/x-troff"), T(".tr") },

77 { 
T
("application/x-troff"), T(".roff") },

78 { 
T
("application/x-troff-man"), T(".man") },

79 { 
T
("application/x-troff-me"), T(".me") },

80 { 
T
("application/x-troff-ms"), T(".ms") },

81 { 
T
("application/x-ustar"), T(".ustar") },

82 { 
T
("application/x-wais-source"), T(".src") },

83 { 
T
("application/zip"), T(".zip") },

84 { 
T
("audio/basic"), T(".au snd") },

85 { 
T
("audio/x-aiff"), T(".aif") },

86 { 
T
("audio/x-aiff"), T(".aiff") },

87 { 
T
("audio/x-aiff"), T(".aifc") },

88 { 
T
("audio/x-wav"), T(".wav") },

89 { 
T
("audio/x-wav"), T(".ram") },

90 { 
T
("image/ief"), T(".ief") },

91 { 
T
("image/jpeg"), T(".jpeg") },

92 { 
T
("image/jpeg"), T(".jpe") },

93 { 
T
("image/tiff"), T(".tiff") },

94 { 
T
("image/tiff"), T(".tif") },

95 { 
T
("image/x-cmu-raster"), T(".ras") },

96 { 
T
("image/x-portable-anymap"), T(".pnm") },

97 { 
T
("image/x-portable-bitmap"), T(".pbm") },

98 { 
T
("image/x-portable-graymap"), T(".pgm") },

99 { 
T
("image/x-portable-pixmap"), T(".ppm") },

100 { 
T
("image/x-rgb"), T(".rgb") },

101 { 
T
("image/x-xbitmap"), T(".xbm") },

102 { 
T
("image/x-xpixmap"), T(".xpm") },

103 { 
T
("image/x-xwindowdump"), T(".xwd") },

104 { 
T
("text/html"), T(".cfm") },

105 { 
T
("text/html"), T(".shtm") },

106 { 
T
("text/html"), T(".shtml") },

107 { 
T
("text/richtext"), T(".rtx") },

108 { 
T
("text/tab-separated-values"), T(".tsv") },

109 { 
T
("text/x-setext"), T(".etx") },

110 { 
T
("video/mpeg"), T(".mpeg mpg mpe") },

111 { 
T
("video/quicktime"), T(".qt") },

112 { 
T
("video/quicktime"), T(".mov") },

113 { 
T
("video/x-msvideo"), T(".avi") },

114 { 
T
("video/x-sgi-movie"), T(".movie") },

116 { 
NULL
, NULL},

	@mime64.c

19 
	~"wsI¡∫.h
"

27 
ch¨_t
 
	gm≠64
[] = {

54 
	$websDecode64
(
ch¨_t
 *
outbuf
, ch¨_à*
°rög
, 
ouéí
)

56 
shi·buf
;

57 
ch¨_t
 *
˝
, *
›
;

58 
c
, 
i
, 
j
, 
shi·
;

60 
›
 = 
outbuf
;

61 *
›
 = '\0';

62 
˝
 = 
°rög
;

63 *
˝
 && *cp != '=') {

67 
shi·buf
 = 0;

68 
shi·
 = 18;

69 
i
 = 0; i < 4 && *
˝
 && *cp != '='; i++, cp++) {

70 
c
 = 
m≠64
[*
˝
 & 0xff];

71 i‡(
c
 == -1) {

72 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Bad såög: %†© %¯ödex %d"), 
°rög
,

73 
c
, 
i
);

76 
shi·buf
 = shi·bu‡| (
c
 << 
shi·
);

77 
shi·
 -= 6;

83 --
i
;

84 i‡((
›
 + 
i
Ë>&
outbuf
[
ouéí
]) {

85 
	`g°r˝y
(
outbuf
, 
	`T
("StringÅoo big"));

88 
j
 = 0; j < 
i
; j++) {

89 *
›
++ = (
ch¨_t
Ë((
shi·buf
 >> (8 * (2 - 
j
))) & 0xff);

91 *
›
 = '\0';

94 
	}
}

	@misc.c

12 
	~"uemf.h
"

18 
	#kU£Memc›y


	)

27 
	#STR_REALLOC
 0x1

	)

28 
	#STR_INC
 64

	)

31 
ch¨_t
 *
	ms
;

32 
	msize
;

33 
	mmax
;

34 
	mcou¡
;

35 
	mÊags
;

36 } 
	t°rbuf_t
;

41 
	eÊag
 {

42 
	mÊag_n⁄e
 = 0,

43 
	mÊag_möus
 = 1,

44 
	mÊag_∂us
 = 2,

45 
	mÊag_•a˚
 = 4,

46 
	mÊag_hash
 = 8,

47 
	mÊag_zîo
 = 16,

48 
	mÊag_sh‹t
 = 32,

49 
	mÊag_l⁄g
 = 64

54 
d¢¥ötf
(
ch¨_t
 **
s
, 
size
, ch¨_à*
fmt
, 
va_li°
 
¨g
,

55 
msize
);

56 
put_ch¨
(
°rbuf_t
 *
buf
, 
ch¨_t
 
c
);

57 
put_°rög
(
°rbuf_t
 *
buf
, 
ch¨_t
 *
s
, 
Àn
,

58 
width
, 
¥ec
, 
Êag
 
f
);

59 
put_ul⁄g
(
°rbuf_t
 *
buf
, 
vÆue
, 
ba£
,

60 
uµî
, 
ch¨_t
 *
¥efix
, 
width
, 
¥ec
, 
Êag
 
f
);

61 
g°∫Àn
(
ch¨_t
 *
s
, 
n
);

69 #i‡(!
deföed
 (
LINUX
Ë&& !deföed (
LYNX
Ë&& !deföed (
MACOSX
))

70 
ch¨_t
 *
	$ba£«me
(
ch¨_t
 *
«me
)

72 
ch¨_t
 *
˝
;

74 #i‡(
	`deföed
 (
NW
Ë|| deföed (
WIN
))

75 i‡(((
˝
 = 
	`g°ºchr
(
«me
, '\\')Ë=
NULL
) &&

76 ((
˝
 = 
	`g°ºchr
(
«me
, '/')Ë=
NULL
)) {

77  
«me
;

79 i‡((
˝
 = 
	`g°ºchr
(
«me
, '/')Ë=
NULL
) {

80  
«me
;

82 } i‡(*(
˝
 + 1Ë='\0' && c∞=
«me
) {

83  
«me
;

84 } i‡(*(
˝
 + 1Ë='\0' && c∞!
«me
) {

85  
	`T
("");

87  ++
˝
;

89 
	}
}

98 
ch¨_t
 *
	$dú«me
(
ch¨_t
 *
buf
, ch¨_à*
«me
, 
bufsize
)

100 
ch¨_t
 *
˝
;

101 
Àn
;

103 
	`a_as£π
(
«me
);

104 
	`a_as£π
(
buf
);

105 
	`a_as£π
(
bufsize
 > 0);

107 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
NW
))

108 i‡((
˝
 = 
	`g°ºchr
(
«me
, '/')Ë=
NULL
 &&

109 (
˝
 = 
	`g°ºchr
(
«me
, '\\')Ë=
NULL
)

111 i‡((
˝
 = 
	`g°ºchr
(
«me
, '/')Ë=
NULL
)

114 
	`g°r˝y
(
buf
, 
	`T
("."));

115  
buf
;

118 i‡((*(
˝
 + 1Ë='\0' && c∞=
«me
)) {

119 
	`g°∫˝y
(
buf
, 
	`T
("."), 
	`TSZ
(
bufsize
));

120 
	`g°r˝y
(
buf
, 
	`T
("."));

121  
buf
;

124 
Àn
 = 
˝
 - 
«me
;

126 i‡(
Àn
 < 
bufsize
) {

127 
	`g°∫˝y
(
buf
, 
«me
, 
Àn
);

128 
buf
[
Àn
] = '\0';

130 
	`g°∫˝y
(
buf
, 
«me
, 
	`TSZ
(
bufsize
));

131 
buf
[
bufsize
 - 1] = '\0';

134  
buf
;

135 
	}
}

145 
	$fmtAŒoc
(
ch¨_t
 **
s
, 
n
, ch¨_à*
fmt
, ...)

147 
va_li°
 
≠
;

148 
ªsu…
;

150 
	`a_as£π
(
s
);

151 
	`a_as£π
(
fmt
);

153 *
s
 = 
NULL
;

154 
	`va_°¨t
(
≠
, 
fmt
);

155 
ªsu…
 = 
	`d¢¥ötf
(
s
, 
n
, 
fmt
, 
≠
, 0);

156 
	`va_íd
(
≠
);

157  
ªsu…
;

158 
	}
}

165 
	$fmtSètic
(
ch¨_t
 *
s
, 
n
, ch¨_à*
fmt
, ...)

167 
va_li°
 
≠
;

168 
ªsu…
;

170 
	`a_as£π
(
s
);

171 
	`a_as£π
(
fmt
);

172 
	`a_as£π
(
n
 <= 256);

174 i‡(
n
 <= 0) {

177 
	`va_°¨t
(
≠
, 
fmt
);

178 
ªsu…
 = 
	`d¢¥ötf
(&
s
, 
n
, 
fmt
, 
≠
, 0);

179 
	`va_íd
(
≠
);

180  
ªsu…
;

181 
	}
}

189 
	$fmtRóŒoc
(
ch¨_t
 **
s
, 
n
, 
msize
, ch¨_à*
fmt
, ...)

191 
va_li°
 
≠
;

192 
ªsu…
;

194 
	`a_as£π
(
s
);

195 
	`a_as£π
(
fmt
);

197 i‡(
msize
 == -1) {

198 *
s
 = 
NULL
;

200 
	`va_°¨t
(
≠
, 
fmt
);

201 
ªsu…
 = 
	`d¢¥ötf
(
s
, 
n
, 
fmt
, 
≠
, 
msize
);

202 
	`va_íd
(
≠
);

203  
ªsu…
;

204 
	}
}

211 
	$fmtVÆloc
(
ch¨_t
 **
s
, 
n
, ch¨_à*
fmt
, 
va_li°
 
¨g
)

213 
	`a_as£π
(
s
);

214 
	`a_as£π
(
fmt
);

216 *
s
 = 
NULL
;

217  
	`d¢¥ötf
(
s
, 
n
, 
fmt
, 
¨g
, 0);

218 
	}
}

230 
	$d¢¥ötf
(
ch¨_t
 **
s
, 
size
, ch¨_à*
fmt
, 
va_li°
 
¨g
, 
msize
)

232 
°rbuf_t
 
buf
;

233 
ch¨_t
 
c
;

235 
	`a_as£π
(
s
);

236 
	`a_as£π
(
fmt
);

238 
	`mem£t
(&
buf
, 0, (buf));

239 
buf
.
s
 = *s;

241 i‡(*
s
 =
NULL
 || 
msize
 != 0) {

242 
buf
.
max
 = 
size
;

243 
buf
.
Êags
 |
STR_REALLOC
;

244 i‡(
msize
 != 0) {

245 
buf
.
size
 = 
	`max
(
msize
, 0);

247 i‡(*
s
 !
NULL
 && 
msize
 != 0) {

248 
buf
.
cou¡
 = 
	`g°æí
(*
s
);

251 
buf
.
size
 = size;

254 (
c
 = *
fmt
++) != '\0') {

255 i‡(
c
 !'%' || (¯*
fmt
++) == '%') {

256 
	`put_ch¨
(&
buf
, 
c
);

258 
Êag
 
f
 = 
Êag_n⁄e
;

259 
width
 = 0;

260 
¥ec
 = -1;

261  ; 
c
 !'\0'; c = *
fmt
++) {

262 i‡(
c
 == '-') {

263 
f
 |
Êag_möus
;

264 } i‡(
c
 == '+') {

265 
f
 |
Êag_∂us
;

266 } i‡(
c
 == ' ') {

267 
f
 |
Êag_•a˚
;

268 } i‡(
c
 == '#') {

269 
f
 |
Êag_hash
;

270 } i‡(
c
 == '0') {

271 
f
 |
Êag_zîo
;

276 i‡(
c
 == '*') {

277 
width
 = 
	`va_¨g
(
¨g
, );

278 i‡(
width
 < 0) {

279 
f
 |
Êag_möus
;

280 
width
 = -width;

282 
c
 = *
fmt
++;

284  ; 
	`gisdigô
(()
c
); c = *
fmt
++) {

285 
width
 = width * 10 + (
c
 - '0');

288 i‡(
c
 == '.') {

289 
f
 &~
Êag_zîo
;

290 
c
 = *
fmt
++;

291 i‡(
c
 == '*') {

292 
¥ec
 = 
	`va_¨g
(
¨g
, );

293 
c
 = *
fmt
++;

295 
¥ec
 = 0; 
	`gisdigô
(()
c
); c = *
fmt
++) {

296 
¥ec
 =Öª¯* 10 + (
c
 - '0');

300 i‡(
c
 == 'h' || c == 'l') {

301 
f
 |(
c
 ='h' ? 
Êag_sh‹t
 : 
Êag_l⁄g
);

302 
c
 = *
fmt
++;

304 i‡(
c
 == 'd' || c == 'i') {

305 
vÆue
;

306 i‡(
f
 & 
Êag_sh‹t
) {

307 
vÆue
 = (Ë
	`va_¨g
(
¨g
, );

308 } i‡(
f
 & 
Êag_l⁄g
) {

309 
vÆue
 = 
	`va_¨g
(
¨g
, );

311 
vÆue
 = 
	`va_¨g
(
¨g
, );

313 i‡(
vÆue
 >= 0) {

314 i‡(
f
 & 
Êag_∂us
) {

315 
	`put_ul⁄g
(&
buf
, 
vÆue
, 10, 0, 
	`T
("+"), 
width
, 
¥ec
, 
f
);

316 } i‡(
f
 & 
Êag_•a˚
) {

317 
	`put_ul⁄g
(&
buf
, 
vÆue
, 10, 0, 
	`T
(" "), 
width
, 
¥ec
, 
f
);

319 
	`put_ul⁄g
(&
buf
, 
vÆue
, 10, 0, 
NULL
, 
width
, 
¥ec
, 
f
);

322 
	`put_ul⁄g
(&
buf
, -
vÆue
, 10, 0, 
	`T
("-"), 
width
, 
¥ec
, 
f
);

324 } i‡(
c
 == 'o' || c == 'u' || c == 'x' || c == 'X') {

325 
vÆue
;

326 i‡(
f
 & 
Êag_sh‹t
) {

327 
vÆue
 = (Ë
	`va_¨g
(
¨g
, );

328 } i‡(
f
 & 
Êag_l⁄g
) {

329 
vÆue
 = 
	`va_¨g
(
¨g
, );

331 
vÆue
 = 
	`va_¨g
(
¨g
, );

333 i‡(
c
 == 'o') {

334 i‡(
f
 & 
Êag_hash
 && 
vÆue
 != 0) {

335 
	`put_ul⁄g
(&
buf
, 
vÆue
, 8, 0, 
	`T
("0"), 
width
, 
¥ec
, 
f
);

337 
	`put_ul⁄g
(&
buf
, 
vÆue
, 8, 0, 
NULL
, 
width
, 
¥ec
, 
f
);

339 } i‡(
c
 == 'u') {

340 
	`put_ul⁄g
(&
buf
, 
vÆue
, 10, 0, 
NULL
, 
width
, 
¥ec
, 
f
);

342 i‡(
f
 & 
Êag_hash
 && 
vÆue
 != 0) {

343 i‡(
c
 == 'x') {

344 
	`put_ul⁄g
(&
buf
, 
vÆue
, 16, 0, 
	`T
("0x"), 
width
,

345 
¥ec
, 
f
);

347 
	`put_ul⁄g
(&
buf
, 
vÆue
, 16, 1, 
	`T
("0X"), 
width
,

348 
¥ec
, 
f
);

355 
	`put_ul⁄g
(&
buf
, 
vÆue
, 16, ('X' =
c
Ë, 
NULL
, 
width
, 
¥ec
, 
f
);

359 } i‡(
c
 == 'c') {

360 
ch¨_t
 
vÆue
 = 
	`va_¨g
(
¨g
, );

361 
	`put_ch¨
(&
buf
, 
vÆue
);

363 } i‡(
c
 == 's' || c == 'S') {

364 
ch¨_t
 *
vÆue
 = 
	`va_¨g
(
¨g
, char_t *);

365 i‡(
vÆue
 =
NULL
) {

366 
	`put_°rög
(&
buf
, 
	`T
("“uŒ)"), -1, 
width
, 
¥ec
, 
f
);

367 } i‡(
f
 & 
Êag_hash
) {

368 
	`put_°rög
(&
buf
,

369 
vÆue
 + 1, (
ch¨_t
Ë*vÆue, 
width
, 
¥ec
, 
f
);

371 
	`put_°rög
(&
buf
, 
vÆue
, -1, 
width
, 
¥ec
, 
f
);

373 } i‡(
c
 == 'p') {

374 *
vÆue
 = 
	`va_¨g
(
¨g
, *);

375 
	`put_ul⁄g
(&
buf
,

376 (Ë
vÆue
, 16, 0, 
	`T
("0x"), 
width
, 
¥ec
, 
f
);

377 } i‡(
c
 == 'n') {

378 i‡(
f
 & 
Êag_sh‹t
) {

379 *
vÆue
 = 
	`va_¨g
(
¨g
, *);

380 *
vÆue
 = 
buf
.
cou¡
;

381 } i‡(
f
 & 
Êag_l⁄g
) {

382 *
vÆue
 = 
	`va_¨g
(
¨g
, *);

383 *
vÆue
 = 
buf
.
cou¡
;

385 *
vÆue
 = 
	`va_¨g
(
¨g
, *);

386 *
vÆue
 = 
buf
.
cou¡
;

389 
	`put_ch¨
(&
buf
, 
c
);

393 i‡(
buf
.
s
 =
NULL
) {

394 
	`put_ch¨
(&
buf
, '\0');

400 i‡(*
s
 =
NULL
 || 
msize
 != 0) {

401 *
s
 = 
buf
.s;

404 i‡(*
s
 !
NULL
 && 
size
 > 0) {

405 i‡(
buf
.
cou¡
 < 
size
) {

406 (*
s
)[
buf
.
cou¡
] = '\0';

408 (*
s
)[
buf
.
size
 - 1] = '\0';

412 i‡(
msize
 != 0) {

413  
buf
.
size
;

415  
buf
.
cou¡
;

416 
	}
}

422 
	$g°∫Àn
(
ch¨_t
 *
s
, 
n
)

424 
Àn
;

426 
Àn
 = 
	`g°æí
(
s
);

427  
	`mö
(
Àn
, 
n
);

428 
	}
}

435 
	$put_ch¨
(
°rbuf_t
 *
buf
, 
ch¨_t
 
c
)

437 i‡(
buf
->
cou¡
 >(buf->
size
 - 1)) {

438 i‡(! (
buf
->
Êags
 & 
STR_REALLOC
)) {

441 
buf
->
size
 +
STR_INC
;

442 i‡(
buf
->
size
 > buf->
max
 && buf->sizê> 
STR_INC
) {

446 
buf
->
size
 -
STR_INC
;

449 i‡(
buf
->
s
 =
NULL
) {

450 
buf
->
s
 = 
	`bÆloc
(
B_L
, buf->
size
 * (
ch¨_t
));

452 
buf
->
s
 = 
	`bªÆloc
(
B_L
, buf->s, buf->
size
 * (
ch¨_t
));

455 
buf
->
s
[buf->
cou¡
] = 
c
;

456 i‡(
c
 != '\0') {

457 ++
buf
->
cou¡
;

459 
	}
}

466 
	$put_°rög
(
°rbuf_t
 *
buf
, 
ch¨_t
 *
s
, 
Àn
, 
width
,

467 
¥ec
, 
Êag
 
f
)

469 
i
;

471 i‡(
Àn
 < 0) {

472 
Àn
 = 
	`g°∫Àn
(
s
, 
¥ec
 >0 ?Öª¯: 
ULONG_MAX
);

473 } i‡(
¥ec
 >0 &&Öª¯< 
Àn
) {

474 
Àn
 = 
¥ec
;

476 i‡(
width
 > 
Àn
 && !(
f
 & 
Êag_möus
)) {

477 
i
 = 
Àn
; i < 
width
; ++i) {

478 
	`put_ch¨
(
buf
, ' ');

481 
i
 = 0; i < 
Àn
; ++i) {

482 
	`put_ch¨
(
buf
, 
s
[
i
]);

484 i‡(
width
 > 
Àn
 && 
f
 & 
Êag_möus
) {

485 
i
 = 
Àn
; i < 
width
; ++i) {

486 
	`put_ch¨
(
buf
, ' ');

489 
	}
}

496 
	$put_ul⁄g
(
°rbuf_t
 *
buf
, 
vÆue
, 
ba£
,

497 
uµî
, 
ch¨_t
 *
¥efix
, 
width
, 
¥ec
, 
Êag
 
f
)

499 
x
, 
x2
;

500 
Àn
, 
zîos
, 
i
;

502 
Àn
 = 1, 
x
 = 1; x < 
ULONG_MAX
 / 
ba£
; ++Àn, x = 
x2
) {

503 
x2
 = 
x
 * 
ba£
;

504 i‡(
x2
 > 
vÆue
) {

508 
zîos
 = (
¥ec
 > 
Àn
) ?Örec -Üen : 0;

509 
width
 -
zîos
 + 
Àn
;

510 i‡(
¥efix
 !
NULL
) {

511 
width
 -
	`g°∫Àn
(
¥efix
, 
ULONG_MAX
);

513 i‡(!(
f
 & 
Êag_möus
)) {

514 i‡(
f
 & 
Êag_zîo
) {

515 
i
 = 0; i < 
width
; ++i) {

516 
	`put_ch¨
(
buf
, '0');

519 
i
 = 0; i < 
width
; ++i) {

520 
	`put_ch¨
(
buf
, ' ');

524 i‡(
¥efix
 !
NULL
) {

525 
	`put_°rög
(
buf
, 
¥efix
, -1, 0, -1, 
Êag_n⁄e
);

527 
i
 = 0; i < 
zîos
; ++i) {

528 
	`put_ch¨
(
buf
, '0');

530  ; 
x
 > 0; x /
ba£
) {

531 
digô
 = (
vÆue
 / 
x
Ë% 
ba£
;

532 
	`put_ch¨
(
buf
, (Ë((
digô
 < 10 ? '0' : (
uµî
 ? 'A' : 'a') - 10) +

533 
digô
));

535 i‡(
f
 & 
Êag_möus
) {

536 
i
 = 0; i < 
width
; ++i) {

537 
	`put_ch¨
(
buf
, ' ');

540 
	}
}

549 
ch¨_t
 *
	$ascToUni
(
ch¨_t
 *
ubuf
, *
°r
, 
nByãs
)

551 #ifde‡
UNICODE


552 i‡(
	`Mu…iByãToWideCh¨
(
CP_ACP
, 0, 
°r
, 
nByãs
 / (
ch¨_t
), 
ubuf
,

553 
nByãs
 / (
ch¨_t
)) < 0) {

554  (
ch¨_t
*Ë
°r
;

558 #ifde‡
kU£Memc›y


559 
	`mem˝y
(
ubuf
, 
°r
, 
nByãs
);

561 
	`°∫˝y
(
ubuf
, 
°r
, 
nByãs
);

564  
ubuf
;

565 
	}
}

574 *
	$uniToAsc
(*
buf
, 
ch¨_t
 *
u°r
, 
nByãs
)

576 #ifde‡
UNICODE


577 i‡(
	`WideCh¨ToMu…iByã
(
CP_ACP
, 0, 
u°r
, 
nByãs
, 
buf
,ÇBytes,

578 
NULL
, NULL) < 0)

580  (*Ë
u°r
;

583 #ifde‡
kU£Memc›y


584 
	`mem˝y
(
buf
, 
u°r
, 
nByãs
);

586 
	`°∫˝y
(
buf
, 
u°r
, 
nByãs
);

589  (*Ë
buf
;

590 
	}
}

601 
ch¨_t
 *
	$bÆlocAscToUni
(*
˝
, 
Æí
)

603 
ch¨_t
 *
unù
;

604 
uÀn
;

606 
uÀn
 = (
Æí
 + 1Ë* (
ch¨_t
);

607 i‡((
unù
 = 
	`bÆloc
(
B_L
, 
uÀn
)Ë=
NULL
) {

608  
NULL
;

610 
	`ascToUni
(
unù
, 
˝
, 
uÀn
);

611 
unù
[
Æí
] = 0;

612  
unù
;

613 
	}
}

624 *
	$bÆlocUniToAsc
(
ch¨_t
 *
unù
, 
uÀn
)

626 * 
˝
;

628 i‡((
˝
 = 
	`bÆloc
(
B_L
, 
uÀn
+1)Ë=
NULL
) {

629  
NULL
;

631 
	`uniToAsc
(
˝
, 
unù
, 
uÀn
);

632 
˝
[
uÀn
] = '\0';

633  
˝
;

634 
	}
}

642 
	$hextoi
(
ch¨_t
 *
hex°rög
)

644 
ch¨_t
 *
h
;

645 
c
, 
v
;

647 
v
 = 0;

648 
h
 = 
hex°rög
;

649 i‡(*
h
 == '0' && (*(h+1) == 'x' || *(h+1) == 'X')) {

650 
h
 += 2;

652 (
c
 = ()*
h
++) != 0) {

653 i‡(
c
 >= '0' && c <= '9') {

654 
c
 -= '0';

655 } i‡(
c
 >= 'a' && c <= 'f') {

656 
c
 = (c - 'a') + 10;

657 } i‡(
c
 >= 'A' && c <= 'F') {

658 
c
 = (c - 'A') + 10;

662 
v
 = (v * 0x10Ë+ 
c
;

664  
v
;

665 
	}
}

673 
	$g°πoi
(
ch¨_t
 *
s
)

675 i‡(*
s
 == '0' && (*(s+1) == 'x' || *(s+1) == 'X')) {

676 
s
 += 2;

677  
	`hextoi
(
s
);

679  
	`g©oi
(
s
);

680 
	}
}

	@page.c

20 
	~"wsI¡∫.h
"

27 
	$websPageO≥n
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
, ch¨_à*
∑th
, 
mode
, 
≥rm
)

29 #i‡
	`deföed
(
WIN32
)

30 
î∫o_t
 
îr‹
;

32 
	`a_as£π
(
	`websVÆid
(
wp
));

34 #ifde‡
WEBS_PAGE_ROM


35  
	`websRomPageO≥n
(
wp
, 
∑th
, 
mode
, 
≥rm
);

36 #ñi‡
	`deföed
(
WIN32
)

37 
îr‹
 = 
	`_s›í_s
(&(
wp
->
docfd
), 
Õ©h
, 
mode
, 
_SH_DENYNO
, 
_S_IREAD
);

38  (
wp
->
docfd
 = 
	`g›í
(
Õ©h
, 
mode
, 
_S_IREAD
));

40  (
wp
->
docfd
 = 
	`g›í
(
Õ©h
, 
mode
, 
≥rm
));

42 
	}
}

49 
	$websPageClo£
(
webs_t
 
wp
)

51 
	`a_as£π
(
	`websVÆid
(
wp
));

53 #ifde‡
WEBS_PAGE_ROM


54 
	`websRomPageClo£
(
wp
->
docfd
);

56 i‡(
wp
->
docfd
 >= 0) {

57 
	`˛o£
(
wp
->
docfd
);

58 
wp
->
docfd
 = -1;

61 
	}
}

68 
	$websPageSèt
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
, ch¨_à*
∑th
, 
websSètTy≥
* 
sbuf
)

70 #ifde‡
WEBS_PAGE_ROM


71  
	`websRomPageSèt
(
∑th
, 
sbuf
);

73 
g°©_t
 
s
;

75 i‡(
	`g°©
(
Õ©h
, &
s
) < 0) {

78 
sbuf
->
size
 = 
s
.
°_size
;

79 
sbuf
->
mtime
 = 
s
.
°_mtime
;

80 
sbuf
->
isDú
 = 
s
.
°_mode
 & 
S_IFDIR
;

83 
	}
}

90 
	$websPageIsDúe˘‹y
(
ch¨_t
 *
Õ©h
)

92 #ifde‡
WEBS_PAGE_ROM


93 
websSètTy≥
 
sbuf
;

95 i‡(
	`websRomPageSèt
(
Õ©h
, &
sbuf
) >= 0) {

96 (
sbuf
.
isDú
);

101 
g°©_t
 
sbuf
;

103 i‡(
	`g°©
(
Õ©h
, &
sbuf
) >= 0) {

104 (
sbuf
.
°_mode
 & 
S_IFDIR
);

109 
	}
}

118 
	$websPageRódD©a
(
webs_t
 
wp
, *
buf
, 
nByãs
)

121 #ifde‡
WEBS_PAGE_ROM


122 
	`a_as£π
(
	`websVÆid
(
wp
));

123  
	`websRomPageRódD©a
(
wp
, 
buf
, 
nByãs
);

125 
	`a_as£π
(
	`websVÆid
(
wp
));

126  
	`ªad
(
wp
->
docfd
, 
buf
, 
nByãs
);

128 
	}
}

135 
	$websPageSìk
(
webs_t
 
wp
, 
off£t
)

137 
	`a_as£π
(
	`websVÆid
(
wp
));

139 #ifde‡
WEBS_PAGE_ROM


140 
	`websRomPageSìk
(
wp
, 
off£t
, 
SEEK_CUR
);

142 
	`l£ek
(
wp
->
docfd
, 
off£t
, 
SEEK_CUR
);

144 
	}
}

	@ringq.c

51 
	~"uemf.h
"

58 
	#RINGQ_LEN
(
rq
) \

59 ((
rq
->
£rvp
 >Ñq->
ídp
) ? \

60 (
rq
->
buÊí
 + (rq->
ídp
 -Ñq->
£rvp
)) : \

61 (
rq
->
ídp
 -Ñq->
£rvp
))

	)

65 
rögqGrow
(
rögq_t
 *
rq
);

66 
gëBöBlockSize
(
size
);

68 
	grögqGrowCÆls
 = 0;

79 
	$rögqO≥n
(
rögq_t
 *
rq
, 
öôSize
, 
maxsize
)

81 
ö¸emít
;

83 
	`a_as£π
(
rq
);

84 
	`a_as£π
(
öôSize
 >= 0);

86 
ö¸emít
 = 
	`gëBöBlockSize
(
öôSize
);

87 i‡((
rq
->
buf
 = 
	`bÆloc
(
B_L
, (
ö¸emít
))Ë=
NULL
) {

90 
rq
->
maxsize
 = maxsize;

91 
rq
->
buÊí
 = 
ö¸emít
;

92 
rq
->
ö¸emít
 = increment;

93 
rq
->
ídbuf
 = &rq->
buf
[rq->
buÊí
];

94 
rq
->
£rvp
 =Ñq->
buf
;

95 
rq
->
ídp
 =Ñq->
buf
;

96 *
rq
->
£rvp
 = '\0';

98 
	}
}

105 
	$rögqClo£
(
rögq_t
 *
rq
)

107 
	`a_as£π
(
rq
);

108 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

110 i‡(
rq
 =
NULL
) {

114 
	`rögqFlush
(
rq
);

115 
	`b‰ì
(
B_L
, (*Ë
rq
->
buf
);

116 
rq
->
buf
 = 
NULL
;

117 
	}
}

125 
	$rögqLí
(
rögq_t
 *
rq
)

127 
	`a_as£π
(
rq
);

128 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

130 i‡(
rq
->
£rvp
 >Ñq->
ídp
) {

131  
rq
->
buÊí
 +Ñq->
ídp
 -Ñq->
£rvp
;

133  
rq
->
ídp
 -Ñq->
£rvp
;

135 
	}
}

142 
	$rögqGëc
(
rögq_t
 *
rq
)

144 
ch¨_t
 
c
;

145 
ch¨_t
* 
˝
;

147 
	`a_as£π
(
rq
);

148 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

150 i‡(
rq
->
£rvp
 =rq->
ídp
) {

154 
˝
 = (
ch¨_t
*Ë
rq
->
£rvp
;

155 
c
 = *
˝
++;

156 
rq
->
£rvp
 = (*Ë
˝
;

157 i‡(
rq
->
£rvp
 >rq->
ídbuf
) {

158 
rq
->
£rvp
 =Ñq->
buf
;

170  (Ë((Ë
c
);

171 
	}
}

179 
	$rögqPutc
(
rögq_t
 *
rq
, 
ch¨_t
 
c
)

181 
ch¨_t
 *
˝
;

183 
	`a_as£π
(
rq
);

184 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

186 i‡((
	`rögqPutBlkMax
(
rq
Ë< (Ë(
ch¨_t
)Ë&& !
	`rögqGrow
(rq)) {

190 
˝
 = (
ch¨_t
*Ë
rq
->
ídp
;

191 *
˝
++ = (
ch¨_t
Ë
c
;

192 
rq
->
ídp
 = (*Ë
˝
;

193 i‡(
rq
->
ídp
 >rq->
ídbuf
) {

194 
rq
->
ídp
 =Ñq->
buf
;

197 
	}
}

204 
	$rögqIn£πc
(
rögq_t
 *
rq
, 
ch¨_t
 
c
)

206 
ch¨_t
 *
˝
;

208 
	`a_as£π
(
rq
);

209 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

211 i‡(
	`rögqPutBlkMax
(
rq
Ë< (Ë(
ch¨_t
Ë&& !
	`rögqGrow
(rq)) {

214 i‡(
rq
->
£rvp
 <rq->
buf
) {

215 
rq
->
£rvp
 =Ñq->
ídbuf
;

217 
˝
 = (
ch¨_t
*Ë
rq
->
£rvp
;

218 *--
˝
 = (
ch¨_t
Ë
c
;

219 
rq
->
£rvp
 = (*Ë
˝
;

221 
	}
}

228 
	$rögqPutSå
(
rögq_t
 *
rq
, 
ch¨_t
 *
°r
)

230 
rc
;

232 
	`a_as£π
(
rq
);

233 
	`a_as£π
(
°r
);

234 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

236 
rc
 = 
	`rögqPutBlk
(
rq
, (*Ë
°r
, 
	`g°æí
(°rË* (
ch¨_t
));

237 *((
ch¨_t
*Ë
rq
->
ídp
) = (char_t) '\0';

238  
rc
;

239 
	}
}

246 
	$rögqAddNuŒ
(
rögq_t
 *
rq
)

248 
	`a_as£π
(
rq
);

249 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

251 *((
ch¨_t
*Ë
rq
->
ídp
) = (char_t) '\0';

252 
	}
}

255 #ifde‡
UNICODE


260 
	$rögqGëcA
(
rögq_t
 *
rq
)

262 
c
;

264 
	`a_as£π
(
rq
);

265 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

267 i‡(
rq
->
£rvp
 =rq->
ídp
) {

271 
c
 = *
rq
->
£rvp
++;

272 i‡(
rq
->
£rvp
 >rq->
ídbuf
) {

273 
rq
->
£rvp
 =Ñq->
buf
;

275  
c
;

276 
	}
}

284 
	$rögqPutcA
(
rögq_t
 *
rq
, 
c
)

286 
	`a_as£π
(
rq
);

287 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

289 i‡(
	`rögqPutBlkMax
(
rq
Ë=0 && !
	`rögqGrow
(rq)) {

293 *
rq
->
ídp
++ = (Ë
c
;

294 i‡(
rq
->
ídp
 >rq->
ídbuf
) {

295 
rq
->
ídp
 =Ñq->
buf
;

298 
	}
}

305 
	$rögqIn£πcA
(
rögq_t
 *
rq
, 
c
)

307 
	`a_as£π
(
rq
);

308 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

310 i‡(
	`rögqPutBlkMax
(
rq
Ë=0 && !
	`rögqGrow
(rq)) {

313 i‡(
rq
->
£rvp
 <rq->
buf
) {

314 
rq
->
£rvp
 =Ñq->
ídbuf
;

316 *--
rq
->
£rvp
 = (Ë
c
;

318 
	}
}

326 
	$rögqPutSåA
(
rögq_t
 *
rq
, *
°r
)

328 
rc
;

330 
	`a_as£π
(
rq
);

331 
	`a_as£π
(
°r
);

332 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

334 
rc
 = 
	`rögqPutBlk
(
rq
, (*Ë
°r
, 
	`°æí
(str));

335 
rq
->
ídp
[0] = '\0';

336  
rc
;

337 
	}
}

346 
	$rögqPutBlk
(
rögq_t
 *
rq
, *
buf
, 
size
)

348 
this
, 
byãs_put
;

350 
	`a_as£π
(
rq
);

351 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

352 
	`a_as£π
(
buf
);

353 
	`a_as£π
(0 <
size
);

358 
byãs_put
 = 0;

359 
size
 > 0) {

360 
this
 = 
	`mö
(
	`rögqPutBlkMax
(
rq
), 
size
);

361 i‡(
this
 <= 0) {

362 i‡(! 
	`rögqGrow
(
rq
)) {

365 
this
 = 
	`mö
(
	`rögqPutBlkMax
(
rq
), 
size
);

368 
	`mem˝y
(
rq
->
ídp
, 
buf
, 
this
);

369 
buf
 +
this
;

370 
rq
->
ídp
 +
this
;

371 
size
 -
this
;

372 
byãs_put
 +
this
;

374 i‡(
rq
->
ídp
 >rq->
ídbuf
) {

375 
rq
->
ídp
 =Ñq->
buf
;

378  
byãs_put
;

379 
	}
}

386 
	$rögqGëBlk
(
rögq_t
 *
rq
, *
buf
, 
size
)

388 
this
, 
byãs_ªad
;

390 
	`a_as£π
(
rq
);

391 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

392 
	`a_as£π
(
buf
);

393 
	`a_as£π
(0 <
size
 && sizê< 
rq
->
buÊí
);

398 
byãs_ªad
 = 0;

399 
size
 > 0) {

400 
this
 = 
	`rögqGëBlkMax
(
rq
);

401 
this
 = 
	`mö
—his, 
size
);

402 i‡(
this
 <= 0) {

406 
	`mem˝y
(
buf
, 
rq
->
£rvp
, 
this
);

407 
buf
 +
this
;

408 
rq
->
£rvp
 +
this
;

409 
size
 -
this
;

410 
byãs_ªad
 +
this
;

412 i‡(
rq
->
£rvp
 >rq->
ídbuf
) {

413 
rq
->
£rvp
 =Ñq->
buf
;

416  
byãs_ªad
;

417 
	}
}

425 
	$rögqPutBlkMax
(
rögq_t
 *
rq
)

427 
•a˚
, 
ö_a_löe
;

429 
	`a_as£π
(
rq
);

430 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

432 
•a˚
 = 
rq
->
buÊí
 - 
	`RINGQ_LEN
(rq) - 1;

433 
ö_a_löe
 = 
rq
->
ídbuf
 -Ñq->
ídp
;

435  
	`mö
(
ö_a_löe
, 
•a˚
);

436 
	}
}

444 
	$rögqGëBlkMax
(
rögq_t
 *
rq
)

446 
Àn
, 
ö_a_löe
;

448 
	`a_as£π
(
rq
);

449 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

451 
Àn
 = 
	`RINGQ_LEN
(
rq
);

452 
ö_a_löe
 = 
rq
->
ídbuf
 -Ñq->
£rvp
;

454  
	`mö
(
ö_a_löe
, 
Àn
);

455 
	}
}

462 
	$rögqPutBlkAdj
(
rögq_t
 *
rq
, 
size
)

464 
	`a_as£π
(
rq
);

465 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

466 
	`a_as£π
(0 <
size
 && sizê< 
rq
->
buÊí
);

468 
rq
->
ídp
 +
size
;

469 i‡(
rq
->
ídp
 >rq->
ídbuf
) {

470 
rq
->
ídp
 -rq->
buÊí
;

475 i‡(
rq
->
ídp
 >rq->
ídbuf
) {

476 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("BadÉndÖointer"));

477 
	`rögqFlush
(
rq
);

479 
	}
}

486 
	$rögqGëBlkAdj
(
rögq_t
 *
rq
, 
size
)

488 
	`a_as£π
(
rq
);

489 
	`a_as£π
(
rq
->
buÊí
 =‘q->
ídbuf
 -Ñq->
buf
));

490 
	`a_as£π
(0 < 
size
 && sizê< 
rq
->
buÊí
);

492 
rq
->
£rvp
 +
size
;

493 i‡(
rq
->
£rvp
 >rq->
ídbuf
) {

494 
rq
->
£rvp
 -rq->
buÊí
;

499 i‡(
rq
->
£rvp
 >rq->
ídbuf
) {

500 
	`îr‹
(
E_L
, 
E_LOG
, 
	`T
("Bad servÖointer"));

501 
	`rögqFlush
(
rq
);

503 
	}
}

510 
	$rögqFlush
(
rögq_t
 *
rq
)

512 
	`a_as£π
(
rq
);

513 
	`a_as£π
(
rq
->
£rvp
);

515 
rq
->
£rvp
 =Ñq->
buf
;

516 
rq
->
ídp
 =Ñq->
buf
;

517 i‡(
rq
->
£rvp
) {

518 *
rq
->
£rvp
 = '\0';

520 
	}
}

529 
	$rögqGrow
(
rögq_t
 *
rq
)

531 *
√wbuf
;

532 
Àn
;

534 
	`a_as£π
(
rq
);

536 i‡(
rq
->
maxsize
 >0 &&Ñq->
buÊí
 >=Ñq->maxsize) {

540 
Àn
 = 
	`rögqLí
(
rq
);

542 i‡((
√wbuf
 = 
	`bÆloc
(
B_L
, 
rq
->
buÊí
 +Ñq->
ö¸emít
)Ë=
NULL
) {

545 
	`rögqGëBlk
(
rq
, 
√wbuf
, 
	`rögqLí
(rq));

546 
	`b‰ì
(
B_L
, (*Ë
rq
->
buf
);

549 
rq
->
buÊí
 +rq->
ö¸emít
;

550 
rq
->
ídp
 = 
√wbuf
;

551 
rq
->
£rvp
 = 
√wbuf
;

552 
rq
->
buf
 = 
√wbuf
;

553 
rq
->
ídbuf
 = &rq->
buf
[rq->
buÊí
];

555 
	`rögqPutBlk
(
rq
, 
√wbuf
, 
Àn
);

560 
rq
->
ö¸emít
 = 
	`gëBöBlockSize
(2 *Ñq->increment);

563 
	}
}

572 
	$gëBöBlockSize
(
size
)

574 
q
;

576 
size
 = sizê>> 
B_SHIFT
;

577 
q
 = 0; 
size
; size >>= 1) {

578 
q
++;

580  (1 << (
B_SHIFT
 + 
q
));

581 
	}
}

	@rom.c

22 
	~<°dlib.h
>

24 
	~"wsI¡∫.h
"

28 #ifde‡
WEBS_PAGE_ROM


30 
sym_fd_t
 
	gromTab
;

37 
	$websRomO≥n
()

39 
websRomPageIndexTy≥
 *
wù
;

40 
nch¨s
;

41 
ch¨_t
 
«me
[
SYM_MAX
];

43 
romTab
 = 
	`symO≥n
(
WEBS_SYM_INIT
);

45 
wù
 = 
websRomPageIndex
; wù->
∑th
; wip++) {

46 
	`g°∫˝y
(
«me
, 
wù
->
∑th
, 
SYM_MAX
);

47 
nch¨s
 = 
	`g°æí
(
«me
) - 1;

48 i‡(
nch¨s
 > 0 &&

49 (
«me
[
nch¨s
] == '/' ||Çame[nchars] == '\\')) {

50 
«me
[
nch¨s
] = '\0';

52 
	`symE¡î
(
romTab
, 
«me
, 
	`vÆueI¡egî
((Ë
wù
), 0);

55 
	}
}

62 
	$websRomClo£
()

64 
	`symClo£
(
romTab
);

65 
	}
}

72 
	$websRomPageO≥n
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, 
mode
, 
≥rm
)

74 
websRomPageIndexTy≥
 *
wù
;

75 
sym_t
 *
•
;

77 
	`a_as£π
(
	`websVÆid
(
wp
));

78 
	`a_as£π
(
∑th
 && *path);

80 i‡((
•
 = 
	`symLookup
(
romTab
, 
∑th
)Ë=
NULL
) {

83 
wù
 = (
websRomPageIndexTy≥
*Ë
•
->
c⁄ã¡
.
vÆue
.
öãgî
;

84 
wù
->
pos
 = 0;

85  (
wp
->
docfd
 = 
wù
 - 
websRomPageIndex
);

86 
	}
}

93 
	$websRomPageClo£
(
fd
)

95 
	}
}

102 
	$websRomPageSèt
(
ch¨_t
 *
∑th
, 
websSètTy≥
 *
sbuf
)

104 
websRomPageIndexTy≥
 *
wù
;

105 
sym_t
 *
•
;

107 
	`a_as£π
(
∑th
 && *path);

109 i‡((
•
 = 
	`symLookup
(
romTab
, 
∑th
)Ë=
NULL
) {

112 
wù
 = (
websRomPageIndexTy≥
*Ë
•
->
c⁄ã¡
.
vÆue
.
öãgî
;

114 
	`mem£t
(
sbuf
, 0, (
websSètTy≥
));

115 
sbuf
->
size
 = 
wù
->size;

116 i‡(
wù
->
∑ge
 =
NULL
) {

117 
sbuf
->
isDú
 = 1;

120 
	}
}

127 
	$websRomPageRódD©a
(
webs_t
 
wp
, *
buf
, 
nByãs
)

129 
websRomPageIndexTy≥
 *
wù
;

130 
Àn
;

132 
	`a_as£π
(
	`websVÆid
(
wp
));

133 
	`a_as£π
(
buf
);

134 
	`a_as£π
(
wp
->
docfd
 >= 0);

136 
wù
 = &
websRomPageIndex
[
wp
->
docfd
];

138 
Àn
 = 
	`mö
(
wù
->
size
 - wù->
pos
, 
nByãs
);

139 
	`mem˝y
(
buf
, &
wù
->
∑ge
[wù->
pos
], 
Àn
);

140 
wù
->
pos
 +
Àn
;

141  
Àn
;

142 
	}
}

149 
	$websRomPageSìk
(
webs_t
 
wp
, 
off£t
, 
‹igö
)

151 
websRomPageIndexTy≥
 *
wù
;

152 
pos
;

154 
	`a_as£π
(
	`websVÆid
(
wp
));

155 
	`a_as£π
(
‹igö
 =
SEEK_SET
 || origö =
SEEK_CUR
 || origö =
SEEK_END
);

156 
	`a_as£π
(
wp
->
docfd
 >= 0);

158 
wù
 = &
websRomPageIndex
[
wp
->
docfd
];

160 i‡(
‹igö
 !
SEEK_SET
 && origö !
SEEK_CUR
 && origö !
SEEK_END
) {

161 
î∫o
 = 
EINVAL
;

165 i‡(
wp
->
docfd
 < 0) {

166 
î∫o
 = 
EBADF
;

170 
pos
 = 
off£t
;

171 
‹igö
) {

172 
SEEK_CUR
:

173 
pos
 = 
wù
->po†+ 
off£t
;

175 
SEEK_END
:

176 
pos
 = 
wù
->
size
 + 
off£t
;

182 i‡(
pos
 < 0) {

183 
î∫o
 = 
EBADF
;

187  (
wù
->
pos
 =Öos);

188 
	}
}

	@security.c

18 
	~"wsI¡∫.h
"

19 
	~"um.h
"

20 #ifde‡
DIGEST_ACCESS_SUPPORT


21 
	~"websda.h
"

32 #i‚de‡
USER_MANAGEMENT_SUPPORT


33 
	#umGëAc˚ssMëhodF‹URL
(
uæ
Ë
AM_FULL


	)

34 
	#umU£rExi°s
(
u£rid
Ë0

	)

35 
	#umU£rC™Ac˚ssURL
(
u£rid
, 
uæ
Ë1

	)

36 
	#umGëU£rPassw‹d
(
u£rid
Ë
	`websGëPassw‹d
()

	)

37 
	#umGëAc˚ssLimôSecuª
(
ac˚ssLimô
Ë0

	)

38 
	#umGëAc˚ssLimô
(
uæ
Ë
NULL


	)

43 
ch¨_t
 
	gwebsPassw‹d
[
WEBS_MAX_PASS
];

44 #ifde‡
_DEBUG


45 
	gdebugSecurôy
 = 1;

47 
	gdebugSecurôy
 = 0;

55 
	$websSecurôyH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
,

56 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
)

58 
ch¨_t
 *
ty≥
, *
u£rid
, *
∑ssw‹d
, *
ac˚ssLimô
;

59 
Êags
, 
nRë
;

60 
ac˚ssMëh_t
 
am
;

62 
	`a_as£π
(
	`websVÆid
(
wp
));

63 
	`a_as£π
(
uæ
 && *url);

64 
	`a_as£π
(
∑th
 && *path);

68 
ty≥
 = 
	`websGëReque°Ty≥
(
wp
);

69 
∑ssw‹d
 = 
	`websGëReque°Passw‹d
(
wp
);

70 
u£rid
 = 
	`websGëReque°U£rName
(
wp
);

71 
Êags
 = 
	`websGëReque°Fœgs
(
wp
);

75 
ac˚ssLimô
 = 
	`umGëAc˚ssLimô
(
∑th
);

76 i‡(
ac˚ssLimô
 =
NULL
) {

83 #ifde‡
WEBS_SSL_SUPPORT


84 
nRë
 = 
	`umGëAc˚ssLimôSecuª
(
ac˚ssLimô
);

85 i‡(
nRë
 && ((
Êags
 & 
WEBS_SECURE
) == 0)) {

86 
websSèts
.
ac˚ss
++;

87 
	`websEº‹
(
wp
, 405, 
	`T
("Access Denied\nSecureáccess isÑequired."));

88 
	`åa˚
(3, 
	`T
("SEC: N⁄-£cuªác˚s†©ãm±ed o¿<%s>\n"), 
∑th
);

92 
	`b‰ì
(
B_L
, 
ac˚ssLimô
);

100 
am
 = 
	`umGëAc˚ssMëhodF‹URL
(
ac˚ssLimô
);

102 
nRë
 = 0;

103 i‡((
Êags
 & 
WEBS_LOCAL_REQUEST
Ë&& (
debugSecurôy
 == 0)) {

107 } i‡(
am
 =
AM_NONE
) {

111 
websSèts
.
ac˚ss
++;

112 
	`websEº‹
(
wp
, 404, 
	`T
("Page Not Found"));

113 
nRë
 = 1;

114 } i‡(
u£rid
 && *userid) {

115 i‡(!
	`umU£rExi°s
(
u£rid
)) {

116 
websSèts
.
ac˚ss
++;

117 
	`websEº‹
(
wp
, 401, 
	`T
("Access Denied\nUnknown User"));

118 
	`åa˚
(3, 
	`T
("SEC: Unknown user <%s>áttemptedÅoáccess <%s>\n"),

119 
u£rid
, 
∑th
);

120 
nRë
 = 1;

121 } i‡(!
	`umU£rC™Ac˚ssURL
(
u£rid
, 
ac˚ssLimô
)) {

122 
websSèts
.
ac˚ss
++;

123 
	`websEº‹
(
wp
, 403, 
	`T
("Access Denied\nProhibited User"));

124 
nRë
 = 1;

125 } i‡(
∑ssw‹d
 && *Öassword) {

126 
ch¨_t
 * 
u£Ωass
 = 
	`umGëU£rPassw‹d
(
u£rid
);

127 i‡(
u£Ωass
) {

128 i‡(
	`g°rcmp
(
∑ssw‹d
, 
u£Ωass
) != 0) {

129 
websSèts
.
ac˚ss
++;

130 
	`websEº‹
(
wp
, 401, 
	`T
("Access Denied\nWrong Password"));

131 
	`åa˚
(3, 
	`T
("SEC: Password fail for user <%s>")

132 
	`T
("©ãm±Åÿac˚s†<%s>\n"), 
u£rid
, 
∑th
);

133 
nRë
 = 1;

140 
	`b‰ì
 (
B_L
, 
u£Ωass
);

142 #ifde‡
DIGEST_ACCESS_SUPPORT


143 } i‡(
Êags
 & 
WEBS_AUTH_DIGEST
) {

145 
ch¨_t
 *
dige°CÆc
;

150 
wp
->
∑ssw‹d
 = 
	`umGëU£rPassw‹d
(
u£rid
);

152 
	`a_as£π
(
wp
->
dige°
);

153 
	`a_as£π
(
wp
->
n⁄˚
);

154 
	`a_as£π
(
wp
->
∑ssw‹d
);

156 
dige°CÆc
 = 
	`websCÆcDige°
(
wp
);

157 
	`a_as£π
(
dige°CÆc
);

159 i‡(
	`g°rcmp
(
wp
->
dige°
, 
dige°CÆc
) != 0) {

160 
	`b‰ì
 (
B_L
, 
dige°CÆc
);

161 
dige°CÆc
 = 
	`websCÆcUæDige°
(
wp
);

162 
	`a_as£π
(
dige°CÆc
);

163 i‡(
	`g°rcmp
(
wp
->
dige°
, 
dige°CÆc
) != 0) {

164 
websSèts
.
ac˚ss
++;

166 
	`websEº‹
(
wp
, 401, 
	`T
("Access Denied\nWrong Password"));

167 
nRë
 = 1;

171 
	`b‰ì
 (
B_L
, 
dige°CÆc
);

177 #ifde‡
DIGEST_ACCESS_SUPPORT


178 i‡(
am
 =
AM_DIGEST
) {

179 
wp
->
Êags
 |
WEBS_AUTH_DIGEST
;

182 
websSèts
.
îr‹s
++;

183 
	`websEº‹
(
wp
, 401,

184 
	`T
("AccessÅoÅhis documentÑequiresáÖassword"));

185 
nRë
 = 1;

187 } i‡(
am
 !
AM_FULL
) {

192 #ifde‡
DIGEST_ACCESS_SUPPORT


193 i‡(
am
 =
AM_DIGEST
) {

194 
wp
->
Êags
 |
WEBS_AUTH_DIGEST
;

197 
websSèts
.
îr‹s
++;

198 
	`websEº‹
(
wp
, 401, 
	`T
("AccessÅoÅhis documentÑequiresá User ID"));

199 
nRë
 = 1;

202 
	`b‰ì
(
B_L
, 
ac˚ssLimô
);

204  
nRë
;

205 
	}
}

212 
	$websSecurôyDñëe
()

214 
	`websUæH™dÀrDñëe
(
websSecurôyH™dÀr
);

215 
	}
}

223 
	$websSëPassw‹d
(
ch¨_t
 *
∑ssw‹d
)

225 
	`a_as£π
(
∑ssw‹d
);

227 
	`g°∫˝y
(
websPassw‹d
, 
∑ssw‹d
, 
	`TSZ
(websPassword));

228 
	}
}

235 
ch¨_t
 *
	$websGëPassw‹d
()

237  
	`b°rdup
(
B_L
, 
websPassw‹d
);

238 
	}
}

	@sock.c

17 
	~<°rög.h
>

18 
	~<°dlib.h
>

20 
	~"uemf.h
"

24 
sockë_t
 **
	gsockëLi°
;

25 
	gsockëMax
;

26 
	gsockëHighe°Fd
 = -1;

30 
sockëDoOuçut
(
sockë_t
 *
•
, *
buf
, 
toWrôe
, *
îrCode
);

31 
åyA…î«ãSídTo
(
sock
, *
buf
, 
toWrôe
, 
i
,

32 
sockaddr
 *
£rvî
);

41 
	$sockëWrôe
(
sid
, *
buf
, 
bufsize
)

43 
sockë_t
 *
•
;

44 
rögq_t
 *
rq
;

45 
Àn
, 
byãsWrôãn
, 
room
;

47 
	`a_as£π
(
buf
);

48 
	`a_as£π
(
bufsize
 >= 0);

50 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

59 
rq
 = &
•
->
outBuf
;

60 
byãsWrôãn
 = 0; 
bufsize
 > 0; ) {

61 i‡((
room
 = 
	`rögqPutBlkMax
(
rq
)) == 0) {

62 i‡(
	`sockëFlush
(
sid
) < 0) {

65 i‡((
room
 = 
	`rögqPutBlkMax
(
rq
)) == 0) {

66 i‡(
•
->
Êags
 & 
SOCKET_BLOCK
) {

67 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

68 
îrCode
;

69 i‡(! 
	`sockëWaôF‹Evít
(
•
, 
FD_WRITE
 | 
SOCKET_WRITABLE
,

70 &
îrCode
)) {

80 
Àn
 = 
	`mö
(
room
, 
bufsize
);

81 
	`rögqPutBlk
(
rq
, (*Ë
buf
, 
Àn
);

82 
byãsWrôãn
 +
Àn
;

83 
bufsize
 -
Àn
;

84 
buf
 +
Àn
;

86  
byãsWrôãn
;

87 
	}
}

94 
	$sockëWrôeSåög
(
sid
, 
ch¨_t
 *
buf
)

96 #ifde‡
UNICODE


97 *
byãBuf
;

98 
r
, 
Àn
;

100 
Àn
 = 
	`g°æí
(
buf
);

101 
byãBuf
 = 
	`bÆlocUniToAsc
(
buf
, 
Àn
);

102 
r
 = 
	`sockëWrôe
(
sid
, 
byãBuf
, 
Àn
);

103 
	`b‰ìSa„
(
B_L
, 
byãBuf
);

104  
r
;

106  
	`sockëWrôe
(
sid
, 
buf
, 
	`°æí
(buf));

108 
	}
}

124 
	$sockëRód
(
sid
, *
buf
, 
bufsize
)

126 
sockë_t
 *
•
;

127 
rögq_t
 *
rq
;

128 
Àn
, 
room
, 
îrCode
, 
byãsRód
;

130 
	`a_as£π
(
buf
);

131 
	`a_as£π
(
bufsize
 > 0);

133 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

137 i‡(
•
->
Êags
 & 
SOCKET_EOF
) {

141 
rq
 = &
•
->
öBuf
;

142 
byãsRód
 = 0; 
bufsize
 > 0; ) {

143 
Àn
 = 
	`mö
(
	`rögqLí
(
rq
), 
bufsize
);

144 i‡(
Àn
 <= 0) {

149 i‡((
•
->
Êags
 & 
SOCKET_BLOCK
) &&

150 (
byãsRód
 > 0)) {

158 
	`rögqFlush
(
rq
);

159 
room
 = 
	`rögqPutBlkMax
(
rq
);

160 
Àn
 = 
	`sockëGëI≈ut
(
sid
, (*Ë
rq
->
ídp
, 
room
, &
îrCode
);

161 i‡(
Àn
 < 0) {

162 i‡(
îrCode
 =
EWOULDBLOCK
) {

163 i‡((
•
->
Êags
 & 
SOCKET_BLOCK
) &&

164 (
byãsRód
 == 0)) {

167 i‡(
byãsRód
 >= 0) {

168  
byãsRód
;

173 } i‡(
Àn
 == 0) {

179 i‡(
byãsRód
 == 0) {

180 
•
->
Êags
 |
SOCKET_EOF
;

182  
byãsRód
;

184 
	`rögqPutBlkAdj
(
rq
, 
Àn
);

185 
Àn
 = 
	`mö
÷í, 
bufsize
);

187 
	`mem˝y
(&
buf
[
byãsRód
], 
rq
->
£rvp
, 
Àn
);

188 
	`rögqGëBlkAdj
(
rq
, 
Àn
);

189 
bufsize
 -
Àn
;

190 
byãsRód
 +
Àn
;

192  
byãsRód
;

193 
	}
}

206 
	$sockëGës
(
sid
, 
ch¨_t
 **
buf
)

208 
sockë_t
 *
•
;

209 
rögq_t
 *
lq
;

210 
c
;

211 
rc
, 
Àn
;

213 
	`a_as£π
(
buf
);

214 *
buf
 = 
NULL
;

216 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

219 
lq
 = &
•
->
löeBuf
;

223 i‡((
rc
 = 
	`sockëRód
(
sid
, &
c
, 1)) < 0) {

224  
rc
;

227 i‡(
rc
 == 0) {

231 i‡(
	`rögqLí
(
lq
Ë> 0 && (
•
->
Êags
 & 
SOCKET_EOF
)) {

232 
c
 = '\n';

241 i‡(
	`rögqLí
(
lq
Ë> 
E_MAX_REQUEST
) {

242 
c
 = '\n';

248 i‡(
c
 == '\n') {

249 
Àn
 = 
	`rögqLí
(
lq
);

250 i‡(
Àn
 > 0) {

251 *
buf
 = 
	`bÆlocAscToUni
((*)
lq
->
£rvp
, 
Àn
);

253 *
buf
 = 
NULL
;

255 
	`rögqFlush
(
lq
);

256  
Àn
;

258 } i‡(
c
 == '\r') {

261 
	`rögqPutcA
(
lq
, 
c
);

264 
	}
}

272 
	$sockëFlush
(
sid
)

274 
sockë_t
 *
•
;

275 
rögq_t
 *
rq
;

276 
Àn
, 
byãsWrôãn
, 
îrCode
;

278 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

281 
rq
 = &
•
->
outBuf
;

287 i‡(! (
•
->
Êags
 & 
SOCKET_BLOCK
)) {

288 
•
->
Êags
 |
SOCKET_FLUSHING
;

295 
	`rögqLí
(
rq
) > 0) {

296 
Àn
 = 
	`rögqGëBlkMax
(&
•
->
outBuf
);

297 
byãsWrôãn
 = 
	`sockëDoOuçut
(
•
, (*Ë
rq
->
£rvp
, 
Àn
, &
îrCode
);

298 i‡(
byãsWrôãn
 < 0) {

299 i‡(
îrCode
 =
EINTR
) {

301 } i‡(
îrCode
 =
EWOULDBLOCK
 ||ÉºCodê=
EAGAIN
) {

302 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

303 i‡(
•
->
Êags
 & 
SOCKET_BLOCK
) {

304 
îrCode
;

305 i‡(! 
	`sockëWaôF‹Evít
(
•
, 
FD_WRITE
 | 
SOCKET_WRITABLE
,

306 &
îrCode
)) {

317 i‡(
•
->
ßveMask
 < 0 ) {

318 
•
->
ßveMask
 = sp->
h™dÀrMask
;

319 
	`sockëRegi°îI¡îe°
(
•
,

320 
•
->
h™dÀrMask
 | 
SOCKET_WRITABLE
);

326 
	`rögqGëBlkAdj
(
rq
, 
byãsWrôãn
);

333 i‡(
	`rögqLí
(
rq
) == 0) {

334 
	`rögqFlush
(
rq
);

340 i‡(
•
->
ßveMask
 >= 0) {

341 
	`sockëRegi°îI¡îe°
(
•
, sp->
ßveMask
);

342 
•
->
ßveMask
 = -1;

344 
•
->
Êags
 &~
SOCKET_FLUSHING
;

346 
	}
}

354 
	$sockëI≈utBuf„ªd
(
sid
)

356 
sockë_t
 *
•
;

358 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

361 i‡(
	`sockëEof
(
sid
)) {

364  
	`rögqLí
(&
•
->
öBuf
);

365 
	}
}

372 
	$sockëEof
(
sid
)

374 
sockë_t
 *
•
;

376 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

379  
•
->
Êags
 & 
SOCKET_EOF
;

380 
	}
}

387 
	$sockëC™Wrôe
(
sid
)

389 
sockë_t
 *
•
;

391 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

394  
•
->
outBuf
.
buÊí
 - 
	`rögqLí
(&sp->outBuf) - 1;

395 
	}
}

402 
	$sockëSëBuf„rSize
(
sid
, 
ö
, 
löe
, 
out
)

404 
sockë_t
 *
•
;

406 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

410 i‡(
ö
 >= 0) {

411 
	`rögqClo£
(&
•
->
öBuf
);

412 
ö
++;

413 
	`rögqO≥n
(&
•
->
öBuf
, 
ö
, in);

416 i‡(
löe
 >= 0) {

417 
	`rögqClo£
(&
•
->
löeBuf
);

418 
löe
++;

419 
	`rögqO≥n
(&
•
->
löeBuf
, 
löe
,Üine);

422 i‡(
out
 >= 0) {

423 
	`rögqClo£
(&
•
->
outBuf
);

424 
out
++;

425 
	`rögqO≥n
(&
•
->
outBuf
, 
out
, out);

427 
	}
}

435 
	$sockëCª©eH™dÀr
(
sid
, 
h™dÀrMask
, 
sockëH™dÀr_t
 
h™dÀr
,

436 * 
d©a
)

438 
sockë_t
 *
•
;

440 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

443 
•
->
h™dÀr
 = handler;

444 
•
->
h™dÀr_d©a
 = 
d©a
;

445 
	`sockëRegi°îI¡îe°
(
•
, 
h™dÀrMask
);

446 
	}
}

453 
	$sockëDñëeH™dÀr
(
sid
)

455 
sockë_t
 *
•
;

457 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

460 
•
->
h™dÀr
 = 
NULL
;

461 
	`sockëRegi°îI¡îe°
(
•
, 0);

462 
	}
}

470 
	$sockëDoOuçut
(
sockë_t
 *
•
, *
buf
, 
toWrôe
, *
îrCode
)

472 
sockaddr_ö
 
£rvî
;

473 
byãs
;

475 
	`a_as£π
(
•
);

476 
	`a_as£π
(
buf
);

477 
	`a_as£π
(
toWrôe
 > 0);

478 
	`a_as£π
(
îrCode
);

480 *
îrCode
 = 0;

482 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

483 i‡((
•
->
Êags
 & 
SOCKET_ASYNC
)

484 && ! 
	`sockëWaôF‹Evít
(
•
, 
FD_CONNECT
, 
îrCode
)) {

492 i‡(
•
->
Êags
 & 
SOCKET_BROADCAST
) {

493 
£rvî
.
sö_Ámûy
 = 
AF_INET
;

494 
£rvî
.
sö_addr
.
s_addr
 = 
INADDR_BROADCAST
;

495 
£rvî
.
sö_p‹t
 = 
	`ht⁄s
(()(
•
->
p‹t
 & 0xFFFF));

496 i‡((
byãs
 = 
	`£ndto
(
•
->
sock
, 
buf
, 
toWrôe
, 0,

497 (
sockaddr
 *Ë&
£rvî
, (server))) < 0) {

498 
byãs
 = 
	`åyA…î«ãSídTo
(
•
->
sock
, 
buf
, 
toWrôe
, 0,

499 (
sockaddr
 *Ë&
£rvî
);

501 } i‡(
•
->
Êags
 & 
SOCKET_DATAGRAM
) {

502 
£rvî
.
sö_Ámûy
 = 
AF_INET
;

503 
£rvî
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
•
->
ho°
);

504 
£rvî
.
sö_p‹t
 = 
	`ht⁄s
(()(
•
->
p‹t
 & 0xFFFF));

505 
byãs
 = 
	`£ndto
(
•
->
sock
, 
buf
, 
toWrôe
, 0,

506 (
sockaddr
 *Ë&
£rvî
, (server));

509 
byãs
 = 
	`£nd
(
•
->
sock
, 
buf
, 
toWrôe
, 0);

512 i‡(
byãs
 < 0) {

513 *
îrCode
 = 
	`sockëGëEº‹
();

514 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

515 
•
->
cuºítEvíts
 &~
FD_WRITE
;

520 } i‡(
byãs
 =0 && byã†!
toWrôe
) {

521 *
îrCode
 = 
EWOULDBLOCK
;

522 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

523 
•
->
cuºítEvíts
 &~
FD_WRITE
;

532  
byãs
;

533 
	}
}

542 
	$åyA…î«ãSídTo
(
sock
, *
buf
, 
toWrôe
, 
i
,

543 
sockaddr
 *
£rvî
)

545 #ifde‡
VXWORKS


546 *
±r
;

548 
±r
 = (*)
£rvî
;

549 *
±r
 = *(ptr+1);

550 *(
±r
+1) = 0;

551  
	`£ndto
(
sock
, 
buf
, 
toWrôe
, 
i
, 
£rvî
, (
sockaddr
));

555 
	}
}

562 
	$sockëAŒoc
(*
ho°
, 
p‹t
, 
sockëAc˚±_t
 
ac˚±
, 
Êags
)

564 
sockë_t
 *
•
;

565 
sid
;

567 i‡((
sid
 = 
	`hAŒocE¡ry
((***Ë&
sockëLi°
, &
sockëMax
,

568 (
sockë_t
))) < 0) {

571 
•
 = 
sockëLi°
[
sid
];

573 
•
->
sid
 = sid;

574 
•
->
ac˚±
 =áccept;

575 
•
->
p‹t
 =Öort;

576 
•
->
fûeH™dÀ
 = -1;

577 
•
->
ßveMask
 = -1;

579 i‡(
ho°
) {

580 
	`°∫˝y
(
•
->
ho°
, host, (sp->host));

586 
	`a_as£π
((
Êags
 & ~(
SOCKET_BROADCAST
|
SOCKET_DATAGRAM
|
SOCKET_BLOCK
|

587 
SOCKET_LISTENING
)) == 0);

588 
•
->
Êags
 = fœg†& (
SOCKET_BROADCAST
 | 
SOCKET_DATAGRAM
 | 
SOCKET_BLOCK
 |

589 
SOCKET_LISTENING
 | 
SOCKET_MYOWNBUFFERS
);

591 i‡(!(
Êags
 & 
SOCKET_MYOWNBUFFERS
)) {

595 
	`rögqO≥n
(&
•
->
öBuf
, 
SOCKET_BUFSIZ
, SOCKET_BUFSIZ);

596 
	`rögqO≥n
(&
•
->
outBuf
, 
SOCKET_BUFSIZ
 + 1, SOCKET_BUFSIZ + 1);

598 
	`mem£t
(&
•
->
öBuf
, 0x0, (
rögq_t
));

599 
	`mem£t
(&
•
->
outBuf
, 0x0, (
rögq_t
));

601 
	`rögqO≥n
(&
•
->
löeBuf
, 
SOCKET_BUFSIZ
, -1);

603  
sid
;

604 
	}
}

611 
	$sockëFªe
(
sid
)

613 
sockë_t
 *
•
;

614 
ch¨_t
 
buf
[256];

615 
i
;

617 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

629 
	`sockëRegi°îI¡îe°
(
•
, 0);

630 i‡(
•
->
sock
 >= 0) {

631 
	`sockëSëBlock
(
sid
, 0);

632 i‡(
	`shutdown
(
•
->
sock
, 1) >= 0) {

633 
	`ªcv
(
•
->
sock
, 
buf
, (buf), 0);

635 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

636 
	`˛o£sockë
(
•
->
sock
);

638 
	`˛o£
(
•
->
sock
);

642 i‡(!(
•
->
Êags
 & 
SOCKET_MYOWNBUFFERS
)) {

643 
	`rögqClo£
(&
•
->
öBuf
);

644 
	`rögqClo£
(&
•
->
outBuf
);

646 
	`rögqClo£
(&
•
->
löeBuf
);

648 
	`b‰ì
(
B_L
, 
•
);

649 
sockëMax
 = 
	`hFªe
((***Ë&
sockëLi°
, 
sid
);

654 
sockëHighe°Fd
 = -1;

655 
i
 = 0; i < 
sockëMax
; i++) {

656 i‡((
•
 = 
sockëLi°
[
i
]Ë=
NULL
) {

659 
sockëHighe°Fd
 = 
	`max
(sockëHighe°Fd, 
•
->
sock
);

661 
	}
}

668 
sockë_t
 *
	$sockëPå
(
sid
)

670 i‡(
sid
 < 0 || sid >
sockëMax
 || 
sockëLi°
[sid] =
NULL
) {

671 
	`a_as£π
(
NULL
);

672 
î∫o
 = 
EBADF
;

673  
NULL
;

676 
	`a_as£π
(
sockëLi°
[
sid
]);

677  
sockëLi°
[
sid
];

678 
	}
}

685 
	$sockëGëEº‹
()

687 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

688 
	`WSAGëLa°Eº‹
()) {

689 
WSAEWOULDBLOCK
:

690  
EWOULDBLOCK
;

691 
WSAECONNRESET
:

692  
ECONNRESET
;

693 
WSAENETDOWN
:

694  
ENETDOWN
;

695 
WSAEPROCLIM
:

696  
EAGAIN
;

697 
WSAEINTR
:

698  
EINTR
;

700  
EINVAL
;

703  
î∫o
;

705 
	}
}

712 
	$sockëGëH™dÀ
(
sid
)

714 
sockë_t
 *
•
;

716 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

719  
•
->
sock
;

720 
	}
}

727 
	$sockëGëBlock
(
sid
)

729 
sockë_t
 *
•
;

731 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

732 
	`a_as£π
(0);

735  (
•
->
Êags
 & 
SOCKET_BLOCK
);

736 
	}
}

743 
	$sockëGëMode
(
sid
)

745 
sockë_t
 *
•
;

747 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

748 
	`a_as£π
(0);

751  
•
->
Êags
;

752 
	}
}

759 
	$sockëSëMode
(
sid
, 
mode
)

761 
sockë_t
 *
•
;

763 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

764 
	`a_as£π
(0);

767 
•
->
Êags
 = 
mode
;

768 
	}
}

775 
	$sockëGëP‹t
(
sid
)

777 
sockë_t
 *
•
;

779 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

782  
•
->
p‹t
;

783 
	}
}

	@sockGen.c

16 #i‡(!
deföed
 (
WIN
Ë|| deföed (
LITTLEFOOT
Ë|| deföed (
WEBS
))

19 #i‚de‡
CE


20 
	~<î∫o.h
>

21 
	~<f˙é.h
>

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

26 
	~"uemf.h
"

28 #ifde‡
VXWORKS


29 
	~<ho°Lib.h
>

34 
sockë_t
 **
sockëLi°
;

35 
sockëMax
;

36 
sockëHighe°Fd
;

37 
	gsockëO≥nCou¡
 = 0;

41 
sockëAc˚±
(
sockë_t
 *
•
);

42 
sockëDoEvít
(
sockë_t
 *
•
);

43 
åyA…î«ãC⁄√˘
(
sock
, 
sockaddr
 *sockaddr);

50 
	$sockëO≥n
()

52 #i‡(
	`deföed
 (
CE
Ë|| deföed (
WIN
))

53 
WSADATA
 
wßD©a
;

56 i‡(++
sockëO≥nCou¡
 > 1) {

60 #i‡(
	`deföed
 (
CE
Ë|| deföed (
WIN
))

61 i‡(
	`WSASèπup
(
	`MAKEWORD
(1,1), &
wßD©a
) != 0) {

64 i‡(
wßD©a
.
wVîsi⁄
 !
	`MAKEWORD
(1,1)) {

65 
	`WSACÀ™up
();

70 
sockëLi°
 = 
NULL
;

71 
sockëMax
 = 0;

72 
sockëHighe°Fd
 = -1;

75 
	}
}

82 
	$sockëClo£
()

84 
i
;

86 i‡(--
sockëO≥nCou¡
 <= 0) {

87 
i
 = 
sockëMax
; i >= 0; i--) {

88 i‡(
sockëLi°
 && sockëLi°[
i
]) {

89 
	`sockëClo£C⁄√˘i⁄
(
i
);

92 
sockëO≥nCou¡
 = 0;

94 
	}
}

101 
	$sockëO≥nC⁄√˘i⁄
(*
ho°
, 
p‹t
, 
sockëAc˚±_t
 
ac˚±
, 
Êags
)

103 #i‡(!
	`deföed
 (
NO_GETHOSTBYNAME
Ë&& !deföed (
VXWORKS
))

104 
ho°ít
 *hostent;

106 
sockë_t
 *
•
;

107 
sockaddr_ö
 
sockaddr
;

108 
sid
, 
bˇ°
, 
dgøm
, 
rc
;

110 i‡(
p‹t
 > 
SOCKET_PORT_MAX
) {

116 i‡((
sid
 = 
	`sockëAŒoc
(
ho°
, 
p‹t
, 
ac˚±
, 
Êags
)) < 0) {

119 
•
 = 
sockëLi°
[
sid
];

120 
	`a_as£π
(
•
);

125 
	`mem£t
((*Ë&
sockaddr
, '\0', (
sockaddr_ö
));

126 
sockaddr
.
sö_Ámûy
 = 
AF_INET
;

127 
sockaddr
.
sö_p‹t
 = 
	`ht⁄s
((Ë(
p‹t
 & 0xFFFF));

129 i‡(
ho°
 =
NULL
) {

130 
sockaddr
.
sö_addr
.
s_addr
 = 
INADDR_ANY
;

132 
sockaddr
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
ho°
);

133 i‡(
sockaddr
.
sö_addr
.
s_addr
 =
INADDR_NONE
) {

141 #ifde‡
NO_GETHOSTBYNAME


142 i‡(
	`°rcmp
(
ho°
, 
	`basicGëHo°
()) == 0) {

143 
sockaddr
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
	`basicGëAddªss
());

145 i‡(
sockaddr
.
sö_addr
.
s_addr
 =
INADDR_NONE
) {

146 
	`sockëFªe
(
sid
);

149 #ñi‡(
	`deföed
 (
VXWORKS
))

150 
sockaddr
.
sö_addr
.
s_addr
 = (Ë
	`ho°GëByName
(
ho°
);

151 i‡(
sockaddr
.
sö_addr
.
s_addr
 =
NULL
) {

152 
î∫o
 = 
ENXIO
;

153 
	`sockëFªe
(
sid
);

157 
ho°ít
 = 
	`gëho°by«me
(
ho°
);

158 i‡(
ho°ít
 !
NULL
) {

159 
	`mem˝y
((*Ë&
sockaddr
.
sö_addr
,

160 (*Ë
ho°ít
->
h_addr_li°
[0],

161 (
size_t
Ë
ho°ít
->
h_Àngth
);

163 *
asciiAddªss
;

164 
ch¨_t
 *
addªss
;

166 
addªss
 = 
	`basicGëAddªss
();

167 
asciiAddªss
 = 
	`bÆlocUniToAsc
(
addªss
, 
	`g°æí
(address));

168 
sockaddr
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
asciiAddªss
);

169 
	`b‰ì
(
B_L
, 
asciiAddªss
);

170 i‡(
sockaddr
.
sö_addr
.
s_addr
 =
INADDR_NONE
) {

171 
î∫o
 = 
ENXIO
;

172 
	`sockëFªe
(
sid
);

180 
bˇ°
 = 
•
->
Êags
 & 
SOCKET_BROADCAST
;

181 i‡(
bˇ°
) {

182 
•
->
Êags
 |
SOCKET_DATAGRAM
;

184 
dgøm
 = 
•
->
Êags
 & 
SOCKET_DATAGRAM
;

190 
•
->
sock
 = 
	`sockë
(
AF_INET
, 
dgøm
 ? 
SOCK_DGRAM
: 
SOCK_STREAM
, 0);

191 i‡(
•
->
sock
 < 0) {

192 
	`sockëFªe
(
sid
);

195 #i‚de‡
__NO_FCNTL


196 
	`f˙é
(
•
->
sock
, 
F_SETFD
, 
FD_CLOEXEC
);

198 
sockëHighe°Fd
 = 
	`max
(sockëHighe°Fd, 
•
->
sock
);

203 i‡(
bˇ°
) {

204 
brﬂdˇ°Fœg
 = 1;

205 i‡(
	`£tsock›t
(
•
->
sock
, 
SOL_SOCKET
, 
SO_BROADCAST
,

206 (*Ë&
brﬂdˇ°Fœg
, (broadcastFlag)) < 0) {

207 
	`sockëFªe
(
sid
);

215 i‡(
ho°
) {

220 i‡(!
dgøm
) {

221 i‡(! (
•
->
Êags
 & 
SOCKET_BLOCK
)) {

227 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
)Ë&& (!deföed (
LITTLEFOOT
Ë&& !deföed (
WEBS
))

228 
Êag
;

230 
•
->
Êags
 |
SOCKET_ASYNC
;

234 
Êag
 = 1;

235 i‡(
	`io˘lsockë
(
•
->
sock
, 
FIONBIO
, &
Êag
Ë=
SOCKET_ERROR
) {

236 
	`sockëFªe
(
sid
);

240 
	`sockëSëBlock
(
sid
, 1);

244 i‡((
rc
 = 
	`c⁄√˘
(
•
->
sock
, (
sockaddr
 *) &sockaddr,

245 (
sockaddr
))) < 0 &&

246 (
rc
 = 
	`åyA…î«ãC⁄√˘
(
•
->
sock
,

247 (
sockaddr
 *) &sockaddr)) < 0) {

248 #i‡(
	`deföed
 (
WIN
Ë|| deföed (
CE
))

249 i‡(
	`sockëGëEº‹
(Ë!
EWOULDBLOCK
) {

250 
	`sockëFªe
(
sid
);

254 
	`sockëFªe
(
sid
);

265 
rc
 = 1;

266 
	`£tsock›t
(
•
->
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
rc
, (rc));

267 i‡(
	`böd
(
•
->
sock
, (
sockaddr
 *) &sockaddr,

268 (
sockaddr
)) < 0) {

269 
	`sockëFªe
(
sid
);

273 i‡(! 
dgøm
) {

274 i‡(
	`li°í
(
•
->
sock
, 
SOMAXCONN
) < 0) {

275 
	`sockëFªe
(
sid
);

278 
•
->
Êags
 |
SOCKET_LISTENING
;

280 
•
->
h™dÀrMask
 |
SOCKET_READABLE
;

287 i‡(
Êags
 & 
SOCKET_BLOCK
) {

288 
	`sockëSëBlock
(
sid
, 1);

290 
	`sockëSëBlock
(
sid
, 0);

292  
sid
;

293 
	}
}

304 
	$åyA…î«ãC⁄√˘
(
sock
, 
sockaddr
 *sockaddr)

306 #ifde‡
VXWORKS


307 *
±r
;

309 
±r
 = (*)
sockaddr
;

310 *
±r
 = *(ptr+1);

311 *(
±r
+1) = 0;

312  
	`c⁄√˘
(
sock
, 
sockaddr
, (sockaddr));

316 
	}
}

323 
	$sockëClo£C⁄√˘i⁄
(
sid
)

325 
sockë_t
 *
•
;

327 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

330 
	`sockëFªe
(
sid
);

331 
	}
}

338 
	$sockëAc˚±
(
sockë_t
 *
•
)

340 
sockaddr_ö
 
addr
;

341 
sockë_t
 *
n•
;

342 
size_t
 
Àn
;

343 *
pSåög
;

344 
√wSock
, 
nid
;

347 #ifde‡
NW


348 
NETINET_DEFINE_CONTEXT
;

351 
	`a_as£π
(
•
);

356 
Àn
 = (
sockaddr_ö
);

357 i‡((
√wSock
 =

358 
	`ac˚±
(
•
->
sock
, (
sockaddr
 *Ë&
addr
, (
sockÀn_t
 *Ë&
Àn
)) < 0) {

361 #i‚de‡
__NO_FCNTL


362 
	`f˙é
(
√wSock
, 
F_SETFD
, 
FD_CLOEXEC
);

364 
sockëHighe°Fd
 = 
	`max
(sockëHighe°Fd, 
√wSock
);

369 
nid
 = 
	`sockëAŒoc
(
•
->
ho°
, sp->
p‹t
, sp->
ac˚±
, sp->
Êags
);

370 
n•
 = 
sockëLi°
[
nid
];

371 
	`a_as£π
(
n•
);

372 
n•
->
sock
 = 
√wSock
;

373 
n•
->
Êags
 &~
SOCKET_LISTENING
;

375 i‡(
n•
 =
NULL
) {

382 
	`sockëSëBlock
(
nid
, (
n•
->
Êags
 & 
SOCKET_BLOCK
) ? 1: 0);

387 i‡(
•
->
ac˚±
 !
NULL
) {

388 
pSåög
 = 
	`öë_¡ﬂ
(
addr
.
sö_addr
);

389 i‡((
•
->
ac˚±
)(
nid
, 
pSåög
, 
	`¡ohs
(
addr
.
sö_p‹t
), sp->
sid
) < 0) {

390 
	`sockëFªe
(
nid
);

392 #ifde‡
VXWORKS


393 
	`‰ì
(
pSåög
);

396 
	}
}

404 
	$sockëGëI≈ut
(
sid
, *
buf
, 
toRód
, *
îrCode
)

406 
sockaddr_ö
 
£rvî
;

407 
sockë_t
 *
•
;

408 
Àn
, 
byãsRód
;

410 
	`a_as£π
(
buf
);

411 
	`a_as£π
(
îrCode
);

413 *
îrCode
 = 0;

415 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

422 i‡(
•
->
Êags
 & 
SOCKET_EOF
) {

425 #i‡((
	`deföed
 (
WIN
Ë|| deföed (
CE
)Ë&& (!deföed (
LITTLEFOOT
Ë&& !deföed (
WEBS
)))

426 i‡–!(
•
->
Êags
 & 
SOCKET_BLOCK
)

427 && ! 
	`sockëWaôF‹Evít
(
•
, 
FD_CONNECT
, 
îrCode
)) {

435 i‡(
•
->
Êags
 & 
SOCKET_DATAGRAM
) {

436 
Àn
 = (
£rvî
);

437 
byãsRód
 = 
	`ªcv‰om
(
•
->
sock
, 
buf
, 
toRód
, 0,

438 (
sockaddr
 *Ë&
£rvî
, (
sockÀn_t
 *Ë&
Àn
);

440 
byãsRód
 = 
	`ªcv
(
•
->
sock
, 
buf
, 
toRód
, 0);

452 i‡(
byãsRód
 < 0)

454 *
îrCode
 = 
	`sockëGëEº‹
();

455 i‡(*
îrCode
 =
ECONNRESET
)

457 
•
->
Êags
 |
SOCKET_CONNRESET
;

462  
byãsRód
;

463 
	}
}

476 
	$sockëRegi°îI¡îe°
(
sockë_t
 *
•
, 
h™dÀrMask
)

478 
	`a_as£π
(
•
);

480 
•
->
h™dÀrMask
 = handlerMask;

481 
	}
}

489 
	$sockëWaôF‹Evít
(
sockë_t
 *
•
, 
h™dÀrMask
, *
îrCode
)

491 
mask
;

493 
	`a_as£π
(
•
);

495 
mask
 = 
•
->
h™dÀrMask
;

496 
•
->
h™dÀrMask
 |= handlerMask;

497 
	`sockëSñe˘
(
•
->
sid
, 1000)) {

498 i‡(
•
->
cuºítEvíts
 & (
h™dÀrMask
 | 
SOCKET_EXCEPTION
)) {

502 
•
->
h™dÀrMask
 = 
mask
;

503 i‡(
•
->
cuºítEvíts
 & 
SOCKET_EXCEPTION
) {

505 } i‡(
•
->
cuºítEvíts
 & 
h™dÀrMask
) {

508 i‡(
îrCode
) {

509 *
îrCode
 = 
î∫o
 = 
EWOULDBLOCK
;

512 
	}
}

519 
	$sockëRódy
(
sid
)

521 
sockë_t
 *
•
;

522 
Æl
;

524 
Æl
 = 0;

525 i‡(
sid
 < 0) {

526 
sid
 = 0;

527 
Æl
 = 1;

530 ; 
sid
 < 
sockëMax
; sid++) {

531 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

532 i‡(! 
Æl
) {

538 i‡(
•
->
Êags
 & 
SOCKET_CONNRESET
) {

539 
	`sockëClo£C⁄√˘i⁄
(
sid
);

542 i‡(
•
->
cuºítEvíts
 & sp->
h™dÀrMask
) {

548 i‡(
•
->
h™dÀrMask
 & 
SOCKET_READABLE
 && 
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

549 
	`sockëSñe˘
(
sid
, 0);

552 i‡(! 
Æl
) {

557 
	}
}

565 #i‡(
deföed
 (
WIN
Ë|| deföed (
CE
Ë|| deföed (
NW
))

567 
	$sockëSñe˘
(
sid
, 
timeout
)

569 
timevÆ
 
tv
;

570 
sockë_t
 *
•
;

571 
fd_£t
 
ªadFds
, 
wrôeFds
, 
ex˚±Fds
;

572 
nEvíts
;

573 
Æl
, 
sockëHighe°Fd
;

575 
	`FD_ZERO
(&
ªadFds
);

576 
	`FD_ZERO
(&
wrôeFds
);

577 
	`FD_ZERO
(&
ex˚±Fds
);

578 
sockëHighe°Fd
 = -1;

580 
tv
.
tv_£c
 = 
timeout
 / 1000;

581 
tv
.
tv_u£c
 = (
timeout
 % 1000) * 1000;

586 
Æl
 = 
nEvíts
 = 0;

588 i‡(
sid
 < 0) {

589 
Æl
++;

590 
sid
 = 0;

593 ; 
sid
 < 
sockëMax
; sid++) {

594 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

597 
	`a_as£π
(
•
);

601 i‡(
•
->
h™dÀrMask
 & 
SOCKET_READABLE
) {

602 
	`FD_SET
(
•
->
sock
, &
ªadFds
);

603 
nEvíts
++;

604 i‡(
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

605 
tv
.
tv_£c
 = 0;

606 
tv
.
tv_u£c
 = 0;

609 i‡(
•
->
h™dÀrMask
 & 
SOCKET_WRITABLE
) {

610 
	`FD_SET
(
•
->
sock
, &
wrôeFds
);

611 
nEvíts
++;

613 i‡(
•
->
h™dÀrMask
 & 
SOCKET_EXCEPTION
) {

614 
	`FD_SET
(
•
->
sock
, &
ex˚±Fds
);

615 
nEvíts
++;

617 i‡(! 
Æl
) {

626 i‡(
nEvíts
 == 0) {

627 
	`SÀï
(
timeout
);

634 
nEvíts
 = 
	`£À˘
(
sockëHighe°Fd
+1, &
ªadFds
, &
wrôeFds
, &
ex˚±Fds
, &
tv
);

636 i‡(
Æl
) {

637 
sid
 = 0;

639 ; 
sid
 < 
sockëMax
; sid++) {

640 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

644 i‡(
	`FD_ISSET
(
•
->
sock
, &
ªadFds
Ë|| 
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

645 
•
->
cuºítEvíts
 |
SOCKET_READABLE
;

647 i‡(
	`FD_ISSET
(
•
->
sock
, &
wrôeFds
)) {

648 
•
->
cuºítEvíts
 |
SOCKET_WRITABLE
;

650 i‡(
	`FD_ISSET
(
•
->
sock
, &
ex˚±Fds
)) {

651 
•
->
cuºítEvíts
 |
SOCKET_EXCEPTION
;

653 i‡(! 
Æl
) {

658  
nEvíts
;

659 
	}
}

663 
	$sockëSñe˘
(
sid
, 
timeout
)

665 
sockë_t
 *
•
;

666 
timevÆ
 
tv
;

667 
fd_mask
 *
ªadFds
, *
wrôeFds
, *
ex˚±Fds
;

668 
Æl
, 
Àn
, 
nw‹ds
, 
ödex
, 
bô
, 
nEvíts
;

673 
nw‹ds
 = (
sockëHighe°Fd
 + 
NFDBITS
) / NFDBITS;

674 
Àn
 = 
nw‹ds
 * (
fd_mask
);

676 
ªadFds
 = 
	`bÆloc
(
B_L
, 
Àn
);

677 
	`mem£t
(
ªadFds
, 0, 
Àn
);

678 
wrôeFds
 = 
	`bÆloc
(
B_L
, 
Àn
);

679 
	`mem£t
(
wrôeFds
, 0, 
Àn
);

680 
ex˚±Fds
 = 
	`bÆloc
(
B_L
, 
Àn
);

681 
	`mem£t
(
ex˚±Fds
, 0, 
Àn
);

683 
tv
.
tv_£c
 = 
timeout
 / 1000;

684 
tv
.
tv_u£c
 = (
timeout
 % 1000) * 1000;

689 
Æl
 = 
nEvíts
 = 0;

691 i‡(
sid
 < 0) {

692 
Æl
++;

693 
sid
 = 0;

696 ; 
sid
 < 
sockëMax
; sid++) {

697 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

698 i‡(
Æl
 == 0) {

704 
	`a_as£π
(
•
);

709 
ödex
 = 
•
->
sock
 / (
NBBY
 * (
fd_mask
));

710 
bô
 = 1 << (
•
->
sock
 % (
NBBY
 * (
fd_mask
)));

715 i‡(
•
->
h™dÀrMask
 & 
SOCKET_READABLE
) {

716 
ªadFds
[
ödex
] |
bô
;

717 
nEvíts
++;

718 i‡(
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

719 
tv
.
tv_£c
 = 0;

720 
tv
.
tv_u£c
 = 0;

723 i‡(
•
->
h™dÀrMask
 & 
SOCKET_WRITABLE
) {

724 
wrôeFds
[
ödex
] |
bô
;

725 
nEvíts
++;

727 i‡(
•
->
h™dÀrMask
 & 
SOCKET_EXCEPTION
) {

728 
ex˚±Fds
[
ödex
] |
bô
;

729 
nEvíts
++;

731 i‡(! 
Æl
) {

740 
nEvíts
 = 
	`£À˘
(
sockëHighe°Fd
 + 1, (
fd_£t
 *Ë
ªadFds
,

741 (
fd_£t
 *Ë
wrôeFds
, (fd_£à*Ë
ex˚±Fds
, &
tv
);

743 i‡(
nEvíts
 > 0) {

744 i‡(
Æl
) {

745 
sid
 = 0;

747 ; 
sid
 < 
sockëMax
; sid++) {

748 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

749 i‡(
Æl
 == 0) {

756 
ödex
 = 
•
->
sock
 / (
NBBY
 * (
fd_mask
));

757 
bô
 = 1 << (
•
->
sock
 % (
NBBY
 * (
fd_mask
)));

759 i‡(
ªadFds
[
ödex
] & 
bô
 || 
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

760 
•
->
cuºítEvíts
 |
SOCKET_READABLE
;

762 i‡(
wrôeFds
[
ödex
] & 
bô
) {

763 
•
->
cuºítEvíts
 |
SOCKET_WRITABLE
;

765 i‡(
ex˚±Fds
[
ödex
] & 
bô
) {

766 
•
->
cuºítEvíts
 |
SOCKET_EXCEPTION
;

768 i‡(! 
Æl
) {

774 
	`b‰ì
(
B_L
, 
ªadFds
);

775 
	`b‰ì
(
B_L
, 
wrôeFds
);

776 
	`b‰ì
(
B_L
, 
ex˚±Fds
);

778  
nEvíts
;

779 
	}
}

787 
	$sockëPro˚ss
(
sid
)

789 
sockë_t
 *
•
;

790 
Æl
;

792 
Æl
 = 0;

793 i‡(
sid
 < 0) {

794 
Æl
 = 1;

795 
sid
 = 0;

800 ; 
sid
 < 
sockëMax
; sid++) {

801 i‡((
•
 = 
sockëLi°
[
sid
]Ë=
NULL
) {

802 i‡(! 
Æl
) {

808 i‡(
	`sockëRódy
(
sid
)) {

809 
	`sockëDoEvít
(
•
);

811 i‡(! 
Æl
) {

815 
	}
}

822 
	$sockëDoEvít
(
sockë_t
 *
•
)

824 
rögq_t
 *
rq
;

825 
sid
;

827 
	`a_as£π
(
•
);

829 
sid
 = 
•
->sid;

830 i‡(
•
->
cuºítEvíts
 & 
SOCKET_READABLE
) {

831 i‡(
•
->
Êags
 & 
SOCKET_LISTENING
) {

832 
	`sockëAc˚±
(
•
);

833 
•
->
cuºítEvíts
 = 0;

842 i‡(
•
->
h™dÀrMask
 & 
SOCKET_READABLE
 && 
	`sockëI≈utBuf„ªd
(
sid
) > 0) {

843 
•
->
cuºítEvíts
 |
SOCKET_READABLE
;

851 i‡(
•
->
cuºítEvíts
 & 
SOCKET_WRITABLE
) {

852 i‡(
•
->
Êags
 & 
SOCKET_FLUSHING
) {

853 
rq
 = &
•
->
outBuf
;

854 i‡(
	`rögqLí
(
rq
) > 0) {

855 
	`sockëFlush
(
•
->
sid
);

857 
•
->
Êags
 &~
SOCKET_FLUSHING
;

866 i‡(
•
->
h™dÀr
 && (•->
h™dÀrMask
 & sp->
cuºítEvíts
)) {

867 (
•
->
h™dÀr
)(
sid
, sp->
h™dÀrMask
 & sp->
cuºítEvíts
,

868 
•
->
h™dÀr_d©a
);

872 i‡(
sockëLi°
 && 
sid
 < 
sockëMax
 && sockëLi°[sid] =
•
) {

873 
•
->
cuºítEvíts
 = 0;

877 
	}
}

884 
	$sockëSëBlock
(
sid
, 
⁄
)

886 
sockë_t
 *
•
;

887 
Êag
;

888 
iÊag
;

889 
ﬁdBlock
;

891 
Êag
 = 
iÊag
 = !
⁄
;

893 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

894 
	`a_as£π
(0);

897 
ﬁdBlock
 = (
•
->
Êags
 & 
SOCKET_BLOCK
);

898 
•
->
Êags
 &~(
SOCKET_BLOCK
);

899 i‡(
⁄
) {

900 
•
->
Êags
 |
SOCKET_BLOCK
;

906 i‡(
•
->
Êags
 & 
SOCKET_BLOCK
) {

907 #i‡(
	`deföed
 (
CE
Ë|| deföed (
WIN
))

908 
	`io˘lsockë
(
•
->
sock
, 
FIONBIO
, &
Êag
);

909 #ñi‡(
	`deföed
 (
ECOS
))

910 
off
;

911 
off
 = 0;

912 
	`io˘l
(
•
->
sock
, 
FIONBIO
, &
off
);

913 #ñi‡(
	`deföed
 (
VXWORKS
Ë|| deföed (
NW
))

914 
	`io˘l
(
•
->
sock
, 
FIONBIO
, ()&
iÊag
);

916 
	`f˙é
(
•
->
sock
, 
F_SETFL
, f˙é(•->sock, 
F_GETFL
Ë& ~
O_NONBLOCK
);

920 #i‡(
	`deföed
 (
CE
Ë|| deföed (
WIN
))

921 
	`io˘lsockë
(
•
->
sock
, 
FIONBIO
, &
Êag
);

922 #ñi‡(
	`deföed
 (
ECOS
))

923 
⁄
;

924 
⁄
 = 1;

925 
	`io˘l
(
•
->
sock
, 
FIONBIO
, &
⁄
);

926 #ñi‡(
	`deföed
 (
VXWORKS
Ë|| deföed (
NW
))

927 
	`io˘l
(
•
->
sock
, 
FIONBIO
, ()&
iÊag
);

929 
	`f˙é
(
•
->
sock
, 
F_SETFL
, f˙é(•->sock, 
F_GETFL
Ë| 
O_NONBLOCK
);

933 #ifde‡
MACOSX


934 
iÊag
 = 1;

935 
	`£tsock›t
(
•
->
sock
, 
SOL_SOCKET
, 
SO_NOSIGPIPE
, (*)&
iÊag
, (iflag));

937  
ﬁdBlock
;

938 
	}
}

945 
	$sockëD⁄tBlock
()

947 
sockë_t
 *
•
;

948 
i
;

950 
i
 = 0; i < 
sockëMax
; i++) {

951 i‡((
•
 = 
sockëLi°
[
i
]Ë=
NULL
 ||

952 (
•
->
h™dÀrMask
 & 
SOCKET_READABLE
) == 0) {

955 i‡(
	`sockëI≈utBuf„ªd
(
i
) > 0) {

960 
	}
}

967 
	$sockëSockBuf„ªd
(
sock
)

969 
sockë_t
 *
•
;

970 
i
;

972 
i
 = 0; i < 
sockëMax
; i++) {

973 i‡((
•
 = 
sockëLi°
[
i
]Ë=
NULL
 || sp->
sock
 != sock) {

976  
	`sockëI≈utBuf„ªd
(
i
);

979 
	}
}

	@sym.c

20 
	~"uemf.h
"

25 
	möu£
;

26 
	mhash_size
;

27 
sym_t
 **
	mhash_èbÀ
;

28 } 
	tsym_èbít_t
;

32 
sym_èbít_t
 **
	gsym
;

33 
	gsymMax
;

34 
	gsymO≥nCou¡
 = 0;

36 
	ghtIndex
;

37 
sym_t
* 
	g√xt
;

41 
hashIndex
(
sym_èbít_t
 *
ç
, 
ch¨_t
 *
«me
);

42 
sym_t
 *
hash
(
sym_èbít_t
 *
ç
, 
ch¨_t
 *
«me
);

43 
ˇlcPrime
(
size
);

50 
	$symSubO≥n
()

52 i‡(++
symO≥nCou¡
 == 1) {

53 
symMax
 = 0;

54 
sym
 = 
NULL
;

57 
	}
}

64 
	$symSubClo£
()

66 i‡(--
symO≥nCou¡
 <= 0) {

67 
symO≥nCou¡
 = 0;

69 
	}
}

76 
sym_fd_t
 
	$symO≥n
(
hash_size
)

78 
sym_fd_t
 
sd
;

79 
sym_èbít_t
 *
ç
;

81 
	`a_as£π
(
hash_size
 > 2);

86 i‡((
sd
 = 
	`hAŒoc
((***Ë&
sym
)) < 0) {

93 i‡((
ç
 = (
sym_èbít_t
*Ë
	`bÆloc
(
B_L
, (sym_èbít_t))Ë=
NULL
) {

94 
symMax
 = 
	`hFªe
((***Ë&
sym
, 
sd
);

97 
	`mem£t
(
ç
, 0, (
sym_èbít_t
));

98 i‡(
sd
 >
symMax
) {

99 
symMax
 = 
sd
 + 1;

101 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

102 
sym
[
sd
] = 
ç
;

107 
ç
->
hash_size
 = 
	`ˇlcPrime
(hash_size);

108 
ç
->
hash_èbÀ
 = (
sym_t
**Ë
	`bÆloc
(
B_L
,Åp->
hash_size
 * (sym_t*));

109 
	`a_as£π
(
ç
->
hash_èbÀ
);

110 
	`mem£t
(
ç
->
hash_èbÀ
, 0,Åp->
hash_size
 * (
sym_t
*));

112  
sd
;

113 
	}
}

121 
	$symClo£
(
sym_fd_t
 
sd
)

123 
sym_èbít_t
 *
ç
;

124 
sym_t
 *
•
, *
f‹w
;

125 
i
;

127 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

128 
ç
 = 
sym
[
sd
];

129 
	`a_as£π
(
ç
);

134 
i
 = 0; i < 
ç
->
hash_size
; i++) {

135 
•
 = 
ç
->
hash_èbÀ
[
i
]; sp; s∞
f‹w
) {

136 
f‹w
 = 
•
->forw;

137 
	`vÆueFªe
(&
•
->
«me
);

138 
	`vÆueFªe
(&
•
->
c⁄ã¡
);

139 
	`b‰ì
(
B_L
, (*Ë
•
);

140 
•
 = 
f‹w
;

143 
	`b‰ì
(
B_L
, (*Ë
ç
->
hash_èbÀ
);

145 
symMax
 = 
	`hFªe
((***Ë&
sym
, 
sd
);

146 
	`b‰ì
(
B_L
, (*Ë
ç
);

147 
	}
}

156 
sym_t
* 
	$symFú°
(
sym_fd_t
 
sd
)

158 
sym_èbít_t
 *
ç
;

159 
sym_t
 *
•
, *
f‹w
;

160 
i
;

162 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

163 
ç
 = 
sym
[
sd
];

164 
	`a_as£π
(
ç
);

169 
i
 = 0; i < 
ç
->
hash_size
; i++) {

170 
•
 = 
ç
->
hash_èbÀ
[
i
]; sp; s∞
f‹w
) {

171 
f‹w
 = 
•
->forw;

173 i‡(
f‹w
 =
NULL
) {

174 
htIndex
 = 
i
 + 1;

175 
√xt
 = 
ç
->
hash_èbÀ
[
htIndex
];

177 
htIndex
 = 
i
;

178 
√xt
 = 
f‹w
;

180  
•
;

183  
NULL
;

184 
	}
}

191 
sym_t
* 
	$symNext
(
sym_fd_t
 
sd
)

193 
sym_èbít_t
 *
ç
;

194 
sym_t
 *
•
, *
f‹w
;

195 
i
;

197 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

198 
ç
 = 
sym
[
sd
];

199 
	`a_as£π
(
ç
);

204 
i
 = 
htIndex
; i < 
ç
->
hash_size
; i++) {

205 
•
 = 
√xt
; sp; s∞
f‹w
) {

206 
f‹w
 = 
•
->forw;

208 i‡(
f‹w
 =
NULL
) {

209 
htIndex
 = 
i
 + 1;

210 
√xt
 = 
ç
->
hash_èbÀ
[
htIndex
];

212 
htIndex
 = 
i
;

213 
√xt
 = 
f‹w
;

215  
•
;

217 
√xt
 = 
ç
->
hash_èbÀ
[
i
 + 1];

219  
NULL
;

220 
	}
}

228 
sym_t
 *
	$symLookup
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
)

230 
sym_èbít_t
 *
ç
;

231 
sym_t
 *
•
;

232 
ch¨_t
 *
˝
;

234 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

235 i‡((
ç
 = 
sym
[
sd
]Ë=
NULL
) {

236  
NULL
;

239 i‡(
«me
 =
NULL
 || *name == '\0') {

240  
NULL
;

246 
•
 = 
	`hash
(
ç
, 
«me
); sp; s∞•->
f‹w
) {

247 
˝
 = 
•
->
«me
.
vÆue
.
°rög
;

248 i‡(
˝
[0] =
«me
[0] && 
	`g°rcmp
(cp,Çame) == 0) {

252  
•
;

253 
	}
}

263 
sym_t
 *
	$symE¡î
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
, 
vÆue_t
 
v
, 
¨g
)

265 
sym_èbít_t
 *
ç
;

266 
sym_t
 *
•
, *
œ°
;

267 
ch¨_t
 *
˝
;

268 
hödex
;

270 
	`a_as£π
(
«me
);

271 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

272 
ç
 = 
sym
[
sd
];

273 
	`a_as£π
(
ç
);

279 
œ°
 = 
NULL
;

280 
hödex
 = 
	`hashIndex
(
ç
, 
«me
);

281 i‡((
•
 = 
ç
->
hash_èbÀ
[
hödex
]Ë!
NULL
) {

282 ; 
•
; s∞•->
f‹w
) {

283 
˝
 = 
•
->
«me
.
vÆue
.
°rög
;

284 i‡(
˝
[0] =
«me
[0] && 
	`g°rcmp
(cp,Çame) == 0) {

287 
œ°
 = 
•
;

289 i‡(
•
) {

299 i‡(
•
->
c⁄ã¡
.
vÆid
) {

300 
	`vÆueFªe
(&
•
->
c⁄ã¡
);

302 
•
->
c⁄ã¡
 = 
v
;

303 
•
->
¨g
 =árg;

304  
•
;

309 
•
 = (
sym_t
*Ë
	`bÆloc
(
B_L
, (sym_t));

310 i‡(
•
 =
NULL
) {

311  
NULL
;

313 
•
->
«me
 = 
	`vÆueSåög
“ame, 
VALUE_ALLOCATE
);

314 
•
->
c⁄ã¡
 = 
v
;

315 
•
->
f‹w
 = (
sym_t
*Ë
NULL
;

316 
•
->
¨g
 =árg;

317 
œ°
->
f‹w
 = 
•
;

323 
•
 = (
sym_t
*Ë
	`bÆloc
(
B_L
, (sym_t));

324 i‡(
•
 =
NULL
) {

325  
NULL
;

327 
ç
->
hash_èbÀ
[
hödex
] = 
•
;

328 
ç
->
hash_èbÀ
[
	`hashIndex
—p, 
«me
)] = 
•
;

330 
•
->
f‹w
 = (
sym_t
*Ë
NULL
;

331 
•
->
c⁄ã¡
 = 
v
;

332 
•
->
¨g
 =árg;

333 
•
->
«me
 = 
	`vÆueSåög
“ame, 
VALUE_ALLOCATE
);

335  
•
;

336 
	}
}

343 
	$symDñëe
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
)

345 
sym_èbít_t
 *
ç
;

346 
sym_t
 *
•
, *
œ°
;

347 
ch¨_t
 *
˝
;

348 
hödex
;

350 
	`a_as£π
(
«me
 && *name);

351 
	`a_as£π
(0 <
sd
 && sd < 
symMax
);

352 
ç
 = 
sym
[
sd
];

353 
	`a_as£π
(
ç
);

359 
œ°
 = 
NULL
;

360 
hödex
 = 
	`hashIndex
(
ç
, 
«me
);

361 i‡((
•
 = 
ç
->
hash_èbÀ
[
hödex
]Ë!
NULL
) {

362  ; 
•
; s∞•->
f‹w
) {

363 
˝
 = 
•
->
«me
.
vÆue
.
°rög
;

364 i‡(
˝
[0] =
«me
[0] && 
	`g°rcmp
(cp,Çame) == 0) {

367 
œ°
 = 
•
;

370 i‡(
•
 =(
sym_t
*Ë
NULL
) {

378 i‡(
œ°
) {

379 
œ°
->
f‹w
 = 
•
->forw;

381 
ç
->
hash_èbÀ
[
hödex
] = 
•
->
f‹w
;

383 
	`vÆueFªe
(&
•
->
«me
);

384 
	`vÆueFªe
(&
•
->
c⁄ã¡
);

385 
	`b‰ì
(
B_L
, (*Ë
•
);

388 
	}
}

396 
sym_t
 *
	$hash
(
sym_èbít_t
 *
ç
, 
ch¨_t
 *
«me
)

398 
	`a_as£π
(
ç
);

400  
ç
->
hash_èbÀ
[
	`hashIndex
—p, 
«me
)];

401 
	}
}

410 
	$hashIndex
(
sym_èbít_t
 *
ç
, 
ch¨_t
 *
«me
)

412 
sum
;

413 
i
;

415 
	`a_as£π
(
ç
);

421 
i
 = 0;

422 
sum
 = 0;

423 *
«me
) {

424 
sum
 +(((Ë*
«me
++Ë<< 
i
);

425 
i
 = (ò+ 7Ë% (
	`BITS
(Ë- 
BITSPERBYTE
);

427  
sum
 % 
ç
->
hash_size
;

428 
	}
}

435 
	$isPrime
(
n
)

437 
i
, 
max
;

439 
	`a_as£π
(
n
 > 0);

441 
max
 = 
n
 / 2;

442 
i
 = 2; i <
max
; i++) {

443 i‡(
n
 % 
i
 == 0) {

448 
	}
}

455 
	$ˇlcPrime
(
size
)

457 
cou¡
;

459 
	`a_as£π
(
size
 > 0);

461 
cou¡
 = 
size
; count > 0; count--) {

462 i‡(
	`isPrime
(
cou¡
)) {

463  
cou¡
;

467 
	}
}

	@uemf.c

18 
	~"uemf.h
"

22 
	gemfIn°
;

26 
deÁu…Eº‹H™dÀr
(
ëy≥
, 
ch¨_t
 *
buf
);

27 (*
îr‹H™dÀr
)(
ëy≥
, 
ch¨_t
 *
msg
Ë
deÁu…Eº‹H™dÀr
;

29 
	`deÁu…Tø˚H™dÀr
(
Àvñ
, 
ch¨_t
 *
buf
);

30 (*
åa˚H™dÀr
)(
Àvñ
, 
ch¨_t
 *
buf
Ë
deÁu…Tø˚H™dÀr
;

38 
	$îr‹
(
E_ARGS_DEC
, 
ëy≥
, 
ch¨_t
 *
fmt
, ...)

40 
va_li°
 
¨gs
;

41 
ch¨_t
 *
fmtBuf
, *
buf
;

43 
	`va_°¨t
(
¨gs
, 
fmt
);

44 
	`fmtVÆloc
(&
fmtBuf
, 
E_MAX_ERROR
, 
fmt
, 
¨gs
);

46 i‡(
ëy≥
 =
E_LOG
) {

47 
	`fmtAŒoc
(&
buf
, 
E_MAX_ERROR
, 
	`T
("%s\n"), 
fmtBuf
);

49 } i‡(
ëy≥
 =
E_ASSERT
) {

50 
	`fmtAŒoc
(&
buf
, 
E_MAX_ERROR
,

51 
	`T
("As£πi⁄ %s, faûedáà%†%d\n"), 
fmtBuf
, 
E_ARGS
);

53 } i‡(
ëy≥
 =
E_USER
) {

54 
	`fmtAŒoc
(&
buf
, 
E_MAX_ERROR
, 
	`T
("%s\n"), 
fmtBuf
);

64 
	`fmtAŒoc
(&
buf
, 
E_MAX_ERROR
, 
	`T
("UnknownÉrror"));

66 
	`va_íd
(
¨gs
);

68 
	`b‰ì
(
B_L
, 
fmtBuf
);

70 i‡(
îr‹H™dÀr
) {

71 
	`îr‹H™dÀr
(
ëy≥
, 
buf
);

74 
	`b‰ìSa„
(
B_L
, 
buf
);

75 
	}
}

82 (*
îr‹SëH™dÀr
((*
fun˘i⁄
)(
ëy≥
, 
ch¨_t
 *
msg
))) \

83 (
ëy≥
, 
ch¨_t
 *
msg
)

85 (*
ﬁdH™dÀr
)(
ëy≥
, 
ch¨_t
 *
buf
);

87 
ﬁdH™dÀr
 = 
îr‹H™dÀr
;

88 
îr‹H™dÀr
 = 
fun˘i⁄
;

89  
ﬁdH™dÀr
;

90 
	}
}

97 
	$åa˚
(
Àvñ
, 
ch¨_t
 *
fmt
, ...)

99 
va_li°
 
¨gs
;

100 
ch¨_t
 *
buf
;

102 
	`va_°¨t
(
¨gs
, 
fmt
);

103 
	`fmtVÆloc
(&
buf
, 
VALUE_MAX_STRING
, 
fmt
, 
¨gs
);

105 i‡(
åa˚H™dÀr
) {

106 
	`åa˚H™dÀr
(
Àvñ
, 
buf
);

108 
	`b‰ìSa„
(
B_L
, 
buf
);

109 
	`va_íd
(
¨gs
);

110 
	}
}

117 
	$åa˚Raw
(
ch¨_t
 *
buf
)

119 i‡(
åa˚H™dÀr
) {

120 
	`åa˚H™dÀr
(0, 
buf
);

122 
	}
}

129 (*
åa˚SëH™dÀr
((*
fun˘i⁄
)(
Àvñ
, 
ch¨_t
 *
buf
)))

130 (
Àvñ
, *
buf
)

132 (*
ﬁdH™dÀr
)(
Àvñ
, 
ch¨_t
 *
buf
);

134 
ﬁdH™dÀr
 = 
åa˚H™dÀr
;

135 i‡(
fun˘i⁄
) {

136 
åa˚H™dÀr
 = 
fun˘i⁄
;

138  
ﬁdH™dÀr
;

139 
	}
}

146 
	$emfIn°Së
(
ö°
)

148 
emfIn°
 = 
ö°
;

149 
	}
}

156 
	$emfIn°Gë
()

158  
emfIn°
;

159 
	}
}

166 
ch¨_t
 *
	$°æowî
(
ch¨_t
 *
°rög
)

168 
ch¨_t
 *
s
;

170 
	`a_as£π
(
°rög
);

172 i‡(
°rög
 =
NULL
) {

173  
NULL
;

176 
s
 = 
°rög
;

177 *
s
) {

178 i‡(
	`gisuµî
(*
s
)) {

179 *
s
 = (
ch¨_t
Ë
	`gtﬁowî
(*s);

181 
s
++;

183 *
s
 = '\0';

184  
°rög
;

185 
	}
}

192 
ch¨_t
 *
	$°ruµî
(
ch¨_t
 *
°rög
)

194 
ch¨_t
 *
s
;

196 
	`a_as£π
(
°rög
);

197 i‡(
°rög
 =
NULL
) {

198  
NULL
;

201 
s
 = 
°rög
;

202 *
s
) {

203 i‡(
	`gi¶owî
(*
s
)) {

204 *
s
 = (
ch¨_t
Ë
	`gtouµî
(*s);

206 
s
++;

208 *
s
 = '\0';

209  
°rög
;

210 
	}
}

218 
ch¨_t
 *
	$°rôﬂ
(
n
, 
ch¨_t
 *
°rög
, 
width
)

220 
ch¨_t
 *
˝
, *
lim
, *
s
;

221 
ch¨_t
 
buf
[16];

222 
√xt
, 
möus
;

224 
	`a_as£π
(
°rög
 && 
width
 > 0);

226 i‡(
°rög
 =
NULL
) {

227 i‡(
width
 == 0) {

228 
width
 = 10;

230 i‡((
°rög
 = 
	`bÆloc
(
B_L
, 
width
 + 1)Ë=
NULL
) {

231  
NULL
;

234 i‡(
n
 < 0) {

235 
möus
 = 1;

236 
n
 = -n;

237 
width
--;

239 
möus
 = 0;

242 
˝
 = 
buf
;

243 
lim
 = &
buf
[
width
 - 1];

244 
n
 > 9 && 
˝
 < 
lim
) {

245 
√xt
 = 
n
;

246 
n
 /= 10;

247 *
˝
++ = (
ch¨_t
Ë(
√xt
 - 
n
 * 10 + '0');

249 i‡(
˝
 < 
lim
) {

250 *
˝
++ = (
ch¨_t
Ë(
n
 + '0');

253 
s
 = 
°rög
;

254 i‡(
möus
) {

255 *
s
++ = '-';

258 
˝
 > 
buf
) {

259 *
s
++ = *--
˝
;

262 *
s
++ = '\0';

263  
°rög
;

264 
	}
}

276 
	$deÁu…Eº‹H™dÀr
(
ëy≥
, 
ch¨_t
 *
msg
)

279 
	`wrôe
(1, 
msg
, 
	`g°æí
(msg));

281 
	}
}

288 
	$deÁu…Tø˚H™dÀr
(
Àvñ
, 
ch¨_t
 *
buf
)

295 i‡(
buf
) {

296 
	`wrôe
(1, 
buf
, 
	`g°æí
(buf));

299 
	}
}

306 
ch¨_t
 *
	$basicGëProdu˘
()

308  
	`T
("uemf");

309 
	}
}

311 
ch¨_t
 *
	$basicGëAddªss
()

313  
	`T
("localhost");

314 
	}
}

316 
	$îr‹O≥n
(
ch¨_t
 *
≤ame
)

319 
	}
}

321 
	$îr‹Clo£
()

323 
	}
}

	@uemf.h

10 #i‚de‡
_h_UEMF


11 
	#_h_UEMF
 1

	)

21 #ifde‡
WIN


22 
	~<dúe˘.h
>

23 
	~<io.h
>

24 
	~<sys/°©.h
>

25 
	~<limôs.h
>

26 
	~<tch¨.h
>

27 
	~<wödows.h
>

28 
	~<wö∆s.h
>

29 
	~<time.h
>

30 
	~<sys/ty≥s.h
>

31 
	~<°dio.h
>

32 
	~<°dlib.h
>

33 
	~<f˙é.h
>

34 
	~<î∫o.h
>

37 #ifde‡
CE


39 
	~<limôs.h
>

40 
	~<tch¨.h
>

41 
	~<wödows.h
>

42 
	~<wösock.h
>

43 
	~<wö∆s.h
>

44 
	~"CE/wöcom∑t.h
"

45 
	~<wösock.h
>

48 #ifde‡
NW


49 
	~<dúe˘.h
>

50 
	~<io.h
>

51 
	~<sys/°©.h
>

52 
	~<time.h
>

53 
	~<sys/ty≥s.h
>

54 
	~<°dio.h
>

55 
	~<°dlib.h
>

56 
	~<f˙é.h
>

57 
	~<î∫o.h
>

58 
	~<nôîr‹.h
>

59 
	#EINTR
 
EINUSE


	)

60 
	#WEBS
 1

	)

61 
	~<limôs.h
>

62 
	~<√tdb.h
>

63 
	~<¥o˚ss.h
>

64 
	~<tiu£r.h
>

65 
	~<sys/time.h
>

66 
	~<¨∑/öë.h
>

67 
	~<sys/ty≥s.h
>

68 
	~<sys/sockë.h
>

69 
	~<sys/fûio.h
>

70 
	~<√töë/ö.h
>

73 #ifde‡
SCOV5


74 
	~<sys/ty≥s.h
>

75 
	~<°dio.h
>

76 
	~"sys/sockë.h
"

77 
	~"sys/£À˘.h
"

78 
	~"√töë/ö.h
"

79 
	~"¨∑/öë.h
"

80 
	~"√tdb.h
"

83 #ifde‡
UNIX


84 
	~<°dio.h
>

87 #ifde‡
LINUX


88 
	~<sys/ty≥s.h
>

89 
	~<sys/°©.h
>

90 
	~<sys/∑øm.h
>

91 
	~<limôs.h
>

92 
	~<°dio.h
>

93 
	~<°dlib.h
>

94 
	~<uni°d.h
>

95 
	~<sys/sockë.h
>

96 
	~<sys/£À˘.h
>

97 
	~<√töë/ö.h
>

98 
	~<¨∑/öë.h
>

99 
	~<√tdb.h
>

100 
	~<time.h
>

101 
	~<f˙é.h
>

102 
	~<î∫o.h
>

105 #ifde‡
LYNX


106 
	~<limôs.h
>

107 
	~<°d¨g.h
>

108 
	~<°dio.h
>

109 
	~<°dlib.h
>

110 
	~<uni°d.h
>

111 
	~<sockë.h
>

112 
	~<√töë/ö.h
>

113 
	~<¨∑/öë.h
>

114 
	~<√tdb.h
>

115 
	~<time.h
>

116 
	~<f˙é.h
>

117 
	~<î∫o.h
>

120 #ifde‡
MACOSX


121 
	~<limôs.h
>

122 
	~<sys/£À˘.h
>

123 
	~<sys/ty≥s.h
>

124 
	~<sys/°©.h
>

125 
	~<°dio.h
>

126 
	~<°dlib.h
>

127 
	~<uni°d.h
>

128 
	~<sys/sockë.h
>

129 
	~<√töë/ö.h
>

130 
	~<¨∑/öë.h
>

131 
	~<√tdb.h
>

132 
	~<f˙é.h
>

133 
	~<î∫o.h
>

134 
	~<time.h
>

137 #ifde‡
UW


138 
	~<°dio.h
>

141 #ifde‡
VXWORKS


142 
	~<vxW‹ks.h
>

143 
	~<sockLib.h
>

144 
	~<£À˘Lib.h
>

145 
	~<öëLib.h
>

146 
	~<ioLib.h
>

147 
	~<°dio.h
>

148 
	~<°©.h
>

149 
	~<time.h
>

150 
	~<u§Lib.h
>

151 
	~<f˙é.h
>

152 
	~<î∫o.h
>

155 #ifde‡
•¨c


156 
	#__NO_PACK


	)

159 #ifde‡
SOLARIS


160 
	~<sys/ty≥s.h
>

161 
	~<limôs.h
>

162 
	~<°dio.h
>

163 
	~<°dlib.h
>

164 
	~<uni°d.h
>

165 
	~<sockë.h
>

166 
	~<sys/£À˘.h
>

167 
	~<√töë/ö.h
>

168 
	~<¨∑/öë.h
>

169 
	~<√tdb.h
>

170 
	~<time.h
>

171 
	~<f˙é.h
>

172 
	~<î∫o.h
>

175 #ifde‡
QNX4


176 
	~<sys/ty≥s.h
>

177 
	~<°dio.h
>

178 
	~<sys/sockë.h
>

179 
	~<sys/£À˘.h
>

180 
	~<√töë/ö.h
>

181 
	~<¨∑/öë.h
>

182 
	~<√tdb.h
>

183 
	~<°dlib.h
>

184 
	~<uni°d.h
>

185 
	~<sys/uio.h
>

186 
	~<sys/waô.h
>

189 #ifde‡
ECOS


190 
	~<limôs.h
>

191 
	~<cyg/ö‰a/cyg_ty≥.h
>

192 
	~<cyg/kî√l/k≠i.h
>

193 
	~<time.h
>

194 
	~<√tw‹k.h
>

195 
	~<î∫o.h
>

200 
	~<˘y≥.h
>

201 
	~<°d¨g.h
>

202 
	~<°rög.h
>

204 #i‚de‡
WEBS


205 
	~"mesßges.h
"

210 #ifde‡
UW


211 
	#__NO_PACK
 1

	)

214 #i‡(
deföed
 (
SCOV5
Ë|| deföed (
VXWORKS
Ë|| deföed (
LINUX
Ë|| deföed (
LYNX
Ë|| deföed (
MACOSX
))

215 #i‚de‡
O_BINARY


216 
	#O_BINARY
 0

	)

218 
	#SOCKET_ERROR
 -1

	)

221 #i‡(
deföed
 (
WIN
Ë|| deföed (
CE
))

225 
	#__NO_FCNTL
 1

	)

227 #unde‡
R_OK


228 
	#R_OK
 4

	)

229 #unde‡
W_OK


230 
	#W_OK
 2

	)

231 #unde‡
X_OK


232 
	#X_OK
 1

	)

233 #unde‡
F_OK


234 
	#F_OK
 0

	)

236 
	tsockÀn_t
;

240 #i‡(
deföed
 (
LINUX
Ë&& !deföed (
_STRUCT_TIMEVAL
))

241 
	stimevÆ


243 
time_t
 
	mtv_£c
;

244 
time_t
 
	mtv_u£c
;

246 
	#_STRUCT_TIMEVAL
 1

	)

249 #ifde‡
ECOS


250 
	#O_RDONLY
 1

	)

251 
	#O_BINARY
 2

	)

253 
	#__NO_PACK
 1

	)

254 
	#__NO_EJ_FILE
 1

	)

255 
	#__NO_CGI_BIN
 1

	)

256 
	#__NO_FCNTL
 1

	)

261 
	#LIBKERN_INLINE


	)

265 #ifde‡
QNX4


266 
	tfd_mask
;

267 
	#NFDBITS
 ( (
fd_mask
Ë* 
NBBY
Ë

	)

270 #ifde‡
MACOSX


271 
öt32_t
 
	tfd_mask
;

274 #ifde‡
NW


275 
	#fd_mask
 
fd_£t


	)

276 
	#INADDR_NONE
 -1l

	)

277 
	#SÀï
 
dñay


	)

279 
	#__NO_FCNTL
 1

	)

281 #unde‡
R_OK


282 
	#R_OK
 4

	)

283 #unde‡
W_OK


284 
	#W_OK
 2

	)

285 #unde‡
X_OK


286 
	#X_OK
 1

	)

287 #unde‡
F_OK


288 
	#F_OK
 0

	)

296 
	#TRACE_MAX
 (4096 - 48)

	)

297 
	#VALUE_MAX_STRING
 (4096 - 48)

	)

298 
	#SYM_MAX
 (512)

	)

299 
	#XML_MAX
 4096

	)

300 
	#BUF_MAX
 4096

	)

301 #i‚de‡
LINE_MAX


302 
	#LINE_MAX
 2048

	)

304 
	#FMT_STATIC_MAX
 256

	)

306 #i‡(
deföed
 (
LITTLEFOOT
Ë|| deföed (
WEBS
))

307 
	#LF_BUF_MAX
 (510)

	)

308 
	#LF_PATHSIZE
 
LF_BUF_MAX


	)

310 
	#LF_BUF_MAX
 
BUF_MAX


	)

311 
	#LF_PATHSIZE
 
PATHSIZE


	)

312 
	#UPPATHSIZE
 
PATHSIZE


	)

314 #i‚de‡
CHAR_T_DEFINED


315 
	#CHAR_T_DEFINED
 1

	)

316 #ifde‡
UNICODE


321 
	#T
(
x
Ë
	`__TXT
(x)

	)

322 
	#__TXT
(
s
Ë
L
 ## 
	)
s

323 
	tch¨_t
;

324 
	tuch¨_t
;

330 
	#TSZ
(
x
Ë((xË/ (
ch¨_t
))

	)

335 
	#TASTRL
(
x
Ë((
	`wc¶í
(xË+ 1Ë* (
ch¨_t
))

	)

338 
	#T
(
s
Ë
	)
s

339 
	tch¨_t
;

340 
	#TSZ
(
x
Ë((x))

	)

341 
	#TASTRL
(
x
Ë(
	`°æí
(xË+ 1)

	)

342 #ifde‡
WIN


343 
	tuch¨_t
;

354 #i‚de‡
TRUE


355 
	#TRUE
 1

	)

358 #i‚de‡
FALSE


359 
	#FALSE
 0

	)

365 
	#GOAHEAD_COPYRIGHT
 \

366 
	`T
("C›yrighà(cËGoAhód So·w¨êInc., 1995-2010. AŒ Right†Re£rved.")

	)

372 #i‡(
deföed
 (
LITTLEFOOT
Ë&& deföed (
INMEM
))

373 
	~"lf/ömem.h
"

379 #ifde‡
UNICODE


381 
	#gmaö
 
wmaö


	)

383 
	#gas˘ime
 
_was˘ime


	)

384 
	#g•rötf
 
sw¥ötf


	)

385 
	#g¥ötf
 
w¥ötf


	)

386 
	#gÂrötf
 
fw¥ötf


	)

387 
	#gssˇnf
 
swsˇnf


	)

388 
	#gv•rötf
 
vsw¥ötf


	)

390 
	#g°r˝y
 
wcs˝y


	)

391 
	#g°∫˝y
 
wc¢˝y


	)

392 
	#g°∫ˇt
 
wc¢ˇt


	)

393 
	#g°æí
 
wc¶í


	)

394 
	#g°rˇt
 
wcsˇt


	)

395 
	#g°rcmp
 
wcscmp


	)

396 
	#g°∫cmp
 
wc¢cmp


	)

397 
	#g°ricmp
 
wcsicmp


	)

398 
	#g°rchr
 
wcschr


	)

399 
	#g°ºchr
 
wc§chr


	)

400 
	#g°πok
 
wc°ok


	)

401 
	#g°∫£t
 
wc¢£t


	)

402 
	#g°ºchr
 
wc§chr


	)

403 
	#g°r•n
 
wcs•n


	)

404 
	#g°rc•n
 
wcsc•n


	)

405 
	#g°r°r
 
wcs°r


	)

406 
	#g°πﬁ
 
wc°ﬁ


	)

408 
	#gf›í
 
_wf›í


	)

409 
	#g›í
 
_w›í


	)

410 
	#g˛o£
 
˛o£


	)

411 
	#g¸ót
 
_w¸ót


	)

412 
	#gfgës
 
fgëws


	)

413 
	#gÂuts
 
Âutws


	)

414 
	#gfsˇnf
 
fwsˇnf


	)

415 
	#ggës
 
_gëws


	)

416 
	#gl£ek
 
l£ek


	)

417 
	#gu∆ök
 
_wu∆ök


	)

418 
	#gªad
 
ªad


	)

419 
	#gª«me
 
_wª«me


	)

420 
	#gwrôe
 
wrôe


	)

421 
	#gtm≤am
 
_wtm≤am


	)

422 
	#gãm≤am
 
_wãm≤am


	)

423 
	#gfödfú°
 
_wfödfú°


	)

424 
	#gfödd©a_t
 
_wfödd©a_t


	)

425 
	#gföd√xt
 
_wföd√xt


	)

426 
	#gföd˛o£
 
_föd˛o£


	)

427 
	#g°©
 
_w°©


	)

428 
	#gac˚ss
 
_wac˚ss


	)

429 
	#gchmod
 
_wchmod


	)

431 
_°©
 
	tg°©_t
;

433 
	#gmkdú
 
_wmkdú


	)

434 
	#gchdú
 
_wchdú


	)

435 
	#grmdú
 
_wrmdú


	)

436 
	#ggëcwd
 
_wgëcwd


	)

438 
	#gtﬁowî
 
towlowî


	)

439 
	#gtouµî
 
towuµî


	)

440 #ifde‡
CE


441 
	#gis•a˚
 
is•a˚


	)

442 
	#gisdigô
 
isdigô


	)

443 
	#gisxdigô
 
isxdigô


	)

444 
	#gisuµî
 
isuµî


	)

445 
	#gi¶owî
 
i¶owî


	)

446 
	#gi•röt
 
i•röt


	)

448 
	#gªmove
 
_wªmove


	)

449 
	#gis•a˚
 
isw•a˚


	)

450 
	#gisdigô
 
iswdigô


	)

451 
	#gisxdigô
 
iswxdigô


	)

452 
	#gisuµî
 
iswuµî


	)

453 
	#gi¶owî
 
iswlowî


	)

455 
	#giß um
 
iswÆnum


	)

456 
	#gißÕha
 
iswÆpha


	)

457 
	#g©oi
(
s
Ë
	`wc°ﬁ
(s, 
NULL
, 10)

	)

459 
	#g˘ime
 
_w˘ime


	)

460 
	#ggëív
 
_wgëív


	)

461 
	#gexecvp
 
_wexecvp


	)

465 #ifde‡
VXWORKS


466 
	#gchdú
 
vxchdú


	)

467 
	#gmkdú
 
vxmkdú


	)

468 
	#grmdú
 
vxrmdú


	)

469 #ñi‡(
deföed
 (
LYNX
Ë|| deföed (
LINUX
Ë|| deföed (
MACOSX
Ë|| deföed (
SOLARIS
))

470 
	#gchdú
 
chdú


	)

471 
	#gmkdú
(
s
Ë
	`mkdú
(s,0755)

	)

472 
	#grmdú
 
rmdú


	)

474 
	#gchdú
 
chdú


	)

475 
	#gmkdú
 
mkdú


	)

476 
	#grmdú
 
rmdú


	)

479 
	#g˛o£
 
˛o£


	)

480 
	#g˛o£dú
 
˛o£dú


	)

481 
	#gchmod
 
chmod


	)

482 
	#ggëcwd
 
gëcwd


	)

483 
	#gl£ek
 
l£ek


	)

484 
	#glﬂdModuÀ
 
lﬂdModuÀ


	)

485 
	#g›í
 
›í


	)

486 
	#g›ídú
 
›ídú


	)

487 
	#gªad
 
ªad


	)

488 
	#gªaddú
 
ªaddú


	)

489 
	#gª«me
 
ª«me


	)

490 
	#g°©
 
°©


	)

491 
	#gu∆ök
 
u∆ök


	)

492 
	#gwrôe
 
wrôe


	)

494 
	#gas˘ime
 
as˘ime


	)

495 
	#g•rötf
 
•rötf


	)

496 
	#g¥ötf
 
¥ötf


	)

497 
	#gÂrötf
 
Ârötf


	)

498 
	#gssˇnf
 
ssˇnf


	)

499 
	#gv•rötf
 
v•rötf


	)

501 
	#g°r˝y
 
°r˝y


	)

502 
	#g°∫˝y
 
°∫˝y


	)

503 
	#g°∫ˇt
 
°∫ˇt


	)

504 
	#g°æí
 
°æí


	)

505 
	#g°rˇt
 
°rˇt


	)

506 
	#g°rcmp
 
°rcmp


	)

507 
	#g°∫cmp
 
°∫cmp


	)

508 
	#g°ricmp
 
°rcmpci


	)

509 
	#g°rchr
 
°rchr


	)

510 
	#g°ºchr
 
°ºchr


	)

511 
	#g°πok
 
°πok


	)

512 
	#g°∫£t
 
°∫£t


	)

513 
	#g°ºchr
 
°ºchr


	)

514 
	#g°r•n
 
°r•n


	)

515 
	#g°rc•n
 
°rc•n


	)

516 
	#g°r°r
 
°r°r


	)

517 
	#g°πﬁ
 
°πﬁ


	)

519 
	#gf›í
 
f›í


	)

520 
	#g¸ót
 
¸ót


	)

521 
	#gfgës
 
fgës


	)

522 
	#gÂuts
 
Âuts


	)

523 
	#gfsˇnf
 
fsˇnf


	)

524 
	#ggës
 
gës


	)

525 
	#gtm≤am
 
tm≤am


	)

526 
	#gãm≤am
 
ãm≤am


	)

527 
	#gfödfú°
 
_födfú°


	)

528 
	#gfödd©a_t
 
_född©a_t


	)

529 
	#gföd√xt
 
_föd√xt


	)

530 
	#gföd˛o£
 
_föd˛o£


	)

531 
	#gac˚ss
 
ac˚ss


	)

533 
°©
 
	tg°©_t
;

535 
	#gªmove
 
ªmove


	)

537 
	#gtﬁowî
 
tﬁowî


	)

538 
	#gtouµî
 
touµî


	)

539 
	#gis•a˚
 
is•a˚


	)

540 
	#gisdigô
 
isdigô


	)

541 
	#gisxdigô
 
isxdigô


	)

542 
	#giß um
 
iß um


	)

543 
	#gißÕha
 
ißÕha


	)

544 
	#gisuµî
 
isuµî


	)

545 
	#gi¶owî
 
i¶owî


	)

546 
	#g©oi
 
©oi


	)

548 
	#g˘ime
 
˘ime


	)

549 
	#ggëív
 
gëív


	)

550 
	#gexecvp
 
execvp


	)

551 #i‚de‡
VXWORKS


552 
	#gmaö
 
maö


	)

554 #ifde‡
VXWORKS


555 
	#f˙é
(
a
, 
b
, 
c
)

	)

559 #ifde‡
WIN32


560 
	#gëcwd
 
_gëcwd


	)

561 
	#ãm≤am
 
_ãm≤am


	)

562 
	#›í
 
_›í


	)

563 
	#˛o£
 
_˛o£


	)

564 
	#ªad
 
_ªad


	)

565 
	#wrôe
 
_wrôe


	)

566 
	#chdú
 
_chdú


	)

567 
	#l£ek
 
_l£ek


	)

568 
	#u∆ök
 
_u∆ök


	)

570 
	#loˇ…ime
 
loˇ…ime_s


	)

579 #ifde‡
INMEM


580 
	~"lf/ömem.h
"

585 #i‚de‡
FNAMESIZE


586 
	#FNAMESIZE
 254

	)

589 
	#E_MAX_ERROR
 4096

	)

590 
	#URL_MAX
 4096

	)

591 
	#E_MAX_REQUEST
 2048

	)

596 
	#E_ASSERT
 0x1

	)

597 
	#E_LOG
 0x2

	)

598 
	#E_USER
 0x3

	)

600 
	#E_L
 
	`T
(
__FILE__
), 
__LINE__


	)

601 
	#E_ARGS_DEC
 
ch¨_t
 *
fûe
, 
löe


	)

602 
	#E_ARGS
 
fûe
, 
löe


	)

604 #i‡(
deföed
 (
ASSERT
Ë|| deföed (
ASSERT_CE
))

605 
	#a_as£π
(
C
Ëi‡(CË; 
	`îr‹
(
E_L
, 
E_ASSERT
, 
	`T
("%s"), T(#C))

	)

607 
	#a_as£π
(
C
Ëi‡(1Ë; 

	)

610 
	#ñemítsof
(
X
Ë(XË/ (X[0])

	)

620 
	mundeföed
 = 0,

621 
	mbyãöt
 = 1,

622 
	msh‹töt
 = 2,

623 
	möãgî
 = 3,

624 
	mhex
 = 4,

625 
	m≥r˚¡
 = 5,

626 
	mo˘Æ
 = 6,

627 
	mbig
 = 7,

628 
	mÊag
 = 8,

629 
	mÊﬂtög
 = 9,

630 
	m°rög
 = 10,

631 
	mbyãs
 = 11,

632 
	msymbﬁ
 = 12,

633 
	mîrmsg
 = 13

634 } 
	tvty≥_t
;

636 #i‚de‡
__NO_PACK


637 #¥agm®
∑ck
(2)

643 
	mÊag
;

644 
	mbyãöt
;

645 
	msh‹töt
;

646 
	m≥r˚¡
;

647 
	möãgî
;

648 
	mhex
;

649 
	mo˘Æ
;

650 
	mbig
[2];

651 #ifde‡
FLOATING_POINT_SUPPORT


652 
	mÊﬂtög
;

654 
ch¨_t
 *
	m°rög
;

655 *
	mbyãs
;

656 
ch¨_t
 *
	mîrmsg
;

657 *
	msymbﬁ
;

658 } 
	mvÆue
;

660 
vty≥_t
 
	mty≥
;

661 
	mvÆid
 : 8;

662 
	mÆloˇãd
 : 8;

663 } 
	tvÆue_t
;

665 #i‚de‡
__NO_PACK


666 #¥agm®
∑ck
()

672 
	#VALUE_ALLOCATE
 0x1

	)

674 
	#vÆue_numîic
(
t
Ë— >
byãöt
 &&Å <
big
)

	)

675 
	#vÆue_°r
(
t
Ë— >
°rög
 &&Å <
byãs
)

	)

676 
	#vÆue_ok
(
t
Ë— > 
undeföed
 &&Å <
symbﬁ
)

	)

678 
	#VALUE_VALID
 { {0}, 
öãgî
, 1 }

	)

679 
	#VALUE_INVALID
 { {0}, 
undeföed
, 0 }

	)

723 *
	mbuf
;

724 *
	m£rvp
;

725 *
	mídp
;

726 *
	mídbuf
;

727 
	mbuÊí
;

728 
	mmaxsize
;

729 
	mö¸emít
;

730 } 
	trögq_t
;

735 #ifdef 
B_STATS


736 #i‚de‡
B_L


737 
	#B_L
 
	`T
(
__FILE__
), 
__LINE__


	)

738 
	#B_ARGS_DEC
 
ch¨_t
 *
fûe
, 
löe


	)

739 
	#B_ARGS
 
fûe
, 
löe


	)

749 *
	m√xt
;

750 
	msize
;

751 } 
	mu
;

752 
	mÊags
;

753 } 
	tbTy≥
;

755 
	#B_SHIFT
 4

	)

756 
	#B_ROUND
 ((1 << (
B_SHIFT
)Ë- 1)

	)

757 
	#B_MAX_CLASS
 13

	)

758 
	#B_MALLOCED
 0x80000000

	)

759 
	#B_DEFAULT_MEM
 (64 * 1024Ë

	)

760 
	#B_MAX_FILES
 (512Ë

	)

761 
	#B_FILL_CHAR
 (0x77Ë

	)

762 
	#B_FILL_WORD
 (0x77777777Ë

	)

763 
	#B_MAX_BLOCKS
 (64 * 1024Ë

	)

768 
	#B_INTEGRITY
 0x8124000

	)

769 
	#B_INTEGRITY_MASK
 0xFFFF000

	)

770 
	#B_USE_MALLOC
 0x1

	)

771 
	#B_USER_BUF
 0x2

	)

777 
	ssym_t
 {

778 
sym_t
 *
	mf‹w
;

779 
vÆue_t
 
	m«me
;

780 
vÆue_t
 
	mc⁄ã¡
;

781 
	m¨g
;

782 } 
	tsym_t
;

784 
	tsym_fd_t
;

789 
	#EMF_SCRIPT_JSCRIPT
 0

	)

790 
	#EMF_SCRIPT_TCL
 1

	)

791 
	#EMF_SCRIPT_EJSCRIPT
 2

	)

792 
	#EMF_SCRIPT_MAX
 3

	)

794 #i‡!
deföed
(
HAVE_MAXINT
)

795 
	#MAXINT
 
INT_MAX


	)

797 
	#BITSPERBYTE
 8

	)

798 
	#BITS
(
ty≥
Ë(
BITSPERBYTE
 * (Ë—y≥))

	)

799 
	#STRSPACE
 
	`T
("\à\n\r\t")

	)

801 #i‚de‡
max


802 
	#max
(
a
,
b
Ë((◊Ë> (b)Ë? (aË: (b))

	)

805 #i‚de‡
mö


806 
	#mö
(
a
,
b
Ë((◊Ë< (b)Ë? (aË: (b))

	)

814 
ch¨_t
 *
	mmöuã
;

815 
ch¨_t
 *
	mhour
;

816 
ch¨_t
 *
	mday
;

817 
ch¨_t
 *
	mm⁄th
;

818 
ch¨_t
 *
	mdayofwìk
;

819 } 
	t¸⁄_t
;

821 
¸⁄U¡û
(
¸⁄_t
 *
˝
, 
≥riod
, 
time_t
 
ã°Time
);

822 
¸⁄AŒoc
(
¸⁄_t
 *
˝
, 
ch¨_t
 *
°r
);

823 
¸⁄Fªe
(
¸⁄_t
 *
˝
);

832 #i‡((
deföed
 (
WIN
Ë|| deföed (
CE
)Ë&& deföed (
WEBS
Ë&& !deföed(
WIN32
))

834 #i‚de‡
EWOULDBLOCK


835 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

837 #i‚de‡
ENETDOWN


838 
	#ENETDOWN
 
WSAENETDOWN


	)

840 #i‚de‡
ECONNRESET


841 
	#ECONNRESET
 
WSAECONNRESET


	)

845 
	#SOCKET_EOF
 0x1

	)

846 
	#SOCKET_CONNECTING
 0x2

	)

847 
	#SOCKET_BROADCAST
 0x4

	)

848 
	#SOCKET_PENDING
 0x8

	)

849 
	#SOCKET_FLUSHING
 0x10

	)

850 
	#SOCKET_DATAGRAM
 0x20

	)

851 
	#SOCKET_ASYNC
 0x40

	)

852 
	#SOCKET_BLOCK
 0x80

	)

853 
	#SOCKET_LISTENING
 0x100

	)

854 
	#SOCKET_CLOSING
 0x200

	)

855 
	#SOCKET_CONNRESET
 0x400

	)

856 
	#SOCKET_MYOWNBUFFERS
 0x800

	)

858 
	#SOCKET_PORT_MAX
 0xfff‡

	)

863 
	#SOCKET_WOULDBLOCK
 1

	)

864 
	#SOCKET_RESET
 2

	)

865 
	#SOCKET_NETDOWN
 3

	)

866 
	#SOCKET_AGAIN
 4

	)

867 
	#SOCKET_INTR
 5

	)

868 
	#SOCKET_INVAL
 6

	)

873 
	#SOCKET_READABLE
 0x2

	)

874 
	#SOCKET_WRITABLE
 0x4

	)

875 
	#SOCKET_EXCEPTION
 0x8

	)

876 
	#EMF_SOCKET_MESSAGE
 (
WM_USER
+13)

	)

878 
	#WEBS_MAX_REQUEST
 2048

	)

880 #ifde‡
LITTLEFOOT


881 
	#SOCKET_BUFSIZ
 510

	)

883 
	#SOCKET_BUFSIZ
 1024

	)

886 (*
	tsockëH™dÀr_t
)(
	tsid
, 
	tmask
, * 
	td©a
);

887 (*
	tsockëAc˚±_t
)(
	tsid
, *
	tùaddr
, 
	tp‹t
,

888 
	tli°íSid
);

890 
ho°
[64];

891 
rögq_t
 
öBuf
;

892 
rögq_t
 
outBuf
;

893 
rögq_t
 
löeBuf
;

894 
sockëAc˚±_t
 
ac˚±
;

895 
sockëH™dÀr_t
 
h™dÀr
;

896 *
h™dÀr_d©a
;

897 
h™dÀrMask
;

898 
sid
;

899 
p‹t
;

900 
Êags
;

901 
sock
;

902 
fûeH™dÀ
;

903 
öãª°Evíts
;

904 
cuºítEvíts
;

905 
£À˘Evíts
;

906 
ßveMask
;

907 
îr‹
;

908 } 
	tsockë_t
;

916 
	`b˛o£
();

917 
	`b›í
(*
buf
, 
bufsize
, 
Êags
);

924 #ifde‡
NO_BALLOC


925 
	#bÆloc
(
B_ARGS
, 
num
Ë
	`mÆloc
“um)

	)

926 
	#b‰ì
(
B_ARGS
, 
p
Ë
	`‰ì
’)

	)

927 
	#b‰ìSa„
(
B_ARGS
, 
p
) \

928 i‡(
p
Ë{ 
	`‰ì
’); 
	}
} 

	)

929 
	#bªÆloc
(
B_ARGS
, 
p
, 
num
Ë
	`ªÆloc
’,Çum)

	)

930 
ch¨_t
 *
b°rdupNoBÆloc
(ch¨_à*
s
);

931 *
b°rdupANoBÆloc
(*
s
);

932 
	#b°rdup
(
B_ARGS
, 
s
Ë
	`b°rdupNoBÆloc
(s)

	)

933 
	#b°rdupA
(
B_ARGS
, 
s
Ë
	`b°rdupANoBÆloc
(s)

	)

934 
	#g°rdup
(
B_ARGS
, 
s
Ë
	`b°rdupNoBÆloc
(s)

	)

938 #i‚de‡
B_STATS


939 
	#bÆloc
(
B_ARGS
, 
num
Ë
	`bÆloc
“um)

	)

940 
	#b‰ì
(
B_ARGS
, 
p
Ë
	`b‰ì
’)

	)

941 
	#b‰ìSa„
(
B_ARGS
, 
p
Ë
	`b‰ìSa„
’)

	)

942 
	#bªÆloc
(
B_ARGS
, 
p
, 
size
Ë
	`bªÆloc
’, size)

	)

943 
	#b°rdup
(
B_ARGS
, 
p
Ë
	`b°rdup
’)

	)

945 #ifde‡
UNICODE


946 
	#b°rdupA
(
B_ARGS
, 
p
Ë
	`b°rdupA
’)

	)

948 
	#b°rdupA
 
b°rdup


	)

953 
	#g°rdup
 
b°rdup


	)

954 *
bÆloc
(
B_ARGS_DEC
, 
size
);

955 
b‰ì
(
B_ARGS_DEC
, *
mp
);

956 
b‰ìSa„
(
B_ARGS_DEC
, *
mp
);

957 *
bªÆloc
(
B_ARGS_DEC
, *
buf
, 
√wsize
);

958 
ch¨_t
 *
b°rdup
(
B_ARGS_DEC
, ch¨_à*
s
);

960 #ifde‡
UNICODE


961 *
b°rdupA
(
B_ARGS_DEC
, *
s
);

963 
	#b°rdupA
 
b°rdup


	)

967 
b°©s
(
h™dÀ
, (*
wrôe‚
)(h™dÀ, 
ch¨_t
 *
fmt
, ...));

972 
	#B_USE_MALLOC
 0x1

	)

973 
	#B_USER_BUF
 0x2

	)

975 #i‚de‡
LINUX


976 
ch¨_t
 *
	`ba£«me
(ch¨_à*
«me
);

979 (
	temfSchedProc
)(*
	td©a
, 
	tid
);

980 
	`emfSchedCÆlback
(
dñay
, 
emfSchedProc
 *
¥oc
, *
¨g
);

981 
	`emfUnschedCÆlback
(
id
);

982 
	`emfReschedCÆlback
(
id
, 
dñay
);

983 
	`emfSchedPro˚ss
();

984 
	`emfIn°Gë
();

985 
	`emfIn°Së
(
ö°
);

986 
	`îr‹
(
E_ARGS_DEC
, 
Êags
, 
ch¨_t
 *
fmt
, ...);

987 (*
	`îr‹SëH™dÀr
((*
fun˘i⁄
)(
ëy≥
, 
ch¨_t
 *
msg
))) \

988 (
ëy≥
, 
ch¨_t
 *
msg
);

990 #ifde‡
B_STATS


991 
	#hAŒoc
(
x
Ë
	`HALLOC
(
B_L
, x)

	)

992 
	#hAŒocE¡ry
(
x
, 
y
, 
z
Ë
	`HALLOCENTRY
(
B_L
, x, y, z)

	)

993 
	`HALLOC
(
B_ARGS_DEC
, ***
m≠
);

994 
	`HALLOCENTRY
(
B_ARGS_DEC
, ***
li°
, *
max
, 
size
);

996 
	`hAŒoc
(***
m≠
);

997 
	`hAŒocE¡ry
(***
li°
, *
max
, 
size
);

1000 
	`hFªe
(***
m≠
, 
h™dÀ
);

1002 
	`rögqO≥n
(
rögq_t
 *
rq
, 
ö¸emít
, 
maxsize
);

1003 
	`rögqClo£
(
rögq_t
 *
rq
);

1004 
	`rögqLí
(
rögq_t
 *
rq
);

1006 
	`rögqPutc
(
rögq_t
 *
rq
, 
ch¨_t
 
c
);

1007 
	`rögqIn£πc
(
rögq_t
 *
rq
, 
ch¨_t
 
c
);

1008 
	`rögqPutSå
(
rögq_t
 *
rq
, 
ch¨_t
 *
°r
);

1009 
	`rögqGëc
(
rögq_t
 *
rq
);

1011 
	`fmtVÆloc
(
ch¨_t
 **
s
, 
n
, ch¨_à*
fmt
, 
va_li°
 
¨g
);

1012 
	`fmtAŒoc
(
ch¨_t
 **
s
, 
n
, ch¨_à*
fmt
, ...);

1013 
	`fmtSètic
(
ch¨_t
 *
s
, 
n
, ch¨_à*
fmt
, ...);

1015 #ifde‡
UNICODE


1016 
	`rögqPutcA
(
rögq_t
 *
rq
, 
c
);

1017 
	`rögqIn£πcA
(
rögq_t
 *
rq
, 
c
);

1018 
	`rögqPutSåA
(
rögq_t
 *
rq
, *
°r
);

1019 
	`rögqGëcA
(
rögq_t
 *
rq
);

1021 
	#rögqPutcA
 
rögqPutc


	)

1022 
	#rögqIn£πcA
 
rögqIn£πc


	)

1023 
	#rögqPutSåA
 
rögqPutSå


	)

1024 
	#rögqGëcA
 
rögqGëc


	)

1027 
	`rögqPutBlk
(
rögq_t
 *
rq
, *
buf
, 
Àn
);

1028 
	`rögqPutBlkMax
(
rögq_t
 *
rq
);

1029 
	`rögqPutBlkAdj
(
rögq_t
 *
rq
, 
size
);

1030 
	`rögqGëBlk
(
rögq_t
 *
rq
, *
buf
, 
Àn
);

1031 
	`rögqGëBlkMax
(
rögq_t
 *
rq
);

1032 
	`rögqGëBlkAdj
(
rögq_t
 *
rq
, 
size
);

1033 
	`rögqFlush
(
rögq_t
 *
rq
);

1034 
	`rögqAddNuŒ
(
rögq_t
 *
rq
);

1036 
	`s¸ùtSëV¨
(
ígöe
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

1037 
	`s¸ùtEvÆ
(
ígöe
, 
ch¨_t
 *
cmd
, ch¨_à**
r¶t
, * 
ch™
);

1039 
	`sockëClo£
();

1040 
	`sockëClo£C⁄√˘i⁄
(
sid
);

1041 
	`sockëCª©eH™dÀr
(
sid
, 
mask
, 
sockëH™dÀr_t


1042 
h™dÀr
, * 
¨g
);

1043 
	`sockëDñëeH™dÀr
(
sid
);

1044 
	`sockëEof
(
sid
);

1045 
	`sockëC™Wrôe
(
sid
);

1046 
	`sockëSëBuf„rSize
(
sid
, 
ö
, 
löe
, 
out
);

1047 
	`sockëFlush
(
sid
);

1048 
	`sockëGës
(
sid
, 
ch¨_t
 **
buf
);

1049 
	`sockëGëP‹t
(
sid
);

1050 
	`sockëI≈utBuf„ªd
(
sid
);

1051 
	`sockëO≥n
();

1052 
	`sockëO≥nC⁄√˘i⁄
(*
ho°
, 
p‹t
,

1053 
sockëAc˚±_t
 
ac˚±
, 
Êags
);

1054 
	`sockëPro˚ss
(
hid
);

1055 
	`sockëRód
(
sid
, *
buf
, 
Àn
);

1056 
	`sockëRódy
(
hid
);

1057 
	`sockëWrôe
(
sid
, *
buf
, 
Àn
);

1058 
	`sockëWrôeSåög
(
sid
, 
ch¨_t
 *
buf
);

1059 
	`sockëSñe˘
(
hid
, 
timeout
);

1060 
	`sockëGëH™dÀ
(
sid
);

1061 
	`sockëSëBlock
(
sid
, 
Êags
);

1062 
	`sockëGëBlock
(
sid
);

1063 
	`sockëAŒoc
(*
ho°
, 
p‹t
, 
sockëAc˚±_t
 
ac˚±
,

1064 
Êags
);

1065 
	`sockëFªe
(
sid
);

1066 
	`sockëGëEº‹
();

1067 
sockë_t
 *
	`sockëPå
(
sid
);

1068 
	`sockëWaôF‹Evít
(
sockë_t
 *
•
, 
evíts
, *
îrCode
);

1069 
	`sockëRegi°îI¡îe°
(
sockë_t
 *
•
, 
h™dÀrMask
);

1070 
	`sockëGëI≈ut
(
sid
, *
buf
, 
toRód
, *
îrCode
);

1072 
ch¨_t
 *
	`°æowî
(ch¨_à*
°rög
);

1073 
ch¨_t
 *
	`°ruµî
(ch¨_à*
°rög
);

1075 
ch¨_t
 *
	`°rôﬂ
(
n
, ch¨_à*
°rög
, 
width
);

1077 
sym_fd_t
 
	`symO≥n
(
hash_size
);

1078 
	`symClo£
(
sym_fd_t
 
sd
);

1079 
sym_t
 *
	`symLookup
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
);

1080 
sym_t
 *
	`symE¡î
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
, 
vÆue_t
 
v
, 
¨g
);

1081 
	`symDñëe
(
sym_fd_t
 
sd
, 
ch¨_t
 *
«me
);

1082 
	`symWÆk
(
sym_fd_t
 
sd
, (*
‚
)(
sym_t
 *
symp
));

1083 
sym_t
 *
	`symFú°
(
sym_fd_t
 
sd
);

1084 
sym_t
 *
	`symNext
(
sym_fd_t
 
sd
);

1085 
	`symSubO≥n
();

1086 
	`symSubClo£
();

1088 
	`åa˚
(
Àv
, 
ch¨_t
 *
fmt
, ...);

1089 
	`åa˚Raw
(
ch¨_t
 *
buf
);

1090 (*
	`åa˚SëH™dÀr
((*
fun˘i⁄
)(
Àvñ
, 
ch¨_t
 *
buf
)))

1091 (
Àvñ
, 
ch¨_t
 *
buf
);

1093 
vÆue_t
 
	`vÆueI¡egî
(
vÆue
);

1094 
vÆue_t
 
	`vÆueSåög
(
ch¨_t
 *
vÆue
, 
Êags
);

1095 
vÆue_t
 
	`vÆueEºmsg
(
ch¨_t
 *
vÆue
);

1096 
	`vÆueFªe
(
vÆue_t
 *
v
);

1097 
	`vxchdú
(*
dú«me
);

1099 
	`hextoi
(
ch¨_t
 *
hex°rög
);

1100 
	`g°πoi
(
ch¨_t
 *
s
);

1101 
time_t
 
	`timeM£c
();

1103 
ch¨_t
 *
	`ascToUni
(ch¨_à*
ubuf
, *
°r
, 
nByãs
);

1104 *
	`uniToAsc
(*
buf
, 
ch¨_t
 *
u°r
, 
nByãs
);

1105 
ch¨_t
 *
	`bÆlocAscToUni
(*
˝
, 
Æí
);

1106 *
	`bÆlocUniToAsc
(
ch¨_t
 *
unù
, 
uÀn
);

1108 
ch¨_t
 *
	`basicGëHo°
();

1109 
ch¨_t
 *
	`basicGëAddªss
();

1110 
ch¨_t
 *
	`basicGëProdu˘
();

1111 
	`basicSëHo°
(
ch¨_t
 *
ho°
);

1112 
	`basicSëAddªss
(
ch¨_t
 *
addr
);

1114 
	`h¨√ssO≥n
(
ch¨_t
 **
¨gv
);

1115 
	`h¨√ssClo£
(
°©us
);

1116 
	`h¨√ssTe°ög
(
ch¨_t
 *
msg
, ...);

1117 
	`h¨√ssPas£d
();

1118 
	`h¨√ssFaûed
(
löe
);

1119 
	`h¨√ssLevñ
();

	@um.c

18 
	~"um.h
"

19 
	~"emfdb.h
"

20 
	~"webs.h
"

24 
	#UM_DB_FILENAME
 
	`T
("um.xml")

	)

25 
	#UM_TXT_FILENAME
 
	`T
("umc⁄fig.txt")

	)

30 
	#UM_USER_TABLENAME
 
	`T
("u£rs")

	)

31 
	#UM_GROUP_TABLENAME
 
	`T
("groups")

	)

32 
	#UM_ACCESS_TABLENAME
 
	`T
("ac˚ss")

	)

37 
	#UM_NAME
 
	`T
("«me")

	)

38 
	#UM_PASS
 
	`T
("∑ssw‹d")

	)

39 
	#UM_GROUP
 
	`T
("group")

	)

40 
	#UM_PROT
 
	`T
("¥Ÿ")

	)

41 
	#UM_DISABLE
 
	`T
("dißbÀ")

	)

42 
	#UM_METHOD
 
	`T
("mëhod")

	)

43 
	#UM_PRIVILEGE
 
	`T
("¥iv")

	)

44 
	#UM_SECURE
 
	`T
("£cuª")

	)

51 
	#UM_XOR_ENCRYPT
 
	`T
("*j7a(L#yZ98sSd5HfSgGjMj8;Ss;d)(*&^#@$a2s0i3g")

	)

58 
	#NUMBER_OF_USER_COLUMNS
 5

	)

60 
ch¨_t
 *
	gu£rCﬁumnNames
[
NUMBER_OF_USER_COLUMNS
] = {

61 
UM_NAME
, 
UM_PASS
, 
UM_GROUP
, 
UM_PROT
, 
UM_DISABLE


64 
	gu£rCﬁumnTy≥s
[
NUMBER_OF_USER_COLUMNS
] = {

65 
T_STRING
, T_STRING, T_STRING, 
T_INT
, T_INT

68 
dbTabÀ_t
 
	gu£rTabÀ
 = {

69 
UM_USER_TABLENAME
,

70 
NUMBER_OF_USER_COLUMNS
,

71 
u£rCﬁumnNames
,

72 
u£rCﬁumnTy≥s
,

74 
NULL


80 
	#NUMBER_OF_GROUP_COLUMNS
 5

	)

82 
ch¨_t
 *
	ggroupCﬁumnNames
[
NUMBER_OF_GROUP_COLUMNS
] = {

83 
UM_NAME
, 
UM_PRIVILEGE
, 
UM_METHOD
, 
UM_PROT
, 
UM_DISABLE


86 
	ggroupCﬁumnTy≥s
[
NUMBER_OF_GROUP_COLUMNS
] = {

87 
T_STRING
, 
T_INT
, T_INT, T_INT, T_INT

90 
dbTabÀ_t
 
	ggroupTabÀ
 = {

91 
UM_GROUP_TABLENAME
,

92 
NUMBER_OF_GROUP_COLUMNS
,

93 
groupCﬁumnNames
,

94 
groupCﬁumnTy≥s
,

96 
NULL


102 
	#NUMBER_OF_ACCESS_COLUMNS
 4

	)

104 
ch¨_t
 *
	gac˚ssCﬁumnNames
[
NUMBER_OF_ACCESS_COLUMNS
] = {

105 
UM_NAME
, 
UM_METHOD
, 
UM_SECURE
, 
UM_GROUP


108 
	gac˚ssCﬁumnTy≥s
[
NUMBER_OF_ACCESS_COLUMNS
] = {

109 
T_STRING
, 
T_INT
, T_INT, T_STRING

112 
dbTabÀ_t
 
	gac˚ssTabÀ
 = {

113 
UM_ACCESS_TABLENAME
,

114 
NUMBER_OF_ACCESS_COLUMNS
,

115 
ac˚ssCﬁumnNames
,

116 
ac˚ssCﬁumnTy≥s
,

118 
NULL


124 
	gdidUM
 = -1;

129 
ch¨_t
 *
	gßveFûíame
 = 
NULL
;

131 
	gumO≥nCou¡
 = 0;

135 
boﬁ_t
 
umCheckName
(
ch¨_t
 *
«me
);

142 
	$umO≥n
()

144 i‡(++
umO≥nCou¡
 != 1) {

145  
didUM
;

150 i‡(
didUM
 == -1) {

151 
didUM
 = 
	`dbO≥n
(
UM_USER_TABLENAME
, 
UM_DB_FILENAME
, 
NULL
, 0);

152 
	`dbRegi°îDBSchema
(&
u£rTabÀ
);

153 
	`dbRegi°îDBSchema
(&
groupTabÀ
);

154 
	`dbRegi°îDBSchema
(&
ac˚ssTabÀ
);

157 i‡(
ßveFûíame
 =
NULL
) {

158 
ßveFûíame
 = 
	`b°rdup
(
B_L
, 
UM_TXT_FILENAME
);

161  
didUM
;

162 
	}
}

169 
	$umClo£
()

171 i‡(--
umO≥nCou¡
 > 0) {

177 i‡(
didUM
 != -1) {

178 
	`dbClo£
(
didUM
);

179 
didUM
 = -1;

182 i‡(
ßveFûíame
 !
NULL
) {

183 
	`b‰ì
(
B_L
, 
ßveFûíame
);

184 
ßveFûíame
 = 
NULL
;

186 
	}
}

193 
	$umCommô
(
ch¨_t
 *
fûíame
)

195 i‡(
fûíame
 && *filename) {

196 i‡(
ßveFûíame
 !
NULL
) {

197 
	`b‰ì
(
B_L
, 
ßveFûíame
);

200 
ßveFûíame
 = 
	`b°rdup
(
B_L
, 
fûíame
);

203 
	`a_as£π
 (
ßveFûíame
 && *saveFilename);

204 
	`åa˚
(3, 
	`T
("UM: Writing User ConfigurationÅo file <%s>\n"),

205 
ßveFûíame
);

207  
	`dbSave
(
didUM
, 
ßveFûíame
, 0);

208 
	}
}

215 
	$umRe°‹e
(
ch¨_t
 *
fûíame
)

217 i‡(
fûíame
 && *filename) {

218 i‡(
ßveFûíame
 !
NULL
) {

219 
	`b‰ì
(
B_L
, 
ßveFûíame
);

222 
ßveFûíame
 = 
	`b°rdup
(
B_L
, 
fûíame
);

225 
	`a_as£π
(
ßveFûíame
 && *saveFilename);

227 
	`åa˚
(3, 
	`T
("UM: Loading User Configuration from file <%s>\n"),

228 
ßveFûíame
);

233 
	`dbZîo
(
didUM
);

234  
	`dbLﬂd
(
didUM
, 
ßveFûíame
, 0);

235 
	}
}

243 
	$umEn¸y±Såög
(
ch¨_t
 *
ãxtSåög
)

245 
ch¨_t
 *
íMask
;

246 
ch¨_t
 
íCh¨
;

247 
numCh¨s
;

249 
	`a_as£π
(
ãxtSåög
);

251 
íMask
 = 
UM_XOR_ENCRYPT
;

252 
numCh¨s
 = 0;

254 *
ãxtSåög
) {

255 
íCh¨
 = *
ãxtSåög
 ^ *
íMask
;

260 i‡(
íCh¨
 && !
	`gis•a˚
(enChar))

261 *
ãxtSåög
 = 
íCh¨
;

265 
íMask
++;

266 
ãxtSåög
++;

267 
numCh¨s
++;

271 i‡(*
íMask
 == '\0') {

272 
íMask
 = 
UM_XOR_ENCRYPT
;

276  
numCh¨s
;

277 
	}
}

285 
ch¨_t
 *
	$umGëFú°RowD©a
(
ch¨_t
 *
èbÀName
, ch¨_à*
cﬁumnName
)

287 
ch¨_t
 *
cﬁumnD©a
;

288 
row
;

289 
check
;

291 
	`a_as£π
(
èbÀName
 && *tableName);

292 
	`a_as£π
(
cﬁumnName
 && *columnName);

294 
row
 = 0;

299 
cﬁumnD©a
 = 
NULL
;

300 (
check
 = 
	`dbRódSå
(
didUM
, 
èbÀName
, 
cﬁumnName
, 
row
++,

301 &
cﬁumnD©a
)Ë=0 || (
check
 =
DB_ERR_ROW_DELETED
)) {

302 i‡(
cﬁumnD©a
 && *columnData) {

303  
cﬁumnD©a
;

307  
NULL
;

308 
	}
}

316 
ch¨_t
 *
	$umGëNextRowD©a
(
ch¨_t
 *
èbÀName
, ch¨_à*
cﬁumnName
,

317 
ch¨_t
 *
keyLa°
)

319 
ch¨_t
 *
key
;

320 
row
;

321 
check
;

323 
	`a_as£π
(
èbÀName
 && *tableName);

324 
	`a_as£π
(
cﬁumnName
 && *columnName);

325 
	`a_as£π
(
keyLa°
 && *keyLast);

329 
row
 = 0;

330 
key
 = 
NULL
;

332 (((
check
 = 
	`dbRódSå
(
didUM
, 
èbÀName
, 
cﬁumnName
, 
row
++,

333 &
key
)Ë=0Ë|| (
check
 =
DB_ERR_ROW_DELETED
)) &&

334 ((
key
 =
NULL
Ë|| (
	`g°rcmp
(key, 
keyLa°
) != 0))) {

339 i‡(!
key
 || 
	`g°rcmp
(key, 
keyLa°
) != 0) {

340  
NULL
;

345 ((
check
 = 
	`dbRódSå
(
didUM
, 
èbÀName
, 
cﬁumnName
, 
row
++, &
key
))

346 =0Ë|| (
check
 =
DB_ERR_ROW_DELETED
)) {

347 i‡(
key
 && *key && (
	`g°rcmp
(key, 
keyLa°
) != 0)) {

348  
key
;

352  
NULL
;

353 
	}
}

360 
	$umAddU£r
(
ch¨_t
 *
u£r
, ch¨_à*
∑ss
, ch¨_à*
group
,

361 
boﬁ_t
 
¥Ÿ
, boﬁ_à
dißbÀd
)

363 
row
;

364 
ch¨_t
 *
∑ssw‹d
;

366 
	`a_as£π
(
u£r
 && *user);

367 
	`a_as£π
(
∑ss
 && *pass);

368 
	`a_as£π
(
group
 && *group);

370 
	`åa˚
(3, 
	`T
("UM: Addög U£∏<%s>\n"), 
u£r
);

375 i‡(
	`umU£rExi°s
(
u£r
)) {

376  
UM_ERR_DUPLICATE
;

382 i‡(!
	`umCheckName
(
u£r
)) {

383  
UM_ERR_BAD_NAME
;

386 i‡(!
	`umCheckName
(
∑ss
)) {

387  
UM_ERR_BAD_PASSWORD
;

393 i‡(!
	`umGroupExi°s
(
group
)) {

394  
UM_ERR_NOT_FOUND
;

400 
row
 = 
	`dbAddRow
(
didUM
, 
UM_USER_TABLENAME
);

402 i‡(
row
 < 0) {

403  
UM_ERR_GENERAL
;

406 i‡(
	`dbWrôeSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
row
, 
u£r
) != 0) {

407  
UM_ERR_GENERAL
;

410 
∑ssw‹d
 = 
	`b°rdup
(
B_L
, 
∑ss
);

411 
	`umEn¸y±Såög
(
∑ssw‹d
);

412 
	`dbWrôeSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PASS
, 
row
, 
∑ssw‹d
);

413 
	`b‰ì
(
B_L
, 
∑ssw‹d
);

414 
	`dbWrôeSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_GROUP
, 
row
, 
group
);

415 
	`dbWrôeI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PROT
, 
row
, 
¥Ÿ
);

416 
	`dbWrôeI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_DISABLE
, 
row
, 
dißbÀd
);

419 
	}
}

426 
	$umDñëeU£r
(
ch¨_t
 *
u£r
)

428 
row
;

430 
	`a_as£π
(
u£r
 && *user);

431 
	`åa˚
(3, 
	`T
("UM: Dñëög U£∏<%s>\n"), 
u£r
);

435 i‡(
	`umGëU£rPrŸe˘ed
(
u£r
)) {

436  
UM_ERR_PROTECTED
;

442 i‡((
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0)) >= 0) {

443  
	`dbDñëeRow
(
didUM
, 
UM_USER_TABLENAME
, 
row
);

446  
UM_ERR_NOT_FOUND
;

447 
	}
}

455 
ch¨_t
 *
	$umGëFú°U£r
()

457  
	`umGëFú°RowD©a
(
UM_USER_TABLENAME
, 
UM_NAME
);

458 
	}
}

466 
ch¨_t
 *
	$umGëNextU£r
(
ch¨_t
 *
u£rLa°
)

468  
	`umGëNextRowD©a
(
UM_USER_TABLENAME
, 
UM_NAME
, 
u£rLa°
);

469 
	}
}

476 
boﬁ_t
 
	$umU£rExi°s
(
ch¨_t
 *
u£r
)

478 
	`a_as£π
(
u£r
 && *user);

480 i‡(
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0) >= 0) {

481  
TRUE
;

483  
FALSE
;

485 
	}
}

492 
ch¨_t
 *
	$umGëU£rPassw‹d
(
ch¨_t
 *
u£r
)

494 
ch¨_t
 *
∑ssw‹d
;

495 
row
;

497 
	`a_as£π
(
u£r
 && *user);

499 
∑ssw‹d
 = 
NULL
;

500 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

502 i‡(
row
 >= 0) {

503 
ch¨_t
 *
∑ss
 = 
NULL
;

504 
	`dbRódSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PASS
, 
row
, &
∑ss
);

510 
∑ssw‹d
 = 
	`b°rdup
(
B_L
, 
∑ss
);

511 
	`umEn¸y±Såög
(
∑ssw‹d
);

514  
∑ssw‹d
;

515 
	}
}

523 
	$umSëU£rPassw‹d
(
ch¨_t
 *
u£r
, ch¨_à*
∑ss
)

525 
row
, 
nRë
;

526 
ch¨_t
 *
∑ssw‹d
;

528 
	`a_as£π
(
u£r
 && *user);

529 
	`a_as£π
(
∑ss
 && *pass);

530 
	`åa˚
(3, 
	`T
("UM: Aâem±ögÅÿch™gêthê∑ssw‹d f‹ u£∏<%s>\n"), 
u£r
);

534 i‡((
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0)) < 0) {

535  
UM_ERR_NOT_FOUND
;

538 
∑ssw‹d
 = 
	`b°rdup
(
B_L
, 
∑ss
);

539 
	`umEn¸y±Såög
(
∑ssw‹d
);

540 
nRë
 = 
	`dbWrôeSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PASS
, 
row
, 
∑ssw‹d
);

541 
	`b‰ì
(
B_L
, 
∑ssw‹d
);

543  
nRë
;

544 
	}
}

551 
ch¨_t
 *
	$umGëU£rGroup
(
ch¨_t
 *
u£r
)

553 
ch¨_t
 *
group
;

554 
row
;

556 
	`a_as£π
(
u£r
 && *user);

557 
group
 = 
NULL
;

561 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

563 i‡(
row
 >= 0) {

564 
	`dbRódSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_GROUP
, 
row
, &
group
);

567  
group
;

568 
	}
}

575 
	$umSëU£rGroup
(
ch¨_t
 *
u£r
, ch¨_à*
group
)

577 
row
;

579 
	`a_as£π
(
u£r
 && *user);

580 
	`a_as£π
(
group
 && *group);

584 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

586 i‡(
row
 >= 0) {

587  
	`dbWrôeSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_GROUP
, 
row
, 
group
);

589  
UM_ERR_NOT_FOUND
;

591 
	}
}

599 
boﬁ_t
 
	$umGëU£rE«bÀd
(
ch¨_t
 *
u£r
)

601 
dißbÀd
, 
row
;

603 
	`a_as£π
(
u£r
 && *user);

605 
dißbÀd
 = 1;

609 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

611 i‡(
row
 >= 0) {

612 
	`dbRódI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_DISABLE
, 
row
, &
dißbÀd
);

615  (
boﬁ_t
)!
dißbÀd
;

616 
	}
}

622 
	$umSëU£rE«bÀd
(
ch¨_t
 *
u£r
, 
boﬁ_t
 
íabÀd
)

624 
row
;

626 
	`a_as£π
(
u£r
 && *user);

630 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

631 i‡(
row
 >= 0) {

632  
	`dbWrôeI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_DISABLE
, 
row
, !
íabÀd
);

634  
UM_ERR_NOT_FOUND
;

636 
	}
}

643 
boﬁ_t
 
	$umGëU£rPrŸe˘ed
(
ch¨_t
 *
u£r
)

645 
¥Ÿe˘
, 
row
;

647 
	`a_as£π
(
u£r
 && *user);

651 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

652 
¥Ÿe˘
 = 
FALSE
;

654 i‡(
row
 >= 0) {

655 
	`dbRódI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PROT
, 
row
, &
¥Ÿe˘
);

658  (
boﬁ_t
)
¥Ÿe˘
;

659 
	}
}

665 
	$umSëU£rPrŸe˘ed
(
ch¨_t
 *
u£r
, 
boﬁ_t
 
¥Ÿe˘
)

667 
row
;

669 
	`a_as£π
(
u£r
 && *user);

673 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_NAME
, 
u£r
, 0);

675 i‡(
row
 >= 0) {

676  
	`dbWrôeI¡
(
didUM
, 
UM_USER_TABLENAME
, 
UM_PROT
, 
row
, 
¥Ÿe˘
);

678  
UM_ERR_NOT_FOUND
;

680 
	}
}

688 
	$umAddGroup
(
ch¨_t
 *
group
, 
¥iv
, 
ac˚ssMëh_t
 
am
,

689 
boﬁ_t
 
¥Ÿ
, boﬁ_à
dißbÀd
)

691 
row
;

693 
	`a_as£π
(
group
 && *group);

694 
	`åa˚
(3, 
	`T
("UM: Addög grou∞<%s>\n"), 
group
);

699 i‡(
	`umGroupExi°s
(
group
)) {

700  
UM_ERR_DUPLICATE
;

706 i‡(!
	`umCheckName
(
group
)) {

707  
UM_ERR_BAD_NAME
;

713 i‡((
row
 = 
	`dbAddRow
(
didUM
, 
UM_GROUP_TABLENAME
)) < 0) {

714  
UM_ERR_GENERAL
;

720 i‡(
	`dbWrôeSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
row
, 
group
) != 0) {

721  
UM_ERR_GENERAL
;

727 
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PRIVILEGE
, 
row
, 
¥iv
);

728 
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_METHOD
, 
row
, (Ë
am
);

729 
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PROT
, 
row
, 
¥Ÿ
);

730 
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_DISABLE
, 
row
, 
dißbÀd
);

733 
	}
}

740 
	$umDñëeGroup
(
ch¨_t
 *
group
)

742 
row
;

744 
	`a_as£π
(
group
 && *group);

745 
	`åa˚
(3, 
	`T
("UM: Dñëög Grou∞<%s>\n"), 
group
);

750 i‡(
	`umGëGroupInU£
(
group
)) {

751  
UM_ERR_IN_USE
;

757 i‡(
	`umGëGroupPrŸe˘ed
(
group
)) {

758  
UM_ERR_PROTECTED
;

764 i‡((
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0)) < 0) {

765  
UM_ERR_NOT_FOUND
;

768  
	`dbDñëeRow
(
didUM
, 
UM_GROUP_TABLENAME
, 
row
);

769 
	}
}

776 
boﬁ_t
 
	$umGroupExi°s
(
ch¨_t
 *
group
)

778 
	`a_as£π
(
group
 && *group);

780 i‡(
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0) >= 0) {

781  
TRUE
;

783  
FALSE
;

785 
	}
}

794 
boﬁ_t
 
	$umGëGroupInU£
(
ch¨_t
 *
group
)

796 
	`a_as£π
(
group
 && *group);

801 i‡(
	`dbSórchSå
(
didUM
, 
UM_USER_TABLENAME
, 
UM_GROUP
, 
group
, 0) >= 0) {

802  
TRUE
;

808 i‡(
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_GROUP
, 
group
, 0) >= 0) {

809  
TRUE
;

812  
FALSE
;

813 
	}
}

821 
ch¨_t
 *
	$umGëFú°Group
()

823  
	`umGëFú°RowD©a
(
UM_GROUP_TABLENAME
, 
UM_NAME
);

824 
	}
}

832 
ch¨_t
 *
	$umGëNextGroup
(
ch¨_t
 *
groupLa°
)

834  
	`umGëNextRowD©a
(
UM_GROUP_TABLENAME
, 
UM_NAME
, 
groupLa°
);

835 
	}
}

842 
ac˚ssMëh_t
 
	$umGëGroupAc˚ssMëhod
(
ch¨_t
 *
group
)

844 
am
, 
row
;

846 
	`a_as£π
(
group
 && *group);

847 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

849 i‡(
row
 >= 0) {

850 
	`dbRódI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_METHOD
, 
row
, (*)&
am
);

852 
am
 = 
AM_INVALID
;

855  (
ac˚ssMëh_t
Ë
am
;

856 
	}
}

863 
	$umSëGroupAc˚ssMëhod
(
ch¨_t
 *
group
, 
ac˚ssMëh_t
 
am
)

865 
row
;

867 
	`a_as£π
(
group
 && *group);

868 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

870 i‡(
row
 >= 0) {

871  
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_METHOD
, 
row
, (Ë
am
);

873  
UM_ERR_NOT_FOUND
;

875 
	}
}

882 
	$umGëGroupPrivûege
(
ch¨_t
 *
group
)

884 
¥ivûege
, 
row
;

886 
	`a_as£π
(
group
 && *group);

887 
¥ivûege
 = -1;

888 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

890 i‡(
row
 >= 0) {

891 
	`dbRódI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PRIVILEGE
, 
row
, &
¥ivûege
);

894  (Ë
¥ivûege
;

895 
	}
}

902 
	$umSëGroupPrivûege
(
ch¨_t
 *
group
, 
¥ivûege
)

904 
row
;

906 
	`a_as£π
(
group
 && *group);

907 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

909 i‡(
row
 >= 0) {

910  
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PRIVILEGE
, 
row
,

911 ()
¥ivûege
);

913  
UM_ERR_NOT_FOUND
;

915 
	}
}

923 
boﬁ_t
 
	$umGëGroupE«bÀd
(
ch¨_t
 *
group
)

925 
dißbÀd
, 
row
;

927 
	`a_as£π
(
group
 && *group);

928 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

929 
dißbÀd
 = 1;

931 i‡(
row
 >= 0) {

932 
	`dbRódI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_DISABLE
, 
row
, &
dißbÀd
);

935  (
boﬁ_t
Ë!
dißbÀd
;

936 
	}
}

943 
	$umSëGroupE«bÀd
(
ch¨_t
 *
group
, 
boﬁ_t
 
íabÀd
)

945 
row
;

947 
	`a_as£π
(
group
 && *group);

948 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

950 i‡(
row
 >= 0) {

951  
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_DISABLE
, 
row
,

952 (Ë!
íabÀd
);

954  
UM_ERR_NOT_FOUND
;

956 
	}
}

964 
boﬁ_t
 
	$umGëGroupPrŸe˘ed
(
ch¨_t
 *
group
)

966 
¥Ÿe˘
, 
row
;

968 
	`a_as£π
(
group
 && *group);

970 
¥Ÿe˘
 = 0;

971 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

972 i‡(
row
 >= 0) {

973 
	`dbRódI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PROT
, 
row
, &
¥Ÿe˘
);

976  (
boﬁ_t
Ë
¥Ÿe˘
;

977 
	}
}

984 
	$umSëGroupPrŸe˘ed
(
ch¨_t
 *
group
, 
boﬁ_t
 
¥Ÿe˘
)

986 
row
;

988 
	`a_as£π
(
group
 && *group);

989 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_NAME
, 
group
, 0);

991 i‡(
row
 >= 0) {

992  
	`dbWrôeI¡
(
didUM
, 
UM_GROUP_TABLENAME
, 
UM_PROT
, 
row
,

993 (Ë
¥Ÿe˘
);

995  
UM_ERR_NOT_FOUND
;

997 
	}
}

1005 
	$umAddAc˚ssLimô
(
ch¨_t
 *
uæ
, 
ac˚ssMëh_t
 
am
, 
£cuª
, ch¨_à*
group
)

1007 
row
;

1009 
	`a_as£π
(
uæ
 && *url);

1010 
	`åa˚
(3, 
	`T
("UM: Addög Ac˚s†Limô f‹ <%s>\n"), 
uæ
);

1015 i‡(
	`umAc˚ssLimôExi°s
(
uæ
)) {

1016  
UM_ERR_DUPLICATE
;

1022 i‡((
row
 = 
	`dbAddRow
(
didUM
, 
UM_ACCESS_TABLENAME
)) < 0) {

1023  
UM_ERR_GENERAL
;

1029 if(
	`dbWrôeSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
row
, 
uæ
) < 0) {

1030  
UM_ERR_GENERAL
;

1036 
	`dbWrôeI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_METHOD
, 
row
, ()
am
);

1037 
	`dbWrôeI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_SECURE
, 
row
, ()
£cuª
);

1038 
	`dbWrôeSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_GROUP
, 
row
, 
group
);

1041 
	}
}

1048 
	$umDñëeAc˚ssLimô
(
ch¨_t
 *
uæ
)

1050 
row
;

1052 
	`a_as£π
(
uæ
 && *url);

1053 
	`åa˚
(3, 
	`T
("UM: Dñëög Ac˚s†Limô f‹ <%s>\n"), 
uæ
);

1057 i‡((
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0)) < 0) {

1058  
UM_ERR_NOT_FOUND
;

1061  
	`dbDñëeRow
(
didUM
, 
UM_ACCESS_TABLENAME
, 
row
);

1062 
	}
}

1069 
ch¨_t
 *
	$umGëFú°Ac˚ssLimô
()

1071  
	`umGëFú°RowD©a
(
UM_ACCESS_TABLENAME
, 
UM_NAME
);

1072 
	}
}

1080 
ch¨_t
 *
	$umGëNextAc˚ssLimô
(
ch¨_t
 *
uæLa°
)

1082  
	`umGëNextRowD©a
(
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæLa°
);

1083 
	}
}

1090 
boﬁ_t
 
	$umAc˚ssLimôExi°s
(
ch¨_t
 *
uæ
)

1092 
	`a_as£π
(
uæ
 && *url);

1094 i‡(
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0) < 0) {

1095  
FALSE
;

1097  
TRUE
;

1099 
	}
}

1106 
ac˚ssMëh_t
 
	$umGëAc˚ssLimôMëhod
(
ch¨_t
 *
uæ
)

1108 
am
, 
row
;

1110 
am
 = (Ë
AM_INVALID
;

1111 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1113 i‡(
row
 >= 0) {

1114 
	`dbRódI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_METHOD
, 
row
, &
am
);

1117  (
ac˚ssMëh_t
Ë
am
;

1118 
	}
}

1125 
	$umSëAc˚ssLimôMëhod
(
ch¨_t
 *
uæ
, 
ac˚ssMëh_t
 
am
)

1127 
row
;

1129 
	`a_as£π
(
uæ
 && *url);

1130 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1132 i‡(
row
 >= 0) {

1133  
	`dbWrôeI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_METHOD
, 
row
, (Ë
am
);

1135  
UM_ERR_NOT_FOUND
;

1137 
	}
}

1144 
	$umGëAc˚ssLimôSecuª
(
ch¨_t
 *
uæ
)

1146 
£cuª
, 
row
;

1148 
	`a_as£π
(
uæ
 && *url);

1149 
£cuª
 = -1;

1150 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1152 i‡(
row
 >= 0) {

1153 
	`dbRódI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_SECURE
, 
row
, &
£cuª
);

1156  ()
£cuª
;

1157 
	}
}

1164 
	$umSëAc˚ssLimôSecuª
(
ch¨_t
 *
uæ
, 
£cuª
)

1166 
row
;

1168 
	`a_as£π
(
uæ
 && *url);

1169 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1171 i‡(
row
 >= 0) {

1172  
	`dbWrôeI¡
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_SECURE
, 
row
,

1173 ()
£cuª
);

1175  
UM_ERR_NOT_FOUND
;

1177 
	}
}

1184 
ch¨_t
 *
	$umGëAc˚ssLimôGroup
(
ch¨_t
 *
uæ
)

1186 
ch¨_t
 *
group
;

1187 
row
;

1189 
	`a_as£π
(
uæ
 && *url);

1190 
group
 = 
NULL
;

1191 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1193 i‡(
row
 >= 0) {

1194 
	`dbRódSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_GROUP
, 
row
, &
group
);

1197  
group
;

1198 
	}
}

1205 
	$umSëAc˚ssLimôGroup
(
ch¨_t
 *
uæ
, ch¨_à*
group
)

1207 
row
;

1209 
	`a_as£π
(
uæ
 && *url);

1210 
row
 = 
	`dbSórchSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_NAME
, 
uæ
, 0);

1212 i‡(
row
 >= 0) {

1213  
	`dbWrôeSå
(
didUM
, 
UM_ACCESS_TABLENAME
, 
UM_GROUP
, 
row
, 
group
);

1215  
UM_ERR_NOT_FOUND
;

1217 
	}
}

1225 
ch¨_t
 *
	$umGëAc˚ssLimô
(
ch¨_t
 *
uæ
)

1227 
ch¨_t
 *
uæRë
, *
uæCheck
, *
œ°Ch¨
;

1228 
Àn
;

1230 
	`a_as£π
(
uæ
 && *url);

1231 
uæRë
 = 
NULL
;

1232 
uæCheck
 = 
	`b°rdup
(
B_L
, 
uæ
);

1233 
	`a_as£π
(
uæCheck
);

1234 
Àn
 = 
	`g°æí
(
uæCheck
);

1238 
Àn
 && !
uæRë
) {

1239 i‡(
	`umAc˚ssLimôExi°s
(
uæCheck
)) {

1240 
uæRë
 = 
	`b°rdup
(
B_L
, 
uæCheck
);

1245 
œ°Ch¨
 = 
uæCheck
 + 
Àn
;

1246 
œ°Ch¨
--;

1248 (
œ°Ch¨
 >
uæCheck
) && ((*lastChar == '/') ||

1249 (*
œ°Ch¨
 == '\\'))) {

1250 *
œ°Ch¨
 = 0;

1251 
œ°Ch¨
--;

1254 (
œ°Ch¨
 >
uæCheck
) && (*lastChar != '/') &&

1255 (*
œ°Ch¨
 != '\\')) {

1256 *
œ°Ch¨
 = 0;

1257 
œ°Ch¨
--;

1260 
Àn
 = 
	`g°æí
(
uæCheck
);

1263 
	`b‰ì
 (
B_L
, 
uæCheck
);

1265  
uæRë
;

1266 
	}
}

1273 
ac˚ssMëh_t
 
	$umGëAc˚ssMëhodF‹URL
(
ch¨_t
 *
uæ
)

1275 
ac˚ssMëh_t
 
amRë
;

1276 
ch¨_t
 *
uæHavögLimô
, *
group
;

1278 
uæHavögLimô
 = 
	`umGëAc˚ssLimô
(
uæ
);

1279 i‡(
uæHavögLimô
) {

1280 
group
 = 
	`umGëAc˚ssLimôGroup
(
uæHavögLimô
);

1282 i‡(
group
 && *group) {

1283 
amRë
 = 
	`umGëGroupAc˚ssMëhod
(
group
);

1285 
amRë
 = 
	`umGëAc˚ssLimôMëhod
(
uæHavögLimô
);

1288 
	`b‰ì
(
B_L
, 
uæHavögLimô
);

1290 
amRë
 = 
AM_FULL
;

1293  
amRë
;

1294 
	}
}

1301 
boﬁ_t
 
	$umU£rC™Ac˚ssURL
(
ch¨_t
 *
u£r
, ch¨_à*
uæ
)

1303 
ac˚ssMëh_t
 
amURL
;

1304 
ch¨_t
 *
group
, *
u£rgroup
, *
uæHavögLimô
;

1305 
¥iv
;

1307 
	`a_as£π
(
u£r
 && *user);

1308 
	`a_as£π
(
uæ
 && *url);

1313 i‡(!
	`umU£rExi°s
(
u£r
)) {

1314  
FALSE
;

1320 i‡(!
	`umGëU£rE«bÀd
(
u£r
)) {

1321  
FALSE
;

1327 
u£rgroup
 = 
	`umGëU£rGroup
(
u£r
);

1328 
¥iv
 = 
	`umGëGroupPrivûege
(
u£rgroup
);

1329 i‡(
¥iv
 == 0) {

1330  
FALSE
;

1336 i‡(!
	`umGëGroupE«bÀd
(
u£rgroup
)) {

1337  
FALSE
;

1343 i‡(
	`umGëGroupAc˚ssMëhod
(
u£rgroup
Ë=
AM_NONE
) {

1344  
FALSE
;

1350 
uæHavögLimô
 = 
	`umGëAc˚ssLimô
(
uæ
);

1351 i‡(
uæHavögLimô
) {

1352 
amURL
 = 
	`umGëAc˚ssLimôMëhod
(
uæHavögLimô
);

1353 
group
 = 
	`umGëAc˚ssLimôGroup
(
uæHavögLimô
);

1354 
	`b‰ì
(
B_L
, 
uæHavögLimô
);

1359  
TRUE
;

1366 i‡(
amURL
 =
AM_NONE
) {

1367  
FALSE
;

1374 i‡(
group
 && *group) {

1375 i‡(
u£rgroup
 && (
	`g°rcmp
(
group
, usergroup) != 0)) {

1376  
FALSE
;

1384  
TRUE
;

1386 
	}
}

1393 
boﬁ_t
 
	$umCheckName
(
ch¨_t
 *
«me
)

1395 
	`a_as£π
(
«me
 && *name);

1397 i‡(
«me
 && *name) {

1398 *
«me
) {

1399 i‡(
	`gis•a˚
(*
«me
)) {

1400  
FALSE
;

1403 
«me
++;

1406  
TRUE
;

1409  
FALSE
;

1410 
	}
}

	@um.h

10 #i‚de‡
_h_UM


11 
	#_h_UM
 1

	)

23 
	~"uemf.h
"

30 
	#UM_OK
 0

	)

31 
	#UM_ERR_GENERAL
 -1

	)

32 
	#UM_ERR_NOT_FOUND
 -2

	)

33 
	#UM_ERR_PROTECTED
 -3

	)

34 
	#UM_ERR_DUPLICATE
 -4

	)

35 
	#UM_ERR_IN_USE
 -5

	)

36 
	#UM_ERR_BAD_NAME
 -6

	)

37 
	#UM_ERR_BAD_PASSWORD
 -7

	)

42 
	#PRIV_NONE
 0x00

	)

43 
	#PRIV_READ
 0x01

	)

44 
	#PRIV_WRITE
 0x02

	)

45 
	#PRIV_ADMIN
 0x04

	)

50 
	tboﬁ_t
;

52 #i‚de‡
TRUE


53 
	#TRUE
 1

	)

56 #i‚de‡
FALSE


57 
	#FALSE
 0

	)

61 
	mAM_NONE
 = 0,

62 
	mAM_FULL
,

63 
	mAM_BASIC
,

64 
	mAM_DIGEST
,

65 
	mAM_INVALID


66 } 
	tac˚ssMëh_t
;

73 
umO≥n
();

78 
umClo£
();

83 
umCommô
(
ch¨_t
 *
fûíame
);

88 
umRe°‹e
(
ch¨_t
 *
fûíame
);

93 
umAddU£r
(
ch¨_t
 *
u£r
, ch¨_à*
∑ssw‹d
,

94 
ch¨_t
 *
group
, 
boﬁ_t
 
¥Ÿe˘
, boﬁ_à
dißbÀd
);

96 
umDñëeU£r
(
ch¨_t
 *
u£r
);

98 
ch¨_t
 *
umGëFú°U£r
();

99 
ch¨_t
 *
umGëNextU£r
(ch¨_à*
œ°U£r
);

101 
boﬁ_t
 
umU£rExi°s
(
ch¨_t
 *
u£r
);

103 
ch¨_t
 *
umGëU£rPassw‹d
(ch¨_à*
u£r
);

104 
umSëU£rPassw‹d
(
ch¨_t
 *
u£r
, ch¨_à*
∑ssw‹d
);

106 
ch¨_t
 *
umGëU£rGroup
(ch¨_à*
u£r
);

107 
umSëU£rGroup
(
ch¨_t
 *
u£r
, ch¨_à*
∑ssw‹d
);

109 
boﬁ_t
 
umGëU£rE«bÀd
(
ch¨_t
 *
u£r
);

110 
umSëU£rE«bÀd
(
ch¨_t
 *
u£r
, 
boﬁ_t
 
íabÀd
);

112 
boﬁ_t
 
umGëU£rPrŸe˘ed
(
ch¨_t
 *
u£r
);

113 
umSëU£rPrŸe˘ed
(
ch¨_t
 *
u£r
, 
boﬁ_t
 
¥Ÿe˘
);

118 
umAddGroup
(
ch¨_t
 *
group
, 
¥ivûege
,

119 
ac˚ssMëh_t
 
am
, 
boﬁ_t
 
¥Ÿe˘
, boﬁ_à
dißbÀd
);

121 
umDñëeGroup
(
ch¨_t
 *
group
);

123 
ch¨_t
 *
umGëFú°Group
();

124 
ch¨_t
 *
umGëNextGroup
(ch¨_à*
œ°U£r
);

126 
boﬁ_t
 
umGroupExi°s
(
ch¨_t
 *
group
);

127 
boﬁ_t
 
umGëGroupInU£
(
ch¨_t
 *
group
);

129 
ac˚ssMëh_t
 
umGëGroupAc˚ssMëhod
(
ch¨_t
 *
group
);

130 
umSëGroupAc˚ssMëhod
(
ch¨_t
 *
group
, 
ac˚ssMëh_t
 
am
);

132 
boﬁ_t
 
umGëGroupE«bÀd
(
ch¨_t
 *
group
);

133 
umSëGroupE«bÀd
(
ch¨_t
 *
group
, 
boﬁ_t
 
íabÀd
);

135 
umGëGroupPrivûege
(
ch¨_t
 *
group
);

136 
umSëGroupPrivûege
(
ch¨_t
 *
group
, 
¥ivûeges
);

138 
boﬁ_t
 
umGëGroupPrŸe˘ed
(
ch¨_t
 *
group
);

139 
umSëGroupPrŸe˘ed
(
ch¨_t
 *
group
, 
boﬁ_t
 
¥Ÿe˘
);

144 
umAddAc˚ssLimô
(
ch¨_t
 *
uæ
, 
ac˚ssMëh_t
 
am
,

145 
£cuª
, 
ch¨_t
 *
group
);

147 
umDñëeAc˚ssLimô
(
ch¨_t
 *
uæ
);

149 
ch¨_t
 *
umGëFú°Ac˚ssLimô
();

150 
ch¨_t
 *
umGëNextAc˚ssLimô
(ch¨_à*
œ°U£r
);

155 
ch¨_t
 *
umGëAc˚ssLimô
(ch¨_à*
uæ
);

157 
boﬁ_t
 
umAc˚ssLimôExi°s
(
ch¨_t
 *
uæ
);

159 
ac˚ssMëh_t
 
umGëAc˚ssLimôMëhod
(
ch¨_t
 *
uæ
);

160 
umSëAc˚ssLimôMëhod
(
ch¨_t
 *
uæ
, 
ac˚ssMëh_t
 
am
);

162 
umGëAc˚ssLimôSecuª
(
ch¨_t
 *
uæ
);

163 
umSëAc˚ssLimôSecuª
(
ch¨_t
 *
uæ
, 
£cuª
);

165 
ch¨_t
 *
umGëAc˚ssLimôGroup
(ch¨_à*
uæ
);

166 
umSëAc˚ssLimôGroup
(
ch¨_t
 *
uæ
, ch¨_à*
group
);

172 
ac˚ssMëh_t
 
umGëAc˚ssMëhodF‹URL
(
ch¨_t
 *
uæ
);

173 
boﬁ_t
 
umU£rC™Ac˚ssURL
(
ch¨_t
 *
u£r
, ch¨_à*
uæ
);

	@umui.c

18 
	~"wsI¡∫.h
"

19 
	~"um.h
"

23 
	#NONE_OPTION
 
	`T
("<NONE>")

	)

24 
	#MSG_START
 
	`T
("<body><h2>")

	)

25 
	#MSG_END
 
	`T
("</h2></body>")

	)

29 
f‹mAddU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

30 
f‹mDñëeU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

31 
f‹mDi•œyU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

32 
a•Gíî©eU£rLi°
(
eid
, 
webs_t
 
wp
,

33 
¨gc
, 
ch¨_t
 **
¨gv
);

35 
f‹mAddGroup
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

36 
f‹mDñëeGroup
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

37 
a•Gíî©eGroupLi°
(
eid
, 
webs_t
 
wp
,

38 
¨gc
, 
ch¨_t
 **
¨gv
);

40 
f‹mAddAc˚ssLimô
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

41 
f‹mDñëeAc˚ssLimô
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

42 
a•Gíî©eAc˚ssLimôLi°
(
eid
, 
webs_t
 
wp
,

43 
¨gc
, 
ch¨_t
 **
¨gv
);

45 
a•Gíî©eAc˚ssMëhodLi°
(
eid
, 
webs_t
 
wp
,

46 
¨gc
, 
ch¨_t
 **
¨gv
);

47 
a•Gíî©ePrivûegeLi°
(
eid
, 
webs_t
 
wp
,

48 
¨gc
, 
ch¨_t
 **
¨gv
);

50 
f‹mSaveU£rM™agemít
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

51 
f‹mLﬂdU£rM™agemít
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
);

53 
websMsgSèπ
(
webs_t
 
wp
);

54 
websMsgEnd
(
webs_t
 
wp
);

61 
	$f‹mDeföeU£rMgmt
()

63 
	`websA•Deföe
(
	`T
("MakeGroupLi°"), 
a•Gíî©eGroupLi°
);

64 
	`websA•Deföe
(
	`T
("MakeU£rLi°"), 
a•Gíî©eU£rLi°
);

65 
	`websA•Deföe
(
	`T
("MakeAc˚ssLimôLi°"), 
a•Gíî©eAc˚ssLimôLi°
);

66 
	`websA•Deföe
(
	`T
("MakeAc˚ssMëhodLi°"), 
a•Gíî©eAc˚ssMëhodLi°
);

67 
	`websA•Deföe
(
	`T
("MakePrivûegeLi°"), 
a•Gíî©ePrivûegeLi°
);

69 
	`websF‹mDeföe
(
	`T
("AddU£r"), 
f‹mAddU£r
);

70 
	`websF‹mDeföe
(
	`T
("DñëeU£r"), 
f‹mDñëeU£r
);

71 
	`websF‹mDeföe
(
	`T
("Di•œyU£r"), 
f‹mDi•œyU£r
);

72 
	`websF‹mDeföe
(
	`T
("AddGroup"), 
f‹mAddGroup
);

73 
	`websF‹mDeföe
(
	`T
("DñëeGroup"), 
f‹mDñëeGroup
);

74 
	`websF‹mDeföe
(
	`T
("AddAc˚ssLimô"), 
f‹mAddAc˚ssLimô
);

75 
	`websF‹mDeföe
(
	`T
("DñëeAc˚ssLimô"), 
f‹mDñëeAc˚ssLimô
);

77 
	`websF‹mDeföe
(
	`T
("SaveU£rM™agemít"), 
f‹mSaveU£rM™agemít
);

78 
	`websF‹mDeföe
(
	`T
("LﬂdU£rM™agemít"), 
f‹mLﬂdU£rM™agemít
);

79 
	}
}

86 
	$f‹mAddU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

88 
ch¨_t
 *
u£rid
, *
∑ss1
, *
∑ss2
, *
group
, *
íabÀd
, *
ok
;

89 
boﬁ_t
 
bDißbÀ
;

90 
nCheck
;

92 
	`a_as£π
(
wp
);

94 
u£rid
 = 
	`websGëV¨
(
wp
, 
	`T
("user"), T(""));

95 
∑ss1
 = 
	`websGëV¨
(
wp
, 
	`T
("password"), T(""));

96 
∑ss2
 = 
	`websGëV¨
(
wp
, 
	`T
("passconf"), T(""));

97 
group
 = 
	`websGëV¨
(
wp
, 
	`T
("group"), T(""));

98 
íabÀd
 = 
	`websGëV¨
(
wp
, 
	`T
("enabled"), T(""));

99 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

101 
	`websHódî
(
wp
);

102 
	`websMsgSèπ
(
wp
);

104 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

105 
	`websWrôe
(
wp
, 
	`T
("Add User Cancelled"));

106 } i‡(
	`g°rcmp
(
∑ss1
, 
∑ss2
) != 0) {

107 
	`websWrôe
(
wp
, 
	`T
("Confirmation Password didÇot match."));

109 i‡(
íabÀd
 && *íabÀd && (
	`g°rcmp
”«bÀd, 
	`T
("on")) == 0)) {

110 
bDißbÀ
 = 
FALSE
;

112 
bDißbÀ
 = 
TRUE
;

115 
nCheck
 = 
	`umAddU£r
(
u£rid
, 
∑ss1
, 
group
, 0, 
bDißbÀ
);

116 i‡(
nCheck
 != 0) {

117 
ch¨_t
 * 
°rEº‹
;

119 
nCheck
) {

120 
UM_ERR_DUPLICATE
:

121 
°rEº‹
 = 
	`T
("UserálreadyÉxists.");

124 
UM_ERR_BAD_NAME
:

125 
°rEº‹
 = 
	`T
("Invalid userÇame.");

128 
UM_ERR_BAD_PASSWORD
:

129 
°rEº‹
 = 
	`T
("InvalidÖassword.");

132 
UM_ERR_NOT_FOUND
:

133 
°rEº‹
 = 
	`T
("Invalid or unselected group.");

137 
°rEº‹
 = 
	`T
("Error writing userÑecord.");

141 
	`websWrôe
(
wp
, 
	`T
("UnableÅoádd user, \"%s\". %s"),

142 
u£rid
, 
°rEº‹
);

144 
	`websWrôe
(
wp
, 
	`T
("User, \"%s\" was successfullyádded."),

145 
u£rid
);

149 
	`websMsgEnd
(
wp
);

150 
	`websFoŸî
(
wp
);

151 
	`websD⁄e
(
wp
, 200);

152 
	}
}

159 
	$f‹mDñëeU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

161 
ch¨_t
 *
u£rid
, *
ok
;

163 
	`a_as£π
(
wp
);

165 
u£rid
 = 
	`websGëV¨
(
wp
, 
	`T
("user"), T(""));

166 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

168 
	`websHódî
(
wp
);

169 
	`websMsgSèπ
(
wp
);

171 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

172 
	`websWrôe
(
wp
, 
	`T
("Delete User Cancelled"));

173 } i‡(
	`umU£rExi°s
(
u£rid
Ë=
FALSE
) {

174 
	`websWrôe
(
wp
, 
	`T
("ERROR: U£∏\"%s\"ÇŸ found"), 
u£rid
);

175 } i‡(
	`umGëU£rPrŸe˘ed
(
u£rid
)) {

176 
	`websWrôe
(
wp
, 
	`T
("ERROR: U£r, \"%s\" i†dñëe-¥Ÿe˘ed."), 
u£rid
);

177 } i‡(
	`umDñëeU£r
(
u£rid
) != 0) {

178 
	`websWrôe
(
wp
, 
	`T
("ERROR: U«bÀÅÿdñëêu£r, \"%s\" "), 
u£rid
);

180 
	`websWrôe
(
wp
, 
	`T
("U£r, \"%s\" wa†suc˚ssfuŒy dñëed."), 
u£rid
);

183 
	`websMsgEnd
(
wp
);

184 
	`websFoŸî
(
wp
);

185 
	`websD⁄e
(
wp
, 200);

186 
	}
}

193 
	$f‹mDi•œyU£r
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

195 
ch¨_t
 *
u£rid
, *
ok
, *
ãmp
;

196 
boﬁ_t
 
íabÀd
;

198 
	`a_as£π
(
wp
);

200 
u£rid
 = 
	`websGëV¨
(
wp
, 
	`T
("user"), T(""));

201 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

203 
	`websHódî
(
wp
);

204 
	`websWrôe
(
wp
, 
	`T
("<body>"));

206 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

207 
	`websWrôe
(
wp
, 
	`T
("Display User Cancelled"));

208 } i‡(
	`umU£rExi°s
(
u£rid
Ë=
FALSE
) {

209 
	`websWrôe
(
wp
, 
	`T
("ERROR: U£∏<b>%s</b>ÇŸ found.\n"), 
u£rid
);

211 
	`websWrôe
(
wp
, 
	`T
("<h2>U£∏ID: <b>%s</b></h2>\n"), 
u£rid
);

212 
ãmp
 = 
	`umGëU£rGroup
(
u£rid
);

213 
	`websWrôe
(
wp
, 
	`T
("<h3>U£∏Group: <b>%s</b></h3>\n"), 
ãmp
);

214 
íabÀd
 = 
	`umGëU£rE«bÀd
(
u£rid
);

215 
	`websWrôe
(
wp
, 
	`T
("<h3>E«bÀd: <b>%d</b></h3>\n"), 
íabÀd
);

218 
	`websWrôe
(
wp
, 
	`T
("</body>\n"));

219 
	`websFoŸî
(
wp
);

220 
	`websD⁄e
(
wp
, 200);

221 
	}
}

229 
	$a•Gíî©eU£rLi°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

231 
ch¨_t
 *
u£rid
;

232 
row
, 
nByãsSít
, 
nByãs
;

234 
	`a_as£π
(
wp
);

236 
nByãs
 = 
	`websWrôe
(
wp
,

237 
	`T
("<SELECT NAME=\"user\" SIZE=\"3\" TITLE=\"Selectá User\">"));

238 
row
 = 0;

239 
u£rid
 = 
	`umGëFú°U£r
();

240 
nByãsSít
 = 0;

242 
u£rid
 && (
nByãs
 > 0)) {

243 
nByãs
 = 
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%s\">%s\n"),

244 
u£rid
, userid);

245 
u£rid
 = 
	`umGëNextU£r
(userid);

246 
nByãsSít
 +
nByãs
;

249 
nByãsSít
 +
	`websWrôe
(
wp
, 
	`T
("</SELECT>"));

251  
nByãsSít
;

252 
	}
}

259 
	$f‹mAddGroup
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

261 
ch¨_t
 *
group
, *
íabÀd
, *
¥ivûege
, *
mëhod
, *
ok
, *
pCh¨
;

262 
nCheck
;

263 
¥iv
;

264 
ac˚ssMëh_t
 
am
;

265 
boﬁ_t
 
bDißbÀ
;

267 
	`a_as£π
(
wp
);

269 
group
 = 
	`websGëV¨
(
wp
, 
	`T
("group"), T(""));

270 
mëhod
 = 
	`websGëV¨
(
wp
, 
	`T
("method"), T(""));

271 
íabÀd
 = 
	`websGëV¨
(
wp
, 
	`T
("enabled"), T(""));

272 
¥ivûege
 = 
	`websGëV¨
(
wp
, 
	`T
("privilege"), T(""));

273 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

275 
	`websHódî
(
wp
);

276 
	`websMsgSèπ
(
wp
);

278 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

279 
	`websWrôe
(
wp
, 
	`T
("Add Group Cancelled."));

280 } i‡((
group
 =
NULL
) || (*group == 0)) {

281 
	`websWrôe
(
wp
, 
	`T
("No Group Name wasÉntered."));

282 } i‡(
	`umGroupExi°s
(
group
)) {

283 
	`websWrôe
(
wp
, 
	`T
("ERROR: Group, \"%s\"áÃódyÉxi°s."), 
group
);

285 i‡(
¥ivûege
 && *privilege) {

290 
¥iv
 = 0;

291 
pCh¨
 = 
¥ivûege
; *pChar;ÖChar++) {

292 i‡(*
pCh¨
 == ' ') {

293 *
pCh¨
 = '\0';

294 
¥iv
 |
	`g©oi
(
¥ivûege
);

295 *
pCh¨
 = ' ';

296 
¥ivûege
 = 
pCh¨
 + 1;

299 
¥iv
 |
	`g©oi
(
¥ivûege
);

301 
¥iv
 = 0;

304 i‡(
mëhod
 && *method) {

305 
am
 = (
ac˚ssMëh_t
Ë
	`g©oi
(
mëhod
);

307 
am
 = 
AM_FULL
;

310 i‡(
íabÀd
 && *íabÀd && (
	`g°rcmp
”«bÀd, 
	`T
("on")) == 0)) {

311 
bDißbÀ
 = 
FALSE
;

313 
bDißbÀ
 = 
TRUE
;

316 
nCheck
 = 
	`umAddGroup
(
group
, 
¥iv
, 
am
, 0, 
bDißbÀ
);

317 i‡(
nCheck
 != 0) {

318 
	`websWrôe
(
wp
, 
	`T
("UnableÅoádd group, \"%s\", code: %d "),

319 
group
, 
nCheck
);

321 
	`websWrôe
(
wp
, 
	`T
("Group, \"%s\" was successfullyádded."),

322 
group
);

326 
	`websMsgEnd
(
wp
);

327 
	`websFoŸî
(
wp
);

328 
	`websD⁄e
(
wp
, 200);

329 
	}
}

336 
	$f‹mDñëeGroup
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

338 
ch¨_t
 *
group
, *
ok
;

340 
	`a_as£π
(
wp
);

342 
group
 = 
	`websGëV¨
(
wp
, 
	`T
("group"), T(""));

343 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

345 
	`websHódî
(
wp
);

346 
	`websMsgSèπ
(
wp
);

348 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

349 
	`websWrôe
(
wp
, 
	`T
("Delete Group Cancelled."));

350 } i‡((
group
 =
NULL
) || (*group == '\0')) {

351 
	`websWrôe
(
wp
, 
	`T
("ERROR: No group was selected."));

352 } i‡(
	`umGëGroupPrŸe˘ed
(
group
)) {

353 
	`websWrôe
(
wp
, 
	`T
("ERROR: Group, \"%s\" i†dñëe-¥Ÿe˘ed."), 
group
);

354 } i‡(
	`umGëGroupInU£
(
group
)) {

355 
	`websWrôe
(
wp
, 
	`T
("ERROR: Group, \"%s\" i†beög u£d."), 
group
);

356 } i‡(
	`umDñëeGroup
(
group
) != 0) {

357 
	`websWrôe
(
wp
, 
	`T
("ERROR: U«bÀÅÿdñëêgroup, \"%s\" "), 
group
);

359 
	`websWrôe
(
wp
, 
	`T
("Group, \"%s\" wa†suc˚ssfuŒy dñëed."), 
group
);

362 
	`websMsgEnd
(
wp
);

363 
	`websFoŸî
(
wp
);

364 
	`websD⁄e
(
wp
, 200);

365 
	}
}

372 
	$a•Gíî©eGroupLi°
(
eid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
)

374 
ch¨_t
 *
group
;

375 
row
, 
nByãsSít
, 
nByãs
;

377 
	`a_as£π
(
wp
);

379 
row
 = 0;

380 
nByãsSít
 = 0;

381 
nByãs
 = 
	`websWrôe
(
wp
,

382 
	`T
("<SELECT NAME=\"group\" SIZE=\"3\" TITLE=\"Selectá Group\">"));

386 
nByãs
 = 
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"\">[NONE]\n"));

388 
group
 = 
	`umGëFú°Group
();

389 
group
 && (
nByãs
 > 0)) {

390 
nByãs
 = 
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%s\">%s\n"), 
group
, group);

391 
group
 = 
	`umGëNextGroup
(group);

392 
nByãsSít
 +
nByãs
;

395 
nByãsSít
 +
	`websWrôe
(
wp
, 
	`T
("</SELECT>"));

397  
nByãsSít
;

398 
	}
}

405 
	$f‹mAddAc˚ssLimô
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

407 
ch¨_t
 *
uæ
, *
mëhod
, *
group
, *
£cuª
, *
ok
;

408 
nCheck
;

409 
ac˚ssMëh_t
 
am
;

410 
nSecuª
;

412 
	`a_as£π
(
wp
);

414 
uæ
 = 
	`websGëV¨
(
wp
, 
	`T
("url"), T(""));

415 
group
 = 
	`websGëV¨
(
wp
, 
	`T
("group"), T(""));

416 
mëhod
 = 
	`websGëV¨
(
wp
, 
	`T
("method"), T(""));

417 
£cuª
 = 
	`websGëV¨
(
wp
, 
	`T
("secure"), T(""));

418 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

420 
	`websHódî
(
wp
);

421 
	`websMsgSèπ
(
wp
);

423 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

424 
	`websWrôe
(
wp
, 
	`T
("Add Access Limit Cancelled."));

425 } i‡((
uæ
 =
NULL
) || (*url == 0)) {

426 
	`websWrôe
(
wp
, 
	`T
("ERROR: No URL wasÉntered."));

427 } i‡(
	`umAc˚ssLimôExi°s
(
uæ
)) {

428 
	`websWrôe
(
wp
, 
	`T
("ERROR: An Access Limit for [%s]álreadyÉxists."),

429 
uæ
);

431 i‡(
mëhod
 && *method) {

432 
am
 = (
ac˚ssMëh_t
Ë
	`g©oi
(
mëhod
);

434 
am
 = 
AM_FULL
;

437 i‡(
£cuª
 && *secure) {

438 
nSecuª
 = (Ë
	`g©oi
(
£cuª
);

440 
nSecuª
 = 0;

443 
nCheck
 = 
	`umAddAc˚ssLimô
(
uæ
, 
am
, 
nSecuª
, 
group
);

444 i‡(
nCheck
 != 0) {

445 
	`websWrôe
(
wp
, 
	`T
("U«bÀÅÿadd Ac˚s†Limô f‹ [%s]"), 
uæ
);

447 
	`websWrôe
(
wp
, 
	`T
("AccessÜimit for [%s], was successfullyádded."),

448 
uæ
);

452 
	`websMsgEnd
(
wp
);

453 
	`websFoŸî
(
wp
);

454 
	`websD⁄e
(
wp
, 200);

455 
	}
}

462 
	$f‹mDñëeAc˚ssLimô
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

464 
ch¨_t
 *
uæ
, *
ok
;

466 
	`a_as£π
(
wp
);

468 
uæ
 = 
	`websGëV¨
(
wp
, 
	`T
("url"), T(""));

469 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

471 
	`websHódî
(
wp
);

472 
	`websMsgSèπ
(
wp
);

474 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

475 
	`websWrôe
(
wp
, 
	`T
("Delete Access Limit Cancelled"));

476 } i‡(
	`umDñëeAc˚ssLimô
(
uæ
) != 0) {

477 
	`websWrôe
(
wp
, 
	`T
("ERROR: UnableÅo delete Access Limit for [%s]"),

478 
uæ
);

480 
	`websWrôe
(
wp
, 
	`T
("Access Limit for [%s], was successfully deleted."),

481 
uæ
);

484 
	`websMsgEnd
(
wp
);

485 
	`websFoŸî
(
wp
);

486 
	`websD⁄e
(
wp
, 200);

487 
	}
}

494 
	$a•Gíî©eAc˚ssLimôLi°
(
eid
, 
webs_t
 
wp
,

495 
¨gc
, 
ch¨_t
 **
¨gv
)

497 
ch¨_t
 *
uæ
;

498 
row
, 
nByãsSít
, 
nByãs
;

500 
	`a_as£π
(
wp
);

502 
row
 = 
nByãsSít
 = 0;

503 
uæ
 = 
	`umGëFú°Ac˚ssLimô
();

504 
nByãs
 = 
	`websWrôe
(
wp
,

505 
	`T
("<SELECT NAME=\"url\" SIZE=\"3\" TITLE=\"Selectá URL\">"));

507 
uæ
 && (
nByãs
 > 0)) {

508 
nByãs
 = 
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%s\">%s\n"), 
uæ
, url);

509 
uæ
 = 
	`umGëNextAc˚ssLimô
(url);

510 
nByãsSít
 +
nByãs
;

513 
nByãsSít
 +
	`websWrôe
(
wp
, 
	`T
("</SELECT>"));

515  
nByãsSít
;

516 
	}
}

523 
	$a•Gíî©eAc˚ssMëhodLi°
(
eid
, 
webs_t
 
wp
,

524 
¨gc
, 
ch¨_t
 **
¨gv
)

526 
nByãs
;

528 
	`a_as£π
(
wp
);

530 
nByãs
 = 
	`websWrôe
(
wp
,

531 
	`T
("<SELECT NAME=\"method\" SIZE=\"3\" TITLE=\"Selectá Method\">"));

532 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">FULL ACCESS\n"),

533 
AM_FULL
);

534 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">BASIC ACCESS\n"),

535 
AM_BASIC
);

536 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\" SELECTED>DIGEST ACCESS\n"),

537 
AM_DIGEST
);

538 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">NO ACCESS\n"),

539 
AM_NONE
);

540 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("</SELECT>"));

542  
nByãs
;

543 
	}
}

549 
	$a•Gíî©ePrivûegeLi°
(
eid
, 
webs_t
 
wp
,

550 
¨gc
, 
ch¨_t
 **
¨gv
)

552 
nByãs
;

554 
	`a_as£π
(
wp
);

556 
nByãs
 = 
	`websWrôe
(
wp
, 
	`T
("<SELECT NAME=\"privilege\" SIZE=\"3\" "));

557 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("MULTIPLE TITLE=\"Choose Privileges\">"));

558 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">READ\n"), 
PRIV_READ
);

559 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">EXECUTE\n"), 
PRIV_WRITE
);

560 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("<OPTION VALUE=\"%d\">ADMINISTRATE\n"),

561 
PRIV_ADMIN
);

562 
nByãs
 +
	`websWrôe
(
wp
, 
	`T
("</SELECT>"));

564  
nByãs
;

565 
	}
}

572 
	$f‹mSaveU£rM™agemít
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

574 
ch¨_t
 *
ok
;

576 
	`a_as£π
(
wp
);

578 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

580 
	`websHódî
(
wp
);

581 
	`websMsgSèπ
(
wp
);

583 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

584 
	`websWrôe
(
wp
, 
	`T
("Save Cancelled."));

585 } i‡(
	`umCommô
(
NULL
) != 0) {

586 
	`websWrôe
(
wp
, 
	`T
("ERROR: UnableÅo save user configuration."));

588 
	`websWrôe
(
wp
, 
	`T
("User configuration was saved successfully."));

591 
	`websMsgEnd
(
wp
);

592 
	`websFoŸî
(
wp
);

593 
	`websD⁄e
(
wp
, 200);

594 
	}
}

601 
	$f‹mLﬂdU£rM™agemít
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, ch¨_à*
quîy
)

603 
ch¨_t
 *
ok
;

605 
	`a_as£π
(
wp
);

607 
ok
 = 
	`websGëV¨
(
wp
, 
	`T
("ok"), T(""));

609 
	`websHódî
(
wp
);

610 
	`websMsgSèπ
(
wp
);

612 i‡(
	`g°ricmp
(
ok
, 
	`T
("ok")) != 0) {

613 
	`websWrôe
(
wp
, 
	`T
("Load Cancelled."));

614 } i‡(
	`umRe°‹e
(
NULL
) != 0) {

615 
	`websWrôe
(
wp
, 
	`T
("ERROR: UnableÅoÜoad user configuration."));

617 
	`websWrôe
(
wp
, 
	`T
("User configuration wasÑe-loaded successfully."));

620 
	`websMsgEnd
(
wp
);

621 
	`websFoŸî
(
wp
);

622 
	`websD⁄e
(
wp
, 200);

623 
	}
}

630 
	$websMsgSèπ
(
webs_t
 
wp
)

632 
	`websWrôe
(
wp
, 
MSG_START
);

633 
	}
}

635 
	$websMsgEnd
(
webs_t
 
wp
)

637 
	`websWrôe
(
wp
, 
MSG_END
);

638 
	}
}

	@url.c

18 
	~"wsI¡∫.h
"

27 
ch¨_t
 
	ghtmExt
[] = 
T
(".htm");

37 
ch¨_t
 *
	$websUæTy≥
(
ch¨_t
 *
uæ
, ch¨_à*
buf
, 
ch¨C¡
)

39 
sym_t
 *
•
;

40 
ch¨_t
 *
ext
, *
∑r£buf
;

42 
	`a_as£π
(
uæ
 && *url);

43 
	`a_as£π
(
buf
 && 
ch¨C¡
 > 0);

45 i‡(
uæ
 =
NULL
 || *url == '\0') {

46 
	`g°r˝y
(
buf
, 
	`T
("text/plain"));

47  
buf
;

49 i‡(
	`websUæP¨£
(
uæ
, &
∑r£buf
, 
NULL
, NULL, NULL, NULL, NULL,

50 
NULL
, &
ext
) < 0) {

51 
	`g°r˝y
(
buf
, 
	`T
("text/plain"));

52  
buf
;

54 
	`°æowî
(
ext
);

59 i‡((
•
 = 
	`symLookup
(
websMime
, 
ext
)Ë!
NULL
) {

60 
	`g°∫˝y
(
buf
, 
•
->
c⁄ã¡
.
vÆue
.
°rög
, 
ch¨C¡
);

62 
	`g°r˝y
(
buf
, 
	`T
("text/plain"));

64 
	`b‰ì
(
B_L
, 
∑r£buf
);

65  
buf
;

66 
	}
}

74 
	$websUæP¨£
(
ch¨_t
 *
uæ
, ch¨_à**
pbuf
, ch¨_à**
pho°
, ch¨_à**
µ©h
,

75 
ch¨_t
 **
µ‹t
, ch¨_à**
pquîy
, ch¨_à**
µrŸo
, ch¨_à**
±ag
,

76 
ch¨_t
 **
≥xt
)

78 
ch¨_t
 *
tok
, *
˝
, *
ho°
, *
∑th
, *
p‹t
, *
¥Ÿo
, *
èg
, *
quîy
, *
ext
;

79 
ch¨_t
 *
ho°buf
, *
p‹tbuf
, *
buf
;

80 
c
, 
Àn
, 
uÀn
;

82 
	`a_as£π
(
uæ
);

83 
	`a_as£π
(
pbuf
);

85 
uÀn
 = 
	`g°æí
(
uæ
);

91 
Àn
 = 
uÀn
 * 2 + 
MAX_PORT_LEN
 + 3;

92 i‡((
buf
 = 
	`bÆloc
(
B_L
, 
Àn
 * (
ch¨_t
))Ë=
NULL
) {

95 
p‹tbuf
 = &
buf
[
Àn
 - 
MAX_PORT_LEN
 - 1];

96 
ho°buf
 = &
buf
[
uÀn
+1];

101 
	`websDecodeUæ
(
buf
, 
uæ
, 
uÀn
);

103 
uæ
 = 
buf
;

109 
	`°rôﬂ
(
	`websGëP‹t
(), 
p‹tbuf
, 
MAX_PORT_LEN
);

110 
p‹t
 = 
p‹tbuf
;

111 
∑th
 = 
	`T
("/");

112 
¥Ÿo
 = 
	`T
("http");

113 
ho°
 = 
	`T
("localhost");

114 
quîy
 = 
	`T
("");

115 
ext
 = 
htmExt
;

116 
èg
 = 
	`T
("");

118 i‡(
	`g°∫cmp
(
uæ
, 
	`T
("http://"), 7) == 0) {

119 
tok
 = &
uæ
[7];

120 
tok
[-3] = '\0';

121 
¥Ÿo
 = 
uæ
;

122 
ho°
 = 
tok
;

123 
˝
 = 
tok
; *cp; cp++) {

124 i‡(*
˝
 == '/') {

127 i‡(*
˝
 == ':') {

128 *
˝
++ = '\0';

129 
p‹t
 = 
˝
;

130 
tok
 = 
˝
;

133 i‡((
˝
 = 
	`g°rchr
(
tok
, '/')Ë!
NULL
) {

138 
c
 = *
˝
;

139 *
˝
 = '\0';

140 
	`g°∫˝y
(
ho°buf
, 
ho°
, 
uÀn
);

141 
	`g°∫˝y
(
p‹tbuf
, 
p‹t
, 
MAX_PORT_LEN
);

142 *
˝
 = 
c
;

143 
ho°
 = 
ho°buf
;

144 
p‹t
 = 
p‹tbuf
;

145 
∑th
 = 
˝
;

146 
tok
 = 
˝
;

150 
∑th
 = 
uæ
;

151 
tok
 = 
uæ
;

157 i‡((
˝
 = 
	`g°rchr
(
tok
, '?')Ë!
NULL
) {

158 *
˝
++ = '\0';

159 
quîy
 = 
˝
;

160 
∑th
 = 
tok
;

161 
tok
 = 
quîy
;

167 i‡((
˝
 = 
	`g°rchr
(
tok
, '#')Ë!
NULL
) {

168 *
˝
++ = '\0';

169 i‡(*
quîy
 == 0) {

170 
∑th
 = 
tok
;

177 i‡(
≥xt
) {

184 i‡((
˝
 = 
	`g°ºchr
(
∑th
, '.')Ë!
NULL
) {

185 c⁄° 
ch¨_t
* 
g¨bage
 = 
	`T
("/\\");

186 
Àngth
 = 
	`g°rc•n
(
˝
, 
g¨bage
);

187 
g¨bageLígth
 = 
	`g°r•n
(
˝
 + 
Àngth
, 
g¨bage
);

188 
ok
 = (
Àngth
 + 
g¨bageLígth
 =(Ë
	`g°æí
(
˝
));

190 i‡(
ok
) {

191 
˝
[
Àngth
] = '\0';

192 #ifde‡
WIN32


193 
	`°æowî
(
˝
);

195 
ext
 = 
˝
;

203 i‡(
pho°
)

204 *
pho°
 = 
ho°
;

205 i‡(
µ©h
)

206 *
µ©h
 = 
∑th
;

207 i‡(
µ‹t
)

208 *
µ‹t
 = 
p‹t
;

209 i‡(
µrŸo
)

210 *
µrŸo
 = 
¥Ÿo
;

211 i‡(
pquîy
)

212 *
pquîy
 = 
quîy
;

213 i‡(
±ag
)

214 *
±ag
 = 
èg
;

215 i‡(
≥xt
)

216 *
≥xt
 = 
ext
;

217 *
pbuf
 = 
buf
;

219 
	}
}

	@utils/webcomp.c

23 
	~<°dio.h
>

24 
	~<°rög.h
>

25 
	~<°dlib.h
>

26 
	~<sys/°©.h
>

27 
	~<f˙é.h
>

29 
°©
 
	t°©_t
;

31 #i‚de‡
O_BINARY


32 
	#O_BINARY
 0

	)

34 #i‚de‡
FNAMESIZE


35 
	#FNAMESIZE
 254

	)

40 
compûe
(*
fûeLi°
, *
¥efix
);

41 
ußge
();

48 
	$maö
(
¨gc
, * 
¨gv
[])

50 *
fûeLi°
, *
¥efix
;

52 
fûeLi°
 = 
NULL
;

54 i‡(
¨gc
 != 3) {

55 
	`ußge
();

58 
¥efix
 = 
¨gv
[1];

59 
fûeLi°
 = 
¨gv
[2];

61 i‡(
	`compûe
(
fûeLi°
, 
¥efix
) < 0) {

65 
	}
}

72 
	$ußge
()

74 
	`Ârötf
(
°dîr
, "usage: webcompÖrefix filelist >output.c\n\
 isá file containingÅheÖathnames ofáll webÖages\n\
 isáÖathÖrefixÅoÑemove fromállÅhe webÖageÖathnames\n\
.c isÅheÑesulting C source fileÅo compileándÜink.\n");

79 
	`exô
(2);

80 
	}
}

87 
	$compûe
(*
fûeLi°
, *
¥efix
)

89 
°©_t
 
sbuf
;

90 
FILE
 *
Õ
;

91 
time_t
 
now
;

92 
fûe
[
FNAMESIZE
];

93 *
˝
, *
¶
;

94 
buf
[512];

95 *
p
;

96 
j
, 
i
, 
Àn
, 
fd
, 
nFûe
;

101 i‡((
Õ
 = 
	`f›í
(
fûeLi°
, "r")Ë=
NULL
) {

102 
	`Ârötf
(
°dîr
, "C™'à›í fûêli° %s\n", 
fûeLi°
);

106 
	`time
(&
now
);

107 
	`Ârötf
(
°dout
, "/*\n * webrom.c -- Compiled Web Pages\n *\n");

108 
	`Ârötf
(
°dout
, " * Compiled by GoAhead WebCompile: %s */\n\n",

109 
	`˘ime
(&
now
));

110 
	`Ârötf
(
°dout
, "#include \"wsIntrn.h\"\n\n");

111 
	`Ârötf
(
°dout
, "#ifndef WEBS_PAGE_ROM\n");

112 
	`Ârötf
(
°dout
, "websRomPageIndexType websRomPageIndex[] = {\n");

113 
	`Ârötf
(
°dout
, "\t{ 0, 0, 0 }\n};\n");

114 
	`Ârötf
(
°dout
, "#else\n");

119 
nFûe
 = 0;

120 
	`fgës
(
fûe
, (fûe), 
Õ
Ë!
NULL
) {

121 i‡((
p
 = (*)
	`°rchr
(
fûe
, '\n')) ||

122 (
p
 = (*)
	`°rchr
(
fûe
, '\r'))) {

123 *
p
 = '\0';

125 i‡(*
fûe
 == '\0') {

128 i‡(
	`°©
(
fûe
, &
sbuf
Ë=0 && sbuf.
°_mode
 & 
S_IFDIR
) {

131 i‡((
fd
 = 
	`›í
(
fûe
, 
O_RDONLY
 | 
O_BINARY
)) < 0) {

132 
	`Ârötf
(
°dîr
, "C™'à›í fûê%s\n", 
fûe
);

135 
	`Ârötf
(
°dout
, "/* %†*/\n", 
fûe
);

136 
	`Ârötf
(
°dout
, "°©i¯unsig√d ch¨Ö%d[] = {\n", 
nFûe
);

138 (
Àn
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0) {

139 
p
 = (*)
buf
;

140 
i
 = 0; i < 
Àn
; ) {

141 
	`Ârötf
(
°dout
, "\t");

142 
j
 = 0; 
p
<(*)(&
buf
[
Àn
]) && j < 16; j++,Ö++) {

143 
	`Ârötf
(
°dout
, "%3d,", *
p
);

145 
i
 +
j
;

146 
	`Ârötf
(
°dout
, "\n");

149 
	`Ârötf
(
°dout
, "\t0 };\n\n");

151 
	`˛o£
(
fd
);

152 
nFûe
++;

154 
	`f˛o£
(
Õ
);

159 
	`Ârötf
(
°dout
, "websRomPageIndexType websRomPageIndex[] = {\n");

161 i‡((
Õ
 = 
	`f›í
(
fûeLi°
, "r")Ë=
NULL
) {

162 
	`Ârötf
(
°dîr
, "C™'à›í fûêli° %s\n", 
fûeLi°
);

165 
nFûe
 = 0;

166 
	`fgës
(
fûe
, (fûe), 
Õ
Ë!
NULL
) {

167 i‡((
p
 = (*)
	`°rchr
(
fûe
, '\n')) ||

168 (
p
 = (*)
	`°rchr
(
fûe
, '\r'))) {

169 *
p
 = '\0';

171 i‡(*
fûe
 == '\0') {

177 i‡(
	`°∫cmp
(
fûe
, 
¥efix
, 
	`°æí
(prefix)) == 0) {

178 
˝
 = &
fûe
[
	`°æí
(
¥efix
)];

180 
˝
 = 
fûe
;

182 (
¶
 = 
	`°rchr
(
fûe
, '\\')Ë!
NULL
) {

183 *
¶
 = '/';

185 i‡(*
˝
 == '/') {

186 
˝
++;

189 i‡(
	`°©
(
fûe
, &
sbuf
Ë=0 && sbuf.
°_mode
 & 
S_IFDIR
) {

190 
	`Ârötf
(
°dout
, "\t{ T(\"/%s\"), 0, 0 },\n", 
˝
);

193 
	`Ârötf
(
°dout
, "\t{ T(\"/%s\"),Ö%d, %d },\n", 
˝
, 
nFûe
,

194 
sbuf
.
°_size
);

195 
nFûe
++;

197 
	`f˛o£
(
Õ
);

199 
	`Ârötf
(
°dout
, "\t{ 0, 0, 0 }\n");

200 
	`Ârötf
(
°dout
, "};\n");

201 
	`Ârötf
(
°dout
, "#endif /* WEBS_PAGE_ROM */\n");

203 
	`f˛o£
(
Õ
);

204 
	`fÊush
(
°dout
);

206 
	}
}

	@value.c

17 
	~"uemf.h
"

25 
vÆue_t
 
	$vÆueI¡egî
(
vÆue
)

27 
vÆue_t
 
v
;

29 
	`mem£t
(&
v
, 0x0, (v));

30 
v
.
vÆid
 = 1;

31 
v
.
ty≥
 = 
öãgî
;

32 
v
.
vÆue
.
öãgî
 = value;

33  
v
;

34 
	}
}

41 
vÆue_t
 
	$vÆueSåög
(
ch¨_t
* 
vÆue
, 
Êags
)

43 
vÆue_t
 
v
;

45 
	`mem£t
(&
v
, 0x0, (v));

46 
v
.
vÆid
 = 1;

47 
v
.
ty≥
 = 
°rög
;

48 i‡(
Êags
 & 
VALUE_ALLOCATE
) {

49 
v
.
Æloˇãd
 = 1;

50 
v
.
vÆue
.
°rög
 = 
	`g°rdup
(
B_L
, value);

52 
v
.
Æloˇãd
 = 0;

53 
v
.
vÆue
.
°rög
 = value;

55  
v
;

56 
	}
}

63 
	$vÆueFªe
(
vÆue_t
* 
v
)

65 i‡(
v
->
vÆid
 && v->
Æloˇãd
 && v->
ty≥
 =
°rög
 &&

66 
v
->
vÆue
.
°rög
 !
NULL
) {

67 
	`b‰ì
(
B_L
, 
v
->
vÆue
.
°rög
);

69 
v
->
ty≥
 = 
undeföed
;

70 
v
->
vÆid
 = 0;

71 
v
->
Æloˇãd
 = 0;

72 
	}
}

	@webrom.c

10 
	~"wsI¡∫.h
"

12 
websRomPageIndexTy≥
 
	gwebsRomPageIndex
[] = {

	@webs.c

19 
	~"wsI¡∫.h
"

20 #ifde‡
DIGEST_ACCESS_SUPPORT


21 
	~"websda.h
"

24 
sockë_t
 **
sockëLi°
;

28 
websSètsTy≥
 
	gwebsSèts
;

29 
webs_t
 *
	gwebs
;

30 
sym_fd_t
 
	gwebsMime
;

31 
	gwebsMax
;

32 
	gwebsP‹t
;

33 
ch¨_t
 
	gwebsHo°
[64];

34 
ch¨_t
 
	gwebsI∑ddr
[64];

35 
ch¨_t
 *
	gwebsHo°Uæ
 = 
NULL
;

36 
ch¨_t
 *
	gwebsI∑ddrUæ
 = 
NULL
;

43 
websEº‹Ty≥
 
	gwebsEº‹s
[] = {

44 { 200, 
T
("Data follows") },

45 { 204, 
T
("No Content") },

46 { 301, 
T
("Redirect") },

47 { 302, 
T
("Redirect") },

48 { 304, 
T
("UseÜocal copy") },

49 { 400, 
T
("PageÇot found") },

50 { 401, 
T
("Unauthorized") },

51 { 403, 
T
("Forbidden") },

52 { 404, 
T
("Site or Page Not Found") },

53 { 405, 
T
("Access Denied") },

54 { 500, 
T
("Web Error") },

55 { 501, 
T
("Not Implemented") },

56 { 503, 
T
("Site Temporarily Unavailable. Tryágain.") },

57 { 0, 
NULL
 }

60 #ifde‡
WEBS_LOG_SUPPORT


61 
ch¨_t
 
	gwebsLog«me
[64] = 
T
("log.txt");

62 
	gwebsLogFd
;

65 #ifde‡
WEBS_TRACE_SUPPORT


66 
ch¨_t
 
	gwebsTø˚«me
[64] = 
T
("trace.txt");

67 
	gwebsTø˚Fd
;

70 
	gwebsLi°íSock
;

71 
ch¨_t
 
	gwebsRólm
[64] = 
T
("GoAhead");

73 
	gwebsO≥nCou¡
 = 0;

79 
websGëI≈ut
(
webs_t
 
wp
, 
ch¨_t
 **
±ext
, *
nbyãs
);

80 
websP¨£Fú°
(
webs_t
 
wp
, 
ch¨_t
 *
ãxt
);

81 
websP¨£Reque°
(
webs_t
 
wp
);

82 
websSockëEvít
(
sid
, 
mask
, * 
d©a
);

83 
websGëTimeSö˚M¨k
(
webs_t
 
wp
);

85 #ifde‡
WEBS_LOG_SUPPORT


86 
websLog
(
webs_t
 
wp
, 
code
);

88 #ifde‡
WEBS_TRACE_SUPPORT


89 
åa˚H™dÀr
(
Àvñ
, 
ch¨_t
 *
buf
);

91 #ifde‡
WEBS_IF_MODIFIED_SUPPORT


92 
time_t
 
d©eP¨£
—ime_à
tù
, 
ch¨_t
 *
cmd
);

100 
	$websO≥nSîvî
(
p‹t
, 
ªåõs
)

102 
websMimeTy≥
 *
mt
;

104 i‡(++
websO≥nCou¡
 != 1) {

105  
websP‹t
;

108 
	`a_as£π
(
p‹t
 > 0);

109 
	`a_as£π
(
ªåõs
 >= 0);

111 
	`websDeÁu…O≥n
();

113 #ifde‡
WEBS_PAGE_ROM


114 
	`websRomO≥n
();

117 
webs
 = 
NULL
;

118 
websMax
 = 0;

122 
websMime
 = 
	`symO≥n
(
WEBS_SYM_INIT
 * 4);

123 
	`a_as£π
(
websMime
 >= 0);

124 
mt
 = 
websMimeLi°
; mt->
ty≥
; mt++) {

125 
	`symE¡î
(
websMime
, 
mt
->
ext
, 
	`vÆueSåög
(mt->
ty≥
, 0), 0);

132 i‡(
	`websUæH™dÀrO≥n
() < 0) {

135 
	`websF‹mO≥n
();

137 #ifde‡
WEBS_LOG_SUPPORT


141 #i‚de‡
VXWORKS


142 
websLogFd
 = 
	`g›í
(
websLog«me
, 
O_CREAT
 | 
O_TRUNC
 | 
O_APPEND
 | 
O_WRONLY
,

145 
websLogFd
 = 
	`g›í
(
websLog«me
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 0666);

146 
	`l£ek
(
fd
, 0, 
SEEK_END
);

148 
	`a_as£π
(
websLogFd
 >= 0);

151 #ifde‡
WEBS_TRACE_SUPPORT


155 #i‚de‡
VXWORKS


156 
websTø˚Fd
 = 
	`g›í
(
websTø˚«me
, 
O_CREAT
 | 
O_TRUNC
 | 
O_APPEND
 | 
O_WRONLY
,

159 
websTø˚Fd
 = 
	`g›í
(
websTø˚«me
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 0666);

160 
	`l£ek
(
fd
, 0, 
SEEK_END
);

162 
	`a_as£π
(
websTø˚Fd
 >= 0);

163 
	`åa˚SëH™dÀr
(
åa˚H™dÀr
);

165  
	`websO≥nLi°í
(
p‹t
, 
ªåõs
);

166 
	}
}

173 
	$websClo£Sîvî
()

175 
webs_t
 
wp
;

176 
wid
;

178 i‡(--
websO≥nCou¡
 > 0) {

185 
	`websClo£Li°í
();

190 
wid
 = 
websMax
; 
webs
 && wid >= 0; wid--) {

191 i‡((
wp
 = 
webs
[
wid
]Ë=
NULL
) {

194 
	`sockëClo£C⁄√˘i⁄
(
wp
->
sid
);

195 
	`websFªe
(
wp
);

198 #ifde‡
WEBS_LOG_SUPPORT


199 i‡(
websLogFd
 >= 0) {

200 
	`˛o£
(
websLogFd
);

201 
websLogFd
 = -1;

204 #ifde‡
WEBS_TRACE_SUPPORT


205 i‡(
websTø˚Fd
 >= 0) {

206 
	`˛o£
(
websTø˚Fd
);

207 
websTø˚Fd
 = -1;

211 #ifde‡
WEBS_PAGE_ROM


212 
	`websRomClo£
();

214 
	`websDeÁu…Clo£
();

215 
	`symClo£
(
websMime
);

216 
	`websF‹mClo£
();

217 
	`websUæH™dÀrClo£
();

218 
	}
}

225 
	$websO≥nLi°í
(
p‹t
, 
ªåõs
)

227 
i
, 
‹ig
;

229 
	`a_as£π
(
p‹t
 > 0);

230 
	`a_as£π
(
ªåõs
 >= 0);

232 
‹ig
 = 
p‹t
;

236 
i
 = 0; i <
ªåõs
; i++) {

237 
websLi°íSock
 = 
	`sockëO≥nC⁄√˘i⁄
(
NULL
, 
p‹t
, 
websAc˚±
, 0);

238 i‡(
websLi°íSock
 >= 0) {

241 
p‹t
++;

243 i‡(
i
 > 
ªåõs
) {

244 
	`îr‹
(
E_L
, 
E_USER
, 
	`T
("Couldn't opená socket onÖorts %d - %d"),

245 
‹ig
, 
p‹t
 - 1);

252 
websP‹t
 = 
p‹t
;

253 
	`b‰ìSa„
(
B_L
, 
websHo°Uæ
);

254 
	`b‰ìSa„
(
B_L
, 
websI∑ddrUæ
);

255 
websI∑ddrUæ
 = 
websHo°Uæ
 = 
NULL
;

257 i‡(
p‹t
 == 80) {

258 
websHo°Uæ
 = 
	`b°rdup
(
B_L
, 
websHo°
);

259 
websI∑ddrUæ
 = 
	`b°rdup
(
B_L
, 
websI∑ddr
);

261 
	`fmtAŒoc
(&
websHo°Uæ
, 
WEBS_MAX_URL
 + 80, 
	`T
("%s:%d"), 
websHo°
, 
p‹t
);

262 
	`fmtAŒoc
(&
websI∑ddrUæ
, 
WEBS_MAX_URL
 + 80, 
	`T
("%s:%d"),

263 
websI∑ddr
, 
p‹t
);

265 
	`åa˚
(0, 
	`T
("webs: Listening for HTTPÑequestsátáddress %s\n"),

266 
websI∑ddrUæ
);

268  
p‹t
;

269 
	}
}

276 
	$websClo£Li°í
()

278 i‡(
websLi°íSock
 >= 0) {

279 
	`sockëClo£C⁄√˘i⁄
(
websLi°íSock
);

280 
websLi°íSock
 = -1;

282 
	`b‰ìSa„
(
B_L
, 
websHo°Uæ
);

283 
	`b‰ìSa„
(
B_L
, 
websI∑ddrUæ
);

284 
websI∑ddrUæ
 = 
websHo°Uæ
 = 
NULL
;

285 
	}
}

292 
	$websAc˚±
(
sid
, *
ùaddr
, 
p‹t
, 
li°íSid
)

294 
webs_t
 
wp
;

295 
wid
;

296 
sockaddr_ö
 
ifAddr
;

297 
Àn
;

298 *
pSåög
;

300 
	`a_as£π
(
ùaddr
 && *ipaddr);

301 
	`a_as£π
(
sid
 >= 0);

302 
	`a_as£π
(
p‹t
 >= 0);

308 i‡((
wid
 = 
	`websAŒoc
(
sid
)) < 0) {

311 
wp
 = 
webs
[
wid
];

312 
	`a_as£π
(
wp
);

313 
wp
->
li°íSid
 =ÜistenSid;

315 
	`ascToUni
(
wp
->
ùaddr
, i∑ddr, 
	`mö
((wp->ùaddr), 
	`°æí
(ipaddr) + 1));

320 
Àn
 = (
sockaddr_ö
);

321 i‡(
	`gësock«me
(
sockëLi°
[
sid
]->
sock
, (
sockaddr
 *)&
ifAddr
, (
sockÀn_t
 *Ë&
Àn
) < 0)

323 
pSåög
 = 
	`öë_¡ﬂ
(
ifAddr
.
sö_addr
);

324 
	`g°∫˝y
(
wp
->
iÁddr
, 
pSåög
, 
	`g°æí
(pString));

330 i‡(
	`g°rcmp
(
wp
->
ùaddr
, 
	`T
("127.0.0.1")) == 0 ||

331 
	`g°rcmp
(
wp
->
ùaddr
, 
websI∑ddr
) == 0 ||

332 
	`g°rcmp
(
wp
->
ùaddr
, 
websHo°
) == 0) {

333 
wp
->
Êags
 |
WEBS_LOCAL_REQUEST
;

339 
	`sockëCª©eH™dÀr
(
sid
, 
SOCKET_READABLE
, 
websSockëEvít
, 
wp
);

344 
wp
->
timeout
 = 
	`emfSchedCÆlback
(
WEBS_TIMEOUT
, 
websTimeout
, (*) wp);

345 
	`åa˚
(8, 
	`T
("webs:ácceptÑequest\n"));

347 
	}
}

356 
	$websSockëEvít
(
sid
, 
mask
, * 
iwp
)

358 
webs_t
 
wp
;

360 
wp
 = (
webs_t
Ë
iwp
;

361 
	`a_as£π
(
wp
);

363 i‡(! 
	`websVÆid
(
wp
)) {

367 i‡(
mask
 & 
SOCKET_READABLE
) {

368 
	`websRódEvít
(
wp
);

370 i‡(
mask
 & 
SOCKET_WRITABLE
) {

371 i‡(
	`websVÆid
(
wp
Ë&& wp->
wrôeSockë
) {

372 (*
wp
->
wrôeSockë
)(wp);

375 
	}
}

384 
	$websRódEvít
(
webs_t
 
wp
)

386 
ch¨_t
 *
ãxt
;

387 
rc
, 
nbyãs
, 
Àn
, 
d⁄e
, 
fd
, 
size
;

389 
	`a_as£π
(
wp
);

390 
	`a_as£π
(
	`websVÆid
(
wp
));

392 
	`websSëTimeM¨k
(
wp
);

398 
ãxt
 = 
NULL
;

399 
fd
 = -1;

400 
d⁄e
 = 0; !done; ) {

401 i‡(
ãxt
) {

402 
	`b‰ì
(
B_L
, 
ãxt
);

403 
ãxt
 = 
NULL
;

411 (
rc
 = 
	`websGëI≈ut
(
wp
, &
ãxt
, &
nbyãs
)) == 0) {

418 i‡(
rc
 < 0) {

425 
wp
->
°©e
) {

426 
WEBS_BEGIN
:

430 i‡(
	`websP¨£Fú°
(
wp
, 
ãxt
) < 0) {

431 
d⁄e
++;

434 
wp
->
°©e
 = 
WEBS_HEADER
;

437 
WEBS_HEADER
:

442 i‡(
	`rögqLí
(&
wp
->
hódî
) > 0) {

443 
	`rögqPutSå
(&
wp
->
hódî
, 
	`T
("\n"));

445 
	`rögqPutSå
(&
wp
->
hódî
, 
ãxt
);

448 
WEBS_POST_CLEN
:

455 #i‚de‡
__NO_CGI_BIN


456 i‡(
wp
->
Êags
 & 
WEBS_CGI_REQUEST
) {

457 i‡(
fd
 == -1) {

458 #i‡!
	`deföed
(
WIN32
)

459 
fd
 = 
	`g›í
(
wp
->
cgiStdö
, 
O_CREAT
 | 
O_WRONLY
 | 
O_BINARY
,

462 
	`_s›í_s
(&
fd
, 
wp
->
cgiStdö
, 
O_CREAT
 | 
O_WRONLY
 | 
O_BINARY
, 
_SH_DENYNO
, 0666);

465 
	`gwrôe
(
fd
, 
ãxt
, 
nbyãs
);

480 i‡(
wp
->
quîy
) {

481 i‡(
wp
->
quîy
[0] && !(wp->
Êags
 & 
WEBS_POST_DATA
)) {

488 
Àn
 = 
	`g°æí
(
wp
->
quîy
);

489 i‡(
ãxt
) {

490 
size
 = (
Àn
 + 
	`g°æí
(
ãxt
Ë+ 2Ë* (
ch¨_t
);

491 
wp
->
quîy
 = 
	`bªÆloc
(
B_L
, wp->query,

492 
size
);

493 
wp
->
quîy
[
Àn
++] = '&';

494 #i‡!
	`deföed
(
WIN32
)

495 
	`°r˝y
(&
wp
->
quîy
[
Àn
], 
ãxt
);

497 
	`°r˝y_s
(&
wp
->
quîy
[
Àn
], 
size
 -Üí, 
ãxt
);

506 i‡(
ãxt
 !
NULL
)

508 
Àn
 = 
	`g°æí
(
wp
->
quîy
);

509 
size
 = (
Àn
 + 
	`g°æí
(
ãxt
Ë+ 1Ë* (
ch¨_t
);

510 
wp
->
quîy
 = 
	`bªÆloc
(
B_L
, wp->quîy, 
size
);

511 i‡(
wp
->
quîy
) {

512 #i‡!
	`deföed
(
WIN32
)

513 
	`g°r˝y
(&
wp
->
quîy
[
Àn
], 
ãxt
);

515 
	`°r˝y_s
(&
wp
->
quîy
[
Àn
], 
size
 -Üí, 
ãxt
);

522 
wp
->
quîy
 = 
	`b°rdup
(
B_L
, 
ãxt
);

527 
wp
->
Êags
 |
WEBS_POST_DATA
;

528 
wp
->
˛í
 -
nbyãs
;

529 i‡(
wp
->
˛í
 > 0) {

530 i‡(
nbyãs
 > 0) {

533 
d⁄e
++;

540 i‡(
fd
 != -1) {

541 
	`g˛o£
 (
fd
);

542 
fd
 = -1;

544 
	`websUæH™dÀrReque°
(
wp
);

545 
d⁄e
++;

548 
WEBS_POST
:

556 #i‚de‡
__NO_CGI_BIN


557 i‡(
wp
->
Êags
 & 
WEBS_CGI_REQUEST
) {

558 i‡(
fd
 == -1) {

559 #i‡!
	`deföed
(
WIN32
)

560 
fd
 = 
	`g›í
(
wp
->
cgiStdö
, 
O_CREAT
 | 
O_WRONLY
 | 
O_BINARY
,

563 
	`_s›í_s
(&
fd
, 
wp
->
cgiStdö
, 
O_CREAT
 | 
O_WRONLY
 | 
O_BINARY
,

564 
_SH_DENYNO
, 0666);

567 
	`gwrôe
(
fd
, 
ãxt
, 
nbyãs
);

568 
	`gwrôe
(
fd
, 
	`T
("\n"), (
ch¨_t
));

571 i‡(
wp
->
quîy
 && *wp->quîy && !(wp->
Êags
 & 
WEBS_POST_DATA
)) {

572 
Àn
 = 
	`g°æí
(
wp
->
quîy
);

573 
size
 = (
Àn
 + 
	`g°æí
(
ãxt
Ë+ 2Ë* (
ch¨_t
);

574 
wp
->
quîy
 = 
	`bªÆloc
(
B_L
, wp->quîy, 
size
);

575 i‡(
wp
->
quîy
) {

576 
wp
->
quîy
[
Àn
++] = '&';

577 #i‡!
	`deföed
(
WIN32
)

578 
	`g°r˝y
(&
wp
->
quîy
[
Àn
], 
ãxt
);

580 
	`°r˝y_s
(&
wp
->
quîy
[
Àn
], 
size
 -Üí, 
ãxt
);

585 
wp
->
quîy
 = 
	`b°rdup
(
B_L
, 
ãxt
);

587 
wp
->
Êags
 |
WEBS_POST_DATA
;

588 
d⁄e
++;

592 
	`websEº‹
(
wp
, 404, 
	`T
("Bad state"));

593 
d⁄e
++;

598 i‡(
fd
 != -1) {

599 
fd
 = 
	`g˛o£
 (fd);

602 i‡(
ãxt
) {

603 
	`b‰ì
(
B_L
, 
ãxt
);

605 
	}
}

620 
	$websGëI≈ut
(
webs_t
 
wp
, 
ch¨_t
 **
±ext
, *
≤byãs
)

622 
ch¨_t
 *
ãxt
;

623 
buf
[
WEBS_SOCKET_BUFSIZ
+1];

624 
nbyãs
, 
Àn
, 
˛í
;

626 
	`a_as£π
(
	`websVÆid
(
wp
));

627 
	`a_as£π
(
±ext
);

628 
	`a_as£π
(
≤byãs
);

630 *
±ext
 = 
ãxt
 = 
NULL
;

631 *
≤byãs
 = 0;

637 i‡(
wp
->
°©e
 =
WEBS_POST_CLEN
) {

638 
Àn
 = (
wp
->
˛í
 > 
WEBS_SOCKET_BUFSIZ
) ? WEBS_SOCKET_BUFSIZ : wp->clen;

640 
Àn
 = 0;

643 i‡(
Àn
 > 0) {

645 #ifde‡
WEBS_SSL_SUPPORT


646 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

647 
nbyãs
 = 
	`websSSLRód
(
wp
->
w•
, 
buf
, 
Àn
);

649 
nbyãs
 = 
	`sockëRód
(
wp
->
sid
, 
buf
, 
Àn
);

652 
nbyãs
 = 
	`sockëRód
(
wp
->
sid
, 
buf
, 
Àn
);

654 i‡(
nbyãs
 < 0) {

655 
	`websD⁄e
(
wp
, 0);

658 } i‡(
nbyãs
 == 0) {

665 i‡(
	`sockëEof
(
wp
->
sid
)) {

666 
	`websD⁄e
(
wp
, 0);

675 
buf
[
nbyãs
] = '\0';

676 i‡((
ãxt
 = 
	`bÆlocAscToUni
(
buf
, 
nbyãs
)Ë=
NULL
) {

677 
	`websEº‹
(
wp
, 503, 
	`T
("Insufficient memory"));

683 #ifde‡
WEBS_SSL_SUPPORT


684 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

685 
nbyãs
 = 
	`websSSLGës
(
wp
->
w•
, &
ãxt
);

687 
nbyãs
 = 
	`sockëGës
(
wp
->
sid
, &
ãxt
);

690 
nbyãs
 = 
	`sockëGës
(
wp
->
sid
, &
ãxt
);

693 i‡(
nbyãs
 < 0) {

694 
eof
;

698 #ifde‡
WEBS_SSL_SUPPORT


699 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

704 i‡(
wp
->
°©e
 =
WEBS_BEGIN
) {

705 
eof
 = 1;

707 
eof
 = 
	`websSSLEof
(
wp
->
w•
);

710 
eof
 = 
	`sockëEof
(
wp
->
sid
);

713 
eof
 = 
	`sockëEof
(
wp
->
sid
);

716 i‡(
eof
) {

722 i‡(
wp
->
°©e
 =
WEBS_POST
) {

723 
	`websUæH™dÀrReque°
(
wp
);

725 
	`websD⁄e
(
wp
, 0);

731 #ifde‡
HP_FIX


732 
	`websD⁄e
(
wp
, 0);

750 } i‡(
nbyãs
 == 0) {

751 i‡(
wp
->
°©e
 =
WEBS_HEADER
) {

755 
	`websP¨£Reque°
(
wp
);

756 i‡(
wp
->
Êags
 & 
WEBS_POST_REQUEST
) {

757 i‡(
wp
->
Êags
 & 
WEBS_CLEN
) {

758 
wp
->
°©e
 = 
WEBS_POST_CLEN
;

759 
˛í
 = 
wp
->clen;

761 
wp
->
°©e
 = 
WEBS_POST
;

762 
˛í
 = 1;

764 i‡(
˛í
 > 0) {

775 
	`websUæH™dÀrReque°
(
wp
);

780 
	`a_as£π
(
ãxt
);

781 
	`a_as£π
(
nbyãs
 > 0);

782 *
±ext
 = 
ãxt
;

783 *
≤byãs
 = 
nbyãs
;

785 
	}
}

792 
	$websP¨£Fú°
(
webs_t
 
wp
, 
ch¨_t
 *
ãxt
)

794 
ch¨_t
 *
›
, *
¥Ÿo
, *
¥ŸoVî
, *
uæ
, *
ho°
, *
quîy
, *
∑th
, *
p‹t
, *
ext
;

795 
ch¨_t
 *
buf
;

796 
ã°P‹t
;

798 
	`a_as£π
(
	`websVÆid
(
wp
));

799 
	`a_as£π
(
ãxt
 && *text);

804 
›
 = 
	`g°πok
(
ãxt
, 
	`T
(" \t"));

805 i‡(
›
 =
NULL
 || *op == '\0') {

806 
	`websEº‹
(
wp
, 400, 
	`T
("Bad HTTPÑequest"));

809 i‡(
	`g°rcmp
(
›
, 
	`T
("GET")) != 0) {

810 i‡(
	`g°rcmp
(
›
, 
	`T
("POST")) == 0) {

811 
wp
->
Êags
 |
WEBS_POST_REQUEST
;

812 } i‡(
	`g°rcmp
(
›
, 
	`T
("HEAD")) == 0) {

813 
wp
->
Êags
 |
WEBS_HEAD_REQUEST
;

815 
	`websEº‹
(
wp
, 400, 
	`T
("BadÑequestÅype"));

823 
	`websSëV¨
(
wp
, 
	`T
("REQUEST_METHOD"), 
›
);

825 
uæ
 = 
	`g°πok
(
NULL
, 
	`T
(" \t\n"));

826 i‡(
uæ
 =
NULL
 || *url == '\0') {

827 
	`websEº‹
(
wp
, 400, 
	`T
("Bad HTTPÑequest"));

830 
¥ŸoVî
 = 
	`g°πok
(
NULL
, 
	`T
(" \t\n"));

838 
ho°
 = 
∑th
 = 
p‹t
 = 
¥Ÿo
 = 
quîy
 = 
ext
 = 
NULL
;

839 i‡(
	`websUæP¨£
(
uæ
, &
buf
, &
ho°
, &
∑th
, &
p‹t
, &
quîy
, &
¥Ÿo
,

840 
NULL
, &
ext
) < 0) {

841 
	`websEº‹
(
wp
, 400, 
	`T
("Bad URL format"));

845 
wp
->
uæ
 = 
	`b°rdup
(
B_L
, url);

847 #i‚de‡
__NO_CGI_BIN


848 i‡(
	`g°r°r
(
uæ
, 
CGI_BIN
Ë!
NULL
) {

849 
wp
->
Êags
 |
WEBS_CGI_REQUEST
;

850 i‡(
wp
->
Êags
 & 
WEBS_POST_REQUEST
) {

851 
wp
->
cgiStdö
 = 
	`websGëCgiCommName
();

856 
wp
->
quîy
 = 
	`b°rdup
(
B_L
, query);

857 
wp
->
ho°
 = 
	`b°rdup
(
B_L
, host);

858 
wp
->
∑th
 = 
	`b°rdup
(
B_L
,Öath);

859 
wp
->
¥Ÿocﬁ
 = 
	`b°rdup
(
B_L
, 
¥Ÿo
);

860 
wp
->
¥ŸoVîsi⁄
 = 
	`b°rdup
(
B_L
, 
¥ŸoVî
);

862 i‡((
ã°P‹t
 = 
	`sockëGëP‹t
(
wp
->
li°íSid
)) >= 0) {

863 
wp
->
p‹t
 = 
ã°P‹t
;

865 
wp
->
p‹t
 = 
	`g©oi
(port);

868 i‡(
	`g°rcmp
(
ext
, 
	`T
(".asp")) == 0) {

869 
wp
->
Êags
 |
WEBS_ASP
;

871 
	`b‰ì
(
B_L
, 
buf
);

873 
	`websUæTy≥
(
uæ
, 
wp
->
ty≥
, 
	`TSZ
(wp->type));

875 #ifde‡
WEBS_PROXY_SUPPORT


882 i‡(
	`g°r°r
(
wp
->
uæ
, 
	`T
("hâp://")Ë=
NULL
 ||

883 ((
	`g°rcmp
(
wp
->
ho°
, 
	`T
("localhost")) == 0 ||

884 
	`g°rcmp
(
wp
->
ho°
, 
websHo°
Ë=0Ë&& (wp->
p‹t
 =
websP‹t
))) {

885 
wp
->
Êags
 |
WEBS_LOCAL_PAGE
;

886 i‡(
	`g°rcmp
(
wp
->
∑th
, 
	`T
("/")) == 0) {

887 
wp
->
Êags
 |
WEBS_HOME_PAGE
;

892 
	`rögqFlush
(&
wp
->
hódî
);

894 
	}
}

901 
	#isgoodch¨
(
s
Ë(
	`giß um
((s)) || ((s) == '/') || ((s) == '_') || \

902 ((
s
Ë='.'Ë|| ((sË='-'Ë)

	)

904 
	$websP¨£Reque°
(
webs_t
 
wp
)

906 
ch¨_t
 *
authTy≥
, *
uµîKey
, *
˝
, *
brow£r
, *
Õ
, *
key
, *
vÆue
;

908 
	`a_as£π
(
	`websVÆid
(
wp
));

913 
	`websSëV¨
(
wp
, 
	`T
("HTTP_AUTHORIZATION"), T(""));

920 
brow£r
 = 
NULL
;

921 
Õ
 = (
ch¨_t
*Ë
wp
->
hódî
.
£rvp
;Üp && *lp; ) {

922 
˝
 = 
Õ
;

923 i‡((
Õ
 = 
	`g°rchr
÷p, '\n')Ë!
NULL
) {

924 
Õ
++;

927 i‡((
key
 = 
	`g°πok
(
˝
, 
	`T
(": \t\n"))Ë=
NULL
) {

931 i‡((
vÆue
 = 
	`g°πok
(
NULL
, 
	`T
("\n"))) == NULL) {

932 
vÆue
 = 
	`T
("");

935 
	`gis•a˚
(*
vÆue
)) {

936 
vÆue
++;

938 
	`°æowî
(
key
);

943 
	`fmtAŒoc
(&
uµîKey
, (
	`g°æí
(
key
Ë+ 6), 
	`T
("HTTP_%s"), key);

944 
˝
 = 
uµîKey
; *cp; cp++) {

945 i‡(*
˝
 == '-')

946 *
˝
 = '_';

948 
	`°ruµî
(
uµîKey
);

949 
	`websSëV¨
(
wp
, 
uµîKey
, 
vÆue
);

950 
	`b‰ì
(
B_L
, 
uµîKey
);

955 i‡(
	`g°rcmp
(
key
, 
	`T
("user-agent")) == 0) {

956 
wp
->
u£rAgít
 = 
	`b°rdup
(
B_L
, 
vÆue
);

961 } i‡(
	`g°ricmp
(
key
, 
	`T
("authorization")) == 0) {

965 
authTy≥
 = 
	`b°rdup
 (
B_L
, 
vÆue
);

966 
	`a_as£π
 (
authTy≥
);

970 
˝
 = 
authTy≥
;

971 
	`gißÕha
(*
˝
)) {

972 
˝
++;

974 *
˝
 = '\0';

976 
wp
->
authTy≥
 = 
	`b°rdup
(
B_L
,áuthType);

977 
	`b‰ì
(
B_L
, 
authTy≥
);

979 i‡(
	`g°ricmp
(
wp
->
authTy≥
, 
	`T
("basic")) == 0) {

980 
ch¨_t
 
u£rAuth
[
FNAMESIZE
];

984 i‡((
˝
 = 
	`g°rchr
(
vÆue
, ' ')Ë!
NULL
) {

985 *
˝
 = '\0';

991 
	`b‰ì
(
B_L
, 
wp
->
authTy≥
);

992 
wp
->
authTy≥
 = 
	`b°rdup
(
B_L
, 
vÆue
);

993 
	`websDecode64
(
u£rAuth
, ++
˝
, (userAuth));

995 
	`websDecode64
(
u£rAuth
, 
vÆue
, (userAuth));

1000 i‡((
˝
 = 
	`g°rchr
(
u£rAuth
, ':')Ë!
NULL
) {

1001 *
˝
++ = '\0';

1003 i‡(
˝
) {

1004 
wp
->
u£rName
 = 
	`b°rdup
(
B_L
, 
u£rAuth
);

1005 
wp
->
∑ssw‹d
 = 
	`b°rdup
(
B_L
, 
˝
);

1007 
wp
->
u£rName
 = 
	`b°rdup
(
B_L
, 
	`T
(""));

1008 
wp
->
∑ssw‹d
 = 
	`b°rdup
(
B_L
, 
	`T
(""));

1013 
wp
->
Êags
 |
WEBS_AUTH_BASIC
;

1015 #ifde‡
DIGEST_ACCESS_SUPPORT


1019 
ch¨_t
 *
≈
;

1020 
ch¨_t
 
ç
;

1021 
ch¨_t
 *
vp
;

1022 
ch¨_t
 *
≈v
;

1023 
ch¨_t
 
çv
;

1027 
wp
->
Êags
 |
WEBS_AUTH_DIGEST
;

1032 
˝
 = 
vÆue
;

1033 
	`isgoodch¨
(*
˝
)) {

1034 
˝
++;

1036 !
	`isgoodch¨
(*
˝
)) {

1037 
˝
++;

1043 
vp
 = 
	`g°rchr
(
˝
, '=');

1044 
vp
) {

1048 
≈
 = 
˝
;

1049 
	`isgoodch¨
(*
≈
)) {

1050 
≈
++;

1052 
ç
 = *
≈
;

1053 *
≈
 = 0;

1057 
vp
++;

1058 !
	`isgoodch¨
(*
vp
)) {

1059 
vp
++;

1064 
≈v
 = 
vp
;

1065 
	`isgoodch¨
(*
≈v
)) {

1066 
≈v
++;

1068 
çv
 = *
≈v
;

1069 *
≈v
 = 0;

1073 i‡(
	`g°ricmp
(
˝
, 
	`T
("username")) == 0) {

1074 
wp
->
u£rName
 = 
	`b°rdup
(
B_L
, 
vp
);

1075 } i‡(
	`g°ricmp
(
˝
, 
	`T
("response")) == 0) {

1076 
wp
->
dige°
 = 
	`b°rdup
(
B_L
, 
vp
);

1077 } i‡(
	`g°ricmp
(
˝
, 
	`T
("opaque")) == 0) {

1078 
wp
->
›aque
 = 
	`b°rdup
(
B_L
, 
vp
);

1079 } i‡(
	`g°ricmp
(
˝
, 
	`T
("uri")) == 0) {

1080 
wp
->
uri
 = 
	`b°rdup
(
B_L
, 
vp
);

1081 } i‡(
	`g°ricmp
(
˝
, 
	`T
("realm")) == 0) {

1082 
wp
->
ªÆm
 = 
	`b°rdup
(
B_L
, 
vp
);

1083 } i‡(
	`g°ricmp
(
˝
, 
	`T
("nonce")) == 0) {

1084 
wp
->
n⁄˚
 = 
	`b°rdup
(
B_L
, 
vp
);

1085 } i‡(
	`g°ricmp
(
˝
, 
	`T
("nc")) == 0) {

1086 
wp
->
nc
 = 
	`b°rdup
(
B_L
, 
vp
);

1087 } i‡(
	`g°ricmp
(
˝
, 
	`T
("cnonce")) == 0) {

1088 
wp
->
˙⁄˚
 = 
	`b°rdup
(
B_L
, 
vp
);

1089 } i‡(
	`g°ricmp
(
˝
, 
	`T
("qop")) == 0) {

1090 
wp
->
q›
 = 
	`b°rdup
(
B_L
, 
vp
);

1095 *
≈
 = 
ç
;

1096 *
≈v
 = 
çv
;

1100 
˝
 = 
≈v
;

1101 *
˝
 && 
	`isgoodch¨
(*cp)) {

1102 
˝
++;

1104 *
˝
 && !
	`isgoodch¨
(*cp)) {

1105 
˝
++;

1108 i‡(*
˝
) {

1109 
vp
 = 
	`g°rchr
(
˝
, '=');

1111 
vp
 = 
NULL
;

1119 } i‡(
	`g°rcmp
(
key
, 
	`T
("content-length")) == 0) {

1126 
wp
->
˛í
 = 
	`g©oi
(
vÆue
);

1127 i‡(
wp
->
˛í
 > 0)

1129 
wp
->
Êags
 |
WEBS_CLEN
;

1130 
	`websSëV¨
(
wp
, 
	`T
("CONTENT_LENGTH"), 
vÆue
);

1134 
wp
->
˛í
 = 0;

1140 } i‡(
	`g°rcmp
(
key
, 
	`T
("content-type")) == 0) {

1141 
	`websSëV¨
(
wp
, 
	`T
("CONTENT_TYPE"), 
vÆue
);

1143 #ifde‡
WEBS_KEEP_ALIVE_SUPPORT


1144 } i‡(
	`g°rcmp
(
key
, 
	`T
("connection")) == 0) {

1145 
	`°æowî
(
vÆue
);

1146 i‡(
	`g°rcmp
(
vÆue
, 
	`T
("keep-alive")) == 0) {

1147 
wp
->
Êags
 |
WEBS_KEEP_ALIVE
;

1151 #ifde‡
WEBS_PROXY_SUPPORT


1156 } i‡(
	`g°rcmp
(
key
, 
	`T
("pragma")) == 0) {

1157 
ch¨_t
 
tmp
[256];

1158 
	`g°∫˝y
(
tmp
, 
vÆue
, 
	`TSZ
(tmp));

1159 
	`°æowî
(
tmp
);

1160 i‡(
	`g°r°r
(
tmp
, 
	`T
("no-cache"))) {

1161 
wp
->
Êags
 |
WEBS_DONT_USE_CACHE
;

1168 } i‡(
	`g°rcmp
(
key
, 
	`T
("cookie")) == 0) {

1169 
wp
->
Êags
 |
WEBS_COOKIE
;

1170 
wp
->
cookõ
 = 
	`b°rdup
(
B_L
, 
vÆue
);

1172 #ifde‡
WEBS_IF_MODIFIED_SUPPORT


1177 } i‡(
	`g°rcmp
(
key
, 
	`T
("if-modified-since")) == 0) {

1178 
ch¨_t
 *
cmd
;

1179 
time_t
 
tù
 = 0;

1181 i‡((
˝
 = 
	`g°rchr
(
vÆue
, ';')Ë!
NULL
) {

1182 *
˝
 = '\0';

1185 
	`fmtAŒoc
(&
cmd
, 64, 
	`T
("%s"), 
vÆue
);

1187 i‡((
wp
->
sö˚
 = 
	`d©eP¨£
(
tù
, 
cmd
)) != 0) {

1188 
wp
->
Êags
 |
WEBS_IF_MODIFIED
;

1191 
	`b‰ìSa„
(
B_L
, 
cmd
);

1195 
	}
}

1204 
	$websSëEnv
(
webs_t
 
wp
)

1206 
ch¨_t
 
p‹tBuf
[8];

1207 
ch¨_t
 *
keyw‹d
, *
vÆue
, *
vÆCheck
, *
vÆNew
;

1209 
	`a_as£π
(
	`websVÆid
(
wp
));

1211 
	`websSëV¨
(
wp
, 
	`T
("QUERY_STRING"), wp->
quîy
);

1212 
	`websSëV¨
(
wp
, 
	`T
("GATEWAY_INTERFACE"), T("CGI/1.1"));

1213 
	`websSëV¨
(
wp
, 
	`T
("SERVER_HOST"), 
websHo°
);

1214 
	`websSëV¨
(
wp
, 
	`T
("SERVER_NAME"), 
websHo°
);

1215 
	`websSëV¨
(
wp
, 
	`T
("SERVER_URL"), 
websHo°Uæ
);

1216 
	`websSëV¨
(
wp
, 
	`T
("REMOTE_HOST"), wp->
ùaddr
);

1217 
	`websSëV¨
(
wp
, 
	`T
("REMOTE_ADDR"), wp->
ùaddr
);

1218 
	`websSëV¨
(
wp
, 
	`T
("PATH_INFO"), wp->
∑th
);

1219 
	`°rôﬂ
(
websP‹t
, 
p‹tBuf
, (portBuf));

1220 
	`websSëV¨
(
wp
, 
	`T
("SERVER_PORT"), 
p‹tBuf
);

1221 
	`websSëV¨
(
wp
, 
	`T
("SERVER_ADDR"), wp->
iÁddr
);

1222 #ifde‡
WEBS_SSL_SUPPORT


1223 
	`fmtAŒoc
(&
vÆue
, 
FNAMESIZE
, 
	`T
("%s/%s %s/%s"),

1224 
WEBS_NAME
, 
WEBS_VERSION
, 
SSL_NAME
, 
SSL_VERSION
);

1226 
	`fmtAŒoc
(&
vÆue
, 
FNAMESIZE
, 
	`T
("%s/%s"), 
WEBS_NAME
, 
WEBS_VERSION
);

1228 
	`websSëV¨
(
wp
, 
	`T
("SERVER_SOFTWARE"), 
vÆue
);

1229 
	`b‰ìSa„
(
B_L
, 
vÆue
);

1230 
	`websSëV¨
(
wp
, 
	`T
("SERVER_PROTOCOL"), wp->
¥ŸoVîsi⁄
);

1238 
wp
->
decodedQuîy
 = 
	`b°rdup
(
B_L
, wp->
quîy
);

1239 
keyw‹d
 = 
	`g°πok
(
wp
->
decodedQuîy
, 
	`T
("&"));

1240 
keyw‹d
 !
NULL
) {

1241 i‡((
vÆue
 = 
	`g°rchr
(
keyw‹d
, '=')Ë!
NULL
) {

1242 *
vÆue
++ = '\0';

1243 
	`websDecodeUæ
(
keyw‹d
, keyw‹d, 
	`g°æí
(keyword));

1244 
	`websDecodeUæ
(
vÆue
, vÆue, 
	`g°æí
(value));

1246 
vÆue
 = 
	`T
("");

1249 i‡(*
keyw‹d
) {

1254 i‡((
vÆCheck
 = 
	`websGëV¨
(
wp
, 
keyw‹d
, 
NULL
)) != 0) {

1255 
	`fmtAŒoc
(&
vÆNew
, 256, 
	`T
("%†%s"), 
vÆCheck
, 
vÆue
);

1256 
	`websSëV¨
(
wp
, 
keyw‹d
, 
vÆNew
);

1257 
	`b‰ìSa„
(
B_L
, 
vÆNew
);

1259 
	`websSëV¨
(
wp
, 
keyw‹d
, 
vÆue
);

1262 
keyw‹d
 = 
	`g°πok
(
NULL
, 
	`T
("&"));

1265 
	}
}

1273 
	$websSëV¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
)

1275 
vÆue_t
 
v
;

1277 
	`a_as£π
(
	`websVÆid
(
wp
));

1282 i‡(
vÆue
) {

1283 
v
 = 
	`vÆueSåög
(
vÆue
, 
VALUE_ALLOCATE
);

1285 
v
 = 
	`vÆueSåög
(
	`T
(""), 
VALUE_ALLOCATE
);

1287 
	`symE¡î
(
wp
->
cgiV¨s
, 
v¨
, 
v
, 0);

1288 
	}
}

1295 
	$websTe°V¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
)

1297 
sym_t
 *
•
;

1299 
	`a_as£π
(
	`websVÆid
(
wp
));

1301 i‡(
v¨
 =
NULL
 || *var == '\0') {

1305 i‡((
•
 = 
	`symLookup
(
wp
->
cgiV¨s
, 
v¨
)Ë=
NULL
) {

1309 
	}
}

1317 
ch¨_t
 *
	$websGëV¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
, ch¨_à*
deÁu…GëVÆue
)

1319 
sym_t
 *
•
;

1321 
	`a_as£π
(
	`websVÆid
(
wp
));

1322 
	`a_as£π
(
v¨
 && *var);

1324 i‡((
•
 = 
	`symLookup
(
wp
->
cgiV¨s
, 
v¨
)Ë!
NULL
) {

1325 
	`a_as£π
(
•
->
c⁄ã¡
.
ty≥
 =
°rög
);

1326 i‡(
•
->
c⁄ã¡
.
vÆue
.
°rög
) {

1327  
•
->
c⁄ã¡
.
vÆue
.
°rög
;

1329  
	`T
("");

1332  
deÁu…GëVÆue
;

1333 
	}
}

1340 
	$websCom∑ªV¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
)

1342 
	`a_as£π
(
	`websVÆid
(
wp
));

1343 
	`a_as£π
(
v¨
 && *var);

1345 i‡(
	`g°rcmp
(
vÆue
, 
	`websGëV¨
(
wp
, 
v¨
, 
	`T
(" __UNDEF__ "))) == 0) {

1349 
	}
}

1356 
	$websTimeoutC™˚l
(
webs_t
 
wp
)

1358 
	`a_as£π
(
	`websVÆid
(
wp
));

1360 i‡(
wp
->
timeout
 >= 0) {

1361 
	`emfUnschedCÆlback
(
wp
->
timeout
);

1362 
wp
->
timeout
 = -1;

1364 
	}
}

1372 
	$websRe•⁄£
(
webs_t
 
wp
, 
code
, 
ch¨_t
 *
mesßge
, ch¨_à*
ªdúe˘
)

1374 
ch¨_t
 *
d©e
;

1376 
	`a_as£π
(
	`websVÆid
(
wp
));

1381 
wp
->
Êags
 &~
WEBS_KEEP_ALIVE
;

1386 i‡–!(
wp
->
Êags
 & 
WEBS_HEADER_DONE
)) {

1387 
wp
->
Êags
 |
WEBS_HEADER_DONE
;

1391 i‡(
ªdúe˘
 !
NULL
) {

1392 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.0 %d %s\r\n"), 
code
, 
	`websEº‹Msg
(code));

1394 
	`websWrôe
(
wp
, 
	`T
("HTTP/1.1 %d %s\r\n"), 
code
, 
	`websEº‹Msg
(code));

1400 #ifde‡
WEBS_SSL_SUPPORT


1401 
	`websWrôe
(
wp
, 
	`T
("Server: %s/%s %s/%s\r\n"),

1402 
WEBS_NAME
, 
WEBS_VERSION
, 
SSL_NAME
, 
SSL_VERSION
);

1404 
	`websWrôe
(
wp
, 
	`T
("Sîvî: %s/%s\r\n"), 
WEBS_NAME
, 
WEBS_VERSION
);

1409 i‡((
d©e
 = 
	`websGëD©eSåög
(
NULL
)) != NULL) {

1410 
	`websWrôe
(
wp
, 
	`T
("D©e: %s\r\n"), 
d©e
);

1411 
	`b‰ì
(
B_L
, 
d©e
);

1416 i‡(
code
 == 401) {

1417 i‡(!(
wp
->
Êags
 & 
WEBS_AUTH_DIGEST
)) {

1418 
	`websWrôe
(
wp
, 
	`T
("WWW-Authenticate: BasicÑealm=\"%s\"\r\n"),

1419 
	`websGëRólm
());

1420 #ifde‡
DIGEST_ACCESS_SUPPORT


1422 
ch¨_t
 *
n⁄˚
, *
›aque
;

1428 
n⁄˚
 = 
	`websCÆcN⁄˚
(
wp
);

1429 
›aque
 = 
	`websCÆcO∑que
(
wp
);

1431 
	`websWrôe
(
wp
,

1432 
	`T
("WWW-Authenticate: DigestÑealm=\"%s\", domain=\"%s\",")

1433 
	`T
("qop=\"%s\",Çonce=\"%s\", opaque=\"%s\",")

1434 
	`T
("algorithm=\"%s\", stale=\"%s\"\r\n"),

1435 
	`websGëRólm
(),

1436 
	`websGëHo°Uæ
(),

1437 
	`T
("auth"),

1438 
n⁄˚
,

1439 
›aque
, 
	`T
("MD5"), T("FALSE"));

1440 
	`b‰ì
(
B_L
, 
n⁄˚
);

1441 
	`b‰ì
(
B_L
, 
›aque
);

1446 i‡(
wp
->
Êags
 & 
WEBS_KEEP_ALIVE
) {

1447 
	`websWrôe
(
wp
, 
	`T
("Connection: keep-alive\r\n"));

1450 
	`websWrôe
(
wp
, 
	`T
("Pragma:Ço-cache\r\nCache-Control:Ço-cache\r\n"));

1451 
	`websWrôe
(
wp
, 
	`T
("Content-Type:Åext/html\r\n"));

1459 i‡(
ªdúe˘
) {

1460 
	`websWrôe
(
wp
, 
	`T
("Loˇti⁄: %s\r\n"), 
ªdúe˘
);

1462 
	`websWrôe
(
wp
, 
	`T
("\r\n"));

1468 i‡((
wp
->
Êags
 & 
WEBS_HEAD_REQUEST
Ë=0 && 
mesßge
 && *message) {

1469 
	`websWrôe
(
wp
, 
	`T
("%s\r\n"), 
mesßge
);

1471 
	`websD⁄e
(
wp
, 
code
);

1472 
	}
}

1479 
	$websRedúe˘
(
webs_t
 
wp
, 
ch¨_t
 *
uæ
)

1481 
ch¨_t
 *
msgbuf
, *
uæbuf
, *
ªdúe˘Fmt
;

1483 
	`a_as£π
(
	`websVÆid
(
wp
));

1484 
	`a_as£π
(
uæ
);

1486 
websSèts
.
ªdúe˘s
++;

1487 
msgbuf
 = 
uæbuf
 = 
NULL
;

1492 i‡(
	`g°r°r
(
uæ
, 
	`T
("hâp://")Ë=
NULL
) {

1493 i‡(*
uæ
 == '/') {

1494 
uæ
++;

1497 
ªdúe˘Fmt
 = 
	`T
("http://%s/%s");

1499 #ifde‡
WEBS_SSL_SUPPORT


1500 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

1501 
ªdúe˘Fmt
 = 
	`T
("https://%s/%s");

1505 
	`fmtAŒoc
(&
uæbuf
, 
WEBS_MAX_URL
 + 80, 
ªdúe˘Fmt
,

1506 
	`websGëV¨
(
wp
, 
	`T
("HTTP_HOST"), 
websHo°Uæ
), 
uæ
);

1507 
uæ
 = 
uæbuf
;

1513 
	`fmtAŒoc
(&
msgbuf
, 
WEBS_MAX_URL
 + 80,

1514 
	`T
("<html><hód></hód><body>\r\n\
 documíàha†movedÅÿ®√w <®hªf=\"%s\">loˇti⁄</a>.\r\n\
 upd©êyou∏documít†tÿªÊe˘Åhê√wÜoˇti⁄.\r\n\
</body></html>\r\n"), 
uæ
);

1519 
	`websRe•⁄£
(
wp
, 302, 
msgbuf
, 
uæ
);

1521 
	`b‰ìSa„
(
B_L
, 
msgbuf
);

1522 
	`b‰ìSa„
(
B_L
, 
uæbuf
);

1523 
	}
}

1534 
	#kLt
 '<'

	)

1535 
	#kLessTh™
 
	`T
("&…;")

	)

1536 
	#kGt
 '>'

	)

1537 
	#kGª©îTh™
 
	`T
("&gt;")

	)

1542 
	$ch¨Cou¡
(c⁄° 
ch¨_t
* 
°r
, ch¨_à
ch
)

1544 
cou¡
 = 0;

1545 
ch¨_t
* 
p
 = (ch¨_t*Ë
°r
;

1547 i‡(
NULL
 =
°r
)

1554 
p
 = 
	`g°rchr
’, 
ch
);

1555 i‡(
NULL
 =
p
)

1562 ++
cou¡
;

1563 ++
p
;

1565  
cou¡
;

1566 
	}
}

1570 
ch¨_t
* 
	$websSa„Uæ
(c⁄° 
ch¨_t
* 
uæ
)

1573 
…Cou¡
 = 
	`ch¨Cou¡
(
uæ
, 
kLt
);

1574 
gtCou¡
 = 
	`ch¨Cou¡
(
uæ
, 
kGt
);

1575 
ß„Lí
 = 0;

1576 
ch¨_t
* 
ß„Uæ
 = 
NULL
;

1577 
ch¨_t
* 
§c
 = 
NULL
;

1578 
ch¨_t
* 
de°
 = 
NULL
;

1580 i‡(
NULL
 !
uæ
)

1582 
ß„Lí
 = 
	`g°æí
(
uæ
);

1583 i‡(
…Cou¡
 =0 && 
gtCou¡
 == 0)

1585 
ß„Uæ
 = 
	`b°rdup
(
B_L
, (
ch¨_t
*Ë
uæ
);

1589 
ß„Lí
 +(
…Cou¡
 * 4);

1590 
ß„Lí
 +(
gtCou¡
 * 4);

1592 
ß„Uæ
 = 
	`bÆloc
(
B_L
, 
ß„Lí
);

1593 i‡(
ß„Uæ
 !
NULL
)

1595 
§c
 = (
ch¨_t
*Ë
uæ
;

1596 
de°
 = 
ß„Uæ
;

1597 *
§c
)

1599 i‡(*
§c
 =
kLt
)

1601 
	`g°r˝y
(
de°
, 
kLessTh™
);

1602 
de°
 +
	`g°æí
(
kLessTh™
);

1604 i‡(*
§c
 =
kGt
)

1606 
	`g°r˝y
(
de°
, 
kGª©îTh™
);

1607 
de°
 +
	`g°æí
(
kGª©îTh™
);

1611 *
de°
++ = *
§c
;

1613 ++
§c
;

1616 *
de°
 = '\0';

1620  
ß„Uæ
;

1621 
	}
}

1629 
	$websEº‹
(
webs_t
 
wp
, 
code
, 
ch¨_t
 *
fmt
, ...)

1631 
va_li°
 
¨gs
;

1632 
ch¨_t
 *
msg
, *
u£rMsg
, *
buf
;

1633 
ch¨_t
* 
ß„Uæ
 = 
NULL
;

1634 
ch¨_t
* 
ß„Msg
 = 
NULL
;

1636 
	`a_as£π
(
	`websVÆid
(
wp
));

1637 
	`a_as£π
(
fmt
);

1639 
websSèts
.
îr‹s
++;

1644 
ß„Uæ
 = 
	`websSa„Uæ
(
wp
->
uæ
);

1645 
	`b‰ìSa„
(
B_L
, 
wp
->
uæ
);

1646 
wp
->
uæ
 = 
ß„Uæ
;

1648 
	`va_°¨t
(
¨gs
, 
fmt
);

1649 
u£rMsg
 = 
NULL
;

1650 
	`fmtVÆloc
(&
u£rMsg
, 
WEBS_BUFSIZE
, 
fmt
, 
¨gs
);

1651 
	`va_íd
(
¨gs
);

1652 
ß„Msg
 = 
	`websSa„Uæ
(
u£rMsg
);

1653 
	`b‰ìSa„
(
B_L
, 
u£rMsg
);

1654 
u£rMsg
 = 
ß„Msg
;

1655 
ß„Msg
 = 
NULL
;

1660 
msg
 = 
	`T
("<html><head><title>Document Error: %s</title></head>\r\n\
<body><h2>Access Error: %s</h2>\r\n\
<p>%s</p></body></html>\r\n");

1667 
buf
 = 
NULL
;

1668 
	`fmtAŒoc
(&
buf
, 
WEBS_BUFSIZE
, 
msg
, 
	`websEº‹Msg
(
code
),

1669 
	`websEº‹Msg
(
code
), 
u£rMsg
);

1671 
	`websRe•⁄£
(
wp
, 
code
, 
buf
, 
NULL
);

1672 
	`b‰ìSa„
(
B_L
, 
buf
);

1673 
	`b‰ìSa„
(
B_L
, 
u£rMsg
);

1674 
	}
}

1682 
ch¨_t
 *
	$websEº‹Msg
(
code
)

1684 
websEº‹Ty≥
 *
ï
;

1686 
ï
 = 
websEº‹s
;Ép->
code
;Ép++) {

1687 i‡(
code
 =
ï
->code) {

1688  
ï
->
msg
;

1691 
	`a_as£π
(0);

1692  
	`T
("");

1693 
	}
}

1701 
	$websWrôe
(
webs_t
 
wp
, 
ch¨_t
 *
fmt
, ...)

1703 
va_li°
 
v¨gs
;

1704 
ch¨_t
 *
buf
;

1705 
rc
;

1707 
	`a_as£π
(
	`websVÆid
(
wp
));

1709 
	`va_°¨t
(
v¨gs
, 
fmt
);

1711 
buf
 = 
NULL
;

1712 
rc
 = 0;

1714 i‡(
	`fmtVÆloc
(&
buf
, 
WEBS_BUFSIZE
, 
fmt
, 
v¨gs
) >= WEBS_BUFSIZE) {

1715 
	`åa˚
(0, 
	`T
("webs: websWriteÜost data, buffer overflow\n"));

1718 
	`va_íd
(
v¨gs
);

1719 
	`a_as£π
(
buf
);

1720 i‡(
buf
) {

1721 
rc
 = 
	`websWrôeBlock
(
wp
, 
buf
, 
	`g°æí
(buf));

1722 
	`b‰ì
(
B_L
, 
buf
);

1724  
rc
;

1725 
	}
}

1738 
	$websWrôeBlock
(
webs_t
 
wp
, 
ch¨_t
 *
buf
, 
nCh¨s
)

1740 
Àn
, 
d⁄e
;

1741 *
asciiBuf
, *
pBuf
;

1743 
	`a_as£π
(
wp
);

1744 
	`a_as£π
(
	`websVÆid
(
wp
));

1745 
	`a_as£π
(
buf
);

1746 
	`a_as£π
(
nCh¨s
 >= 0);

1748 
d⁄e
 = 
Àn
 = 0;

1754 
pBuf
 = 
asciiBuf
 = 
	`bÆlocUniToAsc
(
buf
, 
nCh¨s
);

1756 
nCh¨s
 > 0) {

1757 #ifde‡
WEBS_SSL_SUPPORT


1758 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

1759 i‡((
Àn
 = 
	`websSSLWrôe
(
wp
->
w•
, 
pBuf
, 
nCh¨s
)) < 0) {

1760 
	`b‰ì
(
B_L
, 
asciiBuf
);

1763 
	`websSSLFlush
(
wp
->
w•
);

1765 i‡((
Àn
 = 
	`sockëWrôe
(
wp
->
sid
, 
pBuf
, 
nCh¨s
)) < 0) {

1766 
	`b‰ì
(
B_L
, 
asciiBuf
);

1769 
	`sockëFlush
(
wp
->
sid
);

1772 i‡((
Àn
 = 
	`sockëWrôe
(
wp
->
sid
, 
pBuf
, 
nCh¨s
)) < 0) {

1773 
	`b‰ì
(
B_L
, 
asciiBuf
);

1776 
	`sockëFlush
(
wp
->
sid
);

1778 
nCh¨s
 -
Àn
;

1779 
pBuf
 +
Àn
;

1780 
d⁄e
 +
Àn
;

1783 
	`b‰ì
(
B_L
, 
asciiBuf
);

1784  
d⁄e
;

1785 
	}
}

1797 
	$websWrôeD©aN⁄Block
(
webs_t
 
wp
, *
buf
, 
nCh¨s
)

1799 
r
;

1801 
	`a_as£π
(
wp
);

1802 
	`a_as£π
(
	`websVÆid
(
wp
));

1803 
	`a_as£π
(
buf
);

1804 
	`a_as£π
(
nCh¨s
 >= 0);

1806 #ifde‡
WEBS_SSL_SUPPORT


1807 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

1808 
r
 = 
	`websSSLWrôe
(
wp
->
w•
, 
buf
, 
nCh¨s
);

1809 
	`websSSLFlush
(
wp
->
w•
);

1811 
r
 = 
	`sockëWrôe
(
wp
->
sid
, 
buf
, 
nCh¨s
);

1812 
	`sockëFlush
(
wp
->
sid
);

1815 
r
 = 
	`sockëWrôe
(
wp
->
sid
, 
buf
, 
nCh¨s
);

1816 
	`sockëFlush
(
wp
->
sid
);

1819  
r
;

1820 
	}
}

1827 
	$websDecodeUæ
(
ch¨_t
 *
decoded
, ch¨_à*
tokí
, 
Àn
)

1829 
ch¨_t
 *
ù
, *
›
;

1830 
num
, 
i
, 
c
;

1832 
	`a_as£π
(
decoded
);

1833 
	`a_as£π
(
tokí
);

1835 
›
 = 
decoded
;

1836 
ù
 = 
tokí
; *ù && 
Àn
 > 0; ip++, 
›
++) {

1837 i‡(*
ù
 == '+') {

1838 *
›
 = ' ';

1839 } i‡(*
ù
 ='%' && 
	`gisxdigô
(ip[1]) && gisxdigit(ip[2])) {

1844 
ù
++;

1845 
i
 = 0, 
num
 = 0; i < 2; i++, 
ù
++) {

1846 
c
 = 
	`tﬁowî
(*
ù
);

1847 i‡(
c
 >= 'a' && c <= 'f') {

1848 
num
 = (num * 16Ë+ 10 + 
c
 - 'a';

1850 
num
 = (num * 16Ë+ 
c
 - '0';

1853 *
›
 = (
ch¨_t
Ë
num
;

1854 
ù
--;

1857 *
›
 = *
ù
;

1859 
Àn
--;

1861 *
›
 = '\0';

1862 
	}
}

1865 #ifde‡
WEBS_LOG_SUPPORT


1877 
	$websLog
(
webs_t
 
wp
, 
code
)

1879 
ch¨_t
 *
buf
;

1880 *
abuf
;

1881 
Àn
;

1882 #i‚de‡
WEBS_SIMPLE_TIME


1883 
time_t
 
timî
;

1884 
tm
 
loˇ…
;

1885 #ifde‡
WIN


1886 
DWORD
 
dwRë
;

1887 
TIME_ZONE_INFORMATION
 
tzi
;

1889 
ch¨_t
 
timeSå
[28];

1890 
ch¨_t
 
z⁄eSå
[6];

1891 
ch¨_t
 
d©aSå
[16];

1893 
	`a_as£π
(
	`websVÆid
(
wp
));

1894 
buf
 = 
NULL
;

1895 #i‚de‡
WEBS_SIMPLE_TIME


1896 
	`time
(&
timî
);

1897 
	`loˇ…ime_r
(&
timî
, &
loˇ…
);

1898 
	`°r·ime
(
timeSå
, —imeSå), "%d/%b/%Y:%H:%M:%S", &
loˇ…
);

1899 
timeSå
[(timeStr) - 1] = '\0';

1900 #ifde‡
WIN


1901 
dwRë
 = 
	`GëTimeZ⁄eInf‹m©i⁄
(&
tzi
);

1902 
	`¢¥ötf
(
z⁄eSå
, (z⁄eSå), "%+03d00", -()(
tzi
.
Büs
/60));

1904 
	`¢¥ötf
(
z⁄eSå
, (z⁄eSå), "%+03d00", ()(
loˇ…
.
tm_gmtoff
/3600));

1906 
z⁄eSå
[(zoneStr) - 1] = '\0';

1907 i‡(
wp
->
wrôãn
 != 0) {

1908 
	`¢¥ötf
(
d©aSå
, (d©aSå), "%d", 
wp
->
wrôãn
);

1909 
d©aSå
[(dataStr) - 1] = '\0';

1911 
d©aSå
[0] = '-'; dataStr[1] = '\0';

1913 
	`fmtAŒoc
(&
buf
, 
WEBS_MAX_URL
 + 80,

1914 
	`T
("%s - %s [%s %s] \"%s %s %s\" %d %s\n"),

1915 
wp
->
ùaddr
,

1916 
wp
->
u£rName
 =
NULL
 ? "-" : wp->userName,

1917 
timeSå
, 
z⁄eSå
,

1918 
wp
->
Êags
 & 
WEBS_POST_REQUEST
 ? "POST" :

1919 (
wp
->
Êags
 & 
WEBS_HEAD_REQUEST
 ? "HEAD" : "GET"),

1920 #ifde‡
WEBS_LOG_QUERY


1921 
wp
->
uæ
,

1923 
wp
->
∑th
,

1925 
wp
->
¥ŸoVîsi⁄
, 
code
, 
d©aSå
);

1927 
	`fmtAŒoc
(&
buf
, 
WEBS_MAX_URL
 + 80, 
	`T
("%d %†%d %d\n"), 
	`time
(0),

1928 
wp
->
uæ
, 
code
, wp->
wrôãn
);

1930 
Àn
 = 
	`g°æí
(
buf
);

1931 
abuf
 = 
	`bÆlocUniToAsc
(
buf
, 
Àn
+1);

1932 
	`wrôe
(
websLogFd
, 
abuf
, 
Àn
);

1933 
	`b‰ìSa„
(
B_L
, 
buf
);

1934 
	`b‰ìSa„
(
B_L
, 
abuf
);

1935 
	}
}

1941 #ifde‡
WEBS_TRACE_SUPPORT


1945 
	$åa˚H™dÀr
(
Àvñ
, 
ch¨_t
 *
buf
)

1947 
Àn
;

1948 *
abuf
;

1950 i‡(
Àvñ
 <
WEBS_TRACE_LEVEL
) {

1951 
Àn
 = 
	`g°æí
(
buf
);

1952 
abuf
 = 
	`bÆlocUniToAsc
(
buf
, 
Àn
+1);

1953 
	`wrôe
(
websTø˚Fd
, 
abuf
, 
Àn
);

1954 
	`b‰ìSa„
(
B_L
, 
abuf
);

1956 
	}
}

1967 
	$websTimeout
(*
¨g
, 
id
)

1969 
webs_t
 
wp
;

1970 
dñay
, 
tm
;

1972 
wp
 = (
webs_t
Ë
¨g
;

1973 
	`a_as£π
(
	`websVÆid
(
wp
));

1975 
tm
 = 
	`websGëTimeSö˚M¨k
(
wp
) * 1000;

1976 i‡(
tm
 >
WEBS_TIMEOUT
) {

1977 
websSèts
.
timeouts
++;

1978 
	`emfUnschedCÆlback
(
id
);

1983 
wp
->
timeout
 = -1;

1984 
	`websD⁄e
(
wp
, 404);

1986 
dñay
 = 
WEBS_TIMEOUT
 - 
tm
;

1987 
	`a_as£π
(
dñay
 > 0);

1988 
	`emfReschedCÆlback
(
id
, 
dñay
);

1990 
	}
}

1997 
	$websD⁄e
(
webs_t
 
wp
, 
code
)

1999 
	`a_as£π
(
	`websVÆid
(
wp
));

2004 
	`sockëDñëeH™dÀr
(
wp
->
sid
);

2006 i‡(
code
 != 200) {

2007 
wp
->
Êags
 &~
WEBS_KEEP_ALIVE
;

2010 #ifde‡
WEBS_PROXY_SUPPORT


2011 i‡(! (
wp
->
Êags
 & 
WEBS_LOCAL_PAGE
)) {

2012 
websSèts
.
a˘iveNëReque°s
--;

2016 #ifde‡
WEBS_LOG_SUPPORT


2017 i‡(! (
wp
->
Êags
 & 
WEBS_REQUEST_DONE
)) {

2018 
	`websLog
(
wp
, 
code
);

2025 
	`websPageClo£
(
wp
);

2030 #ifde‡
WEBS_SSL_SUPPORT


2031 i‡(
wp
->
Êags
 & 
WEBS_SECURE
) {

2032 
	`websTimeoutC™˚l
(
wp
);

2033 
	`websSSLFlush
(
wp
->
w•
);

2034 
	`sockëClo£C⁄√˘i⁄
(
wp
->
sid
);

2035 
	`websFªe
(
wp
);

2044 i‡(
wp
->
Êags
 & 
WEBS_KEEP_ALIVE
) {

2045 i‡(
	`sockëFlush
(
wp
->
sid
) == 0) {

2046 
wp
->
°©e
 = 
WEBS_BEGIN
;

2047 
wp
->
Êags
 |
WEBS_REQUEST_DONE
;

2048 i‡(
wp
->
hódî
.
buf
) {

2049 
	`rögqFlush
(&
wp
->
hódî
);

2051 
	`sockëCª©eH™dÀr
(
wp
->
sid
, 
SOCKET_READABLE
, 
websSockëEvít
,

2052 
wp
);

2053 
	`websTimeoutC™˚l
(
wp
);

2054 
wp
->
timeout
 = 
	`emfSchedCÆlback
(
WEBS_TIMEOUT
, 
websTimeout
,

2055 (*Ë
wp
);

2059 
	`websTimeoutC™˚l
(
wp
);

2060 
	`sockëSëBlock
(
wp
->
sid
, 1);

2061 
	`sockëFlush
(
wp
->
sid
);

2062 
	`sockëClo£C⁄√˘i⁄
(
wp
->
sid
);

2064 
	`websFªe
(
wp
);

2065 
	}
}

2072 
	$websAŒoc
(
sid
)

2074 
webs_t
 
wp
;

2075 
wid
;

2080 i‡((
wid
 = 
	`hAŒocE¡ry
((***Ë&
webs
, &
websMax
,

2081 (
websRec
))) < 0) {

2084 
wp
 = 
webs
[
wid
];

2086 
wp
->
wid
 = wid;

2087 
wp
->
sid
 = sid;

2088 
wp
->
°©e
 = 
WEBS_BEGIN
;

2089 
wp
->
docfd
 = -1;

2090 
wp
->
timeout
 = -1;

2091 
wp
->
dú
 = 
NULL
;

2092 
wp
->
authTy≥
 = 
NULL
;

2093 
wp
->
¥Ÿocﬁ
 = 
NULL
;

2094 
wp
->
¥ŸoVîsi⁄
 = 
NULL
;

2095 
wp
->
∑ssw‹d
 = 
NULL
;

2096 
wp
->
u£rName
 = 
NULL
;

2097 #ifde‡
DIGEST_ACCESS_SUPPORT


2098 
wp
->
ªÆm
 = 
NULL
;

2099 
wp
->
n⁄˚
 = 
NULL
;

2100 
wp
->
dige°
 = 
NULL
;

2101 
wp
->
uri
 = 
NULL
;

2102 
wp
->
›aque
 = 
NULL
;

2103 
wp
->
nc
 = 
NULL
;

2104 
wp
->
˙⁄˚
 = 
NULL
;

2105 
wp
->
q›
 = 
NULL
;

2107 #ifde‡
WEBS_SSL_SUPPORT


2108 
wp
->
w•
 = 
NULL
;

2111 
	`rögqO≥n
(&
wp
->
hódî
, 
WEBS_HEADER_BUFINC
, 
WEBS_MAX_HEADER
);

2118 
wp
->
cgiV¨s
 = 
	`symO≥n
(
WEBS_SYM_INIT
);

2120  
wid
;

2121 
	}
}

2128 
	$websFªe
(
webs_t
 
wp
)

2130 
	`a_as£π
(
	`websVÆid
(
wp
));

2132 i‡(
wp
->
∑th
)

2133 
	`b‰ì
(
B_L
, 
wp
->
∑th
);

2134 i‡(
wp
->
uæ
)

2135 
	`b‰ì
(
B_L
, 
wp
->
uæ
);

2136 i‡(
wp
->
ho°
)

2137 
	`b‰ì
(
B_L
, 
wp
->
ho°
);

2138 i‡(
wp
->
Õ©h
)

2139 
	`b‰ì
(
B_L
, 
wp
->
Õ©h
);

2140 i‡(
wp
->
quîy
)

2141 
	`b‰ì
(
B_L
, 
wp
->
quîy
);

2142 i‡(
wp
->
decodedQuîy
)

2143 
	`b‰ì
(
B_L
, 
wp
->
decodedQuîy
);

2144 i‡(
wp
->
authTy≥
)

2145 
	`b‰ì
(
B_L
, 
wp
->
authTy≥
);

2146 i‡(
wp
->
∑ssw‹d
)

2147 
	`b‰ì
(
B_L
, 
wp
->
∑ssw‹d
);

2148 i‡(
wp
->
u£rName
)

2149 
	`b‰ì
(
B_L
, 
wp
->
u£rName
);

2150 i‡(
wp
->
cookõ
)

2151 
	`b‰ì
(
B_L
, 
wp
->
cookõ
);

2152 i‡(
wp
->
u£rAgít
)

2153 
	`b‰ì
(
B_L
, 
wp
->
u£rAgít
);

2154 i‡(
wp
->
dú
)

2155 
	`b‰ì
(
B_L
, 
wp
->
dú
);

2156 i‡(
wp
->
¥Ÿocﬁ
)

2157 
	`b‰ì
(
B_L
, 
wp
->
¥Ÿocﬁ
);

2158 i‡(
wp
->
¥ŸoVîsi⁄
)

2159 
	`b‰ì
(
B_L
, 
wp
->
¥ŸoVîsi⁄
);

2160 i‡(
wp
->
cgiStdö
)

2161 
	`b‰ì
(
B_L
, 
wp
->
cgiStdö
);

2164 #ifde‡
DIGEST_ACCESS_SUPPORT


2165 i‡(
wp
->
ªÆm
)

2166 
	`b‰ì
(
B_L
, 
wp
->
ªÆm
);

2167 i‡(
wp
->
uri
)

2168 
	`b‰ì
(
B_L
, 
wp
->
uri
);

2169 i‡(
wp
->
dige°
)

2170 
	`b‰ì
(
B_L
, 
wp
->
dige°
);

2171 i‡(
wp
->
›aque
)

2172 
	`b‰ì
(
B_L
, 
wp
->
›aque
);

2173 i‡(
wp
->
n⁄˚
)

2174 
	`b‰ì
(
B_L
, 
wp
->
n⁄˚
);

2175 i‡(
wp
->
nc
)

2176 
	`b‰ì
(
B_L
, 
wp
->
nc
);

2177 i‡(
wp
->
˙⁄˚
)

2178 
	`b‰ì
(
B_L
, 
wp
->
˙⁄˚
);

2179 i‡(
wp
->
q›
)

2180 
	`b‰ì
(
B_L
, 
wp
->
q›
);

2182 #ifde‡
WEBS_SSL_SUPPORT


2183 
	`websSSLFªe
(
wp
->
w•
);

2185 
	`symClo£
(
wp
->
cgiV¨s
);

2187 i‡(
wp
->
hódî
.
buf
) {

2188 
	`rögqClo£
(&
wp
->
hódî
);

2191 
websMax
 = 
	`hFªe
((***Ë&
webs
, 
wp
->
wid
);

2192 
	`b‰ì
(
B_L
, 
wp
);

2193 
	`a_as£π
(
websMax
 >= 0);

2194 
	}
}

2201 
ch¨_t
 *
	$websGëHo°
()

2203  
websHo°
;

2204 
	}
}

2211 
ch¨_t
 *
	$websGëI∑ddrUæ
()

2213  
websI∑ddrUæ
;

2214 
	}
}

2221 
ch¨_t
 *
	$websGëHo°Uæ
()

2223  
websHo°Uæ
;

2224 
	}
}

2231 
	$websGëP‹t
()

2233  
websP‹t
;

2234 
	}
}

2241 
	$websGëReque°Byãs
(
webs_t
 
wp
)

2243 
	`a_as£π
(
	`websVÆid
(
wp
));

2245  
wp
->
numbyãs
;

2246 
	}
}

2253 
ch¨_t
 *
	$websGëReque°Dú
(
webs_t
 
wp
)

2255 
	`a_as£π
(
	`websVÆid
(
wp
));

2257 i‡(
wp
->
dú
 =
NULL
) {

2258  
	`T
("");

2261  
wp
->
dú
;

2262 
	}
}

2269 
	$websGëReque°Fœgs
(
webs_t
 
wp
)

2271 
	`a_as£π
(
	`websVÆid
(
wp
));

2273  
wp
->
Êags
;

2274 
	}
}

2281 
ch¨_t
 *
	$websGëReque°I∑ddr
(
webs_t
 
wp
)

2283 
	`a_as£π
(
	`websVÆid
(
wp
));

2285  
wp
->
ùaddr
;

2286 
	}
}

2293 
ch¨_t
 *
	$websGëReque°L∑th
(
webs_t
 
wp
)

2295 
	`a_as£π
(
	`websVÆid
(
wp
));

2297 #ifde‡
WEBS_PAGE_ROM


2298  
wp
->
∑th
;

2300  
wp
->
Õ©h
;

2302 
	}
}

2309 
ch¨_t
 *
	$websGëReque°P©h
(
webs_t
 
wp
)

2311 
	`a_as£π
(
	`websVÆid
(
wp
));

2313 i‡(
wp
->
∑th
 =
NULL
) {

2314  
	`T
("");

2317  
wp
->
∑th
;

2318 
	}
}

2325 
ch¨_t
 *
	$websGëReque°Passw‹d
(
webs_t
 
wp
)

2327 
	`a_as£π
(
	`websVÆid
(
wp
));

2329  
wp
->
∑ssw‹d
;

2330 
	}
}

2337 
ch¨_t
 *
	$websGëReque°Ty≥
(
webs_t
 
wp
)

2339 
	`a_as£π
(
	`websVÆid
(
wp
));

2341  
wp
->
ty≥
;

2342 
	}
}

2349 
ch¨_t
 *
	$websGëReque°U£rName
(
webs_t
 
wp
)

2351 
	`a_as£π
(
	`websVÆid
(
wp
));

2353  
wp
->
u£rName
;

2354 
	}
}

2361 
	$websGëReque°Wrôãn
(
webs_t
 
wp
)

2363 
	`a_as£π
(
	`websVÆid
(
wp
));

2365  
wp
->
wrôãn
;

2366 
	}
}

2373 
	$websSëHo°
(
ch¨_t
 *
ho°
)

2375 
	`g°∫˝y
(
websHo°
, 
ho°
, 
	`TSZ
(websHost));

2376 
	}
}

2383 
	$websSëHo°Uæ
(
ch¨_t
 *
uæ
)

2385 
	`a_as£π
(
uæ
 && *url);

2387 
	`b‰ìSa„
(
B_L
, 
websHo°Uæ
);

2388 
websHo°Uæ
 = 
	`g°rdup
(
B_L
, 
uæ
);

2389 
	}
}

2396 
	$websSëI∑ddr
(
ch¨_t
 *
ùaddr
)

2398 
	`a_as£π
(
ùaddr
 && *ipaddr);

2400 
	`g°∫˝y
(
websI∑ddr
, 
ùaddr
, 
	`TSZ
(websIpaddr));

2401 
	}
}

2408 
	$websSëReque°Byãs
(
webs_t
 
wp
, 
byãs
)

2410 
	`a_as£π
(
	`websVÆid
(
wp
));

2411 
	`a_as£π
(
byãs
 >= 0);

2413 
wp
->
numbyãs
 = 
byãs
;

2414 
	}
}

2421 
	$websSëReque°Fœgs
(
webs_t
 
wp
, 
Êags
)

2423 
	`a_as£π
(
	`websVÆid
(
wp
));

2425 
wp
->
Êags
 = flags;

2426 
	}
}

2433 
	$websSëReque°L∑th
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
)

2435 
	`a_as£π
(
	`websVÆid
(
wp
));

2436 
	`a_as£π
(
Õ©h
 && *lpath);

2438 i‡(
wp
->
Õ©h
) {

2439 
	`b‰ì
(
B_L
, 
wp
->
Õ©h
);

2441 
wp
->
Õ©h
 = 
	`b°rdup
(
B_L
,Üpath);

2442 
	`websSëV¨
(
wp
, 
	`T
("PATH_TRANSLATED"), wp->
Õ©h
);

2443 
	}
}

2450 
	$websSëReque°P©h
(
webs_t
 
wp
, 
ch¨_t
 *
dú
, ch¨_à*
∑th
)

2452 
ch¨_t
 *
tmp
;

2454 
	`a_as£π
(
	`websVÆid
(
wp
));

2456 i‡(
dú
) {

2457 
tmp
 = 
wp
->
dú
;

2458 
wp
->
dú
 = 
	`b°rdup
(
B_L
, dir);

2459 i‡(
tmp
) {

2460 
	`b‰ì
(
B_L
, 
tmp
);

2463 i‡(
∑th
) {

2464 
tmp
 = 
wp
->
∑th
;

2465 
wp
->
∑th
 = 
	`b°rdup
(
B_L
,Öath);

2466 
	`websSëV¨
(
wp
, 
	`T
("PATH_INFO"), wp->
∑th
);

2467 i‡(
tmp
) {

2468 
	`b‰ì
(
B_L
, 
tmp
);

2471 
	}
}

2478 
websSëReque°SockëH™dÀr
(
webs_t
 
wp
, 
mask
, (*
‚
)(webs_t wp))

2480 
	`a_as£π
(
	`websVÆid
(
wp
));

2482 
wp
->
wrôeSockë
 = 
‚
;

2483 
	`sockëCª©eH™dÀr
(
wp
->
sid
, 
SOCKET_WRITABLE
, 
websSockëEvít
, wp);

2484 
	}
}

2491 
	$websSëReque°Wrôãn
(
webs_t
 
wp
, 
wrôãn
)

2493 
	`a_as£π
(
	`websVÆid
(
wp
));

2495 
wp
->
wrôãn
 = written;

2496 
	}
}

2503 
	$websVÆid
(
webs_t
 
wp
)

2505 
wid
;

2507 
wid
 = 0; wid < 
websMax
; wid++) {

2508 i‡(
wp
 =
webs
[
wid
]) {

2513 
	}
}

2521 
ch¨_t
 *
	$websGëD©eSåög
(
websSètTy≥
 *
sbuf
)

2523 
ch¨_t
* 
˝
, *
r
;

2524 
time_t
 
now
;

2526 i‡(
sbuf
 =
NULL
) {

2527 
	`time
(&
now
);

2529 
now
 = 
sbuf
->
mtime
;

2531 i‡((
˝
 = 
	`g˘ime
(&
now
)Ë!
NULL
) {

2532 
˝
[
	`g°æí
(cp) - 1] = '\0';

2533 
r
 = 
	`b°rdup
(
B_L
, 
˝
);

2534  
r
;

2536  
NULL
;

2537 
	}
}

2546 
	$websSëTimeM¨k
(
webs_t
 
wp
)

2548 
wp
->
time°amp
 = 
	`time
(0);

2549 
	}
}

2556 
	$websGëTimeSö˚M¨k
(
webs_t
 
wp
)

2558  
	`time
(0Ë- 
wp
->
time°amp
;

2559 
	}
}

2566 
	$websSëRólm
(
ch¨_t
 *
ªÆmName
)

2568 
	`a_as£π
(
ªÆmName
);

2570 
	`g°∫˝y
(
websRólm
, 
ªÆmName
, 
	`TSZ
(websRealm));

2571 
	}
}

2578 
ch¨_t
 *
	$websGëRólm
()

2580  
websRólm
;

2581 
	}
}

2584 #ifde‡
WEBS_IF_MODIFIED_SUPPORT


2600 íum { 
	mJAN
, 
	mFEB
, 
	mMAR
, 
	mAPR
, 
	mMAY
, 
	mJUN
, 
	mJUL
, 
	mAUG
, 
	mSEP
, 
	mOCT
, 
	mNOV
, 
	mDEC
 } 
	tM⁄thEnumî©i⁄
;

2601 íum { 
	mSUN
, 
	mMON
, 
	mTUE
, 
	mWED
, 
	mTHU
, 
	mFRI
, 
	mSAT
 } 
	tWìkdayEnumî©i⁄
;

2608 
	$∑r£NDIGIT
(
ch¨_t
 *
buf
, 
digôs
, *
ödex
)

2610 
tmpIndex
, 
ªtu∫VÆue
;

2612 
ªtu∫VÆue
 = 0;

2614 
tmpIndex
 = *
ödex
;ÅmpIndex < *ödex+
digôs
;ÅmpIndex++) {

2615 i‡(
	`gisdigô
(
buf
[
tmpIndex
])) {

2616 
ªtu∫VÆue
 =Ñëu∫VÆuê* 10 + (
buf
[
tmpIndex
] - 
	`T
('0'));

2619 *
ödex
 = 
tmpIndex
;

2621  
ªtu∫VÆue
;

2622 
	}
}

2629 
	$∑r£M⁄th
(
ch¨_t
 *
buf
, *
ödex
)

2635 
tmpIndex
, 
ªtu∫VÆue
;

2637 
ªtu∫VÆue
 = -1;

2638 
tmpIndex
 = *
ödex
;

2640 
buf
[
tmpIndex
]) {

2642 
buf
[
tmpIndex
+1]) {

2644 
ªtu∫VÆue
 = 
APR
;

2647 
ªtu∫VÆue
 = 
AUG
;

2652 
ªtu∫VÆue
 = 
DEC
;

2655 
ªtu∫VÆue
 = 
FEB
;

2658 
buf
[
tmpIndex
+1]) {

2660 
ªtu∫VÆue
 = 
JAN
;

2663 
buf
[
tmpIndex
+2]) {

2665 
ªtu∫VÆue
 = 
JUL
;

2668 
ªtu∫VÆue
 = 
JUN
;

2675 
buf
[
tmpIndex
+1]) {

2677 
buf
[
tmpIndex
+2]) {

2679 
ªtu∫VÆue
 = 
MAR
;

2682 
ªtu∫VÆue
 = 
MAY
;

2689 
ªtu∫VÆue
 = 
NOV
;

2692 
ªtu∫VÆue
 = 
OCT
;

2695 
ªtu∫VÆue
 = 
SEP
;

2699 i‡(
ªtu∫VÆue
 >= 0) {

2700 *
ödex
 += 3;

2703  
ªtu∫VÆue
;

2704 
	}
}

2711 
	$∑r£Yór
(
ch¨_t
 *
buf
, *
ödex
)

2713 
tmpIndex
, 
ªtu∫VÆue
;

2715 
tmpIndex
 = *
ödex
;

2716 
ªtu∫VÆue
 = 
	`∑r£NDIGIT
(
buf
, 4, &
tmpIndex
);

2718 i‡(
ªtu∫VÆue
 >= 0) {

2719 *
ödex
 = 
tmpIndex
;

2721 
ªtu∫VÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

2722 i‡(
ªtu∫VÆue
 >= 0) {

2727 i‡(
ªtu∫VÆue
 < 70) {

2728 
ªtu∫VÆue
 += 2000;

2730 
ªtu∫VÆue
 += 1900;

2733 *
ödex
 = 
tmpIndex
;

2737  
ªtu∫VÆue
;

2738 
	}
}

2746 
	~<m©h.h
>

2748 c⁄° 
	gGªg‹ünEpoch
 = 1;

2755 
	$Gªg‹ünLópYórP
(
yór
)

2757 
ªsu…
;

2758 
tmp
;

2760 
tmp
 = 
yór
 % 400;

2762 i‡((
yór
 % 4 == 0) &&

2763 (
tmp
 != 100) &&

2764 (
tmp
 != 200) &&

2765 (
tmp
 != 300)) {

2766 
ªsu…
 = 
TRUE
;

2768 
ªsu…
 = 
FALSE
;

2771  
ªsu…
;

2772 
	}
}

2779 
	$FixedFromGªg‹ün
(
m⁄th
, 
day
, 
yór
)

2781 
fixedD©e
;

2783 
fixedD©e
 = ()(
Gªg‹ünEpoch
 - 1 + 365 * (
yór
 - 1) +

2784 
	`Êo‹
((
yór
 - 1) / 4.0) -

2785 
	`Êo‹
(()(
yór
 - 1) / 100.0) +

2786 
	`Êo‹
(()(
yór
 - 1) / 400.0) +

2787 
	`Êo‹
((367.0 * (()
m⁄th
) - 362.0) / 12.0));

2789 i‡(
m⁄th
 <= 2) {

2790 
fixedD©e
 += 0;

2791 } i‡(
TRUE
 =
	`Gªg‹ünLópYórP
(
yór
)) {

2792 
fixedD©e
 += -1;

2794 
fixedD©e
 += -2;

2797 
fixedD©e
 +
day
;

2799  
fixedD©e
;

2800 
	}
}

2807 
	$Gªg‹ünYórFromFixed
(
fixedD©e
)

2809 
ªsu…
, 
d0
, 
n400
, 
d1
, 
n100
, 
d2
, 
n4
, 
d3
, 
n1
, 
d4
, 
yór
;

2811 
d0
 = 
fixedD©e
 - 
Gªg‹ünEpoch
;

2812 
n400
 = ()(
	`Êo‹
(()
d0
 / ()146097));

2813 
d1
 = 
d0
 % 146097;

2814 
n100
 = ()(
	`Êo‹
(()
d1
 / ()36524));

2815 
d2
 = 
d1
 % 36524;

2816 
n4
 = ()(
	`Êo‹
(()
d2
 / ()1461));

2817 
d3
 = 
d2
 % 1461;

2818 
n1
 = ()(
	`Êo‹
(()
d3
 / ()365));

2819 
d4
 = (
d3
 % 365) + 1;

2820 
yór
 = 400 * 
n400
 + 100 * 
n100
 + 4 * 
n4
 + 
n1
;

2822 i‡((
n100
 =4Ë|| (
n1
 == 4)) {

2823 
ªsu…
 = 
yór
;

2825 
ªsu…
 = 
yór
 + 1;

2828  
ªsu…
;

2829 
	}
}

2838 
	$Gªg‹ünFromFixed
(
fixedD©e
, *
m⁄th
, *
day
, *
yór
)

2840 
¥i‹Days
, 
c‹ª˘i⁄
;

2842 *
yór
 = 
	`Gªg‹ünYórFromFixed
(
fixedD©e
);

2843 
¥i‹Days
 = 
fixedD©e
 - 
	`FixedFromGªg‹ün
(1, 1, *
yór
);

2845 i‡(
fixedD©e
 < 
	`FixedFromGªg‹ün
(3,1,*
yór
)) {

2846 
c‹ª˘i⁄
 = 0;

2847 } i‡(
åue
 =
	`Gªg‹ünLópYórP
(*
yór
)) {

2848 
c‹ª˘i⁄
 = 1;

2850 
c‹ª˘i⁄
 = 2;

2853 *
m⁄th
 = ()(
	`Êo‹
((12.0 * ()(
¥i‹Days
 + 
c‹ª˘i⁄
) + 373.0) / 367.0));

2854 *
day
 = 
fixedD©e
 - 
	`FixedFromGªg‹ün
(*
m⁄th
, 1, *
yór
);

2855 
	}
}

2863 
	$Gªg‹ünD©eDif„ªn˚
–
m⁄th1
, 
day1
, 
yór1
,

2864 
m⁄th2
, 
day2
, 
yór2
)

2866  
	`FixedFromGªg‹ün
(
m⁄th2
, 
day2
, 
yór2
) -

2867 
	`FixedFromGªg‹ün
(
m⁄th1
, 
day1
, 
yór1
);

2868 
	}
}

2876 
	#SECONDS_PER_DAY
 24*60*60

	)

2878 
	$∑r£Time
(
ch¨_t
 *
buf
, *
ödex
)

2883 
ªtu∫VÆue
, 
tmpIndex
, 
hourVÆue
, 
möuãVÆue
, 
£c⁄dVÆue
;

2885 
hourVÆue
 = 
möuãVÆue
 = 
£c⁄dVÆue
 = -1;

2886 
ªtu∫VÆue
 = -1;

2887 
tmpIndex
 = *
ödex
;

2889 
hourVÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

2891 i‡(
hourVÆue
 >= 0) {

2892 
tmpIndex
++;

2893 
möuãVÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

2894 i‡(
möuãVÆue
 >= 0) {

2895 
tmpIndex
++;

2896 
£c⁄dVÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

2900 i‡((
hourVÆue
 >= 0) &&

2901 (
möuãVÆue
 >= 0) &&

2902 (
£c⁄dVÆue
 >= 0)) {

2903 
ªtu∫VÆue
 = (((
hourVÆue
 * 60Ë+ 
möuãVÆue
Ë* 60Ë+ 
£c⁄dVÆue
;

2904 *
ödex
 = 
tmpIndex
;

2907  
ªtu∫VÆue
;

2908 
	}
}

2915 
time_t
 
	$d©eToTimë
(
yór
, 
m⁄th
, 
day
)

2917 
dayDif„ªn˚
;

2925 
dayDif„ªn˚
 = 
	`FixedFromGªg‹ün
(
m⁄th
 + 1, 
day
, 
yór
) -

2926 
	`FixedFromGªg‹ün
(1, 1, 1970);

2928  
dayDif„ªn˚
 * 
SECONDS_PER_DAY
;

2929 
	}
}

2937 
time_t
 
	$∑r£D©e1‹2
(
ch¨_t
 *
buf
, *
ödex
)

2945 
dayVÆue
, 
m⁄thVÆue
, 
yórVÆue
, 
tmpIndex
;

2946 
time_t
 
ªtu∫VÆue
;

2948 
ªtu∫VÆue
 = (
time_t
) -1;

2949 
tmpIndex
 = *
ödex
;

2951 
dayVÆue
 = 
m⁄thVÆue
 = 
yórVÆue
 = -1;

2953 i‡(
buf
[
tmpIndex
] =
	`T
(',')) {

2957 
tmpIndex
 += 2;

2959 
dayVÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

2960 i‡(
dayVÆue
 >= 0) {

2964 
tmpIndex
++;

2965 
m⁄thVÆue
 = 
	`∑r£M⁄th
(
buf
, &
tmpIndex
);

2966 i‡(
m⁄thVÆue
 >= 0) {

2970 
tmpIndex
++;

2971 
yórVÆue
 = 
	`∑r£Yór
(
buf
, &
tmpIndex
);

2975 i‡((
dayVÆue
 >= 0) &&

2976 (
m⁄thVÆue
 >= 0) &&

2977 (
yórVÆue
 >= 0)) {

2978 i‡(
yórVÆue
 < 1970) {

2982 
ªtu∫VÆue
 = 0;

2984 
ªtu∫VÆue
 = 
	`d©eToTimë
(
yórVÆue
, 
m⁄thVÆue
, 
dayVÆue
);

2986 *
ödex
 = 
tmpIndex
;

2990  
ªtu∫VÆue
;

2991 
	}
}

2998 
time_t
 
	$∑r£D©e3Time
(
ch¨_t
 *
buf
, *
ödex
)

3003 
dayVÆue
, 
m⁄thVÆue
, 
yórVÆue
, 
timeVÆue
, 
tmpIndex
;

3004 
time_t
 
ªtu∫VÆue
;

3006 
ªtu∫VÆue
 = (
time_t
) -1;

3007 
tmpIndex
 = *
ödex
;

3009 
dayVÆue
 = 
m⁄thVÆue
 = 
yórVÆue
 = 
timeVÆue
 = -1;

3011 
m⁄thVÆue
 = 
	`∑r£M⁄th
(
buf
, &
tmpIndex
);

3012 i‡(
m⁄thVÆue
 >= 0) {

3016 
tmpIndex
++;

3017 i‡(
buf
[
tmpIndex
] =
	`T
(' ')) {

3021 
tmpIndex
++;

3022 
dayVÆue
 = 
	`∑r£NDIGIT
(
buf
, 1, &
tmpIndex
);

3024 
dayVÆue
 = 
	`∑r£NDIGIT
(
buf
, 2, &
tmpIndex
);

3029 
timeVÆue
 = 
	`∑r£Time
(
buf
, &
tmpIndex
);

3030 i‡(
timeVÆue
 >= 0) {

3034 
yórVÆue
 = 
	`∑r£Yór
(
buf
, &
tmpIndex
);

3038 i‡((
dayVÆue
 >= 0) &&

3039 (
m⁄thVÆue
 >= 0) &&

3040 (
yórVÆue
 >= 0)) {

3041 
ªtu∫VÆue
 = 
	`d©eToTimë
(
yórVÆue
, 
m⁄thVÆue
, 
dayVÆue
);

3042 
ªtu∫VÆue
 +
timeVÆue
;

3043 *
ödex
 = 
tmpIndex
;

3046  
ªtu∫VÆue
;

3047 
	}
}

3058 
	$buf„rIndexIn¸emítGivíNTe°
(
ch¨_t
 *
buf
, 
ã°Index
, ch¨_à
ã°Ch¨
,

3059 
foundIn¸emít
, 
nŸfoundIn¸emít
)

3061 i‡(
buf
[
ã°Index
] =
ã°Ch¨
) {

3062  
foundIn¸emít
;

3065  
nŸfoundIn¸emít
;

3066 
	}
}

3073 
	$∑r£Wìkday
(
ch¨_t
 *
buf
, *
ödex
)

3081 
tmpIndex
, 
ªtu∫VÆue
;

3083 
ªtu∫VÆue
 = -1;

3084 
tmpIndex
 = *
ödex
;

3086 
buf
[
tmpIndex
]) {

3088 
ªtu∫VÆue
 = 
FRI
;

3089 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'd', ("Friday"), 3);

3092 
ªtu∫VÆue
 = 
MON
;

3093 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'd', ("Monday"), 3);

3096 
buf
[
tmpIndex
+1]) {

3098 
ªtu∫VÆue
 = 
SAT
;

3099 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'u', ("Saturday"), 3);

3102 
ªtu∫VÆue
 = 
SUN
;

3103 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'd', ("Sunday"), 3);

3108 
buf
[
tmpIndex
+1]) {

3110 
ªtu∫VÆue
 = 
THU
;

3111 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'r', ("Thursday"), 3);

3114 
ªtu∫VÆue
 = 
TUE
;

3115 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 's', ("Tuesday"), 3);

3120 
ªtu∫VÆue
 = 
WED
;

3121 *
ödex
 +
	`buf„rIndexIn¸emítGivíNTe°
(
buf
, 
tmpIndex
+3, 'n', ("Wednesday"), 3);

3124  
ªtu∫VÆue
;

3125 
	}
}

3132 
time_t
 
	$d©eP¨£
(
time_t
 
tù
, 
ch¨_t
 *
cmd
)

3134 
ödex
, 
tmpIndex
, 
wìkday
, 
timeVÆue
;

3135 
time_t
 
∑r£dVÆue
, 
d©eVÆue
;

3137 
∑r£dVÆue
 = (
time_t
) 0;

3138 
ödex
 = 
timeVÆue
 = 0;

3139 
wìkday
 = 
	`∑r£Wìkday
(
cmd
, &
ödex
);

3141 i‡(
wìkday
 >= 0) {

3142 
tmpIndex
 = 
ödex
;

3143 
d©eVÆue
 = 
	`∑r£D©e1‹2
(
cmd
, &
tmpIndex
);

3144 i‡(
d©eVÆue
 >= 0) {

3145 
ödex
 = 
tmpIndex
 + 1;

3151 
timeVÆue
 = 
	`∑r£Time
(
cmd
, &
ödex
);

3152 i‡(
timeVÆue
 >= 0) {

3157 i‡((
wìkday
 >= 0) &&

3158 (
d©eVÆue
 >= 0) &&

3159 (
timeVÆue
 >= 0)) {

3160 
∑r£dVÆue
 = 
d©eVÆue
 + 
timeVÆue
;

3167 
tmpIndex
 = 
ödex
;

3168 
∑r£dVÆue
 = 
	`∑r£D©e3Time
(
cmd
, &
tmpIndex
);

3172  
∑r£dVÆue
;

3173 
	}
}

	@webs.h

10 #i‚de‡
_h_WEBS


11 
	#_h_WEBS
 1

	)

22 
	~"ej.h
"

23 #ifde‡
WEBS_SSL_SUPPORT


24 
	~"websSSL.h
"

29 
	#WEBS_DEFAULT_HOME
 
	`T
("home.htm"Ë

	)

30 
	#WEBS_DEFAULT_PORT
 8080

	)

31 
	#WEBS_DEFAULT_SSL_PORT
 4433

	)

34 
	#WEBS_WHITELIST_SUPPORT
 1

	)

37 
	#WEBS_LOG_SUPPORT
 1

	)

40 
	#WEBS_TRACE_SUPPORT
 1

	)

41 
	#WEBS_TRACE_LEVEL
 3

	)

57 
	#WEBS_NAME
 
	`T
("GoAhód-Webs")

	)

58 
	#WEBS_VERSION
 
	`T
("2.5.0")

	)

59 #ifde‡
WEBS_SSL_SUPPORT


60 
	#SSL_NAME
 
	`T
("PìrSec-M©rixSSL")

	)

61 
	#SSL_VERSION
 
	`T
(
MATRIXSSL_VERSION
)

	)

66 
	#WEBS_HEADER_BUFINC
 512

	)

67 
	#WEBS_ASP_BUFINC
 512

	)

68 
	#WEBS_MAX_PASS
 32

	)

69 
	#WEBS_BUFSIZE
 960

	)

70 
	#WEBS_MAX_HEADER
 (5 * 1024Ë

	)

71 
	#WEBS_MAX_URL
 2048

	)

72 
	#WEBS_SOCKET_BUFSIZ
 256

	)

76 
	#WEBS_HTTP_PORT
 
	`T
("hâpP‹t")

	)

77 
	#CGI_BIN
 
	`T
("cgi-bö")

	)

82 
	#WEBS_LOCAL_PAGE
 0x1

	)

83 
	#WEBS_KEEP_ALIVE
 0x2

	)

84 
	#WEBS_DONT_USE_CACHE
 0x4

	)

85 
	#WEBS_COOKIE
 0x8

	)

86 
	#WEBS_IF_MODIFIED
 0x10

	)

87 
	#WEBS_POST_REQUEST
 0x20

	)

88 
	#WEBS_LOCAL_REQUEST
 0x40

	)

89 
	#WEBS_HOME_PAGE
 0x80

	)

90 
	#WEBS_ASP
 0x100

	)

91 
	#WEBS_HEAD_REQUEST
 0x200

	)

92 
	#WEBS_CLEN
 0x400

	)

93 
	#WEBS_FORM
 0x800

	)

94 
	#WEBS_REQUEST_DONE
 0x1000

	)

95 
	#WEBS_POST_DATA
 0x2000

	)

96 
	#WEBS_CGI_REQUEST
 0x4000

	)

97 
	#WEBS_SECURE
 0x8000

	)

98 
	#WEBS_AUTH_BASIC
 0x10000

	)

99 
	#WEBS_AUTH_DIGEST
 0x20000

	)

100 
	#WEBS_HEADER_DONE
 0x40000

	)

105 
	#WEBS_HANDLER_FIRST
 0x1

	)

106 
	#WEBS_HANDLER_LAST
 0x2

	)

111 
	swebsRec
 {

112 
rögq_t
 
	mhódî
;

113 
time_t
 
	msö˚
;

114 
sym_fd_t
 
	mcgiV¨s
;

115 
sym_fd_t
 
	mcgiQuîy
;

116 
time_t
 
	mtime°amp
;

117 
	mtimeout
;

118 
ch¨_t
 
	mùaddr
[32];

119 
ch¨_t
 
	miÁddr
[32];

120 
ch¨_t
 
	mty≥
[64];

121 
ch¨_t
 *
	mdú
;

122 
ch¨_t
 *
	m∑th
;

123 
ch¨_t
 *
	muæ
;

124 
ch¨_t
 *
	mho°
;

125 
ch¨_t
 *
	mÕ©h
;

126 
ch¨_t
 *
	mquîy
;

127 
ch¨_t
 *
	mdecodedQuîy
;

128 
ch¨_t
 *
	mauthTy≥
;

129 
ch¨_t
 *
	m∑ssw‹d
;

130 
ch¨_t
 *
	mu£rName
;

131 
ch¨_t
 *
	mcookõ
;

132 
ch¨_t
 *
	mu£rAgít
;

133 
ch¨_t
 *
	m¥Ÿocﬁ
;

134 
ch¨_t
 *
	m¥ŸoVîsi⁄
;

135 
	msid
;

136 
	mli°íSid
;

137 
	mp‹t
;

138 
	m°©e
;

139 
	mÊags
;

140 
	mcode
;

141 
	m˛í
;

142 
	mwid
;

143 
ch¨_t
 *
	mcgiStdö
;

144 
	mdocfd
;

145 
	mnumbyãs
;

146 
	mwrôãn
;

147 (*
	mwrôeSockë
)(
websRec
 *
	mwp
);

148 #ifde‡
DIGEST_ACCESS_SUPPORT


149 
ch¨_t
 *
	mªÆm
;

150 
ch¨_t
 *
	mn⁄˚
;

151 
ch¨_t
 *
	mdige°
;

152 
ch¨_t
 *
	muri
;

153 
ch¨_t
 *
	m›aque
;

154 
ch¨_t
 *
	mnc
;

155 
ch¨_t
 *
	m˙⁄˚
;

156 
ch¨_t
 *
	mq›
;

158 #ifde‡
WEBS_SSL_SUPPORT


159 
websSSL_t
 *
	mw•
;

161 } 
	twebsRec
;

163 
websRec
 *
	twebs_t
;

164 
websRec
 
	twebsTy≥
;

167 
websAc˚±
(
sid
, *
ùaddr
, 
p‹t
, 
li°íSid
);

168 
websA•Deföe
(
ch¨_t
 *
«me
,

169 (*
‚
)(
ejid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
));

170 
	`websA•Reque°
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
);

171 
	`websClo£Li°í
();

172 
	`websDecode64
(
ch¨_t
 *
outbuf
, ch¨_à*
°rög
, 
buÊí
);

173 
	`websDecodeUæ
(
ch¨_t
 *
tokí
, ch¨_à*
decoded
, 
Àn
);

174 
	`websD⁄e
(
webs_t
 
wp
, 
code
);

175 
	`websEncode64
(
ch¨_t
 *
outbuf
, ch¨_à*
°rög
, 
buÊí
);

176 
	`websEº‹
(
webs_t
 
wp
, 
code
, 
ch¨_t
 *
msg
, ...);

178 
ch¨_t
 *
	`websEº‹Msg
(
code
);

179 
	`websFoŸî
(
webs_t
 
wp
);

180 
	`websF‹mDeföe
(
ch¨_t
 *
«me
, (*
‚
)(
webs_t
 
wp
,

181 
ch¨_t
 *
∑th
, ch¨_à*
quîy
));

182 
ch¨_t
 *
	`websGëDeÁu…Dú
();

183 
ch¨_t
 *
	`websGëDeÁu…Page
();

184 
ch¨_t
 *
	`websGëHo°Uæ
();

185 
ch¨_t
 *
	`websGëI∑ddrUæ
();

186 
ch¨_t
 *
	`websGëPassw‹d
();

187 
	`websGëP‹t
();

188 
ch¨_t
 *
	`websGëPublishDú
(ch¨_à*
∑th
, ch¨_à**
uæPªfix
);

189 
ch¨_t
 *
	`websGëRólm
();

190 
	`websGëReque°Byãs
(
webs_t
 
wp
);

191 
ch¨_t
 *
	`websGëReque°Dú
(
webs_t
 
wp
);

192 
	`websGëReque°Fœgs
(
webs_t
 
wp
);

193 
ch¨_t
 *
	`websGëReque°I∑ddr
(
webs_t
 
wp
);

194 
ch¨_t
 *
	`websGëReque°L∑th
(
webs_t
 
wp
);

195 
ch¨_t
 *
	`websGëReque°P©h
(
webs_t
 
wp
);

196 
ch¨_t
 *
	`websGëReque°Passw‹d
(
webs_t
 
wp
);

197 
ch¨_t
 *
	`websGëReque°Ty≥
(
webs_t
 
wp
);

198 
	`websGëReque°Wrôãn
(
webs_t
 
wp
);

199 
ch¨_t
 *
	`websGëV¨
(
webs_t
 
wp
, ch¨_à*
v¨
, ch¨_à*
def
);

200 
	`websCom∑ªV¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

201 
	`websHódî
(
webs_t
 
wp
);

202 
	`websO≥nLi°í
(
p‹t
, 
ªåõs
);

203 
	`websPageO≥n
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
, ch¨_à*
∑th
,

204 
mode
, 
≥rm
);

205 
	`websPageClo£
(
webs_t
 
wp
);

206 
	`websPublish
(
ch¨_t
 *
uæPªfix
, ch¨_à*
∑th
);

207 
	`websRedúe˘
(
webs_t
 
wp
, 
ch¨_t
 *
uæ
);

208 
	`websSecurôyDñëe
();

209 
	`websSecurôyH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

210 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

211 
ch¨_t
 *
quîy
);

212 
	`websSëDeÁu…Dú
(
ch¨_t
 *
dú
);

213 
	`websSëDeÁu…Page
(
ch¨_t
 *
∑ge
);

214 
	`websSëEnv
(
webs_t
 
wp
);

215 
	`websSëHo°
(
ch¨_t
 *
ho°
);

216 
	`websSëI∑ddr
(
ch¨_t
 *
ùaddr
);

217 
	`websSëPassw‹d
(
ch¨_t
 *
∑ssw‹d
);

218 
	`websSëRólm
(
ch¨_t
 *
ªÆmName
);

219 
	`websSëReque°Byãs
(
webs_t
 
wp
, 
byãs
);

220 
	`websSëReque°Fœgs
(
webs_t
 
wp
, 
Êags
);

221 
	`websSëReque°L∑th
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
);

222 
	`websSëReque°P©h
(
webs_t
 
wp
, 
ch¨_t
 *
dú
, ch¨_à*
∑th
);

223 
ch¨_t
 *
	`websGëReque°U£rName
(
webs_t
 
wp
);

224 
	`websSëReque°Wrôãn
(
webs_t
 
wp
, 
wrôãn
);

225 
	`websSëV¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
, ch¨_à*
vÆue
);

226 
	`websTe°V¨
(
webs_t
 
wp
, 
ch¨_t
 *
v¨
);

227 
	`websTimeoutC™˚l
(
webs_t
 
wp
);

228 
	`websUæH™dÀrDeföe
(
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

229 
¨g
, (*
‚
)(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

230 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

231 
ch¨_t
 *
quîy
), 
Êags
);

232 
	`websUæH™dÀrDñëe
((*
‚
)(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

233 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

234 
ch¨_t
 *
quîy
));

235 
	`websUæH™dÀrReque°
(
webs_t
 
wp
);

236 
	`websUæP¨£
(
ch¨_t
 *
uæ
, ch¨_à**
buf
, ch¨_à**
ho°
,

237 
ch¨_t
 **
∑th
, ch¨_à**
p‹t
, ch¨_à**
quîy
,

238 
ch¨_t
 **
¥Ÿo
, ch¨_à**
èg
, ch¨_à**
ext
);

239 
ch¨_t
 *
	`websUæTy≥
(ch¨_à*
webs
, ch¨_à*
buf
, 
ch¨C¡
);

240 
	`websWrôe
(
webs_t
 
wp
, 
ch¨_t
* 
fmt
, ...);

241 
	`websWrôeBlock
(
webs_t
 
wp
, 
ch¨_t
 *
buf
, 
nCh¨s
);

242 
	`websWrôeD©aN⁄Block
(
webs_t
 
wp
, *
buf
, 
nCh¨s
);

243 
	`websVÆid
(
webs_t
 
wp
);

244 
	`websVÆid©eUæ
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
);

245 
	`websSëTimeM¨k
(
webs_t
 
wp
);

250 
	`websAŒoc
(
sid
);

251 
	`websFªe
(
webs_t
 
wp
);

252 
	`websTimeout
(*
¨g
, 
id
);

253 
	`websRódEvít
(
webs_t
 
wp
);

	@websSSL.c

11 #ifde‡
WEBS_SSL_SUPPORT


20 
	~"wsI¡∫.h
"

21 
	~"websSSL.h
"

22 
	~"webs.h
"

23 
	~"m©rixSSLSockë.h
"

25 
	~<°dio.h
>

26 
	~<°dlib.h
>

27 
	~<°rög.h
>

31 
	gs¶Li°íSock
 = -1;

32 
s¶Keys_t
 *
	gs¶Keys
 = 
NULL
;

36 
websSSLAc˚±
(
sid
, *
ùaddr
, 
p‹t
, 
li°íSid
);

37 
websSSLSockëEvít
(
sid
, 
mask
, *
iwp
);

38 
websSSLRódEvít
(
webs_t
 
wp
);

49 
	$websSSLO≥n
()

51 i‡(
	`m©rixS¶O≥n
() < 0) {

55 i‡(
	`m©rixS¶NewKeys
(&
s¶Keys
) < 0) {

56 
	`åa˚
(0, 
	`T
("FailedÅoállocate keys in websSSLOpen\n"));

59 i‡(
	`m©rixS¶LﬂdRßKeys
(
s¶Keys
, 
DEFAULT_CERT_FILE
, 
DEFAULT_KEY_FILE
,

60 
NULL
 ,

61 
NULL
 ) < 0) {

62 
	`åa˚
(0, 
	`T
("FailedÅoÑead certificate %s in websSSLOpen\n"),

63 
DEFAULT_CERT_FILE
);

64 
	`åa˚
(0, 
	`T
("SSL support is disabled\n"));

68 #ifde‡
USE_NONBLOCKING_SSL_SOCKETS


69 
s¶Li°íSock
 = 
	`sockëO≥nC⁄√˘i⁄
(
NULL
, 
WEBS_DEFAULT_SSL_PORT
,

70 
websSSLAc˚±
, 
SOCKET_MYOWNBUFFERS
);

72 
s¶Li°íSock
 = 
	`sockëO≥nC⁄√˘i⁄
(
NULL
, 
WEBS_DEFAULT_SSL_PORT
,

73 
websSSLAc˚±
, 
SOCKET_BLOCK
 | 
SOCKET_MYOWNBUFFERS
);

76 i‡(
s¶Li°íSock
 < 0) {

77 
	`åa˚
(0, 
	`T
("SSL: UnableÅo open SSL socket onÖort %d.\n"),

78 
WEBS_DEFAULT_SSL_PORT
);

81 
	`åa˚
(0, 
	`T
("webs: Listening for HTTPSÑequestsátÖort %d\n"),

82 
WEBS_DEFAULT_SSL_PORT
);

85 
	}
}

91 
	$websSSLAc˚±
(
sid
, *
ùaddr
, 
p‹t
, 
li°íSid
)

93 
webs_t
 
wp
;

94 
wid
;

96 
	`a_as£π
(
ùaddr
 && *ipaddr);

97 
	`a_as£π
(
sid
 >= 0);

98 
	`a_as£π
(
p‹t
 >= 0);

104 i‡((
wid
 = 
	`websAŒoc
(
sid
)) < 0) {

107 
wp
 = 
webs
[
wid
];

108 
	`a_as£π
(
wp
);

109 
wp
->
li°íSid
 =ÜistenSid;

111 
	`ascToUni
(
wp
->
ùaddr
, i∑ddr, 
	`mö
((wp->ùaddr), 
	`°æí
(ipaddr)+1));

117 i‡(
	`g°rcmp
(
wp
->
ùaddr
, 
	`T
("127.0.0.1")) == 0 ||

118 
	`g°rcmp
(
wp
->
ùaddr
, 
websI∑ddr
) == 0 ||

119 
	`g°rcmp
(
wp
->
ùaddr
, 
websHo°
) == 0) {

120 
wp
->
Êags
 |
WEBS_LOCAL_REQUEST
;

125 
wp
->
Êags
 |
WEBS_SECURE
;

130 
	`sockëCª©eH™dÀr
(
sid
, 
SOCKET_READABLE
, 
websSSLSockëEvít
, 
wp
);

135 
wp
->
timeout
 = 
	`emfSchedCÆlback
(
WEBS_TIMEOUT
, 
websTimeout
, (*) wp);

136 
	`åa˚
(8, 
	`T
("websSSLAccept(): webs:ácceptÑequest\n"));

138 
	}
}

144 
	$websSSLRód
(
websSSL_t
 *
w•
, 
ch¨_t
 *
buf
, 
Àn
)

146 
	`a_as£π
(
w•
);

147 
	`a_as£π
(
buf
);

149  
	`s¶Ród
(
w•
->
s¶C⁄n
, 
buf
, 
Àn
);

150 
	}
}

164 
	$websSSLGës
(
websSSL_t
 *
w•
, 
ch¨_t
 **
buf
)

166 
sockë_t
 *
•
;

167 
rögq_t
 *
lq
;

168 
c
;

169 
Àn
;

170 
webs_t
 
wp
;

171 
sid
;

172 
numByãsRe˚ived
;

174 
	`a_as£π
(
w•
);

175 
	`a_as£π
(
buf
);

177 *
buf
 = 
NULL
;

179 
wp
 = 
w•
->wp;

180 
sid
 = 
wp
->sid;

182 i‡((
•
 = 
	`sockëPå
(
sid
)Ë=
NULL
) {

185 
lq
 = &
•
->
löeBuf
;

190 
numByãsRe˚ived
 = 
	`s¶Ród
(
w•
->
s¶C⁄n
, &
c
, 1);

192 i‡(
numByãsRe˚ived
 < 0) {

196 i‡(
numByãsRe˚ived
 == 0) {

200 i‡(
	`rögqLí
(
lq
Ë> 0 && (
•
->
Êags
 & 
SOCKET_EOF
)) {

201 
c
 = '\n';

203 
Àn
 = 
	`rögqLí
(
lq
);

204 i‡(
Àn
 > 0) {

205 *
buf
 = 
	`bÆlocAscToUni
((*)
lq
->
£rvp
, 
Àn
);

207 *
buf
 = 
NULL
;

209 
	`rögqFlush
(
lq
);

210  
Àn
;

217 i‡(
c
 == '\n') {

218 
Àn
 = 
	`rögqLí
(
lq
);

219 i‡(
Àn
 > 0) {

220 *
buf
 = 
	`bÆlocAscToUni
((*)
lq
->
£rvp
, 
Àn
);

222 *
buf
 = 
NULL
;

224 
	`rögqFlush
(
lq
);

225  
Àn
;

227 } i‡(
c
 == '\r') {

230 
	`rögqPutcA
(
lq
, 
c
);

233 
	}
}

241 
	$websSSLSockëEvít
(
sid
, 
mask
, *
iwp
)

243 
webs_t
 
wp
;

245 
wp
 = (
webs_t
Ë
iwp
;

246 
	`a_as£π
(
wp
);

248 i‡(! 
	`websVÆid
(
wp
)) {

252 i‡(
mask
 & 
SOCKET_READABLE
) {

253 
	`websSSLRódEvít
(
wp
);

255 i‡(
mask
 & 
SOCKET_WRITABLE
) {

256 i‡(
wp
->
wrôeSockë
) {

257 (*
wp
->
wrôeSockë
)(wp);

260 
	}
}

266 
	$websSSLRódEvít
 (
webs_t
 
wp
)

268 
ªt
 = 07, 
sock
, 
ªsume
;

269 
sockë_t
 *
•å
;

270 
s¶C⁄n_t
* 
s¶C⁄n
;

272 
	`a_as£π
 (
wp
);

273 
	`a_as£π
(
	`websVÆid
(
wp
));

275 
•å
 = 
	`sockëPå
(
wp
->
sid
);

276 
	`a_as£π
(
•å
);

278 
sock
 = 
•å
->sock;

280 i‡(
wp
->
w•
 =
NULL
) {

281 
ªsume
 = 0;

283 
ªsume
 = 1;

284 
s¶C⁄n
 = (
wp
->
w•
)->sslConn;

299 i‡(
	`s¶Ac˚±
(&
s¶C⁄n
, 
sock
, 
s¶Keys
, 
ªsume
, 
NULL
) < 0) {

300 
	`websTimeoutC™˚l
(
wp
);

301 
	`sockëClo£C⁄√˘i⁄
(
wp
->
sid
);

302 
	`websFªe
(
wp
);

306 i‡(
ªsume
 == 0) {

310 
wp
->
w•
 = 
	`bÆloc
(
B_L
, (
websSSL_t
));

311 
	`a_as£π
 (
wp
->
w•
);

313 (
wp
->
w•
)->
s¶C⁄n
 = sslConn;

314 (
wp
->
w•
)->wp = wp;

320 
	`websRódEvít
(
wp
);

322  
ªt
;

323 
	}
}

329 
	$websSSLIsO≥n
()

331  (
s¶Li°íSock
 != -1);

332 
	}
}

338 
	$websSSLWrôe
(
websSSL_t
 *
w•
, 
ch¨_t
 *
buf
, 
Àn
)

340 
s¶ByãsSít
 = 0;

342 
	`a_as£π
(
w•
);

343 
	`a_as£π
(
buf
);

345 i‡(
w•
 =
NULL
) {

352 i‡((
s¶ByãsSít
 = 
	`s¶Wrôe
(
w•
->
s¶C⁄n
, 
buf
, 
Àn
)) < 0) {

353 
s¶ByãsSít
 = -1;

355  
s¶ByãsSít
;

356 
	}
}

362 
	$websSSLEof
(
websSSL_t
 *
w•
)

364 
webs_t
 
wp
;

365 
sid
;

367 
	`a_as£π
(
w•
);

369 
wp
 = 
w•
->wp;

370 
sid
 = 
wp
->sid;

372  
	`sockëEof
(
sid
);

373 
	}
}

379 
	$websSSLFlush
(
websSSL_t
 *
w•
)

381 
	`a_as£π
(
w•
);

385 
	}
}

391 
	$websSSLFªe
(
websSSL_t
 *
w•
)

393 i‡(
w•
 !
NULL
) {

394 
	`s¶WrôeClosuªAÀπ
(
w•
->
s¶C⁄n
);

395 
	`s¶FªeC⁄√˘i⁄
(&
w•
->
s¶C⁄n
);

396 
	`b‰ì
(
B_L
, 
w•
);

399 
	}
}

405 
	$websSSLClo£
()

407 
	`m©rixS¶DñëeKeys
(
s¶Keys
);

408 
	`m©rixS¶Clo£
();

409 
	}
}

	@websSSL.h

10 #i‚de‡
_h_websSSL


11 
	#_h_websSSL
 1

	)

21 #ifde‡
WEBS_SSL_SUPPORT


23 
	~"webs.h
"

24 
	~"m©rixSSLSockë.h
"

25 
	~"uemf.h
"

29 
	#DEFAULT_CERT_FILE
 "./˚πSrv.≥m"

	)

30 
	#DEFAULT_KEY_FILE
 "./¥ivkeySrv.≥m"

	)

33 
s¶C⁄n_t
* 
	ms¶C⁄n
;

34 
websRec
* 
	mwp
;

35 } 
	twebsSSL_t
;

39 
websSSLO≥n
();

40 
websSSLIsO≥n
();

41 
websSSLClo£
();

42 #ifde‡
WEBS_WHITELIST_SUPPORT


43 
websRequúeSSL
(*
uæ
);

48 
websSSLWrôe
(
websSSL_t
 *
w•
, 
ch¨_t
 *
buf
, 
nCh¨s
);

49 
websSSLGës
(
websSSL_t
 *
w•
, 
ch¨_t
 **
buf
);

50 
websSSLRód
(
websSSL_t
 *
w•
, 
ch¨_t
 *
buf
, 
nCh¨s
);

51 
websSSLEof
(
websSSL_t
 *
w•
);

53 
websSSLFªe
(
websSSL_t
 *
w•
);

54 
websSSLFlush
(
websSSL_t
 *
w•
);

56 
websSSLSëKeyFûe
(
ch¨_t
 *
keyFûe
);

57 
websSSLSëCîtFûe
(
ch¨_t
 *
˚πFûe
);

	@websda.c

18 #i‚de‡
CE


19 
	~<time.h
>

21 
	~"websda.h
"

22 
	~"md5.h
"

24 #ifde‡
DIGEST_ACCESS_SUPPORT


27 
	#RANDOMKEY
 
	`T
("⁄˚up⁄©imeö∑ødi£")

	)

28 
	#NONCE_SIZE
 34

	)

29 
	#HASH_SIZE
 16

	)

36 *
	$websMD5bö¨y
(*
buf
, 
Àngth
)

38 c⁄° *
hex
 = "0123456789abcdef";

39 
psDige°C⁄ãxt_t
 
md5˘x
;

40 
hash
[
HASH_SIZE
];

41 *
r
, *
°rRëu∫
;

42 
ªsu…
[(
HASH_SIZE
 * 2) + 1];

43 
i
;

48 
	`psMd5Inô
(&
md5˘x
);

49 
	`psMd5Upd©e
(&
md5˘x
, 
buf
, ()
Àngth
);

50 
	`psMd5FöÆ
(&
md5˘x
, 
hash
);

55 
i
 = 0, 
r
 = 
ªsu…
; i < 16; i++) {

56 *
r
++ = 
hex
[
hash
[
i
] >> 4];

57 *
r
++ = 
hex
[
hash
[
i
] & 0xF];

63 *
r
 = '\0';

68 
i
 = 
	`ñemítsof
(
ªsu…
);

69 
°rRëu∫
 = 
	`bÆloc
(
B_L
, 
i
);

70 
	`°∫˝y
(
°rRëu∫
, 
ªsu…
, 
i
);

72  
°rRëu∫
;

73 
	}
}

81 
ch¨_t
 *
	$websMD5
(
ch¨_t
 *
°rög
)

83 
ch¨_t
 *
°rRëu∫
;

85 
	`a_as£π
(
°rög
 && *string);

87 i‡(
°rög
 && *string) {

88 *
°rTemp
, *
°rHash
;

89 
nLí
;

93 
nLí
 = 
	`g°æí
(
°rög
);

94 
°rTemp
 = 
	`bÆlocUniToAsc
(
°rög
, 
nLí
 + 1);

98 
°rHash
 = 
	`websMD5bö¨y
((*)
°rTemp
, 
nLí
);

102 
nLí
 = 
	`°æí
(
°rHash
);

103 
°rRëu∫
 = 
	`bÆlocAscToUni
(
°rHash
, 
nLí
);

107 
	`b‰ì
(
B_L
, 
°rTemp
);

108 
	`b‰ì
(
B_L
, 
°rHash
);

110 
°rRëu∫
 = 
NULL
;

113  
°rRëu∫
;

114 
	}
}

123 
ch¨_t
 *
	$websCÆcN⁄˚
(
webs_t
 
wp
)

125 
ch¨_t
 *
n⁄˚
, *
¥í⁄˚
;

126 
time_t
 
l⁄gTime
;

127 #i‡
	`deföed
(
WIN32
)

128 
ch¨_t
 
buf
[26];

129 
î∫o_t
 
îr‹
;

130 
tm
 
√wtime
;

132 
tm
 *
√wtime
;

135 
	`a_as£π
(
wp
);

139 
	`time
(&
l⁄gTime
);

143 #i‡!
	`deföed
(
WIN32
)

144 
√wtime
 = 
	`loˇ…ime
(&
l⁄gTime
);

147 
îr‹
 = 
	`loˇ…ime_s
(&
√wtime
, &
l⁄gTime
);

152 #i‡!
	`deföed
(
WIN32
)

153 
¥í⁄˚
 = 
NULL
;

154 
	`fmtAŒoc
(&
¥í⁄˚
, 256, 
	`T
("%s:%s:%s"), 
RANDOMKEY
, 
	`gas˘ime
(
√wtime
),

155 
wp
->
ªÆm
);

157 
	`as˘ime_s
(
buf
, 
	`ñemítsof
(buf), &
√wtime
);

158 
	`fmtAŒoc
(&
¥í⁄˚
, 256, 
	`T
("%s:%s:%s"), 
RANDOMKEY
, 
buf
,

159 
RANDOMKEY
);

162 
	`a_as£π
(
¥í⁄˚
);

166 
n⁄˚
 = 
	`websMD5
(
¥í⁄˚
);

170 
	`b‰ìSa„
(
B_L
, 
¥í⁄˚
);

172  
n⁄˚
;

173 
	}
}

180 
ch¨_t
 *
	$websCÆcO∑que
(
webs_t
 
wp
)

182 
ch¨_t
 *
›aque
;

183 
	`a_as£π
(
wp
);

187 
›aque
 = 
	`b°rdup
(
B_L
, 
	`T
("5ccc069c403ebaf9f0171e9517f40e41"));

189  
›aque
;

190 
	}
}

197 
ch¨_t
 *
	$websCÆcDige°
(
webs_t
 
wp
)

199 
ch¨_t
 *
dige°
, *
a1
, *
a1¥ime
, *
a2
, *
a2¥ime
, *
¥eDige°
, *
mëhod
;

201 
	`a_as£π
(
wp
);

202 
dige°
 = 
NULL
;

207 
a1
 = 
NULL
;

208 
	`fmtAŒoc
(&
a1
, 255, 
	`T
("%s:%s:%s"), 
wp
->
u£rName
, wp->
ªÆm
, wp->
∑ssw‹d
);

209 
	`a_as£π
(
a1
);

210 
a1¥ime
 = 
	`websMD5
(
a1
);

211 
	`b‰ìSa„
(
B_L
, 
a1
);

215 
mëhod
 = 
	`websGëV¨
(
wp
, 
	`T
("REQUEST_METHOD"), 
NULL
);

216 
	`a_as£π
(
mëhod
);

217 
a2
 = 
NULL
;

218 
	`fmtAŒoc
(&
a2
, 255, 
	`T
("%s:%s"), 
mëhod
, 
wp
->
uri
);

219 
	`a_as£π
(
a2
);

220 
a2¥ime
 = 
	`websMD5
(
a2
);

221 
	`b‰ìSa„
(
B_L
, 
a2
);

225 
	`a_as£π
(
a1¥ime
);

226 
	`a_as£π
(
a2¥ime
);

227 
	`a_as£π
(
wp
->
n⁄˚
);

229 
¥eDige°
 = 
NULL
;

230 i‡(!
wp
->
q›
) {

231 
	`fmtAŒoc
(&
¥eDige°
, 255, 
	`T
("%s:%s:%s"), 
a1¥ime
, 
wp
->
n⁄˚
, 
a2¥ime
);

233 
	`fmtAŒoc
(&
¥eDige°
, 255, 
	`T
("%s:%s:%s:%s:%s:%s"),

234 
a1¥ime
,

235 
wp
->
n⁄˚
,

236 
wp
->
nc
,

237 
wp
->
˙⁄˚
,

238 
wp
->
q›
,

239 
a2¥ime
);

242 
	`a_as£π
(
¥eDige°
);

243 
dige°
 = 
	`websMD5
(
¥eDige°
);

247 
	`b‰ìSa„
(
B_L
, 
a1¥ime
);

248 
	`b‰ìSa„
(
B_L
, 
a2¥ime
);

249 
	`b‰ìSa„
(
B_L
, 
¥eDige°
);

250  
dige°
;

251 
	}
}

260 
ch¨_t
 *
	$websCÆcUæDige°
(
webs_t
 
wp
)

262 
ch¨_t
 *
dige°
, *
a1
, *
a1¥ime
, *
a2
, *
a2¥ime
, *
¥eDige°
, *
mëhod
;

264 
	`a_as£π
(
wp
);

265 
dige°
 = 
NULL
;

270 
a1
 = 
NULL
;

271 
	`fmtAŒoc
(&
a1
, 255, 
	`T
("%s:%s:%s"), 
wp
->
u£rName
, wp->
ªÆm
, wp->
∑ssw‹d
);

272 
	`a_as£π
(
a1
);

273 
a1¥ime
 = 
	`websMD5
(
a1
);

274 
	`b‰ìSa„
(
B_L
, 
a1
);

278 
mëhod
 = 
	`websGëV¨
(
wp
, 
	`T
("REQUEST_METHOD"), 
NULL
);

279 
	`a_as£π
(
mëhod
);

281 
a2
 = 
	`bÆloc
(
B_L
, (
	`g°æí
(
mëhod
Ë+2 + g°æí(
wp
->
uæ
ËË* (
ch¨_t
));

282 
	`a_as£π
(
a2
);

283 
	`g•rötf
(
a2
, 
	`T
("%s:%s"), 
mëhod
, 
wp
->
uæ
);

284 
a2¥ime
 = 
	`websMD5
(
a2
);

285 
	`b‰ìSa„
(
B_L
, 
a2
);

289 
	`a_as£π
(
a1¥ime
);

290 
	`a_as£π
(
a2¥ime
);

291 
	`a_as£π
(
wp
->
n⁄˚
);

293 
¥eDige°
 = 
NULL
;

294 i‡(!
wp
->
q›
) {

295 
	`fmtAŒoc
(&
¥eDige°
, 255, 
	`T
("%s:%s:%s"), 
a1¥ime
, 
wp
->
n⁄˚
, 
a2¥ime
);

297 
	`fmtAŒoc
(&
¥eDige°
, 255, 
	`T
("%s:%s:%s:%s:%s:%s"),

298 
a1¥ime
,

299 
wp
->
n⁄˚
,

300 
wp
->
nc
,

301 
wp
->
˙⁄˚
,

302 
wp
->
q›
,

303 
a2¥ime
);

306 
	`a_as£π
(
¥eDige°
);

307 
dige°
 = 
	`websMD5
(
¥eDige°
);

311 
	`b‰ìSa„
(
B_L
, 
a1¥ime
);

312 
	`b‰ìSa„
(
B_L
, 
a2¥ime
);

313 
	`b‰ìSa„
(
B_L
, 
¥eDige°
);

314  
dige°
;

315 
	}
}

	@websda.h

10 #i‚de‡
_h_WEBSDA


11 
	#_h_WEBSDA
 1

	)

23 
	~"uemf.h
"

24 
	~"webs.h
"

28 
ch¨_t
 *
websCÆcN⁄˚
(
webs_t
 
wp
);

29 
ch¨_t
 *
websCÆcO∑que
(
webs_t
 
wp
);

30 
ch¨_t
 *
websCÆcDige°
(
webs_t
 
wp
);

31 
ch¨_t
 *
websCÆcUæDige°
(
webs_t
 
wp
);

	@websuemf.c

12 
	~"ejI¡∫.h
"

13 
	~"wsI¡∫.h
"

21 (*
	mroutöe
)(*
	m¨g
, 
	mid
);

22 *
	m¨g
;

23 
time_t
 
	m©
;

24 
	mschedid
;

25 } 
	tsched_t
;

29 
sched_t
 **
	gsched
;

30 
	gschedMax
;

37 
	$s¸ùtEvÆ
(
ígöe
, 
ch¨_t
 *
cmd
, ch¨_à**
ªsu…
, * 
ch™
)

39 
ejid
;

41 i‡(
ígöe
 =
EMF_SCRIPT_EJSCRIPT
) {

42 
ejid
 = (Ë
ch™
;

48 i‡(
	`ejEvÆ
(
ejid
, 
cmd
, 
ªsu…
) ) {

55 
	}
}

66 
	$°rcmpci
(
ch¨_t
 *
s1
, ch¨_à*
s2
)

68 
rc
;

70 
	`a_as£π
(
s1
 && 
s2
);

71 i‡(
s1
 =
NULL
 || 
s2
 == NULL) {

75 i‡(
s1
 =
s2
) {

80 
rc
 = 
	`gtﬁowî
(*
s1
Ë- gtﬁowî(*
s2
);

81 i‡(*
s1
 == '\0') {

84 
s1
++;

85 
s2
++;

86 } 
rc
 == 0);

87  
rc
;

88 
	}
}

95 
	$TimîProc
(
schedid
)

97 
sched_t
 *
s
;

99 
	`a_as£π
(0 <
schedid
 && schedid < 
schedMax
);

100 
s
 = 
sched
[
schedid
];

101 
	`a_as£π
(
s
);

103 (
s
->
routöe
)(s->
¨g
, s->
schedid
);

104 
	}
}

112 
	$emfSchedCÆlback
(
dñay
, 
emfSchedProc
 *
¥oc
, *
¨g
)

114 
sched_t
 *
s
;

115 
schedid
;

117 i‡((
schedid
 = 
	`hAŒocE¡ry
((***Ë&
sched
, &
schedMax
,

118 (
sched_t
))) < 0) {

121 
s
 = 
sched
[
schedid
];

122 
s
->
routöe
 = 
¥oc
;

123 
s
->
¨g
 =árg;

124 
s
->
schedid
 = schedid;

129 
s
->
©
 = ((
dñay
 + 500Ë/ 1000Ë+ 
	`time
(0);

131  
schedid
;

132 
	}
}

139 
	$emfReschedCÆlback
(
schedid
, 
dñay
)

141 
sched_t
 *
s
;

143 i‡(
sched
 =
NULL
 || 
schedid
 =-1 || schedid >
schedMax
 ||

144 (
s
 = 
sched
[
schedid
]Ë=
NULL
) {

147 
s
->
©
 = ((
dñay
 + 500Ë/ 1000Ë+ 
	`time
(0);

148 
	}
}

152 
	$emfUnschedCÆlback
(
schedid
)

154 
sched_t
 *
s
;

156 i‡(
sched
 =
NULL
 || 
schedid
 =-1 || schedid >
schedMax
 ||

157 (
s
 = 
sched
[
schedid
]Ë=
NULL
) {

160 
	`b‰ì
(
B_L
, 
s
);

161 
schedMax
 = 
	`hFªe
((***Ë&
sched
, 
schedid
);

162 
	}
}

169 
	$emfSchedPro˚ss
()

171 
sched_t
 *
s
;

172 
schedid
;

173 
√xt
 = 0;

178 i‡(
schedMax
 <= 0) {

186 i‡(
√xt
 >
schedMax
) {

187 
√xt
 = 0;

190 
schedid
 = 
√xt
;

192 i‡((
s
 = 
sched
[
schedid
]Ë!
NULL
 && ()s->
©
 <()
	`time
(0)) {

193 
	`TimîProc
(
schedid
);

194 
√xt
 = 
schedid
 + 1;

197 i‡(++
schedid
 >
schedMax
) {

198 
schedid
 = 0;

200 i‡(
schedid
 =
√xt
) {

208 
	}
}

	@wsIntrn.h

10 #i‚de‡
_h_WEBS_INTERNAL


11 
	#_h_WEBS_INTERNAL
 1

	)

24 
	~<˘y≥.h
>

25 
	~<°dlib.h
>

26 
	~<°rög.h
>

27 
	~<°d¨g.h
>

29 #ifde‡
NETWARE


30 
	~<f˙é.h
>

31 
	~<sys/°©.h
>

32 
	~<sig«l.h
>

33 
	~<io.h
>

36 #ifde‡
WIN


37 
	~<f˙é.h
>

38 
	~<sys/°©.h
>

39 
	~<io.h
>

40 
	#loˇ…ime_r
(
A
, 
B
Ë
	`loˇ…ime_s
(B,A)

	)

41 
	~<sh¨e.h
>

42 
	#¢¥ötf
 
_¢¥ötf


	)

45 #ifde‡
NW


46 
	~<f˙é.h
>

47 
	~<sys/°©.h
>

50 #ifde‡
SCOV5


51 
	~<f˙é.h
>

52 
	~<sys/°©.h
>

53 
	~<sig«l.h
>

54 
	~<uni°d.h
>

57 #ifde‡
LYNX


58 
	~<f˙é.h
>

59 
	~<sys/°©.h
>

60 
	~<sig«l.h
>

61 
	~<uni°d.h
>

64 #ifde‡
UNIX


65 
	~<f˙é.h
>

66 
	~<sys/°©.h
>

67 
	~<sig«l.h
>

68 
	~<uni°d.h
>

71 #ifde‡
QNX4


72 
	~<f˙é.h
>

73 
	~<sys/°©.h
>

74 
	~<sig«l.h
>

75 
	~<uni°d.h
>

76 
	~<unix.h
>

79 #ifde‡
UW


80 
	~<f˙é.h
>

81 
	~<sys/°©.h
>

84 #ifde‡
VXWORKS


85 
	~<vxW‹ks.h
>

86 
	~<f˙é.h
>

87 
	~<sys/°©.h
>

90 #ifde‡
SOLARIS


91 
	~<ma¸os.h
>

92 
	~<f˙é.h
>

93 
	~<sys/°©.h
>

96 
	~"uemf.h
"

97 
	~"ejI¡∫.h
"

98 
	~"webs.h
"

104 
	#WEBS_BEGIN
 0x1

	)

105 
	#WEBS_HEADER
 0x2

	)

106 
	#WEBS_POST
 0x4

	)

107 
	#WEBS_POST_CLEN
 0x8

	)

108 
	#WEBS_PROCESSING
 0x10

	)

109 
	#WEBS_KEEP_TIMEOUT
 15000

	)

110 
	#WEBS_TIMEOUT
 60000

	)

112 
	#PAGE_READ_BUFSIZE
 512

	)

113 
	#MAX_PORT_LEN
 10

	)

114 
	#WEBS_SYM_INIT
 64

	)

121 (*
	mh™dÀr
)(
webs_t
 
	mwp
, 
ch¨_t
 *
	muæPªfix
, ch¨_à*
	mwebDú
, 
	m¨g
,

122 
ch¨_t
 *
	muæ
, ch¨_à*
	m∑th
,

123 
ch¨_t
 *
	mquîy
);

124 
ch¨_t
 *
	mwebDú
;

125 
ch¨_t
 *
	muæPªfix
;

126 
	mÀn
;

127 
	m¨g
;

128 
	mÊags
;

129 } 
	twebsUæH™dÀrTy≥
;

135 
	mîr‹s
;

136 
	mªdúe˘s
;

137 
	m√t_ªque°s
;

138 
	ma˘iveNëReque°s
;

139 
	ma˘iveBrow£rReque°s
;

140 
	mtimeouts
;

141 
	mac˚ss
;

142 
	mloˇlHôs
;

143 
	mªmŸeHôs
;

144 
	mf‹mHôs
;

145 
	mcgiHôs
;

146 
	mh™dÀrHôs
;

147 } 
	twebsSètsTy≥
;

149 
websSètsTy≥
 
websSèts
;

155 
	mcode
;

156 
ch¨_t
 *
	mmsg
;

157 } 
	twebsEº‹Ty≥
;

163 
ch¨_t
 *
	mty≥
;

164 
ch¨_t
 *
	mext
;

165 } 
	twebsMimeTy≥
;

171 
	msize
;

172 
	misDú
;

173 
time_t
 
	mmtime
;

174 } 
	twebsSètTy≥
;

180 
ch¨_t
 *
	m∑th
;

181 *
	m∑ge
;

182 
	msize
;

183 
	mpos
;

184 } 
	twebsRomPageIndexTy≥
;

189 #i‚de‡
CE


190 
	#SOCKET_RDONLY
 
O_RDONLY


	)

191 
	#SOCKET_BINARY
 
O_BINARY


	)

193 
	#SOCKET_RDONLY
 0x1

	)

194 
	#SOCKET_BINARY
 0x2

	)

197 
websRomPageIndexTy≥
 
websRomPageIndex
[];

198 
websMimeTy≥
 
websMimeLi°
[];

199 
sym_fd_t
 
websMime
;

200 
webs_t
* 
webs
;

201 
websMax
;

202 
ch¨_t
 
websHo°
[64];

203 
ch¨_t
 
websI∑ddr
[64];

204 
ch¨_t
 *
websHo°Uæ
;

205 
ch¨_t
 *
websI∑ddrUæ
;

206 
websP‹t
;

210 
websA•O≥n
();

211 
websA•Clo£
();

212 
websF‹mO≥n
();

213 
websF‹mClo£
();

214 
websA•Wrôe
(
ejid
, 
webs_t
 
wp
, 
¨gc
, 
ch¨_t
 **
¨gv
);

216 
websDeÁu…O≥n
();

217 
websDeÁu…Clo£
();

218 #ifde‡
WEBS_WHITELIST_SUPPORT


219 
	#WHITELIST_SSL
 0x001

	)

220 
	#WHITELIST_CGI
 0x002

	)

221 
websBuûdWhôñi°
();

222 
websWhôñi°Check
(*
∑th
);

223 
websDñëeWhôñi°
();

225 
websDeÁu…H™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

226 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

227 
ch¨_t
 *
quîy
);

228 
websF‹mH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

229 
websCgiH™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
, ch¨_à*
webDú
,

230 
¨g
, 
ch¨_t
 *
uæ
, ch¨_à*
∑th
, ch¨_à*
quîy
);

231 
websCgiCÀ™up
();

232 
websCheckCgiProc
(
h™dÀ
);

233 
ch¨_t
 *
websGëCgiCommName
();

235 
websLaunchCgiProc
(
ch¨_t
 *
cgiP©h
, ch¨_à**
¨gp
,

236 
ch¨_t
 **
ívp
, ch¨_à*
°dIn
, ch¨_à*
°dOut
);

237 
websO≥n
(
sid
);

238 
websRe•⁄£
(
webs_t
 
wp
, 
code
, 
ch¨_t
 *
msg
,

239 
ch¨_t
 *
ªdúe˘
);

240 
websJavaS¸ùtEvÆ
(
webs_t
 
wp
, 
ch¨_t
 *
s¸ùt
);

241 
websPageRódD©a
(
webs_t
 
wp
, *
buf
, 
nByãs
);

242 
websPageO≥n
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
, ch¨_à*
∑th
, 
mode
,

243 
≥rm
);

244 
websPageClo£
(
webs_t
 
wp
);

245 
websPageSìk
(
webs_t
 
wp
, 
off£t
);

246 
websPageSèt
(
webs_t
 
wp
, 
ch¨_t
 *
Õ©h
, ch¨_à*
∑th
,

247 
websSètTy≥
 *
sbuf
);

248 
websPageIsDúe˘‹y
(
ch¨_t
 *
Õ©h
);

249 
websRomO≥n
();

250 
websRomClo£
();

251 
websRomPageO≥n
(
webs_t
 
wp
, 
ch¨_t
 *
∑th
, 
mode
, 
≥rm
);

252 
websRomPageClo£
(
fd
);

253 
websRomPageRódD©a
(
webs_t
 
wp
, *
buf
, 
Àn
);

254 
websRomPageSèt
(
ch¨_t
 *
∑th
, 
websSètTy≥
 *
sbuf
);

255 
websRomPageSìk
(
webs_t
 
wp
, 
off£t
, 
‹igö
);

256 
websSëReque°SockëH™dÀr
(
webs_t
 
wp
, 
mask
,

257 (*
‚
)(
webs_t
 
wp
));

258 
	`websSﬁuti⁄H™dÀr
(
webs_t
 
wp
, 
ch¨_t
 *
uæPªfix
,

259 
ch¨_t
 *
webDú
, 
¨g
, ch¨_à*
uæ
, ch¨_à*
∑th
,

260 
ch¨_t
 *
quîy
);

261 
	`websUæH™dÀrClo£
();

262 
	`websUæH™dÀrO≥n
();

263 
	`websO≥nSîvî
(
p‹t
, 
ªåõs
);

264 
	`websClo£Sîvî
();

265 
ch¨_t
* 
	`websGëD©eSåög
(
websSètTy≥
* 
sbuf
);

267 
	`°rcmpci
(
ch¨_t
* 
s1
, ch¨_t* 
s2
);

269 #ifde‡
CE


270 
	`wrôeUniToAsc
(
fid
, *
buf
, 
Àn
);

271 
	`ªadAscToUni
(
fid
, **
buf
, 
Àn
);

	@wwwdemo/cgi-bin/cgitest.c

19 
	~<°dio.h
>

20 
	~<°rög.h
>

21 
	~<°dlib.h
>

22 
	~<time.h
>

33 
	$°rcmpci
(*
s1
, *
s2
)

35 
rc
;

37 i‡(
s1
 =
NULL
 || 
s2
 == NULL) {

41 i‡(
s1
 =
s2
) {

46 
rc
 = 
	`tﬁowî
(*
s1
Ë-Åﬁowî(*
s2
);

47 i‡(*
s1
 == '\0') {

50 
s1
++;

51 
s2
++;

52 } 
rc
 == 0);

54  
rc
;

55 
	}
}

63 *
	$gogëív
(*
v¨«me
)

65 *
ªsu…
;

67 i‡((
ªsu…
 = 
	`gëív
(
v¨«me
)Ë=
NULL
) {

68 
ªsu…
 = "(NULL)";

70  
ªsu…
;

71 
	}
}

78 
	$x2c
(*
wh©
)

80 
digô
;

82 
digô
 = (
wh©
[0] >= 'A' ? ((what[0] & 0xdf) - 'A') + 10 : (what[0] - '0'));

83 
digô
 *= 16;

84 
digô
 +(
wh©
[1] >= 'A' ? ((what[1] & 0xdf) - 'A') + 10 : (what[1] - '0'));

86  
digô
;

87 
	}
}

94 
	$u√sˇ≥_uæ
(*
uæ
)

96 
i
,
j
;

98 
i
 = 0, 
j
 = 0; 
uæ
[j]; ++i,++j) {

99 if((
uæ
[
i
] = uæ[
j
]) == '%') {

100 
uæ
[
i
] = 
	`x2c
(&uæ[
j
 + 1]) ;

101 
j
 += 2 ;

105 
uæ
[
i
] = '\0' ;

106 
	}
}

123 **
	$gëCGIv¨s
()

125 
i
;

126 *
ªque°_mëhod
, *
cgiöput
, *
nv∑ú
, *
eqpos
;

127 
c⁄ã¡_Àngth
, 
∑úcou¡
;

128 **
cgiv¨s
, **
∑úli°
;

134 
ªque°_mëhod
 = 
	`gogëív
("REQUEST_METHOD") ;

136 i‡(!
ªque°_mëhod
) {

137 
ªque°_mëhod
 = "NOT-CGI";

140 i‡(!
	`°rcmp
(
ªque°_mëhod
, "GET") || !strcmp(request_method, "HEAD")) {

141 
cgiöput

	`°rdup
(
	`gogëív
("QUERY_STRING"));

142 } i‡(!
	`°rcmp
(
ªque°_mëhod
, "POST")) {

143 i‡(
	`°rcmpci
(
	`gogëív
("CONTENT_TYPE"), "application/x-www-form-urlencoded")) {

144 
	`¥ötf
("getcgivars(): Unsupported Content-Type.\n");

145  
NULL
;

148 i‡(!(
c⁄ã¡_Àngth
 = 
	`©oi
(
	`gogëív
("CONTENT_LENGTH")))) {

149 
	`¥ötf
("getcgivars(): No Content-Length was sent withÅhe POSTÑequest.\n");

150  
NULL
;

153 i‡(!(
cgiöput
 = (*Ë
	`mÆloc
(
c⁄ã¡_Àngth
 + 1))) {

154 
	`¥ötf
("getcgivars(): CouldÇot malloc for cgiinput.\n") ;

155  
NULL
;

158 i‡(!
	`‰ód
(
cgiöput
, 
c⁄ã¡_Àngth
, 1, 
°dö
)) {

159 
	`¥ötf
("Couldn'tÑead CGI input from STDIN.\n");

160  
NULL
;

163 
cgiöput
[
c⁄ã¡_Àngth
] = '\0' ;

165 
	`¥ötf
("getcgivars(): unsupported REQUEST_METHOD\n") ;

166  
NULL
;

172 
i
 = 0; 
cgiöput
[i]; i++) {

173 i‡(
cgiöput
[
i
] == '+') {

174 
cgiöput
[
i
] = ' ';

181 
∑úli°
 = (**Ë
	`mÆloc
(256 * (**));

182 
∑úcou¡
 = 0 ;

183 
nv∑ú
 = 
	`°πok
(
cgiöput
, "&");

185 
nv∑ú
) {

186 
∑úli°
[
∑úcou¡
++] = 
	`°rdup
(
nv∑ú
);

187 i‡(!(
∑úcou¡
 % 256)) {

188 
∑úli°
(**Ë
	`ªÆloc
’aúli°, (
∑úcou¡
 + 256)

192 
nv∑ú
 = 
	`°πok
(
NULL
, "&") ;

198 
∑úli°
[
∑úcou¡
] = 0;

203 
cgiv¨s
 = (**Ë
	`mÆloc
((
∑úcou¡
 * 2 + 1) * (**));

204 
i
 = 0; i < 
∑úcou¡
; i++) {

205 i‡(
eqpos
 = 
	`°rchr
(
∑úli°
[
i
], '=')) {

206 *
eqpos
 = '\0' ;

207 
	`u√sˇ≥_uæ
(
cgiv¨s
[
i
 * 2 + 1] = 
	`°rdup
(
eqpos
 + 1));

209 
	`u√sˇ≥_uæ
(
cgiv¨s
[
i
 * 2 + 1] = 
	`°rdup
(""));

211 
	`u√sˇ≥_uæ
(
cgiv¨s
[
i
 * 2] = 
	`°rdup
(
∑úli°
[i]));

217 
cgiv¨s
[
∑úcou¡
 * 2] = 0;

222 
	`‰ì
(
cgiöput
);

224 
i
 = 0; 
∑úli°
[i]; i++) {

225 
	`‰ì
(
∑úli°
[
i
]);

228 
	`‰ì
(
∑úli°
);

233  
cgiv¨s
;

235 
	}
}

242 
	$maö
(
¨gc
, *
¨gv
[])

244 **
pV¨s
;

245 
lo›Cou¡
 = 1000;

246 
time_t
 
£c⁄d
;

252 
	`¥ötf
("Content-type:Åext/html\n\n") ;

256 
	`¥ötf
("<html>\n");

257 
	`¥ötf
("<head><title>CGI Output</title></head>\n");

258 
	`¥ötf
("<body>\n");

260 
	`¥ötf
("<H1>CGI Test Program</H1>\n");

261 
	`¥ötf
("<P>ThisÖrogram displaysÅhe CGI Enviroment</P>\n");

266 
	`¥ötf
("<H2>Environment Variables<A NAME=\"env\"></A></H2>\n");

267 
	`¥ötf
("<P>REQUEST METHOD = %s</P>\n", 
	`gogëív
("REQUEST_METHOD"));

268 
	`¥ötf
("<P>QUERY STRING = %s</P>\n", 
	`gogëív
("QUERY_STRING"));

269 
	`¥ötf
("<P>GATEWAY INTERFACE = %s</P>\n", 
	`gogëív
("GATEWAY_INTERFACE"));

270 
	`¥ötf
("<P>SCRIPT NAME = %s</P>\n", 
	`gogëív
("SCRIPT_NAME"));

272 
	`¥ötf
("<P>PATH TRANSLATED = %s</P>\n", 
	`gogëív
("PATH_TRANSLATED"));

273 
	`¥ötf
("<P>PATH INFO = %s</P>\n", 
	`gogëív
("PATH_INFO"));

275 
	`¥ötf
("<P>HTTP HOST = %s</P>\n", 
	`gogëív
("HTTP_HOST"));

276 
	`¥ötf
("<P>HTTP ACCEPT = %s</P>\n", 
	`gogëív
("HTTP_ACCEPT"));

277 
	`¥ötf
("<P>HTTP CONNECTION = %s</P>\n", 
	`gogëív
("HTTP_CONNECTION"));

279 
	`¥ötf
("<P>REMOTE USER = %s</P>\n", 
	`gogëív
("REMOTE_USER"));

280 
	`¥ötf
("<P>REMOTE HOST = %s</P>\n", 
	`gogëív
("REMOTE_HOST"));

281 
	`¥ötf
("<P>REMOTE ADDR = %s</P>\n", 
	`gogëív
("REMOTE_ADDR"));

283 
	`¥ötf
("<P>SERVER NAME = %s</P>\n", 
	`gogëív
("SERVER_NAME"));

284 
	`¥ötf
("<P>SERVER PORT = %s</P>\n", 
	`gogëív
("SERVER_PORT"));

285 
	`¥ötf
("<P>SERVER HOST = %s</P>\n", 
	`gogëív
("SERVER_HOST"));

286 
	`¥ötf
("<P>SERVER PROTOCOL = %s</P>\n", 
	`gogëív
("SERVER_PROTOCOL"));

287 
	`¥ötf
("<P>SERVER ADDR = %s</P>\n", 
	`gogëív
("SERVER_ADDR"));

288 
	`¥ötf
("<P>SERVER URL = %s</P>\n", 
	`gogëív
("SERVER_URL"));

289 
	`¥ötf
("<P>SERVER SOFTWARE = %s</P>\n", 
	`gogëív
("SERVER_SOFTWARE"));

294 
	`¥ötf
("<H2>Query String Variables<A NAME=\"query\"></A></H2>\n");

295 
pV¨s
 = 
	`gëCGIv¨s
();

296 i‡(
pV¨s
) {

297 *
pV¨s
 && *(pVars + 1)) {

298 
	`¥ötf
("<p>%†<b>%s</b></p>\n", *
pV¨s
, *(pVars + 1));

299 
pV¨s
 += 2;

302 
	`¥ötf
("<P>No query variables found</P>\n");

309 #ifde‡
PRINT_BIG_CHUNK_SLOWLY


310 
	`¥ötf
("<H2>Large chunk of meaninglessÅext<A NAME=\"chunk\"></A></H2>\n");

311 
lo›Cou¡
) {

312 
	`¥ötf
("<p>MónögÀs†löêo‡ãxànumbî %d.</p>\n", 
lo›Cou¡
);

313 i‡((
lo›Cou¡
 % 100) == 0) {

314 
£c⁄d
 = 
	`time
(
NULL
);

315 (
	`time
(
NULL
Ë- 
£c⁄d
) < 5) {

318 
lo›Cou¡
--;

322 
	`¥ötf
("</body>\n");

323 
	`¥ötf
("</html>\n");

326 
	}
}

	@
1
.
0
57
555
CE/main.c
CE/wincompat.c
CE/wincompat.h
ECOS/main.c
LINUX/main.c
LYNX/main.c
MACOSX/main.c
NW/main.c
QNX4/main.c
VXWORKS/main.c
VXWORKS/vxcgitst.c
WIN/main.c
asp.c
balloc.c
cgi.c
default.c
ej.h
ejIntrn.h
ejlex.c
ejparse.c
emfdb.c
emfdb.h
form.c
h.c
handler.c
matrixSSLSocket.c
matrixSSLSocket.h
md5.h
md5c.c
mime.c
mime64.c
misc.c
page.c
ringq.c
rom.c
security.c
sock.c
sockGen.c
sym.c
uemf.c
uemf.h
um.c
um.h
umui.c
url.c
utils/webcomp.c
value.c
webrom.c
webs.c
webs.h
websSSL.c
websSSL.h
websda.c
websda.h
websuemf.c
wsIntrn.h
wwwdemo/cgi-bin/cgitest.c
